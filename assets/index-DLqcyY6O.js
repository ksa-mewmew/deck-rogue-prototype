(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();function Nn(){const e=document.documentElement,n=180,t=5,a=7,r=3;let o=0;const d=()=>{o=0;const c=getComputedStyle(e),h=window.innerWidth,b=window.innerHeight,p=parseFloat(c.getPropertyValue("--hudH"))||140,u=parseFloat(c.getPropertyValue("--dockH"))||210,k=parseFloat(c.getPropertyValue("--uiGap"))||16,E=parseFloat(c.getPropertyValue("--edgePad"))||14,i=parseFloat(c.getPropertyValue("--logW"))||360,s=parseFloat(c.getPropertyValue("--logGap"))||14,m=parseFloat(c.getPropertyValue("--playerW"))||320,C=parseFloat(c.getPropertyValue("--slotGapXBase"))||22,T=parseFloat(c.getPropertyValue("--slotGapYBase"))||6,P=Math.max(320,h-(m+i+s*2+E*2)),w=Math.max(260,b-(p+u+k)),g=r*n+(r-1)*C,_=n*(a/t),v=parseFloat(c.getPropertyValue("--battleChromeHBase"))||140,H=_*2+T+v,$=P/g,U=w/H,j=Math.min($,U),A=Math.max(.55,Math.min(j,1.25));e.style.setProperty("--u",String(A))},l=()=>{o||(o=requestAnimationFrame(d))};window.addEventListener("resize",l,{passive:!0}),d()}function On(){let e=!1;const n=()=>{const r=window.innerWidth;!e&&r<1180&&(e=!0),e&&r>1220&&(e=!1),document.body.classList.toggle("compact",e)};let t=0;const a=()=>{t||(t=requestAnimationFrame(()=>{t=0,n()}))};window.addEventListener("resize",a,{passive:!0}),n()}function Be(e){return[{id:"A",type:e[0]},{id:"B",type:e[1]}]}function ye(e,n,t){e.status[n]=Math.max(0,(e.status[n]??0)+t)}function ce(e){const n=Be(Ae(e)),t=Be(Ae(e)),a=Be(Ae(e));return{root:n,nextIfA:t,nextIfB:a}}function Rn(e,n){e.run.branchOffer||(e.run.branchOffer=ce(e));const t=e.run.branchOffer,a=n==="A"?t.nextIfA:t.nextIfB,r=ce(e);e.run.branchOffer={root:a,nextIfA:r.nextIfA,nextIfB:r.nextIfB}}function Ln(){return Math.random().toString(16).slice(2)+"-"+Date.now().toString(16)}function Ke(e,n=0){return e<n?n:e}function qe(e){const n=[...e];for(let t=n.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[n[t],n[a]]=[n[a],n[t]]}return n}function R(e,n="pickOne"){if(e.length===0)throw new Error(`${n}: empty array`);return e[Math.floor(Math.random()*e.length)]}function f(e,n){e.log.unshift(n),e.log=e.log.slice(0,250)}function F(e){return e.enemies.filter(n=>n.hp>0)}function Ae(e){const n=[],t=e.run.treasureObtained?24:20,a=e.run.treasureObtained?1:4,r=(e.run.treasureObtained,5),d=!e.run.treasureObtained&&e.run.nodePickCount>=30?1:0;for(let h=0;h<t;h++)n.push("BATTLE");for(let h=0;h<a;h++)n.push("REST");for(let h=0;h<r;h++)n.push("EVENT");for(let h=0;h<d;h++)n.push("TREASURE");const l=R(n,"rollNodeOffers pool");let c=R(n,"rollNodeOffers pool");if(l==="TREASURE"){const h=n.filter(b=>b!=="TREASURE");c=R(h,"rollNodeOffers poolNoTreasure")}return[l,c]}function Mn(e){return Math.max(0,Math.min(1,e))}function ge(e,n=0){const t=e.player?.fatigue??0,a=Mn(n+Math.max(0,t-5)*.12),r=t<=5?0:t<=8?1:t<=11?2:3;return{f:t,p:a,tier:r}}function Ie(e){const n={phase:"NODE",log:[],uidSeq:0,winHooksAppliedThisCombat:!1,intentsRevealedThisTurn:!1,disruptIndexThisTurn:null,backUidsThisTurn:[],run:{encounterCount:0,treasureObtained:!1,afterTreasureNodePicks:0,finished:!1,nextBattleSuppliesBonus:0,nextBossId:null,bossPool:["boss_gravity_master","boss_cursed_wall","boss_giant_orc","boss_soul_stealer"],nodePickCount:0,branchOffer:null,nodeOfferQueue:[],currentNodeOffers:null,nodePickByType:{BATTLE:0,REST:0,EVENT:0,TREASURE:0},battleCount:0,enemyLastSeenBattle:{},nextBossTime:30,forcedNext:null,bossOmenText:null,deckSizeAtTreasure:null},player:{hp:40,maxHp:40,block:0,supplies:0,fatigue:0,zeroSupplyTurns:0,status:{vuln:0,weak:0,bleed:0,disrupt:0},immuneToDisruptThisTurn:!1,nullifyDamageThisTurn:!1},content:e,cards:{},deck:[],hand:[],discard:[],exhausted:[],vanished:[],choice:null,choiceStack:[],frontSlots:[null,null,null],backSlots:[null,null,null],backSlotDisabled:[!1,!1,!1],enemies:[],attackedEnemyIndicesThisTurn:[],usedThisTurn:0,frontPlacedThisTurn:0,selectedHandCardUid:null,pendingTargetQueue:[],pendingTarget:null,drawCountThisTurn:0,time:0};return n.run.branchOffer=ce(n),Dn(n),f(n,"새 런 시작. 다음 인카운터를 선택하세요."),n}function te(e,n,t){for(let a=0;a<t;a++){const r=Ln(),o={uid:r,defId:n,zone:"deck",upgrade:0};e.cards[r]=o,e.deck.push(r)}}function Dn(e){te(e,"field_ration",2),te(e,"maintenance",2),te(e,"scout",2),te(e,"shield",2),te(e,"power_arrow",1),te(e,"arrow",3),e.deck=qe(e.deck)}function J(e,n){const t=e.cards[n],a=e.content.cardsById[t.defId],r=t.upgrade??0,o=a.upgrades?.[r-1];return o?{...a,...o}:a}function G(e,n,t){const a=e.cardsById[n],r=Math.max(0,t|0);if(r<=0)return a;const o=a.upgrades?.[r-1];return o?{...a,...o}:a}function ae(e,n){const a=e.cards[n].upgrade??0,r=J(e,n);return a>0?`${r.name} +${a}`:r.name}const Fn=[{id:"field_ration",name:"야전 식량",frontText:"방어 +3",backText:"S +2",front:[{op:"block",n:3}],back:[{op:"supplies",n:2}],upgrades:[{frontText:"방어 +5",front:[{op:"block",n:5}],backText:"S +3",back:[{op:"supplies",n:3}]}]},{id:"maintenance",name:"정비 도구",exhaustWhen:"BACK",frontText:"방어 +3",backText:"F -1, 소모",front:[{op:"block",n:3}],back:[{op:"fatigue",n:-1}],upgrades:[{frontText:"방어 +5",front:[{op:"block",n:5}],backText:"F -1, S +1, 소모",back:[{op:"fatigue",n:-1},{op:"supplies",n:1}]}]},{id:"scout",name:"정찰",frontText:"선택한 적에게 3 피해, 방어 +2",backText:"드로우 1, S +2",front:[{op:"damageEnemy",target:"select",n:3},{op:"block",n:2}],back:[{op:"draw",n:1},{op:"supplies",n:2}],upgrades:[{frontText:"선택한 적에게 4 피해, 방어 +3",front:[{op:"damageEnemy",target:"select",n:4},{op:"block",n:3}],backText:"드로우 2, S +2",back:[{op:"draw",n:2},{op:"supplies",n:2}]}]},{id:"shield",name:"방패",frontText:"방어 +6",backText:"방어 +3",front:[{op:"block",n:6}],back:[{op:"block",n:3}],upgrades:[{frontText:"방어 +8",front:[{op:"block",n:8}],backText:"방어 +4",back:[{op:"block",n:4}]}]},{id:"power_arrow",name:"강력한 화살",frontText:"무작위 적에게 10 피해, S -1",backText:"무작위 적에게 전열 한 장당 2 피해, S -1",front:[{op:"supplies",n:-1},{op:"damageEnemy",target:"random",n:10}],back:[{op:"supplies",n:-1},{op:"damageEnemyBy",target:"random",nPer:2,by:"frontCount"}],upgrades:[{frontText:"무작위 적에게 13 피해, S -1",front:[{op:"supplies",n:-1},{op:"damageEnemy",target:"random",n:13}],backText:"무작위 적에게 전열 한 장당 2 피해",back:[{op:"damageEnemyBy",target:"random",nPer:2,by:"frontCount"}]}]},{id:"arrow",name:"화살",frontText:"선택한 적에게 5 피해",backText:"선택한 적에게 5 피해, S -1",front:[{op:"damageEnemy",target:"select",n:5}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:5}],upgrades:[{frontText:"선택한 적에게 7 피해",front:[{op:"damageEnemy",target:"select",n:7}],backText:"선택한 적에게 7 피해, S -1",back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:7}]}]},{id:"goal_treasure",name:"저주받은 보물",exhaustWhen:"BOTH",frontText:"F +1, 소모",backText:"S -1, F +1, 소모",front:[{op:"fatigue",n:1}],back:[{op:"supplies",n:-1},{op:"fatigue",n:1}]},{id:"berserk",name:"광폭화",frontText:"무작위 적에게 15 피해, F +1",backText:"S +4, F +1",front:[{op:"damageEnemy",target:"random",n:15},{op:"fatigue",n:1}],back:[{op:"supplies",n:4},{op:"fatigue",n:1}],upgrades:[{frontText:"무작위 적에게 20 피해, F +2",front:[{op:"damageEnemy",target:"random",n:20},{op:"fatigue",n:2}],backText:"S +6, F +2",back:[{op:"supplies",n:6},{op:"fatigue",n:2}]}]},{id:"bandage",name:"붕대",exhaustWhen:"BOTH",frontText:"HP +4, 소모",backText:"HP +4, S -1, 소모",front:[{op:"heal",n:4}],back:[{op:"supplies",n:-1},{op:"heal",n:4}],upgrades:[{frontText:"HP +4, 출혈 제거, 소모",front:[{op:"heal",n:4},{op:"clearStatusSelf",key:"bleed"}],backText:"HP +4, 출혈 제거, S -1, 소모",back:[{op:"supplies",n:-1},{op:"heal",n:4},{op:"clearStatusSelf",key:"bleed"}]}]},{id:"arrow_rain",name:"화살의 비",exhaustWhen:"BOTH",frontText:"모든 적에게 10 피해, S -1, F +1, 소모",backText:"드로우 2, S +2, F +1, 소모",front:[{op:"damageEnemy",target:"all",n:10},{op:"supplies",n:-1},{op:"fatigue",n:1}],back:[{op:"draw",n:2},{op:"supplies",n:2},{op:"fatigue",n:1}],upgrades:[{frontText:"모든 적에게 13 피해, S -2, F +1, 소모",front:[{op:"damageEnemy",target:"all",n:13},{op:"supplies",n:-2},{op:"fatigue",n:1}],backText:"드로우 3, S +3, F +2, 소모",back:[{op:"draw",n:3},{op:"supplies",n:3},{op:"fatigue",n:2}]}]},{id:"smoke",name:"연막",exhaustWhen:"FRONT",frontText:"이번 턴 적 공격 피해 무효, 소모",backText:"자신은 교란 당하지 않음",front:[{op:"nullifyDamageThisTurn"}],back:[{op:"immuneDisruptThisTurn"}]},{id:"redeploy",name:"재배치",frontText:"S +2",backText:"3번 슬롯에 있는 후열 카드의 전열 효과 발동",front:[{op:"supplies",n:2}],back:[{op:"triggerFrontOfBackSlot",index:2}],upgrades:[{frontText:"S +3",front:[{op:"supplies",n:3}],backText:"3번 슬롯에 있는 후열 카드의 전열 효과 발동, S +1",back:[{op:"triggerFrontOfBackSlot",index:2},{op:"supplies",n:1}]}]},{id:"secret_strike",name:"비장의 일격",exhaustWhen:"BOTH",frontText:"무작위 적에게 자신의 F의 3배 피해, 소모",backText:"모든 적에게 취약 +4 및 약화 +4, 소모",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:3}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:4},{op:"statusEnemy",target:"all",key:"weak",n:4}],upgrades:[{exhaustWhen:"FRONT",frontText:"선택한 적에게 자신의 F의 3배 피해, 소모",front:[{op:"damageEnemyByPlayerFatigue",target:"select",mult:3}],backText:"모든 적에게 취약 +4 및 약화 +4",back:[{op:"statusEnemy",target:"all",key:"vuln",n:4},{op:"statusEnemy",target:"all",key:"weak",n:4}]}]},{id:"fire_scroll",name:"화염 두루마리",exhaustWhen:"BOTH",frontText:"방어 +7, 소모",backText:"모든 적에게 12 피해, 소모",front:[{op:"block",n:7}],back:[{op:"damageEnemy",target:"all",n:12}],upgrades:[{frontText:"방어 +8, 소모",front:[{op:"block",n:8}],backText:"모든 적에게 14 피해, 소모",back:[{op:"damageEnemy",target:"all",n:14}]}]},{id:"caltrops",name:"마름쇠",frontText:"모든 적에게 출혈 4 부여",backText:"이번 턴에 자신을 공격하려는 적에게 출혈 3 부여",front:[{op:"statusEnemy",target:"all",key:"bleed",n:4}],back:[{op:"statusEnemiesAttackingThisTurn",key:"bleed",n:3}],upgrades:[{frontText:"모든 적에게 출혈 5 부여",backText:"이번 턴에 자신을 공격하려는 적에게 출혈 4 부여",front:[{op:"statusEnemy",target:"all",key:"bleed",n:5}],back:[{op:"statusEnemiesAttackingThisTurn",key:"bleed",n:4}]}]},{id:"emergency_rations",name:"비상식량",vanishWhen:"BACK",frontText:"S +2",backText:"S를 10으로 만듦. 소실",front:[{op:"supplies",n:2}],back:[{op:"setSupplies",n:10}],upgrades:[{frontText:"S +3",backText:"S를 15으로 만듦. 소실",front:[{op:"supplies",n:3}],back:[{op:"setSupplies",n:15}]}]},{id:"painkiller",name:"진통제",exhaustWhen:"BOTH",frontText:"HP -8, F -2, 소모",backText:"HP +8, F +2, 소모",front:[{op:"hp",n:-8},{op:"fatigue",n:-2}],back:[{op:"hp",n:8},{op:"fatigue",n:2}],upgrades:[{frontText:"HP -6, F -2, 소모",backText:"HP +10, F +2, 소모",front:[{op:"hp",n:-6},{op:"fatigue",n:-2}],back:[{op:"hp",n:10},{op:"fatigue",n:2}]}]},{id:"field_experience",name:"실전 경험",exhaustWhen:"BACK",frontText:"모든 적에게 3 피해",backText:"이 카드가 후열에 있는 턴에 승리하면 최대 체력 +2, 소모",front:[{op:"damageEnemy",target:"all",n:3}],back:[],onWinWhileInBack:[{op:"maxHp",n:2}],upgrades:[{frontText:"모든 적에게 4 피해",backText:"이 카드가 후열에 있는 턴에 승리하면 최대 체력 +3, 소모",front:[{op:"damageEnemy",target:"all",n:4}],onWinWhileInBack:[{op:"maxHp",n:3}]}]},{id:"camp_prep",name:"야영 준비",frontText:"방어 +4, S +1",backText:"S +3",front:[{op:"block",n:4},{op:"supplies",n:1}],back:[{op:"supplies",n:3}],upgrades:[{frontText:"방어 +5, S +2",backText:"S +5",front:[{op:"block",n:5},{op:"supplies",n:2}],back:[{op:"supplies",n:5}]}]},{id:"vital_shot",name:"급소 사격",frontText:"선택한 적에게 8 피해",backText:"선택한 적에게 5 피해, 출혈 2 부여, S -1",front:[{op:"damageEnemy",target:"select",n:8}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:5},{op:"statusEnemy",target:"select",key:"bleed",n:2}],upgrades:[{frontText:"선택한 적에게 11 피해",backText:"선택한 적에게 6 피해, 출혈 3 부여, S -1",front:[{op:"damageEnemy",target:"select",n:11}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:6},{op:"statusEnemy",target:"select",key:"bleed",n:3}]}]},{id:"taunt",name:"독설",frontText:"선택한 적에게 약화 +4",backText:"모든 적에게 취약 +2 및 약화 +2",front:[{op:"statusEnemy",target:"select",key:"weak",n:4}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:2},{op:"statusEnemy",target:"all",key:"weak",n:2}],upgrades:[{frontText:"선택한 적에게 약화 +5",backText:"모든 적에게 취약 +2 및 약화 +3",front:[{op:"statusEnemy",target:"select",key:"weak",n:5}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:2},{op:"statusEnemy",target:"all",key:"weak",n:3}]}]},{id:"rapid_fire",name:"연속 사격",frontText:"선택한 적에게 2 피해, 3번 발동",backText:"이번 턴에 카드를 뽑았으면 무작위 적에게 8 피해",front:[{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2}],back:[{op:"ifDrewThisTurn",then:[{op:"damageEnemy",target:"random",n:8}]}],upgrades:[{frontText:"선택한 적에게 2 피해, 4번 발동",backText:"이번 턴에 카드를 뽑았으면 무작위 적에게 10 피해",front:[{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2}],back:[{op:"ifDrewThisTurn",then:[{op:"damageEnemy",target:"random",n:10}]}]}]},{id:"mad_echo",name:"메아리",frontText:"무작위 적에게 자신의 F 피해",backText:"드로우 1, S +2, F +1",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:1}],back:[{op:"draw",n:1},{op:"supplies",n:2},{op:"fatigue",n:1}],upgrades:[{frontText:"무작위 적에게 자신의 F의 2배, 피해",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:2}],backText:"드로우 2, S +2, F +1",back:[{op:"draw",n:2},{op:"supplies",n:2},{op:"fatigue",n:1}]}]},{id:"mad_insight",name:"금단의 통찰",exhaustWhen:"BOTH",frontText:"방어 +8, 드로우 1, F +1, 소모",backText:"드로우 3, S +2, F +2, 소모",front:[{op:"block",n:8},{op:"draw",n:1},{op:"fatigue",n:1}],back:[{op:"draw",n:3},{op:"supplies",n:2},{op:"fatigue",n:2}],upgrades:[{frontText:"방어 +10, 드로우 2, F +1, 소모",front:[{op:"block",n:10},{op:"draw",n:2},{op:"fatigue",n:1}],backText:"드로우 4, S +3, F +2, 소모",back:[{op:"draw",n:4},{op:"supplies",n:3},{op:"fatigue",n:2}]}]},{id:"mad_bargain",name:"거래의 잔재",exhaustWhen:"BOTH",frontText:"선택한 적에게 12 피해, S -1, F +1, 소모",backText:"HP +6, F +2, 소모",front:[{op:"damageEnemy",target:"select",n:12},{op:"supplies",n:-1},{op:"fatigue",n:1}],back:[{op:"heal",n:6},{op:"fatigue",n:2}],upgrades:[{frontText:"선택한 적에게 16 피해, S -1, F +1, 소모",front:[{op:"damageEnemy",target:"select",n:16},{op:"supplies",n:-1},{op:"fatigue",n:1}],backText:"HP +8, F +2, 소모",back:[{op:"heal",n:8},{op:"fatigue",n:2}]}]}],Wn=Object.fromEntries(Fn.map(e=>[e.id,e])),zn=[{id:"other_adventurer",name:"보물을 노리는 다른 모험가",maxHp:60,intents:[{label:"창 찌르기: 5 피해, 3번 발동",acts:[{op:"damagePlayer",n:5},{op:"damagePlayer",n:5},{op:"damagePlayer",n:5}]},{label:"독약 뿌리기: 출혈 +4, 취약 +4, 약화 +4 부여",acts:[{op:"statusPlayer",key:"bleed",n:4},{op:"statusPlayer",key:"vuln",n:4},{op:"statusPlayer",key:"weak",n:4}]}]},{id:"goblin_raider",name:"고블린 약탈자",maxHp:20,intents:[{label:"기습: 12 - 이번 턴에 사용한 카드의 수만큼 피해",acts:[{op:"damagePlayerFormula",kind:"goblin_raider"}]},{label:"훔치기: S -3",acts:[{op:"supplies",n:-3}]}]},{id:"watching_statue",name:"감시하는 석상",maxHp:25,intents:[{label:"감시: 4 + 이번 턴에 사용한 카드의 수만큼 피해",acts:[{op:"damagePlayerFormula",kind:"watching_statue"}]}]},{id:"pebble_golem",name:"조약돌 골렘",maxHp:30,intents:[{label:"조약돌 던지기: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"모래 모으기: 자신 HP 6 회복",acts:[{op:"enemyHealSelf",n:6}]}]},{id:"rock_golem",name:"바위 골렘",maxHp:50,intents:[{label:"바위 던지기: 9 피해",acts:[{op:"damagePlayer",n:9}]},{label:"땅 모으기: 자신 HP 10 회복",acts:[{op:"enemyHealSelf",n:10}]}]},{id:"slime",name:"슬라임",maxHp:30,intents:[{label:"유연한 몸: 다음 턴 동안 피해를 입지 않음",acts:[{op:"enemyImmuneNextTurn"}]},{label:"산성액: 약화 +3 부여 후 자신 HP 3 회복",acts:[{op:"statusPlayer",key:"weak",n:3},{op:"enemyHealSelf",n:3}]},{label:"때리기: 6 피해",acts:[{op:"damagePlayer",n:6}]}]},{id:"poison_spider",name:"독거미",maxHp:28,intents:[{label:"독니로 물기: 출혈 +4 부여",acts:[{op:"statusPlayer",key:"bleed",n:4}]},{label:"송곳니로 물기: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"단번에 물기: 출혈 +2 부여, 6 피해",acts:[{op:"statusPlayer",key:"bleed",n:2},{op:"damagePlayer",n:6}]}]},{id:"gravity_echo",name:"중력의 잔향",maxHp:26,intents:[{label:"하중 인장",acts:[{op:"damagePlayerByDeckSize",base:5,per:2,div:6,cap:18}]},{label:"압축: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"놓치게 만들기: S -3",acts:[{op:"supplies",n:-3}]}]},{id:"boss_gravity_master",name:"중력 통달자",omen:"몸이 점점 무겁다.",maxHp:70,intents:[{label:"중력 수축: 약화 +3 부여",acts:[{op:"statusPlayer",key:"weak",n:3}]},{label:"특이점 생성",acts:[{op:"damagePlayerByDeckSize",base:8,per:3,div:5,cap:30}]},{label:"천장 붕괴: 11 피해",acts:[{op:"damagePlayer",n:11}]}]},{id:"boss_cursed_wall",name:"저주받은 벽",omen:"움직이지 않는다. 당신이 닳아간다.",maxHp:120,intents:[{label:"저주의 기운: F +1",acts:[{op:"fatiguePlayer",n:1}]},{label:"아무 행동도 하지 않음",acts:[]}]},{id:"boss_giant_orc",name:"거대한 오크",omen:"거대한 무언가가 기다린다.",maxHp:80,intents:[{label:"내려치기: 15 피해",acts:[{op:"damagePlayer",n:15}]},{label:"단단한 피부: 다음 턴 동안 피해를 입지 않음",acts:[{op:"enemyImmuneNextTurn"}]},{label:"타고난 회복: 자신 HP 15 회복",acts:[{op:"enemyHealSelf",n:15}]}]},{id:"boss_soul_stealer",name:"영혼 강탈자",omen:"행동하지 않으면 종말이 오리라.",maxHp:60,intents:[{label:"허기: 7 피해, S -2",acts:[{op:"damagePlayer",n:7},{op:"supplies",n:-2}]},{label:"나태: 7 피해, F +1",acts:[{op:"damagePlayer",n:7},{op:"fatiguePlayer",n:1}]},{label:"예언: 카운트 진행",acts:[]}]}],Un=Object.fromEntries(zn.map(e=>[e.id,e]));function Vn(e,n){n<=0||(e.player.block+=n,f(e,`방어(블록) +${n} (현재 ${e.player.block})`))}function Kn(e,n){e.player.supplies=Ke(e.player.supplies+n,0),f(e,`보급 S ${n>=0?"+":""}${n} (현재 ${e.player.supplies})`)}function ne(e,n){e.player.fatigue=Ke(e.player.fatigue+n,0),f(e,`피로 F ${n>=0?"+":""}${n} (현재 ${e.player.fatigue})`)}function qn(e,n){if(n<=0)return;const t=e.player.hp;e.player.hp=Math.min(e.player.maxHp,e.player.hp+n),f(e,`HP +${e.player.hp-t} (현재 ${e.player.hp}/${e.player.maxHp})`)}function Te(e){F(e).length===0&&(e.pendingTarget=null,e.pendingTargetQueue=[],e.selectedEnemyIndex=null)}function hn(e,n){n<0||(e.fx??={},e.fx.enemyShake??=[],e.fx.enemyShake.push(n))}function jn(e){e.fx??={},e.fx.playerShake=!0}function ie(e,n,t){if(t<=0)return;const a=e.enemies.indexOf(n);if(a<0){f(e,`WARN: applyDamageToEnemy target not in g.enemies (${n?.id??"?"})`);return}if(e.attackedEnemyIndicesThisTurn.includes(a)||e.attackedEnemyIndicesThisTurn.push(a),n.immuneThisTurn){f(e,`적(${n.name})은(는) 이번 턴 피해 면역 → ${t} 피해 무시`),Te(e);return}const r=e.player.status.weak??0,o=n.status.vuln??0;let d=t-r+o;d<0&&(d=0),n.hp=Math.max(0,n.hp-d),d>0&&hn(e,a),f(e,`적(${n.name})에게 ${d} 피해. (HP ${n.hp}/${n.maxHp})`),Te(e)}function ee(e,n,t,a,r){if(t==="ENEMY_ATTACK"&&e.player.nullifyDamageThisTurn)return f(e,`적 공격 피해 무효 (${a??t})`),0;if(n<=0)return 0;let o=n;if(t==="ENEMY_ATTACK"){const d=r??0,l=e.player.status.vuln??0;if(o=o-d+l,o<0&&(o=0),e.player.block>0){const c=Math.min(e.player.block,o);e.player.block-=c,o-=c}}return o<=0?0:(e.player.hp=Math.max(0,e.player.hp-o),o>0&&jn(e),f(e,`플레이어 ${o} 피해 (${a??t}). (HP ${e.player.hp}/${e.player.maxHp})`),o)}function Ze(e,n){const t=e.game,a={kind:"damageSelect",amount:n,sourceCardUid:e.cardUid,reason:e.side==="front"?"FRONT":"BACK"};t.pendingTargetQueue??=[],t.pendingTarget==null?t.pendingTarget=a:t.pendingTargetQueue.push(a),f(t,`대상 선택 필요: 적을 클릭하세요. (${1+t.pendingTargetQueue.length}개 남음)`)}function Xn(e,n,t){const a=e.game,r={kind:"statusSelect",key:n,n:t,sourceCardUid:e.cardUid,reason:e.side==="front"?"FRONT":"BACK"};a.pendingTargetQueue??=[],a.pendingTarget==null?a.pendingTarget=r:a.pendingTargetQueue.push(r),(a.pendingTarget?1:0)+a.pendingTargetQueue.length,f(a,"대상 선택 필요: 적을 클릭하세요.")}function Yn(e,n){if(n.id==="boss_soul_stealer"&&n.soulWillNukeThisTurn)return!0;const t=e.content.enemiesById[n.id];return t.intents[n.intentIndex%t.intents.length].acts.some(r=>r.op==="damagePlayer"||r.op==="damagePlayerFormula")}function ue(e,n){const t=e.game;for(const a of n)switch(a.op){case"block":Vn(t,a.n);break;case"supplies":Kn(t,a.n);break;case"fatigue":ne(t,a.n);break;case"heal":qn(t,a.n);break;case"hp":t.player.hp=Math.max(0,Math.min(t.player.maxHp,t.player.hp+a.n)),f(t,`HP ${a.n>=0?"+":""}${a.n} (현재 ${t.player.hp}/${t.player.maxHp})`);break;case"maxHp":t.player.maxHp+=a.n,t.player.hp=Math.min(t.player.maxHp,t.player.hp+a.n),f(t,`최대 HP +${a.n} (현재 ${t.player.hp}/${t.player.maxHp})`);break;case"setSupplies":t.player.supplies=Math.max(0,a.n),f(t,`보급 S를 ${t.player.supplies}으로 설정`);break;case"draw":{const r=Xe(t,a.n);t.drawCountThisTurn+=r;break}case"ifDrewThisTurn":{t.drawCountThisTurn>0&&ue(e,a.then);break}case"damageEnemy":if(a.target==="random"){const r=F(t);if(r.length===0)break;ie(t,R(r),a.n)}else if(a.target==="all")for(const r of F(t))ie(t,r,a.n);else Ze(e,a.n);break;case"clearStatusSelf":{const r=a.key;t.player.status[r]=0,f(t,`상태 해제: ${r} = 0`);break}case"damageEnemyBy":{if(a.target!=="random")break;const r=F(t);if(r.length===0)break;let o=0;a.by==="frontCount"&&(o=t.frontSlots.filter(Boolean).length*a.nPer),ie(t,R(r),o);break}case"damageEnemyByPlayerFatigue":{const r=Math.max(0,t.player.fatigue*a.mult);if(a.target==="random"){const o=F(t);if(o.length===0)break;ie(t,R(o),r);break}if(a.target==="select"){if(r<=0)break;Ze(e,r);break}break}case"statusPlayer":t.player.status[a.key]=Math.max(0,(t.player.status[a.key]??0)+a.n),f(t,`플레이어 상태: ${a.key} ${a.n>=0?"+":""}${a.n}`);break;case"statusEnemy":if(a.target==="random"){const r=F(t);if(r.length===0)break;const o=R(r);ye(o,a.key,a.n),f(t,`적(${o.name}) 상태: ${a.key} ${a.n>=0?"+":""}${a.n}`)}else if(a.target==="all"){const r=F(t);if(r.length===0)break;for(const o of r)ye(o,a.key,a.n);f(t,`모든 적 상태: ${a.key} ${a.n>=0?"+":""}${a.n}`)}else Xn(e,a.key,a.n);break;case"statusEnemiesAttackingThisTurn":{const r=F(t).filter(o=>Yn(t,o));if(r.length===0){f(t,`이번 턴 공격 의도 적 없음 → ${a.key} 적용 없음`);break}for(const o of r)o.status[a.key]=Math.max(0,(o.status[a.key]??0)+a.n);f(t,`공격 의도 적에게 ${a.key} ${a.n>=0?"+":""}${a.n} (대상 ${r.length})`);break}case"immuneDisruptThisTurn":t.player.immuneToDisruptThisTurn=!0,f(t,"이번 턴 교란 무시");break;case"nullifyDamageThisTurn":t.player.nullifyDamageThisTurn=!0,f(t,"이번 턴 적 공격 피해 무효");break;case"triggerFrontOfBackSlot":{const r=t.backSlots[a.index];if(!r){f(t,`재배치: 후열 ${a.index+1}번 슬롯이 비어 있음`);break}const o=J(t,r);f(t,`재배치: [[${ae(t,r)}]]의 전열 효과를 추가 발동`),ue({game:t,side:"front",cardUid:r},o.front);break}default:return a}}function xe(e,n=10,t=16){const a=Math.max(0,e-t),r=Math.ceil(Math.sqrt(a));return n+r}function _e(e,n){const t=e.content.enemiesById[n];return{id:t.id,name:t.name,hp:t.maxHp,maxHp:t.maxHp,intentIndex:0,status:{vuln:0,weak:0,bleed:0,disrupt:0},immuneThisTurn:!1,immuneNextTurn:!1,lastIntentKey:null,lastIntentStreak:0,soulWarnCount:n==="boss_soul_stealer"?0:void 0,soulArmed:n==="boss_soul_stealer"?!1:void 0,soulWillNukeThisTurn:n==="boss_soul_stealer"?!1:void 0}}function Qn(e,n,t,a=5){for(const r of n){const o=e.run.enemyLastSeenBattle[r];if(o!=null&&t-o<a)return!1}return!0}function re(e,n){const t=n?.forceBoss??!1,a=e.run.nodePickCount,r=e.run.battleCount+1;if(n?.forcePatternIds&&n.forcePatternIds.length>0){const E=n.forcePatternIds;e.run.battleCount=r;for(const i of E)e.run.enemyLastSeenBattle[i]=r;e.enemies=E.map(i=>_e(e,i)),f(e,`전투 시작! (노드 ${a}, 전투 ${r}회차) 적: ${e.enemies.map(i=>i.name).join(", ")}`);return}if(t)if(e.run.bossPool.length===0&&!e.run.nextBossId)f(e,`보스 풀이 비었습니다. 일반 전투로 진행합니다. (노드 ${a})`);else{let E=e.run.nextBossId??null;if(E!=null){const i=e.content.enemiesById[E];e.run.bossOmenText=Cn[E]??i.omen??null}E?(e.run.nextBossId=null,e.run.bossPool=e.run.bossPool.filter(i=>i!==E)):(E=R(e.run.bossPool),e.run.bossPool=e.run.bossPool.filter(i=>i!==E)),e.enemies=[_e(e,E)],f(e,`보스 등장! (노드 ${a}) 적: ${e.enemies[0].name}`);return}const o=[[["goblin_raider"],["watching_statue"],["pebble_golem"],["slime"]],[["goblin_raider","slime"],["pebble_golem","pebble_golem"],["rock_golem"],["goblin_raider","goblin_raider"],["poison_spider"]],[["goblin_raider","goblin_raider","goblin_raider"],["pebble_golem","pebble_golem","slime"],["rock_golem","pebble_golem"],["slime","slime"],["poison_spider","slime"],["gravity_echo"]]],d=[["gravity_echo","poison_spider"],["poison_spider","slime"],["watching_statue","slime"],["watching_statue","watching_statue"],["poison_spider","poison_spider"],["rock_golem","gravity_echo"],["goblin_raider","goblin_raider","watching_statue"]],l=(e.run.nodePickCount??0)+(e.time??0),c=Math.min(o.length-1,Math.floor(Math.max(0,l)/10)),h=e.run.treasureObtained?d:o[c],b=5,p=h.filter(E=>Qn(e,E,r,b)),u=p.length>0?p:h,k=R(u);e.run.battleCount=r;for(const E of k)e.run.enemyLastSeenBattle[E]=r;e.enemies=k.map(E=>_e(e,E)),f(e,`전투 시작! (노드 ${a}, 전투 ${r}회차) 적: ${e.enemies.map(E=>E.name).join(", ")}`)}function oe(e){e.player.block=0,e.player.status.vuln=0,e.player.status.weak=0,e.player.status.bleed=0,e.player.status.disrupt=0,e.player.zeroSupplyTurns=0,e.phase="REVEAL",e.frontSlots=[null,null,null],e.backSlots=[null,null,null],e.backSlotDisabled=[!1,!1,!1],e.backUidsThisTurn=[],e.hand=[],e.selectedHandCardUid=null,e.pendingTarget=null,e.pendingTargetQueue=[],e.usedThisTurn=0,e.winHooksAppliedThisCombat=!1;const n=e.run.nextBattleSuppliesBonus??0;e.player.supplies=7+n,n!==0&&(f(e,`다음 전투 보너스 적용: S +${n}`),e.run.nextBattleSuppliesBonus=0),e.player.immuneToDisruptThisTurn=!1,e.player.nullifyDamageThisTurn=!1,e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null,e.drawCountThisTurn=0,e.attackedEnemyIndicesThisTurn=[],e.frontPlacedThisTurn=0,e.usedThisTurn=0,Xe(e,4),je(e),e.phase="PLACE",e.victoryResolvedThisCombat=!1}function Gn(e){return e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length}function Jn(e,n){const t=Math.ceil(n/e.div);let a=e.base+e.per*t;return e.cap!=null&&(a=Math.min(a,e.cap)),{dmg:a,scale:t}}const Zn={other_adventurer:new Set([1]),slime:new Set([0,1]),poison_spider:new Set([0,2]),boss_cursed_wall:new Set([0]),boss_giant_orc:new Set([1])};function et(e,n){const t=Zn[e];return!!t&&t.has(n)}function Ne(e){if(e===null)return"null";const n=typeof e;return n==="number"||n==="boolean"?String(e):n==="string"?JSON.stringify(e):Array.isArray(e)?"["+e.map(Ne).join(",")+"]":n==="object"?"{"+Object.keys(e).sort().map(a=>JSON.stringify(a)+":"+Ne(e[a])).join(",")+"}":JSON.stringify(String(e))}function mn(e){if(!e)return"NONE";const n={};for(const t of Object.keys(e))t==="label"||t==="text"||t==="desc"||t==="name"||(n[t]=e[t]);return n.effects&&Array.isArray(n.effects)&&(n.effects=n.effects.map(t=>{const a={};for(const r of Object.keys(t??{}))r==="label"||r==="text"||r==="desc"||r==="name"||(a[r]=t[r]);return a})),Ne(n)}function nt(e,n){const t=e.lastIntentKey??null,a=e.lastIntentStreak??0;t===n?e.lastIntentStreak=Math.min(3,a+1):(e.lastIntentKey=n,e.lastIntentStreak=1)}function tt(e,n,t,a,r){const o=e.length;if(o<=1)return 0;const d=Array.from({length:o},(u,k)=>k),l=u=>u===n&&et(t,u),c=u=>!!a&&r>=2&&mn(e[u])===a,h=d.filter(u=>!l(u)&&!c(u));if(h.length>0)return R(h);const b=d.filter(u=>!c(u));if(b.length>0)return R(b);const p=d.filter(u=>!l(u));return p.length>0?R(p):R(d)}const at=2,rt=.6;function je(e){if(e.intentsRevealedThisTurn)return;e.intentsRevealedThisTurn=!0,e.attackedEnemyIndicesThisTurn=[],e.backUidsThisTurn=[],e.drawCountThisTurn=0,e.phase="REVEAL",e.player.immuneToDisruptThisTurn=!1,e.player.nullifyDamageThisTurn=!1,e.disruptIndexThisTurn=null,e.backSlotDisabled=[!1,!1,!1],(e.player.status.disrupt??0)>0&&(e.disruptIndexThisTurn=Math.floor(Math.random()*3),e.backSlotDisabled[e.disruptIndexThisTurn]=!0);for(const t of e.enemies)t.immuneThisTurn=t.immuneNextTurn,t.immuneNextTurn=!1;for(const t of F(e)){t.intentLabelOverride=void 0;const r=e.content.enemiesById[t.id].intents;if(!r||r.length===0)continue;const o=tt(r,t.intentIndex??0,t.id,t.lastIntentKey??null,t.lastIntentStreak??0);t.intentIndex=o;const d=r[o%r.length];if(nt(t,mn(d)),t.id==="boss_soul_stealer"){t.soulWillNukeThisTurn=!1;const b=t.soulWarnCount??0;if(!!t.soulArmed){if(Math.random()<rt){t.soulWillNukeThisTurn=!0,t.intentLabelOverride="종말: 50 피해",f(e,`적 의도: ${t.name} → ${t.intentLabelOverride}`);continue}const k=r[t.intentIndex%r.length];t.intentLabelOverride=`${k.label} (⚠ 폭발 가능 상태)`,f(e,`적 의도: ${t.name} → ${t.intentLabelOverride}`);continue}const u=r[t.intentIndex%r.length];t.intentLabelOverride=`${u.label} (경고 ${b}/3)`,f(e,`적 의도: ${t.name} → ${t.intentLabelOverride}`);continue}const l=r[t.intentIndex%r.length];let c=l.label;const h=l.acts.find(b=>b.op==="damagePlayerByDeckSize");if(h&&h.op==="damagePlayerByDeckSize"){const b=Gn(e),{dmg:p}=Jn(h,b),u=h.cap!=null?` (최대 ${h.cap})`:"";c=`${l.label.split(":")[0].trim()}: ${p} 피해${u}`}t.intentLabelOverride=c,f(e,`적 의도: ${t.name} → ${c}`)}e.disruptIndexThisTurn!==null&&f(e,`교란: 이번 턴 후열 ${e.disruptIndexThisTurn} 무효`),e.phase="PLACE"}function en(e,n,t,a){if(e.phase!=="PLACE"||!e.hand.includes(n))return;t==="back"&&(e.backUidsThisTurn.includes(n)||e.backUidsThisTurn.push(n));const r=t==="front"?e.frontSlots:e.backSlots;r[a]||(e.hand=e.hand.filter(o=>o!==n),r[a]=n,e.cards[n].zone=t,e.usedThisTurn+=1,f(e,`[${ae(e,n)}]를 ${t==="front"?"전열":"후열"} ${a}번에 배치`),t==="front"&&(e.frontPlacedThisTurn+=1))}function nn(e,n,t){return J(e,n).tags?.includes(t)??!1}function ot(e,n){e.frontSlots=e.frontSlots.map(t=>t===n?null:t),e.backSlots=e.backSlots.map(t=>t===n?null:t)}function tn(e,n,t){const a=J(e,n);ot(e,n),e.hand=e.hand.filter(c=>c!==n),e.deck=e.deck.filter(c=>c!==n),e.discard=e.discard.filter(c=>c!==n);const r=a.vanishWhen,o=a.exhaustWhen,d=r==="BOTH"||r==="FRONT"&&t==="front"||r==="BACK"&&t==="back",l=o==="BOTH"||o==="FRONT"&&t==="front"||o==="BACK"&&t==="back";if(r&&r!=="NONE"&&d){e.vanished.push(n),e.cards[n].zone="vanished",f(e,`[${ae(e,n)}] 소실(영구 제거)`);return}if(o&&o!=="NONE"&&l){e.exhausted.push(n),e.cards[n].zone="exhausted",f(e,`[${ae(e,n)}] 소모(이번 전투에서 제거)`);return}if(!r&&nn(e,n,"VANISH")){e.vanished.push(n),e.cards[n].zone="vanished",f(e,`[${ae(e,n)}] 소실(영구 제거)`);return}if(!o&&nn(e,n,"EXHAUST")){e.exhausted.push(n),e.cards[n].zone="exhausted",f(e,`[${ae(e,n)}] 소모(이번 전투에서 제거)`);return}e.discard.push(n),e.cards[n].zone="discard"}function st(e){for(let n=0;n<3;n++){const t=e.frontSlots[n];t&&tn(e,t,"front"),e.frontSlots[n]=null;const a=e.backSlots[n];a&&tn(e,a,"back"),e.backSlots[n]=null}}function it(e){if(!(e.phase!=="PLACE"&&e.phase!=="BACK")){e.phase="BACK",f(e,"=== 후열 단계 ===");for(let n=0;n<3;n++){const t=e.backSlots[n];if(!t)continue;const a=J(e,t);if(!e.player.immuneToDisruptThisTurn&&e.backSlotDisabled[n]){f(e,`후열 ${n}번 [${a.name}] 교란으로 무효`);continue}ue({game:e,side:"back",cardUid:t},a.back)}e.phase="FRONT"}}function lt(e){if(e.phase==="FRONT"){f(e,"=== 전열 단계 ===");for(let n=0;n<3;n++){const t=e.frontSlots[n];if(!t)continue;const a=J(e,t);ue({game:e,side:"front",cardUid:t},a.front)}e.phase="ENEMY"}}function dt(e){if(e.phase==="ENEMY"){f(e,"=== 적 행동 ===");for(const n of F(e)){const t=e.content.enemiesById[n.id],a=t.intents[n.intentIndex%t.intents.length];if(n.id==="boss_soul_stealer"){if(n.soulWillNukeThisTurn){const r=n.status.weak??0;ee(e,50,"ENEMY_ATTACK","영혼 강탈자",r),f(e,"영혼 강탈자: 영혼 폭발 → 50 피해!"),n.soulWillNukeThisTurn=!1,n.soulArmed=!1,n.soulWarnCount=0;continue}for(const r of a.acts)an(e,n,r);n.intentIndex===at&&(n.soulWarnCount=(n.soulWarnCount??0)+1,f(e,`영혼 강탈자: 경고 +1 (${n.soulWarnCount}/3)`),(n.soulWarnCount??0)>=3&&(n.soulArmed=!0,f(e,"영혼 강탈자: 경고 3회 완료 → 폭발 가능 상태!")));continue}for(const r of a.acts)an(e,n,r)}e.phase="UPKEEP"}}function an(e,n,t){switch(t.op){case"damagePlayer":{const a=n.status.weak??0;ee(e,t.n,"ENEMY_ATTACK",n.name,a);return}case"damagePlayerFormula":{if(t.kind==="goblin_raider"){const a=Math.max(0,12-e.usedThisTurn),r=n.status.weak??0;ee(e,a,"ENEMY_ATTACK",n.name,r)}else{const a=4+e.usedThisTurn,r=n.status.weak??0;ee(e,a,"ENEMY_ATTACK",n.name,r)}return}case"supplies":{e.player.supplies=Ke(e.player.supplies+t.n,0),f(e,`적 효과: 보급 S ${t.n>=0?"+":""}${t.n} (현재 ${e.player.supplies})`);return}case"statusPlayer":{ye(e.player,t.key,t.n),f(e,`적 효과: 플레이어 상태 ${t.key} ${t.n>=0?"+":""}${t.n}`);return}case"enemyHealSelf":{n.hp=Math.min(n.maxHp,n.hp+t.n),f(e,`적(${n.name})이(가) ${t.n} 회복 (HP ${n.hp}/${n.maxHp})`);return}case"enemyImmuneThisTurn":{n.immuneThisTurn=!0,f(e,`적(${n.name})이(가) 피해 면역 상태가 됨`);return}case"enemyImmuneNextTurn":{n.immuneNextTurn=!0,f(e,`적(${n.name})이(가) 다음 턴 피해 면역 상태가 됨`);return}case"fatiguePlayer":{e.player.fatigue=Math.max(0,e.player.fatigue+t.n),f(e,`적 효과: 피로 F ${t.n>=0?"+":""}${t.n} (현재 ${e.player.fatigue})`);return}case"damagePlayerByDeckSize":{const a=e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length,r=Math.ceil(a/t.div);let o=t.base+t.per*r;t.cap!=null&&(o=Math.min(o,t.cap)),ee(e,o,"ENEMY_ATTACK",n.name),f(e,`중력 피해: base ${t.base} + per ${t.per} * ceil(${a}/${t.div})=${r} => ${o}`);return}default:return t}}function ct(e){if(e.phase!=="UPKEEP")return;f(e,"=== 유지비 / 상태 처리 ===");const n=e.frontPlacedThisTurn;n>0&&f(e,`전열 유지비 처리: 전열 ${n}장`);let t=!1;for(let r=0;r<n;r++)e.player.supplies>0?e.player.supplies-=1:t=!0;if(t&&(e.player.fatigue+=1,f(e,"전열 유지비 부족! (F +1)")),e.player.supplies===0){e.player.zeroSupplyTurns+=1;const r=e.player.fatigue;ee(e,r,"ZERO_SUPPLY",`보급 없이 턴 종료! 피해 ${r}`)}const a=e.player.status.bleed??0;a>0&&ee(e,a,"BLEED","출혈");for(const r of F(e)){const o=r.status.bleed??0;if(o>0)if(r.immuneThisTurn)f(e,`적(${r.name})은(는) 이번 턴 면역이라 출혈 피해 무시`);else{r.hp=Math.max(0,r.hp-o);const d=e.enemies.indexOf(r);d>=0&&hn(e,d),f(e,`적(${r.name}) 출혈로 HP -${o} (HP ${r.hp}/${r.maxHp})`)}}e.frontPlacedThisTurn=0,ut(e),st(e),Te(e),ke(e),e.phase="DRAW"}function ut(e){const n=["vuln","weak","bleed","disrupt"];for(const t of n)e.player.status[t]>0&&(e.player.status[t]-=1);for(const t of e.enemies)for(const a of n)t.status[a]>0&&(t.status[a]-=1)}function pt(e){if(e.phase!=="DRAW"||(e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null,ke(e),e.run.finished))return;if(F(e).length===0){Oe(e),e.phase="NODE";return}const n=e.usedThisTurn;e.usedThisTurn=0,Xe(e,n),e.player.block>0&&(e.player.block=0,f(e,"방어(블록) 소실")),je(e)}function Xe(e,n){let t=0;for(let a=0;a<n&&(ft(e),!e.run.finished);a++){const r=e.deck.pop();if(!r)break;e.hand.push(r),t++}return f(e,`드로우 ${t}/${n} (손패 ${e.hand.length})`),t}function ft(e){e.deck.length===0&&e.discard.length>0&&(e.deck=qe(e.discard),e.discard=[],e.player.fatigue+=1,f(e,`피로도 F +1 (셔플, 현재 ${e.player.fatigue})`))}function N(e){return e.pendingTarget!=null||(e.pendingTargetQueue?.length??0)>0}function ht(e,n){if(!e.pendingTarget)return!1;if(F(e).length===0)return e.pendingTarget=null,e.pendingTargetQueue=[],e.selectedEnemyIndex=null,ke(e),!0;const t=e.enemies[n];if(!t||t.hp<=0)return!1;const a=e.pendingTarget;return a.kind==="damageSelect"?ie(e,t,a.amount):a.kind==="statusSelect"&&(ye(t,a.key,a.n),f(e,`적(${t.name}) 상태: ${a.key} ${a.n>=0?"+":""}${a.n}`)),Te(e),ke(e),F(e).length===0?!0:(mt(e),!e.pendingTarget&&(e.pendingTargetQueue?.length??0)===0)}function mt(e){const n=e.pendingTargetQueue??[],t=n.shift()??null;e.pendingTarget=t,e.pendingTargetQueue=n,e.selectedEnemyIndex=null}function Oe(e){e.player.block>0&&(e.player.block=0,f(e,"방어(블록) 소실")),e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null}function bt(e){const n=e.run.deckSizeAtTreasure??null;return n==null?10:xe(n)}function ke(e){if(e.player.hp<=0){Oe(e),e.run.finished=!0,f(e,"패배: 죽었습니다.");return}if(!e.victoryResolvedThisCombat&&F(e).length===0&&e.phase!=="NODE"){if(e.victoryResolvedThisCombat=!0,Oe(e),xt(e),f(e,"적을 모두 처치!"),yt(e),e.enemies=[],e.player.zeroSupplyTurns=0,e.phase="NODE",e.run.treasureObtained){const l=bt(e);if(e.run.afterTreasureNodePicks>=l){e.run.finished=!0,f(e,`승리! 저주받은 보물을 얻은 후 ${l}턴 동안 살아남았습니다.`);return}}const[n,t]=gt(e),a=G(e.content,n.defId,n.upgrade),r=G(e.content,t.defId,t.upgrade),o=n.upgrade>0?`${a.name} +${n.upgrade}`:a.name,d=t.upgrade>0?`${r.name} +${t.upgrade}`:r.name;e.choice={kind:"REWARD",title:"전투 보상",prompt:"두 장 중 한 장을 선택하거나 생략합니다.",options:[{key:`pick:${n.defId}:${n.upgrade}`,label:o,detail:`전열: ${a.frontText} / 후열: ${a.backText}`},{key:`pick:${t.defId}:${t.upgrade}`,label:d,detail:`전열: ${r.frontText} / 후열: ${r.backText}`},{key:"skip",label:"생략"}]};return}}function yt(e){const n=[];for(const o of e.deck)n.push(o);for(const o of e.hand)n.push(o);for(const o of e.discard)n.push(o);for(const o of e.frontSlots)o&&n.push(o);for(const o of e.backSlots)o&&n.push(o);for(const o of e.exhausted)n.push(o);const t=new Set,r=n.filter(o=>t.has(o)?!1:(t.add(o),!0)).filter(o=>e.cards[o]?.zone!=="vanished");e.deck=r;for(const o of r)e.cards[o].zone="deck";e.hand=[],e.discard=[],e.frontSlots=[null,null,null],e.backSlots=[null,null,null],e.selectedHandCardUid=null,e.exhausted=[],e.pendingTarget=null,e.pendingTargetQueue=[],Tt(e.deck)}function Tt(e){for(let n=e.length-1;n>0;n--){const t=Math.floor(Math.random()*(n+1));[e[n],e[t]]=[e[t],e[n]]}}function xt(e){if(!e.winHooksAppliedThisCombat){e.winHooksAppliedThisCombat=!0;for(const n of e.backUidsThisTurn){if(!e.cards[n])continue;const r=J(e,n).onWinWhileInBack;!r||r.length===0||ue({game:e,side:"back",cardUid:n},r)}}}function we(e){return e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length}function kt(e){if(e.run.treasureObtained)return;e.run.treasureObtained=!0,e.run.afterTreasureNodePicks=0,e.run.deckSizeAtTreasure=we(e);const n=xn(e);e.cards[n]={uid:n,defId:"goal_treasure",zone:"deck",upgrade:0},e.deck.push(n),e.deck=qe(e.deck),f(e,"저주받은 보물을 획득했습니다! 덱에 [저주받은 보물] 추가")}const Ct=["arrow","shield","scout","field_ration","maintenance","power_arrow"],St=["arrow","shield","scout","field_ration"],le=[{id:"mad_echo",weight:20},{id:"mad_insight",weight:12},{id:"mad_bargain",weight:3}],se=[{id:"berserk",weight:20},{id:"bandage",weight:12},{id:"arrow_rain",weight:20},{id:"smoke",weight:0},{id:"redeploy",weight:12},{id:"secret_strike",weight:3},{id:"fire_scroll",weight:3},{id:"caltrops",weight:20},{id:"emergency_rations",weight:3},{id:"painkiller",weight:12},{id:"field_experience",weight:3},{id:"camp_prep",weight:12},{id:"vital_shot",weight:20},{id:"taunt",weight:12},{id:"rapid_fire",weight:12}];function he(e,n,t){const a=t?yn(n,t):bn(n);return{defId:Re(a),upgrade:n===le?0:Le(e)}}function me(e,n,t){const a=t?yn(n,t):bn(n),r=Re(a),o=a.filter(b=>b.id!==r),d=Re(o),l=n===le,c=l?0:Le(e),h=l?0:Le(e);return[{defId:r,upgrade:c},{defId:d,upgrade:h}]}function Et(e){const{tier:n}=ge(e);return Math.random()<(n===0?0:n===1?.15:n===2?.35:.6)}function bn(e){const n=new Map;for(const t of e){const a=Math.max(0,t.weight??0);a<=0||n.set(t.id,(n.get(t.id)??0)+a)}return[...n.entries()].map(([t,a])=>({id:t,w:a}))}function yn(e,n={}){const t=n.mult3??1,a=n.mult12??1,r=n.mult20??1,o=new Map;for(const d of e){const l=Math.max(0,d.weight??0);if(l<=0||l===3&&n.drop3||l===12&&n.drop12||l===20&&n.drop20)continue;let c=null;l===3?c=l*t:l===12?c=l*a:l===20?c=l*r:c=l,!(c<=0)&&o.set(d.id,(o.get(d.id)??0)+c)}return[...o.entries()].map(([d,l])=>({id:d,w:l}))}function Re(e){let n=0;for(const a of e)n+=a.w;if(n<=0)throw new Error("No positive weights to pick from.");let t=Math.random()*n;for(const a of e)if(t-=a.w,t<=0)return a.id;return e[e.length-1].id}function Le(e){const n=e?.player?.fatigue??0;if((e?.run.nodePickCount??999)<=6)return 0;const a=.1,r=n>=12?0:n>=9?.25:n>=6?.5:1;return Math.random()<a*r?1:0}function Tn(e){const n=e.player?.fatigue??0,t={defId:R(St),upgrade:0};R(Ct);const a=()=>n<=3?me(e,se):n<=6?me(e,se,{mult3:.25,mult12:.75,mult20:1}):n<=8?me(e,se,{mult3:.1,mult12:.55,mult20:1}):me(e,se,{drop3:!0,mult12:.45,mult20:1}),r=l=>Et(e)?he(e,le):l;if(n<=8){if(n<=6){const[b,p]=a();return[r(b),r(p)]}const l=n===7?.3:.55;if(Math.random()<l){const[b]=a(),p=r(b);return Math.random()<.5?[t,p]:[p,t]}const[c,h]=a();return[r(c),r(h)]}if(n<=11){const l=r(he(e,se,{drop3:!0,mult12:.45,mult20:1}));return Math.random()<.5?[t,l]:[l,t]}const o=he(e,le),d=Math.random()<.65?he(e,le):t;return Math.random()<.5?[o,d]:[d,o]}function gt(e){const n=Tn(e),t=n[0]??{defId:"arrow",upgrade:0},a=n[1]??{defId:"shield",upgrade:0};return[t,a]}function xn(e){return e.uidSeq+=1,`c_${e.uidSeq}`}function He(e,n,t){const a=xn(e);e.cards[a]={uid:a,defId:n,zone:"deck",upgrade:t?.upgrade??0},e.deck.push(a)}function wt(e){const n=Object.values(e.cards).filter(a=>a.zone==="deck"||a.zone==="hand"||a.zone==="discard");if(n.length===0)return;const t=R(n);e.cards[t.uid].zone="vanished",e.vanished.push(t.uid),e.deck=e.deck.filter(a=>a!==t.uid),e.hand=e.hand.filter(a=>a!==t.uid),e.discard=e.discard.filter(a=>a!==t.uid),f(e,`카드 제거: [${J(e,t.uid).name} +${e.cards[t.uid].upgrade??0}]`)}const Pt="goal_treasure";function vt(e,n){const t=e.cards[n];if(t){if(t.defId===Pt){f(e,"저주받은 보물은 덱에서 제거할 수 없습니다.");return}e.deck=e.deck.filter(a=>a!==n),e.hand=e.hand.filter(a=>a!==n),e.discard=e.discard.filter(a=>a!==n),e.frontSlots=e.frontSlots.map(a=>a===n?null:a),e.backSlots=e.backSlots.map(a=>a===n?null:a),t.zone="vanished",e.vanished.push(n),f(e,`카드 제거: [${J(e,t.uid).name} +${e.cards[t.uid].upgrade??0}]`)}}function kn(e,n){const t=e.cards[n];if(!t)return!1;const r=e.content.cardsById[t.defId].upgrades?.length??0;return(t.upgrade??0)<r}function $t(e,n){return kn(e,n)?(e.cards[n].upgrade=(e.cards[n].upgrade??0)+1,!0):!1}function Bt(){return Me[Math.floor(Math.random()*Me.length)]}function rn(e){const{tier:n}=ge(e),t=n===0?0:n===1?.25:n===2?.55:.85;return Math.random()<t?At():Bt()}const Cn={boss_cursed_wall:"움직이지 않는다. 당신이 닳아간다.",boss_giant_orc:"거대한 무언가가 기다린다.",boss_soul_stealer:"행동하지 않으면 종말이 온다.",boss_gravity_master:"몸이 점점 무겁다. 몸을 가볍게 하라."},on=[{id:"mad_mirror",name:"거울에 잠긴 물",prompt:"물 속의 당신이 먼저 웃습니다.",options:e=>[{key:"mad_mirror:take",label:"손을 넣는다",detail:"카드 보상. F +2.",apply:n=>(ne(n,2),f(n,"거울: 무언가를 건져 올렸다. (F +2)"),"REWARD")},{key:"mad_mirror:leave",label:"외면한다",apply:n=>(f(n,"거울: 당신은 물러났다."),"NONE")}]},{id:"mad_contract",name:"젖은 계약서",prompt:"곰팡이 냄새가 납니다.",options:e=>[{key:"mad_contract:sign",label:"서명한다",detail:"최대 HP +2. 카드 1장 제거 후 보상.",apply:n=>(n.player.maxHp+=2,n.player.hp=Math.min(n.player.maxHp,n.player.hp+2),f(n,"계약: 최대 HP +2"),{kind:"REMOVE_PICK",title:"대가",prompt:"제거할 카드 1장을 선택하세요.",then:"REWARD"})},{key:"mad_contract:burn",label:"찢어버린다",detail:"F +1",apply:n=>(ne(n,1),f(n,"불길함: F +1"),"NONE")}]},{id:"mad_lullaby",name:"심해의 자장가",prompt:"잠들면 회복하지만, 깨어나면 잊습니다.",options:e=>[{key:"mad_lullaby:sleep",label:"잠든다",detail:"HP +12. 덱에서 무작위 1장 소실.",apply:n=>(n.player.hp=Math.min(n.player.maxHp,n.player.hp+12),wt(n),f(n,"자장가: HP 회복, 그러나 잊었다… (무작위 1장 소실)"),"NONE")},{key:"mad_lullaby:stay",label:"버틴다",detail:"F -1",apply:n=>(ne(n,-1),f(n,"버팀: F -1"),"NONE")}]}];function At(e){return on[Math.floor(Math.random()*on.length)]}const Me=[{id:"drop_bag",name:"짐 버리기",prompt:"짐을 줄여 피로를 낮추자.",options:()=>[{key:"drop",label:"카드 1장 제거, F -1",apply:e=>(ne(e,-1),f(e,"이벤트: 짐 버리기 → 제거할 카드를 선택하세요."),{kind:"REMOVE_PICK",title:"짐 버리기",prompt:"제거할 카드 1장을 선택하세요.",then:"NONE"})},{key:"skip",label:"아무것도 하지 않는다",apply:e=>(f(e,"이벤트: 짐 버리기(생략)"),"NONE")}]},{id:"hide_from_monster",name:"몬스터로부터 숨기",prompt:"전투하거나, 대가를 치르고 숨을 수 있다.",options:()=>[{key:"fight",label:"전투",apply:e=>(f(e,"이벤트: 몬스터로부터 숨기 → 전투 선택"),"BATTLE")},{key:"remove_and_fatigue",label:"카드 1장 제거 후 F +1",apply:e=>(ne(e,1),f(e,"이벤트: 몬스터로부터 숨기 → 카드 제거 후 F+1"),{kind:"REMOVE_PICK",title:"숨기",prompt:"제거할 카드 1장을 선택하세요.",then:"NONE"})}]},{id:"goblin_ambush_low_supplies",name:"매복한 약탈자들",prompt:`고블린들이 보급을 약탈했다.
이번 전투는 보급(S) 5로 시작합니다.`,options:()=>[{key:"fight",label:"맞서 싸운다",detail:"고블린 약탈자 2마리 전투 (S=5 시작)",apply:e=>(e.run.nextBattleSuppliesBonus=-5,{kind:"BATTLE_SPECIAL",title:"고블린 매복",enemyIds:["goblin_raider","goblin_raider"]})}]},{id:"find_adventurer",name:"다른 모험가 발견",prompt:"거래한다.",options:e=>e.run.treasureObtained?[{key:"adventurer:forced_battle",label:"대치한다",detail:"보물을 노리고 덤벼든다.",apply:n=>({kind:"BATTLE_SPECIAL",enemyIds:["other_adventurer"],title:"보물을 노리는 모험가"})}]:[{key:"trade",label:"카드 1장 제거 후 카드 보상(2장 중 1장)",apply:n=>(f(n,"이벤트: 다른 모험가 발견 → 제거할 카드 선택 후 보상"),{kind:"REMOVE_PICK",title:"다른 모험가 발견",prompt:"제거할 카드 1장을 선택하세요.",then:"REWARD"})},{key:"leave",label:"지나친다",apply:n=>(f(n,"이벤트: 다른 모험가 발견(생략)"),"NONE")}]},{id:"edible_mushroom",name:"식용 버섯 발견",prompt:"기운이 난다. 다음 전투의 시작 보급이 늘어난다.",options:()=>[{key:"eat",label:"F -2, 다음 전투 시작 S +5",apply:e=>(e.player.fatigue=Math.max(0,e.player.fatigue-2),e.run.nextBattleSuppliesBonus+=5,f(e,"식용 버섯: F -2, 다음 전투 시작 S +5"),"NONE")}]},{id:"ominous_prophecy",name:"불길한 예언",prompt:"불길한 속삭임이 귓가를 맴돈다. 대가를 치르고 미래를 엿볼까?",options:e=>[{key:"omen:listen",label:"예언을 듣는다",detail:"F +1. 다음 보스를 확정하고 공개합니다.",apply:n=>{if(ne(n,1),f(n,"불길한 예언: 피로 F +1"),n.run.nextBossId||(n.run.bossPool.length>0?n.run.nextBossId=R(n.run.bossPool):n.run.nextBossId=null),!n.run.nextBossId)return f(n,"예언: 미래가 흐릿하다. (보스가 남아있지 않음)"),"NONE";n.content.enemiesById[n.run.nextBossId];const t=Cn[n.run.nextBossId]??"정체불명의 위협이 다가온다.";return n.run.bossOmenText=`${t}`,f(n,`예언: ${t}`),"NONE"}},{key:"omen:ignore",label:"무시한다",detail:"아무 일도 일어나지 않습니다.",apply:n=>(f(n,"불길한 예언(무시)"),"NONE")}]}];function _t(e){return Me.find(n=>n.id===e)??null}function Ht(){return{cardsById:Wn,enemiesById:Un}}const Pe="deck-rogue-save-v1",Sn=1;function It(e){try{return JSON.parse(e)}catch{return null}}function Nt(){return!!localStorage.getItem(Pe)}function Ot(){localStorage.removeItem(Pe)}function Rt(e,n){const t={ver:Sn,savedAt:Date.now(),build:n?.build,state:e};localStorage.setItem(Pe,JSON.stringify(t))}function Lt(){const e=localStorage.getItem(Pe);if(!e)return null;const n=It(e);return!n||n.ver!==Sn||!n.state?null:{state:n.state,savedAt:n.savedAt}}const Mt=`# Deck Rogue Prototype — 룰북 (플레이어용)

이 문서는 스포일러를 최소화합니다.

[1] 개요
노드를 선택하며 진행하고, 전투에서 살아남아 성장합니다. 목표는 무엇일까요?
모든 카드는 전열과 후열이 있습니다. 배치에 따라 역할이 달라집니다.

[2] 보급과 피로도

보급(S): 전열 카드 및 일부 효과의 발동에 사용됩니다. 보통 7로 시작합니다.
보급이 부족한 상태로 턴 종료 시 피로도만큼 피해를 받습니다.

피로도(F): 덱을 섞거나 전열 카드의 보급이 부족한 채로 턴을 마칠 때 피로도가 1 올라가며, 일부 카드의 효과로도 변합니다.
피로도는 전투가 끝나도 유지됩니다. 너무 쌓인 피로는 때때로 당신을 변하게 합니다.

[3] 전투 흐름
배치 → 후열 발동 → 전열 발동 → 적 행동 → 정리 → 드로우
※ “대상 선택 필요”가 뜨면 살아있는 적을 클릭해 대상을 정하세요.
※ 후열 발동을 누르면 턴이 진행되어, 카드의 배치를 변경할 수 없습니다.
보급 및 그에 따른 변화는 정리 단계에서 처리합니다.

손패는 턴이 종료되어도 유지됩니다.
카드는 매 턴마다 사용한 만큼 뽑습니다. 즉, 카드로 인한 드로우는 패의 매수 자체를 늘리는 효과가 있습니다.

[4] 용어
- 소모: 이번 전투에서 사용할 수 없게 되는 것입니다.
- 소실: 런 전체에서 해당 카드가 사라지는 것입니다.
- 취약: 받는 피해가 (취약)만큼 증가합니다.
- 약화: 주는 피해가 (약화)만큼 감소합니다.
- 출혈: 턴 종료 시 (출혈)만큼 피해를 입습니다.
- 교란: 당신을 방해합니다. 무엇일까요?

[5] 조작

(컴퓨터)
- 4: 선택 해제
- Tab: 손패 선택 이동
- 1~3: 전열 배치 / q,w,e: 후열 배치
- 드래그: 손패→슬롯 배치, 슬롯↔슬롯 스왑, 슬롯→손패 회수
- Space: 다음 턴
- F: 새로운 런

(모바일)
- 손패: 클릭 시 선택, 길게 누를 시 확대
- 카드 선택 상태에서 슬롯을 눌러 배치
- 슬롯: 클릭 시 확대, 길게 누를 시 회수
- 슬롯에 넣은 카드는 이름만 보입니다.

[6] 당신을 위한 조언

덱은 당신의 비품입니다. 비품이 적으면, 늘 새로 꾸리느라 힘들 겁니다. 비품이 많으면, 들고 다니기 힘들겠지요. 균형을 찾으세요.

[7] 시간

시간은 금입니다. 모든 행동은 시간을 소모합니다. 싸움은 좀 더 소모할지도 모르겠군요.
중요한 건 이곳이 당신에게 넉넉한 시간을 주지 않는다는 것이겠지요.
`;let be=null;function Dt(e){be!=null&&window.clearTimeout(be),be=window.setTimeout(()=>{be=null,Rt(e)},250)}function Ft(e,n){if(e.run.finished||e.choice||N(e)||I||e.phase==="NODE")return;let t=!1,a=0;const r=()=>{if(a++,a>60||e.run.finished||e.choice||I||N(e))return;const o=vn(e,n,!1);!o.fn||o.disabled||(e.phase==="DRAW"&&(t=!0),o.fn(),x(e,n),!(t&&e.phase==="PLACE")&&requestAnimationFrame(r))};requestAnimationFrame(r)}function De(e){const n=e.run;n.nextBossTime==null&&(n.nextBossTime=30),n.forcedNext==null&&(n.forcedNext=null)}function Ce(e){return(e.run.nodePickCount??0)+(e.time??0)}function sn(e){const r=Math.max(0,e-20),o=Math.min(85,Math.floor(r*r/3));return{extra:Math.random()*100<o?1:0,pPct:o}}function Wt(e,n){const t=e;return t.content=n,t.time??=0,t.run??={},t.run.nextBossTime??=30,t.run.forcedNext??=null,t.run.bossOmenText??=null,t.run.enemyLastSeenBattle??={},t.run.nodePickByType??={BATTLE:0,REST:0,EVENT:0,TREASURE:0},t.run.bossPool??=["boss_gravity_master","boss_cursed_wall","boss_giant_orc","boss_soul_stealer"],t.run.nextBossId??=null,t.run.afterTreasureNodePicks??=0,t.run.deckSizeAtTreasure??=null,t.run.treasureObtained&&t.run.deckSizeAtTreasure==null&&(t.run.deckSizeAtTreasure=we(t)),t.choiceStack??=[],t.pendingTargetQueue??=[],t.exhausted??=[],t.vanished??=[],t}function zt(e){if(!Nt())return Ie(e);const n=Lt();return n?Wt(n.state,e):Ie(e)}let ln=0,dn=0,Se=null;function Ut(e,n){cn();const t=y("cardZoomLayer");t.style.cssText=`
    position:fixed; inset:0; z-index:7000;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:center;
    padding: 14px;
  `;const a=y("cardZoomPanel");a.style.cssText=`
    width: min(420px, 92vw);
    max-height: 82vh;
    overflow: auto;
  `;const r=Ye(e,n);r.classList.add("zoomedCard"),a.appendChild(r),t.onclick=()=>cn(),a.onclick=o=>o.stopPropagation(),t.appendChild(a),document.body.appendChild(t)}function En(e,n){let t=null,a=!1,r=0,o=0;const d=n.moveTolerancePx??6,l=()=>{t!=null&&window.clearTimeout(t),t=null,a=!1};e.onpointerdown=c=>{n.shouldIgnore?.(c)||(a=!1,r=c.clientX,o=c.clientY,t!=null&&window.clearTimeout(t),t=window.setTimeout(()=>{a=!0,t=null,n.onFire(c)},n.delayMs))},e.onpointermove=c=>{if(t==null)return;const h=c.clientX-r,b=c.clientY-o;h*h+b*b>d*d&&l()},e.onpointerup=c=>{const h=a;l(),!h&&n.onTap&&n.onTap(c)},e.onpointercancel=()=>l()}function cn(){document.querySelector(".cardZoomLayer")?.remove()}function Vt(e,n){const t=e.cards[n],a=G(e.content,t.defId,t.upgrade??0),r=y("card");r.classList.add("inSlot"),r.appendChild(B("cardTitle",ve(e,n)));const o=y("cardMeta");return a.tags?.includes("EXHAUST")&&o.appendChild(z("소모")),a.tags?.includes("VANISH")&&o.appendChild(z("소실")),r.appendChild(o),r}function Kt(e,n){document.querySelector(".cardPeekOverlay")?.remove();const t=y("cardPeekOverlay");t.style.cssText="position:fixed; inset:0; z-index:7000; background:rgba(0,0,0,.60);backdrop-filter: blur(6px); display:flex; align-items:center; justify-content:center;padding:18px; box-sizing:border-box;";const a=y("panel");a.classList.add("cardPeekPanel"),a.style.cssText="width: fit-content; max-width: 92vw; max-height: 92vh;overflow: visible; padding: 12px; border-radius: 16px;";const r=Ye(e,n);r.style.width="var(--handCardW)",r.style.height="var(--handCardH)",r.style.boxSizing="border-box",a.appendChild(r),t.appendChild(a),t.onclick=()=>t.remove(),a.onclick=o=>o.stopPropagation(),document.body.appendChild(t)}function qt(e,n){if(document.querySelector(".mobileQuickMenuBtn")?.remove(),document.querySelector(".mobileQuickMenuSheet")?.remove(),!K())return;const a=document.createElement("button");a.type="button",a.className="mobileQuickMenuBtn",a.textContent="≡",a.style.cssText=`
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    right: calc(env(safe-area-inset-right, 0px) + 10px);
    z-index: 9999;
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(15,18,22,.88);
    color: #fff;
    font-weight: 900;
    backdrop-filter: blur(6px);
  `,a.onclick=()=>r(),document.body.appendChild(a);const r=()=>{document.querySelector(".mobileQuickMenuSheet")?.remove();const o=document.createElement("div");o.className="mobileQuickMenuSheet",o.style.cssText=`
      position: fixed; inset: 0;
      z-index: 9998;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 12px;
      box-sizing: border-box;
    `;const d=document.createElement("div");d.style.cssText=`
      width: min(520px, 100%);
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(15,18,22,.92);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    `;const l=document.createElement("div");l.style.cssText="display:flex; gap:10px; flex-wrap:wrap;";const c=(p,u)=>{const k=document.createElement("button");return k.type="button",k.textContent=p,k.style.cssText=`
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        color: #fff;
        font-weight: 700;
      `,k.onclick=()=>{o.remove(),u()},k};l.appendChild(c("새로운 런",()=>n.onNewRun())),l.appendChild(c("룰북",()=>n.onViewRulebook())),l.appendChild(c("로그",()=>n.onToggleLogOverlay()));const h=document.createElement("div");h.style.cssText="height:1px; margin:12px 0; background: rgba(255,255,255,.10);";const b=document.createElement("div");b.style.cssText="display:flex; gap:10px; flex-wrap:wrap;",b.appendChild(c("덱",()=>n.onViewPile("deck"))),b.appendChild(c("버림",()=>n.onViewPile("discard"))),b.appendChild(c("손패",()=>n.onViewPile("hand"))),b.appendChild(c("소모",()=>n.onViewPile("exhausted"))),b.appendChild(c("소실",()=>n.onViewPile("vanished"))),d.appendChild(l),d.appendChild(h),d.appendChild(b),o.onclick=()=>o.remove(),d.onclick=p=>p.stopPropagation(),o.appendChild(d),document.body.appendChild(o)}}let I=null,un=!1,S=null,X=null,Fe=!1;function Ye(e,n){const t=e.cards[n],a=G(e.content,t.defId,t.upgrade??0),r=y("card");r.classList.add("choiceCard"),a.tags?.includes("EXHAUST")&&r.classList.add("exhaust"),a.tags?.includes("VANISH")&&r.classList.add("vanish"),r.appendChild(B("cardTitle",ve(e,n)));const o=y("cardMeta");a.tags?.includes("EXHAUST")&&o.appendChild(z("소모")),a.tags?.includes("VANISH")&&o.appendChild(z("소실")),r.appendChild(o);const d=y("cardSection");d.appendChild(B("cardSectionTitle","⚔ 전열")),d.appendChild(B("cardText",a.frontText)),r.appendChild(d);const l=y("cardSection");return l.appendChild(B("cardSectionTitle","🕯 후열")),l.appendChild(B("cardText",a.backText)),r.appendChild(l),r}function jt(e,n,t){const a=G(e.content,n,t),r=e.content.cardsById[n]?.name??n,o=y("card");o.classList.add("choiceCard"),a.tags?.includes("EXHAUST")&&o.classList.add("exhaust"),a.tags?.includes("VANISH")&&o.classList.add("vanish"),o.appendChild(B("cardTitle",Ge(r,t)));const d=y("cardMeta");a.tags?.includes("EXHAUST")&&d.appendChild(z("소모")),a.tags?.includes("VANISH")&&d.appendChild(z("소실")),o.appendChild(d);const l=y("cardSection");l.appendChild(B("cardSectionTitle","⚔ 전열")),l.appendChild(B("cardText",a.frontText)),o.appendChild(l);const c=y("cardSection");return c.appendChild(B("cardSectionTitle","🕯 후열")),c.appendChild(B("cardText",a.backText)),o.appendChild(c),o}function gn(e,n){return e==="BATTLE"?"⚔️(전투)":e==="REST"?"⛺(휴식)":e==="EVENT"?"❔(미지)":"🌑(보물)"}function Xt(e,n){return e.map(t=>gn(t.type)).join(" / ")}function Yt(e,n,t){const a=[`[탐험 ${n.run.nodePickCount}회]`];if(n.run.treasureObtained){const g=n.run.deckSizeAtTreasure??we(n),_=xe(g);a.push(`[탈출까지 ${n.run.afterTreasureNodePicks}/${_}]`)}e.appendChild(Qe(a.join(" "))),De(n),(!n.run.bossOmenText||String(n.run.bossOmenText).trim()==="")&&(n.run.bossOmenText="아직 징조가 없다.");const r=n.run,o=Ce(n),d=r.nextBossTime??30,l=t.getNodeOffers(),c=r.nodeExtra01??0,h=o+1+c,b=r.forcedNext==="BOSS",p=!b&&h>=d,u=!b&&!p&&(l[0]?.type==="BATTLE"||l[1]?.type==="BATTLE"),k=h+1,E=b?h+1:u?k:h,i=Math.max(0,d-o);if(E>=d&&r.forcedNext!=="BOSS"){const g=B("bossIncomingBanner","보스가 온다.");g.style.cssText="margin-top:10px; padding:10px 12px; border-radius:14px;border:1px solid rgba(255,255,255,.14);background: rgba(255,120,60,.12);font-weight:700; font-size:13px; line-height:1.25;",e.appendChild(g)}const{tier:m}=ge(n),C=m===0?"":m===1?Math.random()<.1?" . . . 들린다.":"":m===2?Math.random()<.1?" . . . 보인다.":"":Math.random()<.1?" . . . 닿았다.":"",T=` . . . ${n.run.bossOmenText}${C}`,P=B("bossOmenBanner",`다음 보스까지 남은 시간: ${i}${T}`);P.style.cssText="margin-top:8px; padding:10px 12px; border-radius:14px;border:1px solid rgba(255, 255, 255, 0);background:rgba(0, 0, 0, 0.18);font-weight:600;font-size:13px;line-height:1.2;",P.style.color="white",e.appendChild(P);const w=n.run.branchOffer;if(w){const g=y("nodePreviewBox");g.style.cssText="margin-top:10px; padding:12px; border:1px solid rgba(255,255,255,.10); border-radius:16px; background:rgba(0,0,0,.18);";const _=r.forcedNext==="BOSS",v=H=>{const $=y("nodePreviewRow");$.style.cssText="display:flex; gap:10px; align-items:center; padding:10px; border-radius:14px; cursor:pointer;",$.onmouseenter=()=>$.style.background="rgba(255,255,255,.06)",$.onmouseleave=()=>$.style.background="transparent",$.onclick=()=>t.onChooseNode(H);const j=_?"💀(보스)":gn(l[H==="A"?0:1]?.type??"BATTLE"),A=document.createElement("div");A.className="nodePill primary",A.textContent=j,A.onclick=Z=>{Z.stopPropagation(),t.onChooseNode(H)},$.appendChild(A),$.appendChild(B("","→"));const L=H==="A"?w.nextIfA:w.nextIfB,D=B("",Xt(L));return D.style.cssText="opacity:.85;",$.appendChild(D),$};g.appendChild(v("A")),g.appendChild(v("B")),e.appendChild(g),e.appendChild(Qt())}}function Qt(){return document.createElement("hr")}function wn(e,n){let t=null,a=!1,r=!1;const o=[];function d(i){o.length=0,i.choice=null,t=null,document.querySelector(".choice-overlay")?.remove()}function l(i){o.push({choice:i.choice,handler:t})}function c(i){const s=o.pop();if(!s){h(i);return}i.choice=s.choice,t=s.handler}function h(i){if(o.length>0){c(i);return}i.choice=null,t=null,document.querySelector(".choice-overlay")?.remove()}function b(i,s,m){i.choice&&l(i),i.choice=s,t=m}const p=()=>Se||e,u={onHotkeySlot:(i,s)=>{const m=p();if(m.run.finished||N(m)||m.phase!=="PLACE"||i==="back"&&m.backSlotDisabled?.[s])return;const C=i==="front"?m.frontSlots:m.backSlots,T=C[s];if(!m.selectedHandCardUid){if(!T)return;u.onReturnSlotToHand(i,s);return}const P=m.selectedHandCardUid;if(!T){u.onPlaceHandUidToSlot(P,i,s);return}C[s]=null,m.usedThisTurn=Math.max(0,m.usedThisTurn-1),i==="front"&&(m.frontPlacedThisTurn=Math.max(0,m.frontPlacedThisTurn-1)),m.hand.push(T),m.cards[T].zone="hand",en(m,P,i,s),m.selectedHandCardUid=null,f(m,`[${V(m,P)}] ↔ [${V(m,T)}] 스왑: 손패 ↔ ${i}${s+1}`),x(m,u)},rerender:()=>{const i=p();x(i,u)},onToggleLogOverlay:()=>{Fe=!Fe,x(p(),u)},onCloseOverlay:()=>{const i=p();I=null,x(i,u)},onNewRun:()=>{const i=p();X=null,I=null,S=null,h(i),Ot(),n(Ie(i.content))},onViewRulebook:()=>{const i=p();I={kind:"RULEBOOK"},x(i,u)},onViewPile:i=>{const s=p();I={kind:"PILE",pile:i},x(s,u)},onReturnSlotToHand:(i,s)=>{const m=p();if(m.run.finished||N(m)||m.phase!=="PLACE")return;const C=i==="front"?m.frontSlots:m.backSlots,T=C[s];T&&(C[s]=null,m.usedThisTurn=Math.max(0,m.usedThisTurn-1),i==="front"&&(m.frontPlacedThisTurn=Math.max(0,m.frontPlacedThisTurn-1)),m.hand.push(T),m.cards[T].zone="hand",f(m,`[${V(m,T)}] 회수: ${i}${s+1} → 손패`),x(m,u))},onClearSelected:()=>{const i=p();i.selectedHandCardUid=null,x(i,u)},onSelectEnemy:i=>{const s=p();if(r)return;r=!0,requestAnimationFrame(()=>{r=!1});const m=ht(s,i);x(s,u),m&&!s.choice&&!s.run.finished&&u.onAutoAdvance()},onSelectHandCard:i=>{const s=p();N(s)||(s.selectedHandCardUid=s.selectedHandCardUid===i?null:i,x(s,u))},getNodeOffers:()=>{const i=p();De(i),i.run.branchOffer||(i.run.branchOffer=ce(i));const s=i.run,m=Ce(i);return s.forcedNext==="BOSS"?(s.nodeExtra01=0,[{id:"A",type:"BATTLE"},{id:"B",type:"BATTLE"}]):(s.nodeExtra01==null&&(s.nodeExtra01=sn(i.deck.length).extra),m+1+s.nodeExtra01>=s.nextBossTime?[{id:"A",type:"REST"},{id:"B",type:"REST"}]:i.run.branchOffer.root)},onChooseNode:i=>{const s=p();if(a||(a=!0,queueMicrotask(()=>a=!1),s.run.finished)||s.phase!=="NODE")return;De(s),s.run.branchOffer||(s.run.branchOffer=ce(s));const m=s.run,C=u.getNodeOffers(),T=i==="A"?C[0].type:C[1].type,P=Ce(s),w=m.forcedNext==="BOSS";let g=0;w||(m.nodeExtra01==null&&(m.nodeExtra01=sn(s.deck.length).extra),g=m.nodeExtra01);const _=P+1+g,v=s.run.nodePickCount+1;s.run.nodePickCount=v,s.time=(s.time??0)+g,m.nodeExtra01=null;const H=!w&&_>=m.nextBossTime,$=w?"BATTLE":H?"REST":T,U=$==="BATTLE"?1:0,j=_+U;if(s.time=(s.time??0)+g+U,U&&f(s,"전투를 선택해 시간이 더 소모된다. (시간 +1)"),Rn(s,i),s.run.nodePickByType[$]=(s.run.nodePickByType[$]??0)+1,s.run.treasureObtained&&$!=="TREASURE"){s.run.afterTreasureNodePicks+=1;const A=s.run.deckSizeAtTreasure??we(s),L=xe(A);if(s.run.afterTreasureNodePicks>=L){s.run.finished=!0,f(s,`승리! 보물 획득 후 ${L}번의 탐험을 버티고 탈출했습니다.`),x(s,u);return}}if(w){m.forcedNext=null,m.nextBossTime+=30,s.run.bossOmenText=null,f(s,`=== 시간 ${j}: 보스 전투 ===`),re(s,{forceBoss:!0}),oe(s),x(s,u);return}if(!w&&j>=m.nextBossTime&&(m.forcedNext="BOSS",f(s,"시간이 흘러 보스가 다가옵니다!")),$==="BATTLE"){re(s,{forceBoss:!1}),oe(s),x(s,u);return}if($==="REST"){let A=function(D){const Z=D.player.fatigue??0;Z<10||(D.player.fatigue=Math.max(0,Z-2),D.time=(D.time??0)+1,f(D,"피로가 너무 높아 휴식이 더 오래 걸립니다. (F -2, 시간 +1)"))};const L=()=>{const D=(s.player.fatigue??0)>=10,Z=D?"피로도가 너무 높아 더 쉬어야 합니다.":"휴식",O=D?" (피로도 10 이상: F -2, 시간 +1)":"";s.choice={kind:"EVENT",title:Z,prompt:"무엇을 하시겠습니까?",options:[{key:"rest:heal",label:`HP +15 ${O}`},{key:"rest:clear_f",label:`F -3 ${O}`},{key:"rest:upgrade",label:`강화 ${O}`},{key:"rest:skip",label:"생략"}]},t=Y=>{if(Y==="rest:heal"){A(s),s.player.hp=Math.min(s.player.maxHp,s.player.hp+15),f(s,"휴식: HP +15"),h(s),s.phase="NODE",x(s,u);return}if(Y==="rest:clear_f"){A(s),s.player.fatigue=Math.max(0,s.player.fatigue-3),f(s,"휴식: 피로 F-=3"),h(s),s.phase="NODE",x(s,u);return}if(Y==="rest:upgrade"){E(s,u,"강화","강화할 카드 1장을 선택하세요.",{onDone:()=>{A(s),s.phase="NODE",x(s,u)},onSkip:()=>{L(),x(s,u)}});return}f(s,"휴식: 생략"),h(s),s.phase="NODE",x(s,u)}};L(),x(s,u);return}if($==="TREASURE"){kt(s);const A=s.run.deckSizeAtTreasure,L=xe(A);f(s,`저주받은 보물을 얻었습니다! 이제부터 ${L}번의 탐험을 버티면 탈출합니다.`),x(s,u);return}if($==="EVENT"){const A=s.run;A.firstEventSeen??=!1;const L=A.firstEventSeen?rn(s):_t("ominous_prophecy")??rn(s);A.firstEventSeen=!0;const D=L.options(s),{tier:Z}=ge(s);Z>=2&&D.push({key:"mad:whisper",label:"속삭임에 귀 기울인다.",detail:"무언가를 얻는다. 그리고 무언가를 잃는다.",apply:O=>{const Y=Math.random();return Y<.34?(O.player.hp=Math.min(O.player.maxHp,O.player.hp+10),f(O,"속삭임: HP +10")):Y<.67?(O.player.fatigue+=1,f(O,"속삭임: F +1 (대가)")):(He(O,"mad_echo",{upgrade:0}),f(O,"속삭임: [메아리]를 얻었다.")),"NONE"}}),s.choice={kind:"EVENT",title:L.name,prompt:L.prompt,options:D.map(O=>({key:O.key,label:O.label,detail:O.detail}))},t=O=>{const Y=D.find($e=>$e.key===O);if(!Y)return;const M=Y.apply(s);if(typeof M=="object"&&M.kind==="UPGRADE_PICK"){E(s,u,M.title??"강화",M.prompt??"강화할 카드 1장을 선택하세요.");return}if(typeof M=="object"&&M.kind==="REMOVE_PICK"){const $e=Object.values(s.cards).filter(W=>W.zone==="deck"||W.zone==="hand"||W.zone==="discard").map(W=>W.uid);b(s,{kind:"PICK_CARD",title:M.title,prompt:M.prompt??"제거할 카드 1장을 선택하세요.",options:[...$e.map(W=>{const pe=Ue(s,W);return{key:`remove:${W}`,label:V(s,W),detail:`전열: ${pe.frontText} / 후열: ${pe.backText}`,cardUid:W}}),{key:"cancel",label:"취소"}]},W=>{if(W==="cancel"){f(s,"제거 취소"),h(s),x(s,u);return}if(!W.startsWith("remove:")){x(s,u);return}const pe=W.slice(7);vt(s,pe);const fe=M.then,Je=fe==="REWARD"||fe==="REWARD_PICK"?"REWARD_PICK":fe==="BATTLE"?"BATTLE":fe==="NONE"?"NONE":void 0;if(Je==="BATTLE"){d(s),re(s),oe(s),x(s,u);return}if(Je==="REWARD_PICK"){d(s),k(s,u,"카드 보상","두 장 중 한 장을 선택하거나 생략합니다.");return}d(s),s.phase="NODE",x(s,u)}),x(s,u);return}if(typeof M=="object"&&M.kind==="BATTLE_SPECIAL"){d(s),f(s,M.title?`이벤트 전투: ${M.title}`:"이벤트 전투 발생!"),re(s,{forcePatternIds:M.enemyIds}),oe(s),x(s,u);return}if(M==="BATTLE"){d(s),re(s),oe(s),x(s,u);return}if(M==="REWARD"){d(s),k(s,u,"카드 보상","두 장 중 한 장을 선택하거나 생략합니다.");return}h(s),x(s,u)},x(s,u);return}},onChooseChoice:i=>{const s=p();if(!s.choice)return;if(t){t(i);const C=p();C.enemies.length>0&&C.phase==="PLACE"||u.onAutoAdvance();return}const m=s.choice.kind;if(m==="REWARD"||m==="REWARD_PICK"){if(i==="skip"){f(s,"카드 보상 생략"),h(s),x(s,u);return}if(i.startsWith("pick:")){const C=i.slice(5),[T,P]=C.split(":"),w=Number(P??"0")||0;He(s,T,{upgrade:w}),f(s,`카드 획득: ${An(s,T,w)}`),h(s),!s.run.finished&&s.enemies.length===0&&(s.phase="NODE"),x(s,u);return}}f(s,`선택 처리 불가: handler 없음 (kind=${m}, key=${i})`)},onAutoAdvance:()=>{const i=p();Ft(i,u)},onRevealIntents:()=>{const i=p();i.run.finished||i.enemies.length!==0&&(je(i),x(i,u))},onPlaceHandUidToSlot:(i,s,m)=>{const C=p();C.run.finished||N(C)||C.phase==="PLACE"&&(s==="back"&&C.backSlotDisabled?.[m]||(en(C,i,s,m),C.selectedHandCardUid=null,x(C,u)))},onPlaceSelected:(i,s)=>{const m=p();m.selectedHandCardUid&&u.onPlaceHandUidToSlot(m.selectedHandCardUid,i,s)},onMoveSlotCard:(i,s,m,C)=>{const T=p();if(T.run.finished||N(T)||T.phase!=="PLACE"||m==="back"&&T.backSlotDisabled?.[C])return;const P=i==="front"?T.frontSlots:T.backSlots,w=m==="front"?T.frontSlots:T.backSlots,g=P[s];if(!g)return;const _=w[C];P[s]=_??null,w[C]=g,T.cards[g].zone=m,_&&(T.cards[_].zone=i),i!==m&&(i==="front"&&(T.frontPlacedThisTurn=Math.max(0,T.frontPlacedThisTurn-1)),m==="front"&&(T.frontPlacedThisTurn+=1),_&&(m==="front"&&(T.frontPlacedThisTurn=Math.max(0,T.frontPlacedThisTurn-1)),i==="front"&&(T.frontPlacedThisTurn+=1))),f(T,_?`[${V(T,g)}] ↔ [${V(T,_)}] 스왑: ${i}${s+1} ↔ ${m}${C+1}`:`[${V(T,g)}] 이동: ${i}${s+1} → ${m}${C+1}`),We(T),x(T,u)},onResolveBack:()=>{const i=p();i.phase==="PLACE"&&We(i),it(i),x(i,u)},onResolveFront:()=>{const i=p();lt(i),x(i,u)},onResolveEnemy:()=>{const i=p();dt(i),x(i,u)},onUpkeep:()=>{const i=p();ct(i),x(i,u)},onDrawNextTurn:()=>{const i=p();pt(i),x(i,u)}};function k(i,s,m,C){const P=Tn(i).map(w=>{const g=G(i.content,w.defId,w.upgrade);return{key:`pick:${w.defId}:${w.upgrade}`,label:ya(i,w),detail:`전열: ${g.frontText} / 후열: ${g.backText}`}});i.choice={kind:"REWARD",title:m,prompt:C,options:[...P,{key:"skip",label:"생략"}]},t=w=>{if(w.startsWith("pick:")){const g=w.slice(5),[_,v]=g.split(":"),H=Number(v??"0")||0;He(i,_,{upgrade:H})}else f(i,"카드 보상 생략");h(i),i.run.finished||(i.phase="NODE"),x(i,s)},x(i,s)}function E(i,s,m,C,T){let P=Object.values(i.cards).filter(v=>(v.zone==="deck"||v.zone==="hand"||v.zone==="discard")&&kn(i,v.uid)).map(v=>v.uid);const w=i.player.fatigue??0;let g=1/0;if(w>=8?g=4:w>=5&&(g=8),g!==1/0&&P.length>g&&(P=[...P].sort(()=>Math.random()-.5).slice(0,g)),P.length===0){f(i,"강화할 수 있는 카드가 없습니다."),i.choice=null,t=null,T?.onSkip?T.onSkip():x(i,s);return}const _=[...P].sort((v,H)=>{const $=i.cards[v],U=i.cards[H],j=Ee(i,$.defId),A=Ee(i,U.defId),L=j.localeCompare(A,"ko");return L!==0?L:($.upgrade??0)-(U.upgrade??0)});i.choice={kind:"UPGRADE_PICK",title:m,prompt:C,options:[..._.map(v=>{const H=i.cards[v],$=Ue(i,v),U=G(i.content,H.defId,(H.upgrade??0)+1),j=V(i,v),A=`현재: 전열 ${$.frontText} / 후열 ${$.backText}
강화: 전열 ${U.frontText} / 후열 ${U.backText}`;return{key:`up:${v}`,label:j,detail:A,cardUid:v}}),{key:"skip",label:"취소"}]},t=v=>{if(v==="skip"){f(i,"강화 취소"),h(i),T?.onSkip?T.onSkip():x(i,s);return}if(v.startsWith("up:")){const H=v.slice(3),$=$t(i,H);f(i,$?`강화: [${V(i,H)}]`:"강화 실패"),h(i),T?.onDone?T.onDone():x(i,s);return}h(i),x(i,s)},x(i,s)}return u}function We(e){const n=e.frontSlots.filter(a=>a!=null).length,t=e.backSlots.filter(a=>a!=null).length;e.frontPlacedThisTurn=n,e.usedThisTurn=n+t}function Gt(){const e=document.querySelector("#app");return e.innerHTML="",e}function Q(e,n,t=""){const a=document.createElement("button");return t&&(a.className=t),a.type="button",a.textContent=e,a.onclick=n,a}function x(e,n){Se=e;const t=document.querySelector(".mainPanel");t&&(ln=t.scrollTop,dn=t.scrollLeft);const a=Gt();un||(ca(()=>Se??e,n),un=!0),a.appendChild(ta(e,n));const r=y("mainRow"),o=y("stage"),d=y("stageInner"),l=y("panel mainPanel");l.scrollTop=ln,l.scrollLeft=dn,l.appendChild(aa()),e.run.finished?l.appendChild(Qe("런 종료")):e.phase==="NODE"?Yt(l,e,n):oa(l,e,n),d.appendChild(l),o.appendChild(d);const c=y("panel logPanel");c.appendChild(ra());const h=ba(e.log.join(`
`));h.classList.add("log"),c.appendChild(h),r.appendChild(o),r.appendChild(c),a.appendChild(r),ia(e,n,N(e)),Bn(),ea(e,n),na(e,n),e.fx&&(e.fx.enemyShake=[],e.fx.playerShake=!1),Zt(e,n),Jt(n),qt(e,n),Dt(e)}function Jt(e){if(document.querySelector(".floatingNewRun")?.remove(),K())return;const n=Q("새로운 런",()=>e.onNewRun(),"floatingNewRun");n.style.cssText=`
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    left: calc(env(safe-area-inset-left, 0px) + 10px);
    z-index: 10000;
    pointer-events: auto;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.55);
    color: #fff;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    cursor: pointer;
  `,document.body.appendChild(n)}function Zt(e,n){if(document.querySelector(".logOverlay")?.remove(),!Fe)return;const t=y("logOverlay");t.style.cssText=`
    position: fixed; inset: 0;
    z-index: 6000;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: flex-end;
    justify-content: center;
  `;const a=y("panel");a.style.cssText=`
    width: min(720px, 100%);
    max-height: 70vh;
    border-radius: 18px 18px 0 0;
    padding: 12px;
    margin: 0;
  `;const r=y("panelHeader"),o=document.createElement("h2");o.textContent="로그",r.appendChild(o);const d=Q("닫기",()=>n.onToggleLogOverlay());r.appendChild(d),a.appendChild(r);const l=document.createElement("pre");l.className="log",l.textContent=e.log.join(`
`),l.style.maxHeight="60vh",l.style.overflow="auto",a.appendChild(l),t.onclick=()=>n.onToggleLogOverlay(),a.onclick=c=>c.stopPropagation(),t.appendChild(a),document.body.appendChild(t)}function ea(e,n){if(document.querySelector(".overlay-layer")?.remove(),!I)return;const t=y("overlay-layer");t.style.cssText="position:fixed; inset:0; z-index:2500; background:rgba(0,0,0,.55); display:flex; justify-content:center; align-items:center;",t.onclick=c=>{c.target===t&&n.onCloseOverlay()};const a=y("overlay-panel");a.style.cssText="width:min(980px, 92vw); max-height:80vh; overflow:auto; padding:16px; border:1px solid rgba(255,255,255,.12); border-radius:16px; background:rgba(15,18,22,.92); box-shadow:0 18px 60px rgba(0,0,0,.45);",a.onclick=c=>c.stopPropagation();const r=I.kind==="RULEBOOK"?"룰북":I.pile==="deck"?"덱":I.pile==="discard"?"버림 더미":I.pile==="exhausted"?"소모(이번 전투)":I.pile==="vanished"?"소실(영구)":"손패",o=y("overlayHeader");o.style.cssText="display:flex; align-items:center; justify-content:space-between; gap:12px; position:sticky; top:0; padding-bottom:12px; margin-bottom:12px; background:rgba(15,18,22,.92);";const d=ha(r);d.classList.add("overlayTitle");const l=Hn("닫기",n.onCloseOverlay,!1);if(l.classList.add("overlayClose"),l.style.cssText="padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#fff; cursor:pointer;",o.appendChild(d),o.appendChild(l),a.appendChild(o),I.kind==="RULEBOOK"){const c=document.createElement("pre");c.className="rulebook",c.textContent=Mt,c.style.cssText="white-space:pre-wrap; line-height:1.45; font-size:13px; margin:0; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);",a.appendChild(c)}else{const h=[...I.pile==="deck"?e.deck:I.pile==="discard"?e.discard:I.pile==="exhausted"?e.exhausted:I.pile==="vanished"?e.vanished:e.hand].sort((p,u)=>{const k=e.cards[p],E=e.cards[u],i=Ee(e,k.defId),s=Ee(e,E.defId),m=i.localeCompare(s,"ko");return m!==0?m:(k.upgrade??0)-(E.upgrade??0)}),b=y("overlayList");if(b.style.cssText="display:flex; flex-direction:column; gap:10px;",h.length===0){const p=y("overlayEmpty");p.textContent="비어 있습니다.",p.style.cssText="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03);",b.appendChild(p)}else for(const p of h){const u=Ue(e,p),k=ve(e,p),E=y("overlayItem");E.style.cssText="border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:10px; background:rgba(255,255,255,.03);";const i=y("overlayItemTop");i.style.cssText="display:flex; align-items:center; justify-content:space-between; gap:10px;";const s=y("overlayItemTitle");s.textContent=k,s.style.cssText="font-weight:700;";const m=y("overlayItemMeta");m.textContent=`(${e.cards[p].zone})`,m.style.cssText="opacity:.7; font-size:12px; white-space:nowrap;",i.appendChild(s),i.appendChild(m),E.appendChild(i);const C=document.createElement("pre");C.className="overlayItemDetail",C.textContent=`전열: ${u.frontText}
후열: ${u.backText}`,C.style.cssText="margin:10px 0 0 0; padding:10px; white-space:pre-wrap; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.20); font-size:12px; line-height:1.45;",E.appendChild(C),b.appendChild(E)}a.appendChild(b)}t.appendChild(a),document.body.appendChild(t)}function na(e,n){document.querySelector(".choice-overlay")?.remove();const t=e.choice;if(!t)return;const a=y("choice-overlay");a.style.cssText="position:fixed; inset:0; z-index:3000; background:rgba(0,0,0,0.82); display:flex; justify-content:center; align-items:center;";const r=y("choice-panel");r.style.cssText="width:min(980px, 92vw); max-height:80vh; overflow:auto; padding:16px; border:1px solid rgba(255,255,255,.12); border-radius:16px; background:rgba(15,18,22,.92);",r.appendChild(fa(t.title)),t.prompt&&r.appendChild(Qe(t.prompt));const o=y("choice-list");o.style.cssText="display:flex; flex-direction:column; gap:10px; margin-top:12px;";const d=l=>{l.style.width="var(--handCardW)",l.style.height="var(--handCardH)",l.style.boxSizing="border-box"};t.options.forEach(l=>{const c=y("choice-item");c.style.cssText="display:flex; gap:12px; align-items:flex-start;border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px;background:rgba(255,255,255,.03);";const h=y("choice-left");h.style.cssText="flex:0 0 auto;";const b=l.cardUid;if(b){const k=Ye(e,b);d(k),h.appendChild(k)}else if(typeof l.key=="string"&&l.key.startsWith("pick:")){const k=l.key.slice(5),[E,i]=k.split(":"),s=Number(i??"0")||0,m=jt(e,E,s);d(m),h.appendChild(m)}const p=y("choice-right");p.style.cssText="flex:1 1 auto; min-width:260px;";const u=Hn(l.label,()=>n.onChooseChoice(l.key),!1);if(u.classList.add("primary"),p.appendChild(u),l.detail){const k=document.createElement("pre");k.className="choice-detail",k.textContent=String(l.detail),k.style.cssText="margin:10px 0 0 0; padding:10px; white-space:pre-wrap;border-radius:12px; border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22); font-size:12px; line-height:1.45;max-height:220px; overflow:auto;",p.appendChild(k)}c.appendChild(h),c.appendChild(p),o.appendChild(c)}),r.appendChild(o),a.appendChild(r),document.body.appendChild(a)}function K(){return window.matchMedia&&window.matchMedia("(max-width: 900px)").matches}function ta(e,n){document.querySelectorAll(".topHud").forEach(h=>h.remove());const t=e.time,a=y("topHud"),r=K();r||a.appendChild(y("topHudLeftSpacer"));const o=y("playerHudLeft");if(r){const h=y("mobileTopLine");h.appendChild(q(`HP ${e.player.hp}/${e.player.maxHp}`)),h.appendChild(q(`블록 ${e.player.block}`)),h.appendChild(q(`S ${e.player.supplies}`,e.player.supplies===0?"warn":"")),h.appendChild(q(`F ${e.player.fatigue}`)),h.appendChild(q(`시간 ${Math.max(1,Ce(e))}`)),h.appendChild(q(`덱 ${e.deck.length}`)),o.appendChild(h);const b=y("mobileStatusLine"),p=e.player.status,u=[];(p.vuln??0)>0&&u.push(`취약 ${p.vuln}`),(p.weak??0)>0&&u.push(`약화 ${p.weak}`),(p.bleed??0)>0&&u.push(`출혈 ${p.bleed}`),(p.disrupt??0)>0&&u.push(`교란 ${p.disrupt}`);const k=u.slice(0,4);for(const E of k)b.appendChild(z(E));u.length>k.length&&b.appendChild(z(`+${u.length-k.length}`)),o.appendChild(b)}else{const h=y("playerTitleRow");h.appendChild(B("playerHudTitle","플레이어"));const b=y("pileButtons");b.appendChild(Q("덱",()=>n.onViewPile("deck"))),b.appendChild(Q("버림",()=>n.onViewPile("discard"))),b.appendChild(Q("손패",()=>n.onViewPile("hand"))),b.appendChild(Q("소모",()=>n.onViewPile("exhausted"))),b.appendChild(Q("소실",()=>n.onViewPile("vanished"))),h.appendChild(b),o.appendChild(h);const p=y("enemyChip");p.classList.add("playerHudBox"),e.fx?.playerShake&&p.classList.add("shake");const u=y("enemyChipTop");u.appendChild(B("","HP")),u.appendChild(B("",`${e.player.hp}/${e.player.maxHp}`)),p.appendChild(u);const k=y("enemyHPOuter"),E=y("enemyHPFill");E.style.width=`${Math.max(0,Math.min(100,e.player.hp/Math.max(1,e.player.maxHp)*100))}%`,k.appendChild(E),p.appendChild(k);const i=y("enemyChipTop");i.appendChild(B("","블록")),i.appendChild(B("",`${e.player.block}`)),p.appendChild(i);const s=y("enemyHPOuter"),m=y("enemyHPFill");m.style.background="linear-gradient(90deg, #64b5ff, #2a7cff)",m.style.width=`${Math.max(0,Math.min(100,e.player.block/Math.max(1,e.player.maxHp)*100))}%`,s.appendChild(m),p.appendChild(s);const C=e.player.status,T=y("enemyBadges");p.appendChild(T);const P=[];(C.vuln??0)>0&&P.push(`취약 ${C.vuln}`),(C.weak??0)>0&&P.push(`약화 ${C.weak}`),(C.bleed??0)>0&&P.push(`출혈 ${C.bleed}`),(C.disrupt??0)>0&&P.push(`교란 ${C.disrupt}`);const w=r?P.slice(0,3):P;for(const H of w)T.appendChild(z(H));r&&P.length>w.length&&T.appendChild(z(`+${P.length-w.length}`)),o.appendChild(p);const g=y("resourceRow inline"),_=e.enemies.length>0&&e.phase!=="NODE",v=e.run.nextBattleSuppliesBonus??0;_?g.appendChild(q(`S ${e.player.supplies}`,e.player.supplies===0?"warn":"")):v>0&&g.appendChild(q(`보너스 S +${v}`,"bonus")),g.appendChild(q(`F ${e.player.fatigue}`)),g.appendChild(q(`시간 ${Math.max(1,e.run.nodePickCount+t)}`)),g.appendChild(q(`덱 ${e.deck.length}`)),o.appendChild(g)}const d=y("enemyHudCenter"),l=y(r?"enemyStrip":"enemyHud"),c=e.fx?.enemyShake??[];if(e.enemies.length===0)l.appendChild(B("enemyNone",""));else{const h=N(e);for(let b=0;b<e.enemies.length;b++){const p=e.enemies[b],u=y("enemyChip");c.includes(b)&&u.classList.add("shake"),h&&p.hp>0&&u.classList.add("targetable");const k=y("enemyChipTop");if(k.appendChild(B("",`${b+1}. ${p.name}`)),k.appendChild(B("",`${p.hp}/${p.maxHp}`)),u.appendChild(k),!r){const w=y("enemyHPOuter"),g=y("enemyHPFill");g.style.width=`${Math.max(0,Math.min(100,p.hp/Math.max(1,p.maxHp)*100))}%`,w.appendChild(g),u.appendChild(w)}const E=e.content.enemiesById[p.id],i=E.intents[p.intentIndex%E.intents.length];let s=p.intentLabelOverride??i.label;u.appendChild(B("enemyIntent",e.intentsRevealedThisTurn?`${s}`:""));const m=p.status,C=y("enemyBadges");u.appendChild(C);const T=[];(m.vuln??0)>0&&T.push(`취약 ${m.vuln}`),(m.weak??0)>0&&T.push(`약화 ${m.weak}`),(m.bleed??0)>0&&T.push(`출혈 ${m.bleed}`),(m.disrupt??0)>0&&T.push(`교란 ${m.disrupt}`),p.immuneThisTurn&&T.push("면역");const P=r?T.slice(0,2):T;for(const w of P)C.appendChild(z(w));r&&T.length>P.length&&C.appendChild(z(`+${T.length-P.length}`)),u.onclick=()=>n.onSelectEnemy(b),l.appendChild(u)}}if(d.appendChild(l),a.appendChild(o),a.appendChild(d),!r){const h=y("topHudRight"),b=y("topRightControls");b.appendChild(Q("룰북",n.onViewRulebook)),b.appendChild(Q("로그",n.onToggleLogOverlay)),h.appendChild(b),a.appendChild(h)}return e.fx?.enemyShake?.length&&(e.fx.enemyShake=[]),a}function q(e,n=""){const t=document.createElement("span");return t.className="chip"+(n?` ${n}`:""),t.textContent=e,t}function aa(e){if(K()){const r=y("battleTitleRow");return r.style.display="none",r}const t=y("battleTitleRow"),a=document.createElement("h2");return a.textContent="전장",t.appendChild(a),t}function ra(){const e=y("logHeaderRow"),n=document.createElement("h2");return n.textContent="로그",e.appendChild(n),e}function oa(e,n,t){const a=y("combatRoot"),r=y("boardArea"),o=y("targetHintSlot");if(o.style.cssText="height: 54px;margin: 0 0 3px 0;display:flex; align-items:center;",a.appendChild(o),N(n)&&n.selectedEnemyIndex==null){const d=y("targetHint"),l=n.pendingTarget,c=l?.sourceCardUid?V(n,l.sourceCardUid):null,h=l?.sourceLabel??null,b=l?.reason??null,p=c?`대상 선택 (${c})`:h?`대상 선택 (${h})`:"대상 선택 필요",u=b==="FRONT"?"전열":b==="BACK"?"후열":b==="EVENT"?"이벤트":b==="RELIC"?"유물":null,k=u?` — ${u}`:"",E=n.pendingTargetQueue?.length??0,i=(n.pendingTarget?1:0)+E,s=i>1?` (남은 ${i}개)`:" (남은 1개)";d.textContent=`${p}${k}${s}: 위의 적 박스를 클릭하세요.`,o.appendChild(d)}else o.style.visibility="hidden",o.textContent=".";r.appendChild(pn(n,t,"front")),r.appendChild(pn(n,t,"back")),a.appendChild(r),e.appendChild(a)}let ze=null,Pn=!0;function sa(e,n){ze=e,Pn=n}function vn(e,n,t){return e.run.finished?{label:"종료",fn:null,disabled:!0,activePhase:e.phase}:e.choice||I?{label:"선택 중",fn:null,disabled:!0,activePhase:e.phase}:t?{label:"대상 선택",fn:null,disabled:!0,activePhase:e.phase}:e.phase==="NODE"?{label:"노드 선택",fn:null,disabled:!0,activePhase:e.phase}:e.phase==="PLACE"?e.enemies.length>0&&!e.intentsRevealedThisTurn?{label:"다음: 정찰",fn:n.onRevealIntents,disabled:!1,activePhase:e.phase}:{label:"다음: 후열",fn:n.onResolveBack,disabled:!1,activePhase:e.phase}:e.phase==="BACK"?{label:"다음: 후열",fn:n.onResolveBack,disabled:!1,activePhase:e.phase}:e.phase==="FRONT"?{label:"다음: 전열",fn:n.onResolveFront,disabled:!1,activePhase:e.phase}:e.phase==="ENEMY"?{label:"다음: 적",fn:n.onResolveEnemy,disabled:!1,activePhase:e.phase}:e.phase==="UPKEEP"?{label:"다음: 정리",fn:n.onUpkeep,disabled:!1,activePhase:e.phase}:e.phase==="DRAW"?{label:"다음 턴",fn:n.onDrawNextTurn,disabled:!1,activePhase:e.phase}:{label:"다음",fn:null,disabled:!0,activePhase:e.phase}}function ia(e,n,t){const a=document.querySelector(".handDock");a&&a.remove();const r=y("handDock"),o=y("controlsDock"),d=vn(e,n,t),l=document.createElement("button");l.textContent="다음 턴",l.className="stepBtn primary",l.disabled=d.disabled||e.phase==="NODE",l.onclick=()=>n.onAutoAdvance(),o.appendChild(l);const c=document.createElement("button");c.textContent="선택 해제",c.disabled=!e.selectedHandCardUid,c.onclick=n.onClearSelected,o.appendChild(c),r.appendChild(o);const h=y("hand");h.dataset.dropHand="1";const b=y("handCardsRow");if(h.appendChild(b),e.hand.length===0){const p=y("handEmptyHint");p.textContent="손패가 비었습니다.",b.appendChild(p)}else{const p=!K();for(const u of e.hand)b.appendChild(_n(e,u,!0,n.onSelectHandCard,{draggable:p}))}sa(()=>n.onAutoAdvance(),l.disabled),r.appendChild(h),document.body.appendChild(r),K()||la(h)}function la(e){e.dataset?.wheelX!=="1"&&(e.dataset.wheelX="1",e.addEventListener("wheel",n=>{if(n.shiftKey)return;const t=Math.abs(n.deltaX)>Math.abs(n.deltaY)?n.deltaX:n.deltaY;e.scrollLeft+=t,n.preventDefault()},{passive:!1}))}function pn(e,n,t){const a=y("grid6"),r=!!e.selectedHandCardUid,o=t==="front"?e.frontSlots:e.backSlots,d=K();for(let l=0;l<3;l++){const c=t==="back"?!!e.backSlotDisabled?.[l]:!1,h=y("slot"+(c?" disabled":""));h.dataset.slotSide=t,h.dataset.slotIndex=String(l),X&&X.side===t&&X.idx===l&&h.classList.add("dropHover"),r&&!c&&h.classList.add("placeable"),h.appendChild(ma(`${t==="front"?"전열":"후열"} ${l+1}`));const b=o[l];if(b){const p=K()?Vt(e,b):_n(e,b,!1);p.classList.add("inSlot"),h.appendChild(p),d?En(p,{delayMs:420,moveTolerancePx:8,shouldIgnore:()=>!!(c||N(e)||e.phase!=="PLACE"),onFire:u=>{u.stopPropagation(),n.onReturnSlotToHand(t,l)},onTap:u=>{u.stopPropagation(),Kt(e,b)}}):(p.onpointerdown=u=>{K()||u.button!==0&&u.pointerType==="mouse"||N(e)||e.phase==="PLACE"&&$n(u,{kind:"slot",cardUid:b,fromSide:t,fromIdx:l})},p.ondblclick=()=>n.onReturnSlotToHand(t,l))}h.onclick=()=>{if(c||N(e)||e.phase!=="PLACE")return;const p=o[l];if(!e.selectedHandCardUid&&p){n.onReturnSlotToHand(t,l);return}n.onPlaceSelected(t,l)},a.appendChild(h)}return a}function da(){if(document.querySelectorAll(".slot.dropHover").forEach(t=>t.classList.remove("dropHover")),!X)return;const e=`.slot[data-slot-side="${X.side}"][data-slot-index="${X.idx}"]`,n=document.querySelector(e);n&&n.classList.add("dropHover")}function ca(e,n){window.onpointermove=t=>{const a=e();if(a.choice||I||!S||t.pointerId!==S.pointerId)return;S.x=t.clientX,S.y=t.clientY;const r=S.x-S.startX,o=S.y-S.startY;!S.dragging&&r*r+o*o>36&&(S.dragging=!0),X=S.dragging?fn(t.clientX,t.clientY,a):null,Bn(document.querySelector("#app")),da()},window.onpointerup=t=>{const a=e();if(!(a.choice||I)&&!(!S||t.pointerId!==S.pointerId)){if(S.dragging){const r=ua(t.clientX,t.clientY),o=fn(t.clientX,t.clientY,a);if(r&&S.kind==="slot"&&S.fromSide!=null&&S.fromIdx!=null){!a.run.finished&&!N(a)&&a.phase==="PLACE"&&n.onReturnSlotToHand(S.fromSide,S.fromIdx),S=null,X=null,x(a,n);return}if(o)if(S.kind==="hand"){const d=e();if(!(d.run.finished||N(d)||d.phase!=="PLACE")){const l=o.side,c=o.idx;if(!(l==="back"&&d.backSlotDisabled?.[c])){const h=l==="front"?d.frontSlots:d.backSlots,b=h[c];if(!b)n.onPlaceHandUidToSlot(S.cardUid,l,c);else{const p=S.fromHandIndex!=null&&S.fromHandIndex>=0?S.fromHandIndex:d.hand.indexOf(S.cardUid),u=d.hand.indexOf(S.cardUid);u>=0&&d.hand.splice(u,1),h[c]=S.cardUid,d.cards[S.cardUid].zone=l;const k=p!=null&&p>=0&&p<=d.hand.length?p:d.hand.length;d.hand.splice(k,0,b),d.cards[b].zone="hand",d.selectedHandCardUid=null,We(d),f(d,`[${V(d,S.cardUid)}] ↔ [${V(d,b)}] 스왑: 손패 ↔ ${l}${c+1}`),x(d,n)}}}}else S.kind==="slot"&&S.fromSide!=null&&S.fromIdx!=null&&(S.fromSide===o.side&&S.fromIdx===o.idx||n.onMoveSlotCard(S.fromSide,S.fromIdx,o.side,o.idx))}S?.sourceEl&&S.sourceEl.classList.remove("isDraggingSource"),S=null,X=null,x(a,n)}},window.addEventListener("keydown",t=>{const a=t.target;if(a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"))return;const r=e();if(t.code==="KeyF"){t.preventDefault(),n.onNewRun();return}if(t.code==="Digit4"){if(t.preventDefault(),N(r)){r.pendingTarget=null,r.pendingTargetQueue=[],r.selectedEnemyIndex=null,f(r,"대상 선택 취소"),x(r,n);return}n.onClearSelected();return}if(t.key==="Tab"){if(t.preventDefault(),r.hand.length===0)return;const o=r.selectedHandCardUid,d=o?r.hand.indexOf(o):-1,l=t.shiftKey?-1:1,c=((d+l)%r.hand.length+r.hand.length)%r.hand.length;r.selectedHandCardUid=r.hand[c],x(r,n);return}if(t.code==="Space"){t.preventDefault();const o=e();if(o.run.finished||o.choice||N(o))return;n.onAutoAdvance();return}if(t.code==="Digit1"||t.code==="Digit2"||t.code==="Digit3"){t.preventDefault();const o=t.code==="Digit1"?0:t.code==="Digit2"?1:2;if(N(r)){const d=r.enemies[o];if(!d||d.hp<=0){f(r,`대상 선택 실패: ${o+1}번 적이 없습니다.`),x(r,n);return}n.onSelectEnemy(o);return}n.onHotkeySlot("front",o);return}if(t.code==="KeyQ"||t.code==="KeyW"||t.code==="KeyE"){t.preventDefault();const o=t.code==="KeyQ"?0:t.code==="KeyW"?1:2;n.onHotkeySlot("back",o);return}if(t.code==="Enter"){t.preventDefault(),!Pn&&ze&&ze();return}})}function $n(e,n){const t=e.currentTarget;try{t.setPointerCapture(e.pointerId)}catch{}const a=t.closest(".card");a&&a.classList.add("isDraggingSource");const r=a?.getBoundingClientRect(),o=r?e.clientX-r.left:20,d=r?e.clientY-r.top:20,l=getComputedStyle(document.documentElement),c=parseFloat(l.getPropertyValue("--handCardW"))||void 0,h=parseFloat(l.getPropertyValue("--handCardH"))||void 0;if(S={kind:n.kind,cardUid:n.cardUid,fromHandIndex:n.fromHandIndex,fromSide:n.fromSide,fromIdx:n.fromIdx,pointerId:e.pointerId,startX:e.clientX,startY:e.clientY,x:e.clientX,y:e.clientY,dragging:!1,previewEl:void 0,previewW:r?.width??c,previewH:r?.height??h,grabDX:o,grabDY:d},a){S.sourceEl=a;const b=a.cloneNode(!0);b.classList.remove("inSlot"),b.classList.remove("selected"),b.classList.remove("isDraggingSource"),b.style.position="static",b.style.inset="",b.style.width="100%",b.style.height="100%",b.style.margin="0",b.style.boxSizing="border-box",S.previewEl=b}}function ua(e,n){const t=document.elementFromPoint(e,n);if(!t)return!1;let a=t;for(;a;){if(a.dataset?.dropHand==="1")return!0;a=a.parentElement}return!1}function fn(e,n,t){const a=document.elementFromPoint(e,n);if(!a)return null;const r=pa(a,["slotSide","slotIndex"]);if(!r)return null;const o=r.dataset.slotSide,d=Number(r.dataset.slotIndex);return o==="back"&&t.backSlotDisabled?.[d]?null:{side:o,idx:d}}function pa(e,n){let t=e;for(;t;){const a=t.dataset;let r=!0;for(const o of n)if(a[o]==null){r=!1;break}if(r)return t;t=t.parentElement}return null}function Bn(e,n){if(K()){document.querySelector(".dragLayer")?.remove();return}if(!S||!S.dragging){document.querySelector(".dragLayer")?.remove();return}let t=document.querySelector(".dragLayer");if(t||(t=document.createElement("div"),t.className="dragLayer",t.style.position="fixed",t.style.inset="0",t.style.zIndex="5000",t.style.pointerEvents="none",document.body.appendChild(t)),t.innerHTML="",!S.previewEl)return;const a=document.createElement("div");a.className="dragCardPreview",a.style.position="fixed",a.style.left=`${S.x-(S.grabDX??20)}px`,a.style.top=`${S.y-(S.grabDY??20)}px`;const r=S.previewW??0,o=S.previewH??0;r>0&&(a.style.width=`${r}px`),o>0&&(a.style.height=`${o}px`),a.style.transform="scale(1.03)",a.style.opacity="0.96",a.style.filter="saturate(1.05)",a.style.willChange="transform,left,top",a.style.boxShadow="0 18px 60px rgba(0,0,0,.55)",a.appendChild(S.previewEl),t.appendChild(a)}function Ue(e,n){const t=e.cards[n];return G(e.content,t.defId,t.upgrade??0)}function Ee(e,n){return e.content.cardsById[n]?.name??n}function An(e,n,t){const a=t??0,r=e.content.cardsById[n]?.name??n;return a>0?`${r} +${a}`:r}function V(e,n){const t=e.cards[n];return An(e,t.defId,t.upgrade??0)}function _n(e,n,t,a,r){const o=e.cards[n],d=G(e.content,o.defId,o.upgrade??0),l=r?.draggable??!0,c=y("card");e.selectedHandCardUid===n&&c.classList.add("selected"),d.tags?.includes("EXHAUST")&&c.classList.add("exhaust"),d.tags?.includes("VANISH")&&c.classList.add("vanish");const h=ve(e,n);c.appendChild(B("cardTitle",h));const b=y("cardMeta");d.tags?.includes("EXHAUST")&&b.appendChild(z("소모")),d.tags?.includes("VANISH")&&b.appendChild(z("소실")),c.appendChild(b);const p=y("cardSection");p.appendChild(B("cardSectionTitle","⚔ 전열")),p.appendChild(B("cardText",d.frontText)),c.appendChild(p);const u=y("cardSection");return u.appendChild(B("cardSectionTitle","🕯 후열")),u.appendChild(B("cardText",d.backText)),c.appendChild(u),t&&(c.onpointerdown=k=>{if(!K()){if(k.button!==0&&k.pointerType==="mouse"||N(e)||e.phase!=="PLACE"||!l)return;const E=e.hand.indexOf(n);$n(k,{kind:"hand",cardUid:n,fromHandIndex:E});return}},K()?En(c,{delayMs:280,moveTolerancePx:6,shouldIgnore:()=>!!N(e),onFire:()=>{Ut(e,n)},onTap:()=>{a&&a(n)}}):t&&a&&(c.onclick=()=>a(n))),c}function y(e){const n=document.createElement("div");return n.className=e,n}function B(e,n){const t=document.createElement("div");return t.className=e,t.textContent=n,t}function fa(e){const n=document.createElement("h2");return n.textContent=e,n}function ha(e){const n=document.createElement("h3");return n.textContent=e,n}function Qe(e){const n=document.createElement("p");return n.textContent=e,n}function ma(e){const n=document.createElement("small");return n.textContent=e,n}function z(e){const n=document.createElement("span");return n.className="badge",n.textContent=e,n}function Hn(e,n,t){const a=document.createElement("button");return a.textContent=e,a.disabled=t,a.onclick=n,a}function ba(e){const n=document.createElement("pre");return n.className="log",n.textContent=e,n}function Ge(e,n){const t=n??0;return t>0?`${e} +${t}`:e}function ve(e,n){const t=e.cards[n],a=e.content.cardsById[t.defId].name;return Ge(a,t.upgrade)}function ya(e,n){const t=e.content.cardsById[n.defId].name;return Ge(t,n.upgrade)}Nn();On();const Ta=Ht();let de=zt(Ta);function In(e){de=e,Ve=wn(de,In),x(de,Ve)}let Ve=wn(de,In);x(de,Ve);
