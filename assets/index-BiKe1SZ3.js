(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&r(d)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();function nn(){const e=document.documentElement,t=180,n=5,r=7,a=3;let o=0;const d=()=>{o=0;const l=getComputedStyle(e),c=window.innerWidth,h=window.innerHeight,f=parseFloat(l.getPropertyValue("--hudH"))||140,p=parseFloat(l.getPropertyValue("--dockH"))||210,T=parseFloat(l.getPropertyValue("--uiGap"))||16,g=parseFloat(l.getPropertyValue("--edgePad"))||14,i=parseFloat(l.getPropertyValue("--logW"))||360,s=parseFloat(l.getPropertyValue("--logGap"))||14,y=parseFloat(l.getPropertyValue("--playerW"))||320,k=parseFloat(l.getPropertyValue("--slotGapXBase"))||22,x=parseFloat(l.getPropertyValue("--slotGapYBase"))||6,v=Math.max(320,c-(y+i+s*2+g*2)),S=Math.max(260,h-(f+p+T)),w=a*t+(a-1)*k,_=t*(r/n),P=parseFloat(l.getPropertyValue("--battleChromeHBase"))||140,I=_*2+x+P,$=v/w,z=S/I,K=Math.min($,z),B=Math.max(.55,Math.min(K,1.25));e.style.setProperty("--u",String(B))},u=()=>{o||(o=requestAnimationFrame(d))};window.addEventListener("resize",u,{passive:!0}),d()}function rn(){let e=!1;const t=()=>{const a=window.innerWidth;!e&&a<1180&&(e=!0),e&&a>1220&&(e=!1),document.body.classList.toggle("compact",e)};let n=0;const r=()=>{n||(n=requestAnimationFrame(()=>{n=0,t()}))};window.addEventListener("resize",r,{passive:!0}),t()}function Ue(e){return[{id:"A",type:e[0]},{id:"B",type:e[1]}]}function Ae(e,t,n){e.status[t]=Math.max(0,(e.status[t]??0)+n)}function Te(e){const t=Ue(qe(e)),n=Ue(qe(e)),r=Ue(qe(e));return{root:t,nextIfA:n,nextIfB:r}}function an(e,t){e.run.branchOffer||(e.run.branchOffer=Te(e));const n=e.run.branchOffer,r=t==="A"?n.nextIfA:n.nextIfB,a=Te(e);e.run.branchOffer={root:r,nextIfA:a.nextIfA,nextIfB:a.nextIfB}}function on(){return Math.random().toString(16).slice(2)+"-"+Date.now().toString(16)}function it(e,t=0){return e<t?t:e}function lt(e){const t=[...e];for(let n=t.length-1;n>0;n--){const r=Math.floor(Math.random()*(n+1));[t[n],t[r]]=[t[r],t[n]]}return t}function R(e,t="pickOne"){if(e.length===0)throw new Error(`${t}: empty array`);return e[Math.floor(Math.random()*e.length)]}function m(e,t){e.log.unshift(t),e.log=e.log.slice(0,250)}function L(e){return e.enemies.filter(t=>t.hp>0)}function qe(e){const t=[],n=e.run.treasureObtained?24:20,r=e.run.treasureObtained?1:4,a=(e.run.treasureObtained,5),d=!e.run.treasureObtained&&e.run.nodePickCount>=30?1:0;for(let c=0;c<n;c++)t.push("BATTLE");for(let c=0;c<r;c++)t.push("REST");for(let c=0;c<a;c++)t.push("EVENT");for(let c=0;c<d;c++)t.push("TREASURE");const u=R(t,"rollNodeOffers pool");let l=R(t,"rollNodeOffers pool");if(u==="TREASURE"){const c=t.filter(h=>h!=="TREASURE");l=R(c,"rollNodeOffers poolNoTreasure")}return[u,l]}function sn(e){return Math.max(0,Math.min(1,e))}function Le(e,t=0){const n=e.player?.fatigue??0,r=sn(t+Math.max(0,n-5)*.12),a=n<=5?0:n<=8?1:n<=11?2:3;return{f:n,p:r,tier:a}}function Xe(e){const t={phase:"NODE",log:[],uidSeq:0,winHooksAppliedThisCombat:!1,intentsRevealedThisTurn:!1,disruptIndexThisTurn:null,backUidsThisTurn:[],run:{encounterCount:0,treasureObtained:!1,afterTreasureNodePicks:0,finished:!1,nextBattleSuppliesBonus:0,nextBossId:null,bossPool:["boss_gravity_master","boss_cursed_wall","boss_giant_orc","boss_soul_stealer"],nodePickCount:0,branchOffer:null,nodeOfferQueue:[],currentNodeOffers:null,nodePickByType:{BATTLE:0,REST:0,EVENT:0,TREASURE:0},battleCount:0,enemyLastSeenBattle:{},nextBossTime:40,forcedNext:null,bossOmenText:null,deckSizeAtTreasure:null,ominousProphecySeen:!1},player:{hp:40,maxHp:40,block:0,supplies:0,fatigue:0,zeroSupplyTurns:0,status:{vuln:0,weak:0,bleed:0,disrupt:0},immuneToDisruptThisTurn:!1,nullifyDamageThisTurn:!1},content:e,cards:{},deck:[],hand:[],discard:[],exhausted:[],vanished:[],choice:null,choiceStack:[],frontSlots:[null,null,null],backSlots:[null,null,null],backSlotDisabled:[!1,!1,!1],enemies:[],attackedEnemyIndicesThisTurn:[],usedThisTurn:0,frontPlacedThisTurn:0,selectedHandCardUid:null,pendingTargetQueue:[],pendingTarget:null,drawCountThisTurn:0,time:0};return t.run.branchOffer=Te(t),ln(t),m(t,"새 런 시작."),t}function ae(e,t,n){for(let r=0;r<n;r++){const a=on(),o={uid:a,defId:t,zone:"deck",upgrade:0};e.cards[a]=o,e.deck.push(a)}}function ln(e){ae(e,"field_ration",2),ae(e,"maintenance",2),ae(e,"scout",2),ae(e,"shield",2),ae(e,"power_arrow",1),ae(e,"arrow",3),e.deck=lt(e.deck)}function Q(e,t){const n=e.cards[t],r=e.content.cardsById[n.defId],a=n.upgrade??0,o=r.upgrades?.[a-1];return o?{...r,...o}:r}function re(e,t,n){const r=e.cardsById[t],a=Math.max(0,n|0);if(a<=0)return r;const o=r.upgrades?.[a-1];return o?{...r,...o}:r}function oe(e,t){const r=e.cards[t].upgrade??0,a=Q(e,t);return r>0?`${a.name} +${r}`:a.name}const dn=[{id:"field_ration",name:"야전 식량",frontText:"방어 +3",backText:"S +2",front:[{op:"block",n:3}],back:[{op:"supplies",n:2}],upgrades:[{frontText:"방어 +5",front:[{op:"block",n:5}],backText:"S +3",back:[{op:"supplies",n:3}]}]},{id:"maintenance",name:"정비 도구",exhaustWhen:"BACK",frontText:"방어 +3",backText:"F -1, 소모",front:[{op:"block",n:3}],back:[{op:"fatigue",n:-1}],upgrades:[{frontText:"방어 +5",front:[{op:"block",n:5}],backText:"F -1, S +1, 소모",back:[{op:"fatigue",n:-1},{op:"supplies",n:1}]}]},{id:"scout",name:"정찰",frontText:"지정 3 피해, 방어 +1",backText:"드로우 1, S +2",front:[{op:"damageEnemy",target:"select",n:3},{op:"block",n:1}],back:[{op:"draw",n:1},{op:"supplies",n:2}],upgrades:[{frontText:"지정 4 피해, 방어 +2",front:[{op:"damageEnemy",target:"select",n:4},{op:"block",n:2}],backText:"드로우 2, S +2",back:[{op:"draw",n:2},{op:"supplies",n:2}]}]},{id:"shield",name:"방패",frontText:"방어 +5",backText:"방어 +3",front:[{op:"block",n:5}],back:[{op:"block",n:3}],upgrades:[{frontText:"방어 +7",front:[{op:"block",n:7}],backText:"방어 +4",back:[{op:"block",n:4}]}]},{id:"power_arrow",name:"강력한 화살",frontText:"무작위 10 피해, S -2",backText:"무작위 7 피해, S -2",front:[{op:"supplies",n:-2},{op:"damageEnemy",target:"random",n:10}],back:[{op:"supplies",n:-2},{op:"damageEnemy",target:"random",n:7}],upgrades:[{frontText:"무작위 13 피해, S -2",front:[{op:"supplies",n:-2},{op:"damageEnemy",target:"random",n:13}],backText:"무작위 10 피해, S -2",back:[{op:"supplies",n:-2},{op:"damageEnemy",target:"random",n:10}]}]},{id:"arrow",name:"화살",frontText:"지정 5 피해",backText:"지정 5 피해, S -1",front:[{op:"damageEnemy",target:"select",n:5}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:5}],upgrades:[{frontText:"지정 7 피해",front:[{op:"damageEnemy",target:"select",n:7}],backText:"지정 7 피해, S -1",back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:7}]}]},{id:"goal_treasure",name:"저주받은 보물",exhaustWhen:"BOTH",frontText:"F +1, 소모",backText:"S -1, F +1, 소모",front:[{op:"fatigue",n:1}],back:[{op:"supplies",n:-1},{op:"fatigue",n:1}]},{id:"berserk",name:"광폭화",frontText:"무작위 15 피해, F +1",backText:"S +4, F +1",front:[{op:"damageEnemy",target:"random",n:15},{op:"fatigue",n:1}],back:[{op:"supplies",n:4},{op:"fatigue",n:1}],upgrades:[{frontText:"무작위 20 피해, F +2",front:[{op:"damageEnemy",target:"random",n:20},{op:"fatigue",n:2}],backText:"S +6, F +2",back:[{op:"supplies",n:6},{op:"fatigue",n:2}]}]},{id:"bandage",name:"붕대",exhaustWhen:"BOTH",frontText:"HP +4, 소모",backText:"HP +4, S -1, 소모",front:[{op:"heal",n:4}],back:[{op:"supplies",n:-1},{op:"heal",n:4}],upgrades:[{frontText:"HP +4, 출혈 제거, 소모",front:[{op:"heal",n:4},{op:"clearStatusSelf",key:"bleed"}],backText:"HP +4, 출혈 제거, S -1, 소모",back:[{op:"supplies",n:-1},{op:"heal",n:4},{op:"clearStatusSelf",key:"bleed"}]}]},{id:"arrow_rain",name:"화살의 비",exhaustWhen:"BOTH",frontText:"모든 적에게 10 피해, S -1, F +1, 소모",backText:"드로우 2, S +2, F +1, 소모",front:[{op:"damageEnemy",target:"all",n:10},{op:"supplies",n:-1},{op:"fatigue",n:1}],back:[{op:"draw",n:2},{op:"supplies",n:2},{op:"fatigue",n:1}],upgrades:[{frontText:"모든 적에게 13 피해, S -2, F +1, 소모",front:[{op:"damageEnemy",target:"all",n:13},{op:"supplies",n:-2},{op:"fatigue",n:1}],backText:"드로우 3, S +3, F +2, 소모",back:[{op:"draw",n:3},{op:"supplies",n:3},{op:"fatigue",n:2}]}]},{id:"smoke",name:"연막",exhaustWhen:"FRONT",frontText:"이번 턴 적 공격 피해 무효, 소모",backText:"자신은 교란 당하지 않음",front:[{op:"nullifyDamageThisTurn"}],back:[{op:"immuneDisruptThisTurn"}]},{id:"redeploy",name:"재배치",frontText:"S +2",backText:"3번 슬롯에 있는 후열 카드의 전열 효과 발동",front:[{op:"supplies",n:2}],back:[{op:"triggerFrontOfBackSlot",index:2}],upgrades:[{frontText:"S +3",front:[{op:"supplies",n:3}],backText:"3번 슬롯에 있는 후열 카드의 전열 효과 발동, S +1",back:[{op:"triggerFrontOfBackSlot",index:2},{op:"supplies",n:1}]}]},{id:"secret_strike",name:"비장의 일격",exhaustWhen:"BOTH",frontText:"무작위 (F의 3배) 피해, 소모",backText:"모든 적에게 취약 +4 및 약화 +4, 소모",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:3}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:4},{op:"statusEnemy",target:"all",key:"weak",n:4}],upgrades:[{exhaustWhen:"FRONT",frontText:"지정 (F의 3배) 피해, 소모",front:[{op:"damageEnemyByPlayerFatigue",target:"select",mult:3}],backText:"모든 적에게 취약 +4 및 약화 +4",back:[{op:"statusEnemy",target:"all",key:"vuln",n:4},{op:"statusEnemy",target:"all",key:"weak",n:4}]}]},{id:"fire_scroll",name:"화염 두루마리",exhaustWhen:"BOTH",frontText:"방어 +7, 소모",backText:"모든 적에게 12 피해, 소모",front:[{op:"block",n:7}],back:[{op:"damageEnemy",target:"all",n:12}],upgrades:[{frontText:"방어 +8, 소모",front:[{op:"block",n:8}],backText:"모든 적에게 14 피해, 소모",back:[{op:"damageEnemy",target:"all",n:14}]}]},{id:"caltrops",name:"마름쇠",frontText:"모든 적에게 출혈 4 부여",backText:"이번 턴에 자신을 공격하려는 적에게 출혈 3 부여",front:[{op:"statusEnemy",target:"all",key:"bleed",n:4}],back:[{op:"statusEnemiesAttackingThisTurn",key:"bleed",n:3}],upgrades:[{frontText:"모든 적에게 출혈 5 부여",backText:"이번 턴에 자신을 공격하려는 적에게 출혈 4 부여",front:[{op:"statusEnemy",target:"all",key:"bleed",n:5}],back:[{op:"statusEnemiesAttackingThisTurn",key:"bleed",n:4}]}]},{id:"emergency_rations",name:"비상식량",vanishWhen:"BACK",frontText:"S +2",backText:"S를 10으로 만듦. 소실",front:[{op:"supplies",n:2}],back:[{op:"setSupplies",n:10}],upgrades:[{frontText:"S +3",backText:"S를 15으로 만듦. 소실",front:[{op:"supplies",n:3}],back:[{op:"setSupplies",n:15}]}]},{id:"painkiller",name:"진통제",exhaustWhen:"BOTH",frontText:"HP -8, F -2, 소모",backText:"HP +8, F +2, 소모",front:[{op:"hp",n:-8},{op:"fatigue",n:-2}],back:[{op:"hp",n:8},{op:"fatigue",n:2}],upgrades:[{frontText:"HP -6, F -2, 소모",backText:"HP +10, F +2, 소모",front:[{op:"hp",n:-6},{op:"fatigue",n:-2}],back:[{op:"hp",n:10},{op:"fatigue",n:2}]}]},{id:"field_experience",name:"실전 경험",exhaustWhen:"BACK",frontText:"모든 적에게 3 피해",backText:"이 카드가 후열에 있는 턴에 승리하면 최대 체력 +2, 소모",front:[{op:"damageEnemy",target:"all",n:3}],back:[],onWinWhileInBack:[{op:"maxHp",n:2}],upgrades:[{frontText:"모든 적에게 4 피해",backText:"이 카드가 후열에 있는 턴에 승리하면 최대 체력 +3, 소모",front:[{op:"damageEnemy",target:"all",n:4}],onWinWhileInBack:[{op:"maxHp",n:3}]}]},{id:"camp_prep",name:"야영 준비",frontText:"방어 +4, S +1",backText:"S +3",front:[{op:"block",n:4},{op:"supplies",n:1}],back:[{op:"supplies",n:3}],upgrades:[{frontText:"방어 +5, S +2",backText:"S +5",front:[{op:"block",n:5},{op:"supplies",n:2}],back:[{op:"supplies",n:5}]}]},{id:"vital_shot",name:"급소 사격",frontText:"지정 8 피해",backText:"지정 5 피해, 출혈 2 부여, S -1",front:[{op:"damageEnemy",target:"select",n:8}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:5},{op:"statusEnemy",target:"select",key:"bleed",n:2}],upgrades:[{frontText:"지정 11 피해",backText:"지정 6 피해, 출혈 3 부여, S -1",front:[{op:"damageEnemy",target:"select",n:11}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:6},{op:"statusEnemy",target:"select",key:"bleed",n:3}]}]},{id:"taunt",name:"독설",frontText:"지정 약화 +4",backText:"모든 적에게 취약 +2 및 약화 +2",front:[{op:"statusEnemy",target:"select",key:"weak",n:4}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:2},{op:"statusEnemy",target:"all",key:"weak",n:2}],upgrades:[{frontText:"지정 약화 +5",backText:"모든 적에게 취약 +2 및 약화 +3",front:[{op:"statusEnemy",target:"select",key:"weak",n:5}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:2},{op:"statusEnemy",target:"all",key:"weak",n:3}]}]},{id:"rapid_fire",name:"연속 사격",frontText:"지정 2 피해, 3번 발동",backText:"이번 턴에 카드를 뽑았으면 무작위 8 피해",front:[{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2}],back:[{op:"ifDrewThisTurn",then:[{op:"damageEnemy",target:"random",n:8}]}],upgrades:[{frontText:"지정 2 피해, 4번 발동",backText:"이번 턴에 카드를 뽑았으면 무작위 10 피해",front:[{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2}],back:[{op:"ifDrewThisTurn",then:[{op:"damageEnemy",target:"random",n:10}]}]}]},{id:"mad_echo",name:"메아리",frontText:"무작위 (F) 피해",backText:"드로우 1, S +2, F +1",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:1}],back:[{op:"draw",n:1},{op:"supplies",n:2},{op:"fatigue",n:1}],upgrades:[{frontText:"무작위 (F의 2배) 피해",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:2}],backText:"드로우 2, S +2, F +1",back:[{op:"draw",n:2},{op:"supplies",n:2},{op:"fatigue",n:1}]}]},{id:"mad_insight",name:"금단의 통찰",exhaustWhen:"BOTH",frontText:"방어 +8, 드로우 1, F +1, 소모",backText:"드로우 3, S +2, F +2, 소모",front:[{op:"block",n:8},{op:"draw",n:1},{op:"fatigue",n:1}],back:[{op:"draw",n:3},{op:"supplies",n:2},{op:"fatigue",n:2}],upgrades:[{frontText:"방어 +10, 드로우 2, F +1, 소모",front:[{op:"block",n:10},{op:"draw",n:2},{op:"fatigue",n:1}],backText:"드로우 4, S +3, F +2, 소모",back:[{op:"draw",n:4},{op:"supplies",n:3},{op:"fatigue",n:2}]}]},{id:"mad_bargain",name:"거래의 잔재",exhaustWhen:"BOTH",frontText:"지정 12 피해, S -1, F +1, 소모",backText:"HP +6, F +2, 소모",front:[{op:"damageEnemy",target:"select",n:12},{op:"supplies",n:-1},{op:"fatigue",n:1}],back:[{op:"heal",n:6},{op:"fatigue",n:2}],upgrades:[{frontText:"지정 16 피해, S -1, F +1, 소모",front:[{op:"damageEnemy",target:"select",n:16},{op:"supplies",n:-1},{op:"fatigue",n:1}],backText:"HP +8, F +2, 소모",back:[{op:"heal",n:8},{op:"fatigue",n:2}]}]}],cn=Object.fromEntries(dn.map(e=>[e.id,e])),un=[{id:"other_adventurer",name:"보물을 노리는 다른 모험가",maxHp:60,intents:[{label:"창 찌르기: 5 피해, 3번 발동",acts:[{op:"damagePlayer",n:5},{op:"damagePlayer",n:5},{op:"damagePlayer",n:5}]},{label:"독약 뿌리기: 출혈 +4, 취약 +4, 약화 +4 부여",acts:[{op:"statusPlayer",key:"bleed",n:4},{op:"statusPlayer",key:"vuln",n:4},{op:"statusPlayer",key:"weak",n:4}]}]},{id:"goblin_raider",name:"고블린 약탈자",maxHp:20,intents:[{label:"기습: 12 - 이번 턴에 사용한 카드의 수만큼 피해",acts:[{op:"damagePlayerFormula",kind:"goblin_raider"}]},{label:"훔치기: 출혈 +2 부여, S -3",acts:[{op:"supplies",n:-3},{op:"statusPlayer",key:"bleed",n:2}]}]},{id:"watching_statue",name:"감시하는 석상",maxHp:25,intents:[{label:"감시: 4 + 이번 턴에 사용한 카드의 수만큼 피해",acts:[{op:"damagePlayerFormula",kind:"watching_statue"}]}]},{id:"pebble_golem",name:"조약돌 골렘",maxHp:30,intents:[{label:"조약돌 던지기: 8 피해",acts:[{op:"damagePlayer",n:8}]},{label:"모래 모으기: 자신 HP 6 회복",acts:[{op:"enemyHealSelf",n:6}]}]},{id:"rock_golem",name:"바위 골렘",maxHp:50,intents:[{label:"바위 던지기: 10 피해",acts:[{op:"damagePlayer",n:10}]},{label:"땅 모으기: 자신 HP 10 회복",acts:[{op:"enemyHealSelf",n:10}]}]},{id:"slime",name:"슬라임",maxHp:30,intents:[{label:"유연한 몸: 다음 턴 동안 피해를 입지 않음",acts:[{op:"enemyImmuneNextTurn"}]},{label:"산성액: 약화 +3 부여 후 자신 HP 3 회복",acts:[{op:"statusPlayer",key:"weak",n:3},{op:"enemyHealSelf",n:3}]},{label:"때리기: 6 피해",acts:[{op:"damagePlayer",n:6}]}]},{id:"poison_spider",name:"독거미",maxHp:28,intents:[{label:"독니로 물기: 출혈 +4 부여",acts:[{op:"statusPlayer",key:"bleed",n:4}]},{label:"송곳니로 물기: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"단번에 물기: 출혈 +2 부여, 6 피해",acts:[{op:"statusPlayer",key:"bleed",n:2},{op:"damagePlayer",n:6}]}]},{id:"gravity_echo",name:"중력의 잔향",maxHp:26,intents:[{label:"하중 인장",acts:[{op:"damagePlayerByDeckSize",base:5,per:2,div:6,cap:18}]},{label:"압축: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"놓치게 만들기: S -3",acts:[{op:"supplies",n:-3}]}]},{id:"boss_gravity_master",name:"중력 통달자",omen:"몸이 점점 무겁다.",maxHp:70,intents:[{label:"중력 수축: 약화 +3 부여",acts:[{op:"statusPlayer",key:"weak",n:3}]},{label:"특이점 생성",acts:[{op:"damagePlayerByDeckSize",base:8,per:3,div:5,cap:30}]},{label:"천장 붕괴: 11 피해",acts:[{op:"damagePlayer",n:11}]}]},{id:"boss_cursed_wall",name:"저주받은 벽",omen:"움직이지 않는다. 당신이 닳아간다.",maxHp:120,intents:[{label:"저주의 기운: F +1",acts:[{op:"fatiguePlayer",n:1}]},{label:"아무 행동도 하지 않음",acts:[]}]},{id:"boss_giant_orc",name:"거대한 오크",omen:"거대한 무언가가 기다린다.",maxHp:80,intents:[{label:"내려치기: 15 피해",acts:[{op:"damagePlayer",n:15}]},{label:"단단한 피부: 다음 턴 동안 피해를 입지 않음",acts:[{op:"enemyImmuneNextTurn"}]},{label:"타고난 회복: 자신 HP 15 회복",acts:[{op:"enemyHealSelf",n:15}]}]},{id:"boss_soul_stealer",name:"영혼 강탈자",omen:"행동하지 않으면 종말이 오리라.",maxHp:60,intents:[{label:"허기: 7 피해, S -2",acts:[{op:"damagePlayer",n:7},{op:"supplies",n:-2}]},{label:"나태: 7 피해, F +1",acts:[{op:"damagePlayer",n:7},{op:"fatiguePlayer",n:1}]},{label:"예언: 카운트 진행",acts:[]}]}],pn=Object.fromEntries(un.map(e=>[e.id,e]));function mt(e,t){const n=e.game,r={kind:"damageSelect",amount:t,sourceCardUid:e.cardUid,reason:e.side==="front"?"FRONT":"BACK"};n.pendingTargetQueue??=[],n.pendingTarget==null?n.pendingTarget=r:n.pendingTargetQueue.push(r),m(n,`대상 선택 필요: 적을 클릭하세요. (${1+n.pendingTargetQueue.length}개 남음)`)}function fn(e,t,n){const r=e.game,a={kind:"statusSelect",key:t,n,sourceCardUid:e.cardUid,reason:e.side==="front"?"FRONT":"BACK"};r.pendingTargetQueue??=[],r.pendingTarget==null?r.pendingTarget=a:r.pendingTargetQueue.push(a),m(r,"대상 선택 필요: 적을 클릭하세요.")}function hn(e,t){if(t.id==="boss_soul_stealer"&&t.soulWillNukeThisTurn)return!0;const n=e.content.enemiesById[t.id];return n.intents[t.intentIndex%n.intents.length].acts.some(a=>a.op==="damagePlayer"||a.op==="damagePlayerFormula"||a.op==="damagePlayerByDeckSize")}function ge(e,t){const n=e.game;for(const r of t)switch(r.op){case"block":Dn(n,r.n);break;case"supplies":Fn(n,r.n);break;case"fatigue":ne(n,r.n);break;case"heal":Wn(n,r.n);break;case"hp":n.player.hp=Math.max(0,Math.min(n.player.maxHp,n.player.hp+r.n)),m(n,`HP ${r.n>=0?"+":""}${r.n} (현재 ${n.player.hp}/${n.player.maxHp})`);break;case"maxHp":n.player.maxHp+=r.n,n.player.hp=Math.min(n.player.maxHp,n.player.hp+r.n),m(n,`최대 HP +${r.n} (현재 ${n.player.hp}/${n.player.maxHp})`);break;case"setSupplies":n.player.supplies=Math.max(0,r.n),m(n,`보급 S를 ${n.player.supplies}으로 설정`);break;case"draw":{const a=ct(n,r.n);n.drawCountThisTurn+=a;break}case"ifDrewThisTurn":{n.drawCountThisTurn>0&&ge(e,r.then);break}case"damageEnemy":if(r.target==="random"){const a=L(n);if(a.length===0)break;ye(n,R(a),r.n)}else if(r.target==="all")for(const a of L(n))ye(n,a,r.n);else mt(e,r.n);break;case"clearStatusSelf":{const a=r.key;n.player.status[a]=0,m(n,`상태 해제: ${a} = 0`);break}case"damageEnemyBy":{if(r.target!=="random")break;const a=L(n);if(a.length===0)break;let o=0;r.by==="frontCount"&&(o=n.frontSlots.filter(Boolean).length*r.nPer),ye(n,R(a),o);break}case"damageEnemyByPlayerFatigue":{const a=Math.max(0,n.player.fatigue*r.mult);if(r.target==="random"){const o=L(n);if(o.length===0)break;ye(n,R(o),a);break}if(r.target==="select"){if(a<=0)break;mt(e,a);break}break}case"statusPlayer":n.player.status[r.key]=Math.max(0,(n.player.status[r.key]??0)+r.n),m(n,`플레이어 상태: ${r.key} ${r.n>=0?"+":""}${r.n}`);break;case"statusEnemy":if(r.target==="random"){const a=L(n);if(a.length===0)break;const o=R(a);Ae(o,r.key,r.n),m(n,`적(${o.name}) 상태: ${r.key} ${r.n>=0?"+":""}${r.n}`)}else if(r.target==="all"){const a=L(n);if(a.length===0)break;for(const o of a)Ae(o,r.key,r.n);m(n,`모든 적 상태: ${r.key} ${r.n>=0?"+":""}${r.n}`)}else fn(e,r.key,r.n);break;case"statusEnemiesAttackingThisTurn":{const a=L(n).filter(o=>hn(n,o));if(a.length===0){m(n,`이번 턴 공격 의도 적 없음 → ${r.key} 적용 없음`);break}for(const o of a)o.status[r.key]=Math.max(0,(o.status[r.key]??0)+r.n);m(n,`공격 의도 적에게 ${r.key} ${r.n>=0?"+":""}${r.n} (대상 ${a.length})`);break}case"immuneDisruptThisTurn":n.player.immuneToDisruptThisTurn=!0,m(n,"이번 턴 교란 무시");break;case"nullifyDamageThisTurn":n.player.nullifyDamageThisTurn=!0,m(n,"이번 턴 적 공격 피해 무효");break;case"triggerFrontOfBackSlot":{const a=n.backSlots[r.index];if(!a){m(n,`재배치: 후열 ${r.index+1}번 슬롯이 비어 있음`);break}const o=Q(n,a);m(n,`재배치: [[${oe(n,a)}]]의 전열 효과를 추가 발동`),ge({game:n,side:"front",cardUid:a},o.front);break}default:return r}}function He(e,t=10,n=16){const r=Math.max(0,e-n),a=Math.ceil(Math.sqrt(r));return t+a}function Ke(e,t){const n=e.content.enemiesById[t];return{id:n.id,name:n.name,hp:n.maxHp,maxHp:n.maxHp,intentIndex:0,status:{vuln:0,weak:0,bleed:0,disrupt:0},immuneThisTurn:!1,immuneNextTurn:!1,lastIntentKey:null,lastIntentStreak:0,soulWarnCount:t==="boss_soul_stealer"?0:void 0,soulArmed:t==="boss_soul_stealer"?!1:void 0,soulWillNukeThisTurn:t==="boss_soul_stealer"?!1:void 0}}function mn(e,t,n,r=5){for(const a of t){const o=e.run.enemyLastSeenBattle[a];if(o!=null&&n-o<r)return!1}return!0}function pe(e,t){const n=t?.forceBoss??!1,r=e.run.nodePickCount,a=e.run.battleCount+1;if(t?.forcePatternIds&&t.forcePatternIds.length>0){const g=t.forcePatternIds;e.run.battleCount=a;for(const i of g)e.run.enemyLastSeenBattle[i]=a;e.enemies=g.map(i=>Ke(e,i)),m(e,`전투 시작! (노드 ${r}, 전투 ${a}회차) 적: ${e.enemies.map(i=>i.name).join(", ")}`);return}if(n)if(e.run.bossPool.length===0&&!e.run.nextBossId)m(e,`보스 풀이 비었습니다. 일반 전투로 진행합니다. (노드 ${r})`);else{let g=e.run.nextBossId??null;if(g!=null){const s=e.content.enemiesById[g];e.run.bossOmenText=Dt[g]??s.omen??null}g?(e.run.nextBossId=null,e.run.bossPool=e.run.bossPool.filter(s=>s!==g)):(g=R(e.run.bossPool),e.run.bossPool=e.run.bossPool.filter(s=>s!==g)),e.enemies=[Ke(e,g)];const i=e.run;i.ominousProphecySeen=!1,m(e,`보스 등장! (노드 ${r}) 적: ${e.enemies[0].name}`);return}const o=[[["goblin_raider"],["watching_statue"],["pebble_golem"],["slime"]],[["goblin_raider","slime"],["pebble_golem","pebble_golem"],["rock_golem"],["goblin_raider","goblin_raider"],["poison_spider"]],[["goblin_raider","goblin_raider","goblin_raider"],["pebble_golem","pebble_golem","slime"],["rock_golem","pebble_golem"],["slime","slime"],["poison_spider","slime"],["gravity_echo"]]],d=[["gravity_echo","poison_spider"],["poison_spider","slime"],["watching_statue","slime"],["watching_statue","watching_statue"],["poison_spider","poison_spider"],["rock_golem","gravity_echo"],["goblin_raider","goblin_raider","watching_statue"]],u=(e.run.nodePickCount??0)+(e.time??0),l=Math.min(o.length-1,Math.floor(Math.max(0,u)/10)),c=e.run.treasureObtained?d:o[l],h=5,f=c.filter(g=>mn(e,g,a,h)),p=f.length>0?f:c,T=R(p);e.run.battleCount=a;for(const g of T)e.run.enemyLastSeenBattle[g]=a;e.enemies=T.map(g=>Ke(e,g)),m(e,`전투 시작! (노드 ${r}, 전투 ${a}회차) 적: ${e.enemies.map(g=>g.name).join(", ")}`)}function fe(e){e.player.block=0,e.player.status.vuln=0,e.player.status.weak=0,e.player.status.bleed=0,e.player.status.disrupt=0,e.player.zeroSupplyTurns=0,e.phase="REVEAL",e.frontSlots=[null,null,null],e.backSlots=[null,null,null],e.backSlotDisabled=[!1,!1,!1],e.backUidsThisTurn=[],e.hand=[],e.selectedHandCardUid=null,e.pendingTarget=null,e.pendingTargetQueue=[],e.usedThisTurn=0,e.winHooksAppliedThisCombat=!1;const t=e.run.nextBattleSuppliesBonus??0;e.player.supplies=7+t,t!==0&&(m(e,`다음 전투 보너스 적용: S +${t}`),e.run.nextBattleSuppliesBonus=0),e.player.immuneToDisruptThisTurn=!1,e.player.nullifyDamageThisTurn=!1,e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null,e.drawCountThisTurn=0,e.attackedEnemyIndicesThisTurn=[],e.frontPlacedThisTurn=0,e.usedThisTurn=0,ct(e,4),dt(e),e.phase="PLACE",e.victoryResolvedThisCombat=!1}function yn(e){return e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length}function bn(e,t){const n=Math.ceil(t/e.div);let r=e.base+e.per*n;return e.cap!=null&&(r=Math.min(r,e.cap)),{dmg:r,scale:n}}const xn={other_adventurer:new Set([1]),slime:new Set([0,1]),pebble_golem:new Set([1]),rock_golem:new Set([1]),poison_spider:new Set([0,2]),boss_cursed_wall:new Set([0]),boss_giant_orc:new Set([1])};function kn(e,t){const n=xn[e];return!!n&&n.has(t)}function Ye(e){if(e===null)return"null";const t=typeof e;return t==="number"||t==="boolean"?String(e):t==="string"?JSON.stringify(e):Array.isArray(e)?"["+e.map(Ye).join(",")+"]":t==="object"?"{"+Object.keys(e).sort().map(r=>JSON.stringify(r)+":"+Ye(e[r])).join(",")+"}":JSON.stringify(String(e))}function Ot(e){if(!e)return"NONE";const t={};for(const n of Object.keys(e))n==="label"||n==="text"||n==="desc"||n==="name"||(t[n]=e[n]);return t.effects&&Array.isArray(t.effects)&&(t.effects=t.effects.map(n=>{const r={};for(const a of Object.keys(n??{}))a==="label"||a==="text"||a==="desc"||a==="name"||(r[a]=n[a]);return r})),Ye(t)}function Tn(e,t){const n=e.lastIntentKey??null,r=e.lastIntentStreak??0;n===t?e.lastIntentStreak=Math.min(3,r+1):(e.lastIntentKey=t,e.lastIntentStreak=1)}function gn(e,t,n,r,a){const o=e.length;if(o<=1)return 0;const d=Array.from({length:o},(p,T)=>T),u=p=>p===t&&kn(n,p),l=p=>!!r&&a>=2&&Ot(e[p])===r,c=d.filter(p=>!u(p)&&!l(p));if(c.length>0)return R(c);const h=d.filter(p=>!l(p));if(h.length>0)return R(h);const f=d.filter(p=>!u(p));return f.length>0?R(f):R(d)}const Cn=2,En=.6;function dt(e){if(e.intentsRevealedThisTurn)return;e.intentsRevealedThisTurn=!0,e.attackedEnemyIndicesThisTurn=[],e.backUidsThisTurn=[],e.drawCountThisTurn=0,e.phase="REVEAL",e.player.immuneToDisruptThisTurn=!1,e.player.nullifyDamageThisTurn=!1,e.disruptIndexThisTurn=null,e.backSlotDisabled=[!1,!1,!1],(e.player.status.disrupt??0)>0&&(e.disruptIndexThisTurn=Math.floor(Math.random()*3),e.backSlotDisabled[e.disruptIndexThisTurn]=!0);for(const n of e.enemies)n.immuneThisTurn=n.immuneNextTurn,n.immuneNextTurn=!1;for(const n of L(e)){n.intentLabelOverride=void 0;const a=e.content.enemiesById[n.id].intents;if(!a||a.length===0)continue;const o=gn(a,n.intentIndex??0,n.id,n.lastIntentKey??null,n.lastIntentStreak??0);n.intentIndex=o;const d=a[o%a.length];if(Tn(n,Ot(d)),n.id==="boss_soul_stealer"){n.soulWillNukeThisTurn=!1;const h=n.soulWarnCount??0;if(!!n.soulArmed){if(Math.random()<En){n.soulWillNukeThisTurn=!0,n.intentLabelOverride="종말: 50 피해",m(e,`적 의도: ${n.name} → ${n.intentLabelOverride}`);continue}const T=a[n.intentIndex%a.length];n.intentLabelOverride=`${T.label} (⚠ 폭발 가능 상태)`,m(e,`적 의도: ${n.name} → ${n.intentLabelOverride}`);continue}const p=a[n.intentIndex%a.length];n.intentLabelOverride=`${p.label} (경고 ${h}/3)`,m(e,`적 의도: ${n.name} → ${n.intentLabelOverride}`);continue}const u=a[n.intentIndex%a.length];let l=u.label;const c=u.acts.find(h=>h.op==="damagePlayerByDeckSize");if(c&&c.op==="damagePlayerByDeckSize"){const h=yn(e),{dmg:f}=bn(c,h);l=`${u.label.split(":")[0].trim()}: ${f} 피해`}n.intentLabelOverride=l,m(e,`적 의도: ${n.name} → ${l}`)}e.disruptIndexThisTurn!==null&&m(e,`교란: 이번 턴 후열 ${e.disruptIndexThisTurn} 무효`),e.phase="PLACE"}function yt(e,t,n,r){if(e.phase!=="PLACE"||!e.hand.includes(t))return;n==="back"&&(e.backUidsThisTurn.includes(t)||e.backUidsThisTurn.push(t));const a=n==="front"?e.frontSlots:e.backSlots;a[r]||(e.hand=e.hand.filter(o=>o!==t),a[r]=t,e.cards[t].zone=n,e.usedThisTurn+=1,m(e,`[${oe(e,t)}]를 ${n==="front"?"전열":"후열"} ${r}번에 배치`),n==="front"&&(e.frontPlacedThisTurn+=1))}function bt(e,t,n){return Q(e,t).tags?.includes(n)??!1}function Sn(e,t){e.frontSlots=e.frontSlots.map(n=>n===t?null:n),e.backSlots=e.backSlots.map(n=>n===t?null:n)}function xt(e,t,n){const r=Q(e,t);Sn(e,t),e.hand=e.hand.filter(l=>l!==t),e.deck=e.deck.filter(l=>l!==t),e.discard=e.discard.filter(l=>l!==t);const a=r.vanishWhen,o=r.exhaustWhen,d=a==="BOTH"||a==="FRONT"&&n==="front"||a==="BACK"&&n==="back",u=o==="BOTH"||o==="FRONT"&&n==="front"||o==="BACK"&&n==="back";if(a&&a!=="NONE"&&d){e.vanished.push(t),e.cards[t].zone="vanished",m(e,`[${oe(e,t)}] 소실(영구 제거)`);return}if(o&&o!=="NONE"&&u){e.exhausted.push(t),e.cards[t].zone="exhausted",m(e,`[${oe(e,t)}] 소모(이번 전투에서 제거)`);return}if(!a&&bt(e,t,"VANISH")){e.vanished.push(t),e.cards[t].zone="vanished",m(e,`[${oe(e,t)}] 소실(영구 제거)`);return}if(!o&&bt(e,t,"EXHAUST")){e.exhausted.push(t),e.cards[t].zone="exhausted",m(e,`[${oe(e,t)}] 소모(이번 전투에서 제거)`);return}e.discard.push(t),e.cards[t].zone="discard"}function wn(e){for(let t=0;t<3;t++){const n=e.frontSlots[t];n&&xt(e,n,"front"),e.frontSlots[t]=null;const r=e.backSlots[t];r&&xt(e,r,"back"),e.backSlots[t]=null}}function vn(e){if(!(e.phase!=="PLACE"&&e.phase!=="BACK")){e.phase="BACK",m(e,"=== 후열 단계 ===");for(let t=0;t<3;t++){const n=e.backSlots[t];if(!n)continue;const r=Q(e,n);if(!e.player.immuneToDisruptThisTurn&&e.backSlotDisabled[t]){m(e,`후열 ${t}번 [${r.name}] 교란으로 무효`);continue}ge({game:e,side:"back",cardUid:n},r.back)}e.phase="FRONT"}}function Pn(e){if(e.phase==="FRONT"){m(e,"=== 전열 단계 ===");for(let t=0;t<3;t++){const n=e.frontSlots[t];if(!n)continue;const r=Q(e,n);ge({game:e,side:"front",cardUid:n},r.front)}e.phase="ENEMY"}}function $n(e){if(e.phase==="ENEMY"){m(e,"=== 적 행동 ===");for(const t of L(e)){const n=e.content.enemiesById[t.id],r=n.intents[t.intentIndex%n.intents.length];if(t.id==="boss_soul_stealer"){if(t.soulWillNukeThisTurn){const a=t.status.weak??0;te(e,50,"ENEMY_ATTACK","영혼 강탈자",a),m(e,"영혼 강탈자: 영혼 폭발 → 50 피해!"),t.soulWillNukeThisTurn=!1,t.soulArmed=!1,t.soulWarnCount=0;continue}for(const a of r.acts)kt(e,t,a);t.intentIndex===Cn&&(t.soulWarnCount=(t.soulWarnCount??0)+1,m(e,`영혼 강탈자: 경고 +1 (${t.soulWarnCount}/3)`),(t.soulWarnCount??0)>=3&&(t.soulArmed=!0,m(e,"영혼 강탈자: 경고 3회 완료 → 폭발 가능 상태!")));continue}for(const a of r.acts)kt(e,t,a)}e.phase="UPKEEP"}}function kt(e,t,n){switch(n.op){case"damagePlayer":{const r=t.status.weak??0;te(e,n.n,"ENEMY_ATTACK",t.name,r);return}case"damagePlayerFormula":{if(n.kind==="goblin_raider"){const r=Math.max(0,12-e.usedThisTurn),a=t.status.weak??0;te(e,r,"ENEMY_ATTACK",t.name,a)}else{const r=4+e.usedThisTurn,a=t.status.weak??0;te(e,r,"ENEMY_ATTACK",t.name,a)}return}case"supplies":{e.player.supplies=it(e.player.supplies+n.n,0),m(e,`적 효과: 보급 S ${n.n>=0?"+":""}${n.n} (현재 ${e.player.supplies})`);return}case"statusPlayer":{Ae(e.player,n.key,n.n),m(e,`적 효과: 플레이어 상태 ${n.key} ${n.n>=0?"+":""}${n.n}`);return}case"enemyHealSelf":{t.hp=Math.min(t.maxHp,t.hp+n.n),m(e,`적(${t.name})이(가) ${n.n} 회복 (HP ${t.hp}/${t.maxHp})`);return}case"enemyImmuneThisTurn":{t.immuneThisTurn=!0,m(e,`적(${t.name})이(가) 피해 면역 상태가 됨`);return}case"enemyImmuneNextTurn":{t.immuneNextTurn=!0,m(e,`적(${t.name})이(가) 다음 턴 피해 면역 상태가 됨`);return}case"fatiguePlayer":{e.player.fatigue=Math.max(0,e.player.fatigue+n.n),m(e,`적 효과: 피로 F ${n.n>=0?"+":""}${n.n} (현재 ${e.player.fatigue})`);return}case"damagePlayerByDeckSize":{const r=e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length,a=Math.ceil(r/n.div);let o=n.base+n.per*a;n.cap!=null&&(o=Math.min(o,n.cap)),te(e,o,"ENEMY_ATTACK",t.name),m(e,`중력 피해: base ${n.base} + per ${n.per} * ceil(${r}/${n.div})=${a} => ${o}`);return}default:return n}}function Bn(e){if(e.phase!=="UPKEEP")return;m(e,"=== 유지비 / 상태 처리 ===");const t=e.frontPlacedThisTurn;t>0&&m(e,`전열 유지비 처리: 전열 ${t}장`);let n=!1;for(let a=0;a<t;a++)e.player.supplies>0?e.player.supplies-=1:n=!0;if(n&&(e.player.fatigue+=1,m(e,"전열 유지비 부족! (F +1)")),e.player.supplies===0){e.player.zeroSupplyTurns+=1;const a=e.player.fatigue;te(e,a,"ZERO_SUPPLY",`보급 없이 턴 종료! 피해 ${a}`)}const r=e.player.status.bleed??0;r>0&&te(e,r,"BLEED","출혈");for(const a of L(e)){const o=a.status.bleed??0;o>0&&(a.immuneThisTurn?m(e,`적(${a.name})은(는) 이번 턴 면역이라 출혈 피해 무시`):(a.hp=Math.max(0,a.hp-o),e.enemies.indexOf(a),m(e,`적(${a.name}) 출혈로 HP -${o} (HP ${a.hp}/${a.maxHp})`)))}e.frontPlacedThisTurn=0,_n(e),wn(e),be(e),Ce(e),e.phase="DRAW"}function _n(e){const t=["vuln","weak","bleed","disrupt"];for(const n of t)e.player.status[n]>0&&(e.player.status[n]-=1);for(const n of e.enemies)for(const r of t)n.status[r]>0&&(n.status[r]-=1)}function Nn(e){if(e.phase!=="DRAW"||(e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null,Ce(e),e.run.finished))return;if(L(e).length===0){Qe(e),e.phase="NODE";return}const t=e.usedThisTurn;e.usedThisTurn=0,ct(e,t),e.player.block>0&&(e.player.block=0,m(e,"방어(블록) 소실")),dt(e)}function ct(e,t){let n=0;for(let r=0;r<t&&(On(e),!e.run.finished);r++){const a=e.deck.pop();if(!a)break;e.hand.push(a),n++}return m(e,`드로우 ${n}/${t} (손패 ${e.hand.length})`),n}function On(e){e.deck.length===0&&e.discard.length>0&&(e.deck=lt(e.discard),e.discard=[],e.player.fatigue+=1,m(e,`피로도 F +1 (셔플, 현재 ${e.player.fatigue})`))}function H(e){return e.pendingTarget!=null||(e.pendingTargetQueue?.length??0)>0}function An(e,t){if(!e.pendingTarget)return!1;if(L(e).length===0)return e.pendingTarget=null,e.pendingTargetQueue=[],e.selectedEnemyIndex=null,Ce(e),!0;const n=e.enemies[t];if(!n||n.hp<=0)return!1;const r=e.pendingTarget;return r.kind==="damageSelect"?ye(e,n,r.amount):r.kind==="statusSelect"&&(Ae(n,r.key,r.n),m(e,`적(${n.name}) 상태: ${r.key} ${r.n>=0?"+":""}${r.n}`)),be(e),Ce(e),L(e).length===0?!0:(Hn(e),!e.pendingTarget&&(e.pendingTargetQueue?.length??0)===0)}function Hn(e){const t=e.pendingTargetQueue??[],n=t.shift()??null;e.pendingTarget=n,e.pendingTargetQueue=t,e.selectedEnemyIndex=null}function Qe(e){e.player.block>0&&(e.player.block=0,m(e,"방어(블록) 소실")),e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null}function In(e){const t=e.run.deckSizeAtTreasure??null;return t==null?10:He(t)}function Ce(e){if(e.player.hp<=0){Qe(e),e.run.finished=!0,m(e,"패배: 죽었습니다.");return}if(!e.victoryResolvedThisCombat&&L(e).length===0&&e.phase!=="NODE"){if(e.victoryResolvedThisCombat=!0,Qe(e),Ln(e),m(e,"적을 모두 처치!"),Rn(e),e.enemies=[],e.player.zeroSupplyTurns=0,e.phase="NODE",e.run.treasureObtained){const u=In(e);if(e.run.afterTreasureNodePicks>=u){e.run.finished=!0,m(e,`승리! 저주받은 보물을 얻은 후 ${u}턴 동안 살아남았습니다.`);return}}const[t,n]=Vn(e),r=re(e.content,t.defId,t.upgrade),a=re(e.content,n.defId,n.upgrade),o=t.upgrade>0?`${r.name} +${t.upgrade}`:r.name,d=n.upgrade>0?`${a.name} +${n.upgrade}`:a.name;e.choice={kind:"REWARD",title:"전투 보상",prompt:"두 장 중 한 장을 선택하거나 생략합니다.",options:[{key:`pick:${t.defId}:${t.upgrade}`,label:o,detail:`전열: ${r.frontText} / 후열: ${r.backText}`},{key:`pick:${n.defId}:${n.upgrade}`,label:d,detail:`전열: ${a.frontText} / 후열: ${a.backText}`},{key:"skip",label:"생략"}]};return}}function Rn(e){const t=[];for(const o of e.deck)t.push(o);for(const o of e.hand)t.push(o);for(const o of e.discard)t.push(o);for(const o of e.frontSlots)o&&t.push(o);for(const o of e.backSlots)o&&t.push(o);for(const o of e.exhausted)t.push(o);const n=new Set,a=t.filter(o=>n.has(o)?!1:(n.add(o),!0)).filter(o=>e.cards[o]?.zone!=="vanished");e.deck=a;for(const o of a)e.cards[o].zone="deck";e.hand=[],e.discard=[],e.frontSlots=[null,null,null],e.backSlots=[null,null,null],e.selectedHandCardUid=null,e.exhausted=[],e.pendingTarget=null,e.pendingTargetQueue=[],Mn(e.deck)}function Mn(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}function Ln(e){if(!e.winHooksAppliedThisCombat){e.winHooksAppliedThisCombat=!0;for(const t of e.backUidsThisTurn){if(!e.cards[t])continue;const a=Q(e,t).onWinWhileInBack;!a||a.length===0||ge({game:e,side:"back",cardUid:t},a)}}}function De(e){return e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length}function Dn(e,t){t<=0||(e.player.block+=t,m(e,`방어(블록) +${t} (현재 ${e.player.block})`))}function Fn(e,t){e.player.supplies=it(e.player.supplies+t,0),m(e,`보급 S ${t>=0?"+":""}${t} (현재 ${e.player.supplies})`)}function ne(e,t){e.player.fatigue=it(e.player.fatigue+t,0),m(e,`피로 F ${t>=0?"+":""}${t} (현재 ${e.player.fatigue})`)}function Wn(e,t){if(t<=0)return;const n=e.player.hp;e.player.hp=Math.min(e.player.maxHp,e.player.hp+t),m(e,`HP +${e.player.hp-n} (현재 ${e.player.hp}/${e.player.maxHp})`)}function be(e){L(e).length===0&&(e.pendingTarget=null,e.pendingTargetQueue=[],e.selectedEnemyIndex=null)}function ye(e,t,n){if(n<=0)return;const r=e.enemies.indexOf(t);if(r<0){m(e,`WARN: applyDamageToEnemy target not in g.enemies (${t?.id??"?"})`);return}if(e.attackedEnemyIndicesThisTurn.includes(r)||e.attackedEnemyIndicesThisTurn.push(r),t.immuneThisTurn){m(e,`적(${t.name})은(는) 이번 턴 피해 면역 → ${n} 피해 무시`),be(e);return}const a=e.player.status.weak??0,o=t.status.vuln??0;let d=n-a+o;d<0&&(d=0),t.hp=Math.max(0,t.hp-d),m(e,`적(${t.name})에게 ${d} 피해. (HP ${t.hp}/${t.maxHp})`),be(e),L(e).length===0&&(be(e),Ce(e))}function te(e,t,n,r,a){if(n==="ENEMY_ATTACK"&&e.player.nullifyDamageThisTurn)return m(e,`적 공격 피해 무효 (${r??n})`),0;if(t<=0)return 0;let o=t;if(n==="ENEMY_ATTACK"){const d=a??0,u=e.player.status.vuln??0;if(o=o-d+u,o<0&&(o=0),e.player.block>0){const l=Math.min(e.player.block,o);e.player.block-=l,o-=l}}return o<=0?0:(e.player.hp=Math.max(0,e.player.hp-o),m(e,`플레이어 ${o} 피해 (${r??n}). (HP ${e.player.hp}/${e.player.maxHp})`),o)}function zn(e){if(e.run.treasureObtained)return;e.run.treasureObtained=!0,e.run.afterTreasureNodePicks=0,e.run.deckSizeAtTreasure=De(e);const t=Rt(e);e.cards[t]={uid:t,defId:"goal_treasure",zone:"deck",upgrade:0},e.deck.push(t),e.deck=lt(e.deck),m(e,"저주받은 보물을 획득했습니다! 덱에 [저주받은 보물] 추가")}const Un=["arrow","shield","scout","field_ration","maintenance","power_arrow"],qn=["arrow","shield","scout","field_ration"],xe=[{id:"mad_echo",weight:20},{id:"mad_insight",weight:12},{id:"mad_bargain",weight:3}],he=[{id:"berserk",weight:20},{id:"bandage",weight:12},{id:"arrow_rain",weight:20},{id:"smoke",weight:0},{id:"redeploy",weight:12},{id:"secret_strike",weight:3},{id:"fire_scroll",weight:3},{id:"caltrops",weight:20},{id:"emergency_rations",weight:3},{id:"painkiller",weight:12},{id:"field_experience",weight:3},{id:"camp_prep",weight:20},{id:"vital_shot",weight:12},{id:"taunt",weight:12},{id:"rapid_fire",weight:20}];function Pe(e,t,n){const r=n?Ht(t,n):At(t);return{defId:Ge(r),upgrade:t===xe?0:Je(e)}}function $e(e,t,n){const r=n?Ht(t,n):At(t),a=Ge(r),o=r.filter(h=>h.id!==a),d=Ge(o),u=t===xe,l=u?0:Je(e),c=u?0:Je(e);return[{defId:a,upgrade:l},{defId:d,upgrade:c}]}function Kn(e){const{tier:t}=Le(e);return Math.random()<(t===0?0:t===1?.15:t===2?.35:.6)}function At(e){const t=new Map;for(const n of e){const r=Math.max(0,n.weight??0);r<=0||t.set(n.id,(t.get(n.id)??0)+r)}return[...t.entries()].map(([n,r])=>({id:n,w:r}))}function Ht(e,t={}){const n=t.mult3??1,r=t.mult12??1,a=t.mult20??1,o=new Map;for(const d of e){const u=Math.max(0,d.weight??0);if(u<=0||u===3&&t.drop3||u===12&&t.drop12||u===20&&t.drop20)continue;let l=null;u===3?l=u*n:u===12?l=u*r:u===20?l=u*a:l=u,!(l<=0)&&o.set(d.id,(o.get(d.id)??0)+l)}return[...o.entries()].map(([d,u])=>({id:d,w:u}))}function Ge(e){let t=0;for(const r of e)t+=r.w;if(t<=0)throw new Error("No positive weights to pick from.");let n=Math.random()*t;for(const r of e)if(n-=r.w,n<=0)return r.id;return e[e.length-1].id}function Je(e){const t=e?.player?.fatigue??0;if((e?.run.nodePickCount??999)<=6)return 0;const r=.1,a=t>=12?0:t>=9?.25:t>=6?.5:1;return Math.random()<r*a?1:0}function It(e){const t=e.player?.fatigue??0,n={defId:R(qn),upgrade:0};R(Un);const r=()=>t<=3?$e(e,he):t<=6?$e(e,he,{mult3:.25,mult12:.75,mult20:1}):t<=8?$e(e,he,{mult3:.1,mult12:.55,mult20:1}):$e(e,he,{drop3:!0,mult12:.45,mult20:1}),a=u=>Kn(e)?Pe(e,xe):u;if(t<=8){if(t<=6){const[h,f]=r();return[a(h),a(f)]}const u=t===7?.3:.55;if(Math.random()<u){const[h]=r(),f=a(h);return Math.random()<.5?[n,f]:[f,n]}const[l,c]=r();return[a(l),a(c)]}if(t<=11){const u=a(Pe(e,he,{drop3:!0,mult12:.45,mult20:1}));return Math.random()<.5?[n,u]:[u,n]}const o=Pe(e,xe),d=Math.random()<.65?Pe(e,xe):n;return Math.random()<.5?[o,d]:[d,o]}function Vn(e){const t=It(e),n=t[0]??{defId:"arrow",upgrade:0},r=t[1]??{defId:"shield",upgrade:0};return[n,r]}function Rt(e){return e.uidSeq+=1,`c_${e.uidSeq}`}function Oe(e,t,n){const r=Rt(e);e.cards[r]={uid:r,defId:t,zone:"deck",upgrade:n?.upgrade??0},e.deck.push(r)}function jn(e){const t=Object.values(e.cards).filter(r=>r.zone==="deck"||r.zone==="hand"||r.zone==="discard");if(t.length===0)return;const n=R(t);e.cards[n.uid].zone="vanished",e.vanished.push(n.uid),e.deck=e.deck.filter(r=>r!==n.uid),e.hand=e.hand.filter(r=>r!==n.uid),e.discard=e.discard.filter(r=>r!==n.uid),m(e,`카드 제거: [${Q(e,n.uid).name} +${e.cards[n.uid].upgrade??0}]`)}const Xn="goal_treasure";function Mt(e,t){const n=e.cards[t];if(n){if(n.defId===Xn){m(e,"저주받은 보물은 덱에서 제거할 수 없습니다.");return}e.deck=e.deck.filter(r=>r!==t),e.hand=e.hand.filter(r=>r!==t),e.discard=e.discard.filter(r=>r!==t),e.frontSlots=e.frontSlots.map(r=>r===t?null:r),e.backSlots=e.backSlots.map(r=>r===t?null:r),n.zone="vanished",e.vanished.push(t),m(e,`카드 제거: [${Q(e,n.uid).name} +${e.cards[n.uid].upgrade??0}]`)}}function Lt(e,t){const n=e.cards[t];if(!n)return!1;const a=e.content.cardsById[n.defId].upgrades?.length??0;return(n.upgrade??0)<a}function Yn(e,t){return Lt(e,t)?(e.cards[t].upgrade=(e.cards[t].upgrade??0)+1,!0):!1}function Qn(){return Ze[Math.floor(Math.random()*Ze.length)]}function Tt(e){const{tier:t}=Le(e),n=t===0?0:t===1?.25:t===2?.55:.85;return Math.random()<n?Gn():Qn()}const Dt={boss_cursed_wall:"움직이지 않는다. 당신이 닳아간다.",boss_giant_orc:"거대한 무언가가 기다린다.",boss_soul_stealer:"행동하지 않으면 종말이 온다.",boss_gravity_master:"몸이 점점 무겁다. 몸을 가볍게 하라."},gt=[{id:"mad_mirror",name:"거울에 잠긴 물",prompt:"물 속의 당신이 먼저 웃습니다.",art:"assets/events/event_mad_mirror.png",options:e=>[{key:"mad_mirror:take",label:"손을 넣는다",detail:"카드 보상. F +2.",apply:t=>(ne(t,2),m(t,"거울: 무언가를 건져 올렸다. (F +2)"),"REWARD")},{key:"mad_mirror:leave",label:"외면한다",apply:t=>(m(t,"거울: 당신은 물러났다."),"NONE")}]},{id:"mad_contract",name:"젖은 계약서",prompt:"곰팡이 냄새가 납니다.",art:"assets/events/event_mad_contract.png",options:e=>[{key:"mad_contract:sign",label:"서명한다",detail:"최대 HP +2. 카드 1장 제거 후 보상.",apply:t=>(t.player.maxHp+=2,t.player.hp=Math.min(t.player.maxHp,t.player.hp+2),m(t,"계약: 최대 HP +2"),{kind:"REMOVE_PICK",title:"대가",prompt:"제거할 카드 1장을 선택하세요.",then:"REWARD"})},{key:"mad_contract:burn",label:"찢어버린다",detail:"F +1",apply:t=>(ne(t,1),m(t,"불길함: F +1"),"NONE")}]},{id:"mad_lullaby",name:"자장가",prompt:"잠들면 회복하지만, 깨어나면 잊습니다.",art:"assets/events/event_mad_lullaby.png",options:e=>[{key:"mad_lullaby:sleep",label:"잠든다",detail:"HP +12. 덱에서 무작위 1장 소실.",apply:t=>(t.player.hp=Math.min(t.player.maxHp,t.player.hp+12),jn(t),m(t,"자장가: HP 회복, 그러나 잊었다… (무작위 1장 소실)"),"NONE")},{key:"mad_lullaby:stay",label:"버틴다",detail:"F -1",apply:t=>(ne(t,-1),m(t,"버팀: F -1"),"NONE")}]}];function Gn(e){return gt[Math.floor(Math.random()*gt.length)]}const Ze=[{id:"drop_bag",name:"짐 버리기",prompt:"짐을 줄여 피로를 낮추자.",art:"assets/events/event_drop_bag.png",options:()=>[{key:"drop",label:"카드 1장 제거, F -1",apply:e=>(ne(e,-1),m(e,"이벤트: 짐 버리기 → 제거할 카드를 선택하세요."),{kind:"REMOVE_PICK",title:"짐 버리기",prompt:"제거할 카드 1장을 선택하세요.",then:"NONE"})},{key:"skip",label:"아무것도 하지 않는다",apply:e=>(m(e,"이벤트: 짐 버리기(생략)"),"NONE")}]},{id:"hide_from_monster",name:"몬스터로부터 숨기",prompt:"전투하거나, 대가를 치르고 숨을 수 있다.",art:"assets/events/event_hide_from_monster.png",options:()=>[{key:"fight",label:"전투",apply:e=>(m(e,"이벤트: 몬스터로부터 숨기 → 전투 선택"),"BATTLE")},{key:"remove_and_fatigue",label:"카드 1장 제거 후 F +1",apply:e=>(ne(e,1),m(e,"이벤트: 몬스터로부터 숨기 → 카드 제거 후 F+1"),{kind:"REMOVE_PICK",title:"숨기",prompt:"제거할 카드 1장을 선택하세요.",then:"NONE"})}]},{id:"goblin_ambush_low_supplies",name:"매복한 약탈자들",prompt:`고블린들이 보급을 약탈했다.
이번 전투는 보급(S) 5로 시작합니다.`,art:"assets/events/event_goblin_ambush_low_supplies.png",options:()=>[{key:"fight",label:"맞서 싸운다",detail:"고블린 약탈자 2마리 전투 (S=5 시작)",apply:e=>(e.run.nextBattleSuppliesBonus=-5,{kind:"BATTLE_SPECIAL",title:"고블린 매복",enemyIds:["goblin_raider","goblin_raider"]})}]},{id:"find_adventurer",name:"다른 모험가 발견",prompt:"거래한다.",art:"assets/events/event_find_adventurer.png",options:e=>e.run.treasureObtained?[{key:"adventurer:forced_battle",label:"대치한다",detail:"보물을 노리고 덤벼든다.",apply:t=>({kind:"BATTLE_SPECIAL",enemyIds:["other_adventurer"],title:"보물을 노리는 모험가"})}]:[{key:"trade",label:"카드 1장 제거 후 카드 보상(2장 중 1장)",apply:t=>(m(t,"이벤트: 다른 모험가 발견 → 제거할 카드 선택 후 보상"),{kind:"REMOVE_PICK",title:"다른 모험가 발견",prompt:"제거할 카드 1장을 선택하세요.",then:"REWARD"})},{key:"leave",label:"지나친다",apply:t=>(m(t,"이벤트: 다른 모험가 발견(생략)"),"NONE")}]},{id:"edible_mushroom",name:"식용 버섯 발견",prompt:"기운이 난다. 다음 전투의 시작 보급이 늘어난다.",art:"assets/events/event_edible_mushroom.png",options:()=>[{key:"eat",label:"F -2, 다음 전투 시작 S +5",apply:e=>(e.player.fatigue=Math.max(0,e.player.fatigue-2),e.run.nextBattleSuppliesBonus+=5,m(e,"식용 버섯: F -2, 다음 전투 시작 S +5"),"NONE")}]},{id:"ominous_prophecy",name:"불길한 예언",prompt:"불길한 속삭임이 귓가를 맴돈다. 대가를 치르고 미래를 엿볼까?",art:"assets/events/event_ominous_prophecy.png",options:e=>[{key:"omen:listen",label:"예언을 듣는다",detail:"F +1. 다음 보스를 확정하고 공개합니다.",apply:t=>{if(ne(t,1),m(t,"불길한 예언: F +1"),t.run.nextBossId||(t.run.bossPool.length>0?t.run.nextBossId=R(t.run.bossPool):t.run.nextBossId=null),!t.run.nextBossId)return m(t,"예언: 미래가 흐릿하다. (보스가 남아있지 않음)"),"NONE";t.content.enemiesById[t.run.nextBossId];const n=Dt[t.run.nextBossId]??"정체불명의 위협이 다가온다.";return t.run.bossOmenText=`${n}`,m(t,`예언: ${n}`),"NONE"}},{key:"omen:ignore",label:"무시한다",detail:"아무 일도 일어나지 않습니다.",apply:t=>(m(t,"불길한 예언(무시)"),"NONE")}]}];function Jn(e){return Ze.find(t=>t.id===e)??null}function Zn(){return{cardsById:cn,enemiesById:pn}}let le=!1,Ft=null,se=[],me=[],G=-1;function Ie(e,t){se.push({t:Date.now(),kind:e,text:t}),se.length>300&&(se=se.slice(-300))}function er(e){Ft=e}function tr(){return le}function nr(e){le=!le,ie()}function ie(){if(document.querySelector(".devConsole")?.remove(),!le)return;const e=document.createElement("div");e.className="devConsole",e.style.cssText=`
    position: fixed; inset: 0;
    z-index: 60000;
    pointer-events: auto;
    background: rgba(0,0,0,.35);
    backdrop-filter: blur(4px);
    display:flex; align-items:flex-end; justify-content:center;
    padding: 12px;
    box-sizing: border-box;
  `;const t=document.createElement("div");t.style.cssText=`
    width: min(980px, 100%);
    height: min(420px, 70vh);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(10,12,14,.92);
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    display:flex;
    flex-direction: column;
    overflow:hidden;
  `;const n=document.createElement("div");n.style.cssText=`
    padding: 10px 12px;
    display:flex; align-items:center; justify-content:space-between;
    border-bottom: 1px solid rgba(255,255,255,.10);
  `;const r=document.createElement("div");r.textContent="Dev Console",r.style.cssText="font-weight:800; color:#fff; opacity:.95;";const a=document.createElement("div");a.style.cssText="display:flex; gap:8px;";const o=(f,p)=>{const T=document.createElement("button");return T.type="button",T.textContent=f,T.style.cssText=`
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #fff;
      cursor: pointer;
      font-weight: 700;
    `,T.onclick=p,T};a.appendChild(o("Clear",()=>{se=[],ie()})),a.appendChild(o("Close",()=>{le=!1,ie()})),n.appendChild(r),n.appendChild(a);const d=document.createElement("div");d.className="devConsoleOut",d.style.cssText=`
    flex: 1 1 auto;
    padding: 10px 12px;
    overflow: auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 12px;
    line-height: 1.4;
    color: #ddd;
    white-space: pre-wrap;
  `;const u=f=>(f.kind==="in"?"> ":f.kind==="err"?"! ":"  ")+f.text;d.textContent=se.map(u).join(`
`),queueMicrotask(()=>{d.scrollTop=d.scrollHeight});const l=document.createElement("div");l.style.cssText=`
    border-top: 1px solid rgba(255,255,255,.10);
    padding: 10px 12px;
    display:flex; gap:10px; align-items:center;
  `;const c=document.createElement("div");c.textContent=">",c.style.cssText="color:#fff; font-weight:900; opacity:.9;";const h=document.createElement("input");h.type="text",h.placeholder="help / state / newrun ...",h.style.cssText=`
    flex: 1 1 auto;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: #fff;
    outline: none;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 13px;
  `,h.onkeydown=f=>{if(f.key==="Escape"){le=!1,ie();return}if(f.key==="Enter"){const p=h.value.trim();if(!p)return;h.value="",me.unshift(p),G=-1,Ie("in",p);try{rr(p)}catch(T){Ie("err",String(T?.message??T))}ie();return}if(f.key==="ArrowUp"){f.preventDefault();const p=me.length;if(p===0)return;G=Math.min(p-1,G+1),h.value=me[G]??"";return}if(f.key==="ArrowDown"){if(f.preventDefault(),me.length===0)return;G=Math.max(-1,G-1),h.value=G>=0?me[G]??"":"";return}},l.appendChild(c),l.appendChild(h),t.appendChild(n),t.appendChild(d),t.appendChild(l),t.onclick=f=>f.stopPropagation(),e.appendChild(t),document.body.appendChild(e),queueMicrotask(()=>h.focus())}function rr(e){const t=Ft;if(!t){Ie("err","Dev console context not set");return}const n=t.getG(),r=e.split(/\s+/).filter(Boolean),a=(r[0]??"").toLowerCase(),o=r[1],d=r[2],u=c=>Ie("out",c);if(a==="help"){u(["help","state","newrun","hp <n> | maxhp <n> | supplies <n> | fatigue <n>","phase <PLACE|BACK|FRONT|ENEMY|UPKEEP|DRAW|NODE>","addcard <defId> [upgrade=0] [zone=deck|hand|discard]","removecard <uid>","win | lose","log <text...>"].join(`
`));return}if(a==="state"){u(JSON.stringify({phase:n.phase,hp:`${n.player.hp}/${n.player.maxHp}`,supplies:n.player.supplies,fatigue:n.player.fatigue,deck:n.deck.length,hand:n.hand.length,discard:n.discard.length,enemies:n.enemies.map(c=>({id:c.id,hp:`${c.hp}/${c.maxHp}`,intent:c.intentIndex}))},null,2));return}if(a==="newrun"){t.actions.onNewRun(),u("OK: newrun");return}const l=(c,h)=>{const f=Number(o);if(!Number.isFinite(f)){u(`ERR: ${c} requires number`);return}h(f),t.rerender(),u(`OK: ${c} = ${f}`)};if(a==="hp")return l("hp",c=>n.player.hp=Math.max(0,Math.min(n.player.maxHp,c)));if(a==="maxhp")return l("maxHp",c=>{n.player.maxHp=Math.max(1,c),n.player.hp=Math.min(n.player.hp,n.player.maxHp)});if(a==="supplies")return l("supplies",c=>n.player.supplies=Math.max(0,c));if(a==="fatigue")return l("fatigue",c=>n.player.fatigue=Math.max(0,c));if(a==="phase"){const c=(o??"").toUpperCase();if(!new Set(["PLACE","BACK","FRONT","ENEMY","UPKEEP","DRAW","NODE"]).has(c)){u("ERR: phase invalid");return}n.phase=c,t.rerender(),u(`OK: phase=${c}`);return}if(a==="log"){const c=e.slice(e.indexOf(" ")+1);if(!c||c===e){u("ERR: log <text...>");return}t.log?.(`[DEV] ${c}`),u("OK: logged");return}if(a==="addcard"){const c=o;if(!c){u("ERR: addcard <defId> [upgrade=0] [zone=deck|hand|discard]");return}const h=Math.max(0,Number(d??"0")||0),f=r[3]??"deck";Oe(n,c,{upgrade:h});const p=n.deck[n.deck.length-1];p&&f!=="deck"&&(n.deck=n.deck.filter(T=>T!==p),f==="hand"?n.hand.push(p):f==="discard"&&n.discard.push(p),n.cards[p].zone=f),t.log?.(`[DEV] addcard ${c} +${h} (${f}) uid=${p}`),t.rerender(),u(`OK: addcard uid=${p}`);return}if(a==="removecard"){const c=o;if(!c){u("ERR: removecard <uid>");return}if(!n.cards[c]){u(`ERR: uid not found: ${c}`);return}Mt(n,c),t.log?.(`[DEV] removecard ${c}`),t.rerender(),u("OK: removecard");return}if(a==="win"){if(!n.enemies||n.enemies.length===0){u("WARN: enemies=0");return}for(const c of n.enemies)c.hp=0;n.enemies=[],n.phase="NODE",n.pendingTarget=null,n.pendingTargetQueue=[],n.selectedEnemyIndex=null,t.log?.("[DEV] win"),t.rerender(),u("OK: win");return}if(a==="lose"){n.run.finished=!0,t.log?.("[DEV] lose"),t.rerender(),u("OK: lose");return}u(`Unknown command: ${a} (try: help)`)}const Fe="deck-rogue-save-v1",Wt=1;function ar(e){try{return JSON.parse(e)}catch{return null}}function or(){return!!localStorage.getItem(Fe)}function sr(){localStorage.removeItem(Fe)}function ir(e,t){const n={ver:Wt,savedAt:Date.now(),build:t?.build,state:e};localStorage.setItem(Fe,JSON.stringify(n))}function lr(){const e=localStorage.getItem(Fe);if(!e)return null;const t=ar(e);return!t||t.ver!==Wt||!t.state?null:{state:t.state,savedAt:t.savedAt}}const dr=`# Deck Rogue Prototype — 룰북 (플레이어용)

이 문서는 스포일러를 최소화합니다.

[1] 개요
노드를 선택하며 진행하고, 전투에서 살아남아 성장합니다. 목표는 무엇일까요?
모든 카드는 전열과 후열이 있습니다. 배치에 따라 역할이 달라집니다.

[2] 보급과 피로도

보급(S): 전열 카드 및 일부 효과의 발동에 사용됩니다. 보통 7로 시작합니다.
보급이 부족한 상태로 턴 종료 시 피로도만큼 피해를 받습니다.

피로도(F): 덱을 섞거나 전열 카드의 보급이 부족한 채로 턴을 마칠 때 피로도가 1 올라가며, 일부 카드의 효과로도 변합니다.
피로도는 전투가 끝나도 유지됩니다. 너무 쌓인 피로는 때때로 당신을 변하게 합니다.

[3] 전투 흐름
배치 → 후열 발동 → 전열 발동 → 적 행동 → 정리 → 드로우
※ “대상 선택 필요”가 뜨면 살아있는 적을 클릭해 대상을 정하세요.
※ 후열 발동을 누르면 턴이 진행되어, 카드의 배치를 변경할 수 없습니다.
보급 및 그에 따른 변화는 정리 단계에서 처리합니다.

손패는 턴이 종료되어도 유지됩니다.
카드는 매 턴마다 사용한 만큼 뽑습니다. 즉, 카드로 인한 드로우는 패의 매수 자체를 늘리는 효과가 있습니다.

[4] 용어
- 소모: 이번 전투에서 사용할 수 없게 되는 것입니다.
- 소실: 런 전체에서 해당 카드가 사라지는 것입니다.
- 취약: 받는 피해가 (취약)만큼 증가합니다.
- 약화: 주는 피해가 (약화)만큼 감소합니다.
- 출혈: 턴 종료 시 (출혈)만큼 피해를 입습니다.
- 교란: 당신을 방해합니다. 무엇일까요?

[5] 조작

(컴퓨터)
- 4: 선택 해제
- Tab: 손패 선택 이동
- 1~3: 전열 배치 / q,w,e: 후열 배치
- 드래그: 손패→슬롯 배치, 슬롯↔슬롯 스왑, 슬롯→손패 회수
- Space: 다음 턴
- F: 새로운 런

(모바일)
- 손패: 클릭 시 선택, 길게 누를 시 확대
- 카드 선택 상태에서 슬롯을 눌러 배치
- 슬롯: 클릭 시 확대, 길게 누를 시 회수
- 슬롯에 넣은 카드는 이름만 보입니다.

[6] 당신을 위한 조언

덱은 당신의 비품입니다. 비품이 적으면, 늘 새로 꾸리느라 힘들 겁니다. 비품이 많으면, 들고 다니기 힘들겠지요. 균형을 찾으세요.

[7] 시간

시간은 금입니다. 모든 행동은 시간을 소모합니다. 싸움은 좀 더 소모할지도 모르겠군요.
중요한 건 이곳이 당신에게 넉넉한 시간을 주지 않는다는 것이겠지요.
`;function cr(e){return new Promise(t=>window.setTimeout(t,e))}function ur(e){switch(e){case"BACK":return 400;case"FRONT":return 400;case"ENEMY":return 400;case"UPKEEP":return 400;case"DRAW":return 400;case"PLACE":return 0;default:return 220}}let pr=1,Ee=[],zt=null;function Se(e,t,n,r){Ee.push({id:pr++,kind:e,text:t,x:n,y:r,born:performance.now()})}function fr(){const e=performance.now();Ee=Ee.filter(t=>e-t.born<700)}let Be=null,_e=null,Ve=[];function hr(e){if(!(!e.run.finished&&e.enemies.length>0&&e.phase!=="NODE")){Be=null,_e=null,Ve=[];return}if(Be!=null){const n=e.player.hp-Be;n!==0&&mr(n)}if(_e!=null){const n=e.player.block-_e;n!==0&&yr(n)}for(let n=0;n<e.enemies.length;n++){const r=e.enemies[n].hp,a=Ve[n];a!=null&&r!==a&&br(n,r-a)}Be=e.player.hp,_e=e.player.block,Ve=e.enemies.map(n=>n.hp)}function mr(e){const t=document.querySelector(".playerHudBox")??document.querySelector(".playerHudLeft");if(!t)return;const n=t.getBoundingClientRect(),r=(n.left+n.right)/2,a=n.top+14;e<0?Se("dmg",`${e}`,r,a):Se("heal",`+${e}`,r,a),t.classList.add("fxFlash"),setTimeout(()=>t.classList.remove("fxFlash"),240)}function yr(e){const t=document.querySelector(".playerHudBox")??document.querySelector(".playerHudLeft");if(!t)return;const n=t.getBoundingClientRect(),r=(n.left+n.right)/2,a=n.top+34;Se("block",e>0?`+${e}`:`${e}`,r,a)}function br(e,t){const r=Array.from(document.querySelectorAll(".enemyHudCenter .enemyBanner"))[e];if(!r)return;const a=r.getBoundingClientRect(),o=(a.left+a.right)/2,d=a.top+14;t<0?Se("dmg",`${t}`,o,d):Se("heal",`+${t}`,o,d),r.classList.add("fxFlash"),setTimeout(()=>r.classList.remove("fxFlash"),240)}let Z=!1;function xr(){try{const e=localStorage.getItem("deckrogue_logCollapsed");if(e==null)return;Z=e==="1"}catch{}}function kr(){try{localStorage.setItem("deckrogue_logCollapsed",Z?"1":"0")}catch{}}let Ne=null;function Tr(e){Ne!=null&&window.clearTimeout(Ne),Ne=window.setTimeout(()=>{Ne=null,ir(e)},250)}let je=!1;async function gr(e,t){if(!je){je=!0;try{if(e.run.finished||e.choice||H(e)||A||e.phase==="NODE")return;let n=0;for(;n++<60&&!(e.run.finished||e.choice||A||H(e));){const r=Yt(e,t,!1);if(!r.fn||r.disabled)break;const a=e.phase;if(r.fn(),C(e,t),a==="DRAW"&&e.phase==="PLACE"||e.phase==="PLACE")break;const o=ur(a);o>0&&await cr(o)}}finally{je=!1}}}function et(e){const t=e.run;t.nextBossTime==null&&(t.nextBossTime=40),t.forcedNext==null&&(t.forcedNext=null)}function Re(e){return(e.run.nodePickCount??0)+(e.time??0)}function Ct(e){const a=Math.max(0,e-20),o=Math.min(85,Math.floor(a*a/3));return{extra:Math.random()*100<o?1:0,pPct:o}}function Cr(e,t){const n=e;return n.content=t,n.time??=0,n.run??={},n.run.nextBossTime??=40,n.run.forcedNext??=null,n.run.bossOmenText??=null,n.run.enemyLastSeenBattle??={},n.run.nodePickByType??={BATTLE:0,REST:0,EVENT:0,TREASURE:0},n.run.bossPool??=["boss_gravity_master","boss_cursed_wall","boss_giant_orc","boss_soul_stealer"],n.run.nextBossId??=null,n.run.afterTreasureNodePicks??=0,n.run.deckSizeAtTreasure??=null,n.run.treasureObtained&&n.run.deckSizeAtTreasure==null&&(n.run.deckSizeAtTreasure=De(n)),n.choiceStack??=[],n.pendingTargetQueue??=[],n.exhausted??=[],n.vanished??=[],n}function Er(e){if(!or())return Xe(e);const t=lr();return t?Cr(t.state,e):Xe(e)}function Sr(){if(document.querySelector(".bgLayer"))return;const e=document.createElement("div");e.className="bgLayer",document.body.appendChild(e)}let Et=0,St=0,ee=null;function wr(e,t){wt();const n=b("cardZoomLayer");n.style.cssText=`
    position:fixed; inset:0; z-index:7000;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:center;
    padding: 14px;
  `;const r=b("cardZoomPanel");r.style.cssText=`
    width: min(420px, 92vw);
    max-height: 82vh;
    overflow: auto;
  `;const a=de(e,t);a.classList.add("zoomedCard"),r.appendChild(a),n.onclick=()=>wt(),r.onclick=o=>o.stopPropagation(),n.appendChild(r),document.body.appendChild(n)}function Ut(e,t){let n=null,r=!1,a=0,o=0;const d=t.moveTolerancePx??6,u=()=>{n!=null&&window.clearTimeout(n),n=null,r=!1};e.onpointerdown=l=>{t.shouldIgnore?.(l)||(r=!1,a=l.clientX,o=l.clientY,n!=null&&window.clearTimeout(n),n=window.setTimeout(()=>{r=!0,n=null,t.onFire(l)},t.delayMs))},e.onpointermove=l=>{if(n==null)return;const c=l.clientX-a,h=l.clientY-o;c*c+h*h>d*d&&u()},e.onpointerup=l=>{const c=r;u(),!c&&t.onTap&&t.onTap(l)},e.onpointercancel=()=>u()}function wt(){document.querySelector(".cardZoomLayer")?.remove()}function vr(e,t){const n=e.cards[t],r=re(e.content,n.defId,n.upgrade??0),a=b("card");a.classList.add("inSlot"),a.appendChild(D("cardTitle",pt(e,t)));const o=b("cardMeta");return r.tags?.includes("EXHAUST")&&o.appendChild(j("소모")),r.tags?.includes("VANISH")&&o.appendChild(j("소실")),a.appendChild(o),a}function Pr(e,t){document.querySelector(".cardPeekOverlay")?.remove();const n=b("cardPeekOverlay");n.style.cssText="position:fixed; inset:0; z-index:7000; background:rgba(0,0,0,.60);backdrop-filter: blur(6px); display:flex; align-items:center; justify-content:center;padding:18px; box-sizing:border-box;";const r=b("panel");r.classList.add("cardPeekPanel"),r.style.cssText="width: fit-content; max-width: 92vw; max-height: 92vh;overflow: visible; padding: 12px; border-radius: 16px;";const a=de(e,t);a.style.width="var(--handCardW)",a.style.height="var(--handCardH)",a.style.boxSizing="border-box",r.appendChild(a),n.appendChild(r),n.onclick=()=>n.remove(),r.onclick=o=>o.stopPropagation(),document.body.appendChild(n)}function $r(e,t){if(document.querySelector(".mobileQuickMenuBtn")?.remove(),document.querySelector(".mobileQuickMenuSheet")?.remove(),!q())return;const r=document.createElement("button");r.type="button",r.className="mobileQuickMenuBtn",r.textContent="≡",r.style.cssText=`
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    right: calc(env(safe-area-inset-right, 0px) + 10px);
    z-index: 9999;
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(15,18,22,.88);
    color: #fff;
    font-weight: 900;
    backdrop-filter: blur(6px);
  `,r.onclick=()=>a(),document.body.appendChild(r);const a=()=>{document.querySelector(".mobileQuickMenuSheet")?.remove();const o=document.createElement("div");o.className="mobileQuickMenuSheet",o.style.cssText=`
      position: fixed; inset: 0;
      z-index: 9998;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 12px;
      box-sizing: border-box;
    `;const d=document.createElement("div");d.style.cssText=`
      width: min(520px, 100%);
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(15,18,22,.92);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    `;const u=document.createElement("div");u.style.cssText="display:flex; gap:10px; flex-wrap:wrap;";const l=(f,p)=>{const T=document.createElement("button");return T.type="button",T.textContent=f,T.style.cssText=`
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        color: #fff;
        font-weight: 700;
      `,T.onclick=()=>{o.remove(),p()},T};u.appendChild(l("룰북",()=>t.onViewRulebook())),u.appendChild(l("로그",()=>t.onToggleLogOverlay()));const c=document.createElement("div");c.style.cssText="height:1px; margin:12px 0; background: rgba(255,255,255,.10);";const h=document.createElement("div");h.style.cssText="display:flex; gap:10px; flex-wrap:wrap;",h.appendChild(l("덱",()=>t.onViewPile("deck"))),h.appendChild(l("버림",()=>t.onViewPile("discard"))),h.appendChild(l("손패",()=>t.onViewPile("hand"))),h.appendChild(l("소모",()=>t.onViewPile("exhausted"))),h.appendChild(l("소실",()=>t.onViewPile("vanished"))),d.appendChild(u),d.appendChild(c),d.appendChild(h),o.onclick=()=>o.remove(),d.onclick=f=>f.stopPropagation(),o.appendChild(d),document.body.appendChild(o)}}let A=null,vt=!1,E=null,X=null,tt=!1;function Br(e,t,n){const r=e.cards[t];return qt(e,r.defId,n)}function de(e,t,n){const a=We(e,t,!!n,n,{draggable:!1});return a.classList.add("overlayCard"),a}function qt(e,t,n){const r=`__preview:${t}:${n}:${Math.random().toString(36).slice(2)}`,a=e.cards[r];e.cards[r]={uid:r,defId:t,upgrade:n,zone:"preview"};const o=We(e,r,!1,void 0,{draggable:!1});return o.classList.add("overlayCard"),o.draggable=!1,o.style.pointerEvents="none",a?e.cards[r]=a:delete e.cards[r],o}function Kt(e,t){return e==="BATTLE"?"⚔️(전투)":e==="REST"?"⛺(휴식)":e==="EVENT"?"❔(미지)":"🌑(보물)"}function _r(e,t){return e.map(n=>Kt(n.type)).join(" / ")}function Nr(e,t,n){const r=[`[탐험 ${t.run.nodePickCount}회]`];if(t.run.treasureObtained){const w=t.run.deckSizeAtTreasure??De(t),_=He(w);r.push(`[탈출까지 ${t.run.afterTreasureNodePicks}/${_}]`)}e.appendChild(ut(r.join(" "))),et(t),(!t.run.bossOmenText||String(t.run.bossOmenText).trim()==="")&&(t.run.bossOmenText="아직 징조가 없다.");const a=t.run,o=Re(t),d=a.nextBossTime??40,u=n.getNodeOffers(),l=a.nodeExtra01??0,c=o+1+l,h=a.forcedNext==="BOSS",f=!h&&c>=d,p=!h&&!f&&(u[0]?.type==="BATTLE"||u[1]?.type==="BATTLE"),T=c+1,g=h?c+1:p?T:c,i=Math.max(0,d-o);if(g>=d&&a.forcedNext!=="BOSS"){const w=D("bossIncomingBanner","보스가 온다.");w.style.cssText="margin-top:10px; padding:10px 12px; border-radius:14px;border:1px solid rgba(255,255,255,1);background: rgba(255,120,60,1);font-weight:700; font-size:13px; line-height:1.25;",e.appendChild(w)}const{tier:y}=Le(t),k=y===0?"":y===1?Math.random()<.1?" . . . 들린다.":"":y===2?Math.random()<.1?" . . . 보인다.":"":Math.random()<.1?" . . . 닿았다.":"",x=` . . . ${t.run.bossOmenText}${k}`,v=D("bossOmenBanner",`다음 보스까지 남은 시간: ${i}${x}`);v.style.cssText="margin-top:8px; padding:10px 12px; border-radius:14px;border:1px solid rgba(255, 255, 255, 1);background:rgba(0, 0, 0, 1);font-weight:600;font-size:13px;line-height:1.2;",v.style.color="white",e.appendChild(v);const S=t.run.branchOffer;if(S){const w=b("nodePreviewBox");w.style.cssText="margin-top:10px; padding:12px; border:1px solid rgba(255,255,255,1); border-radius:16px; background:rgba(0,0,0,1);";const _=a.forcedNext==="BOSS",P=I=>{const $=b("nodePreviewRow");$.style.cssText="display:flex; gap:10px; align-items:center; padding:10px; border-radius:14px; cursor:pointer;",$.onmouseenter=()=>$.style.background="rgba(255,255,255,.06)",$.onmouseleave=()=>$.style.background="transparent",$.onclick=()=>n.onChooseNode(I);const K=_?"💀(보스)":Kt(u[I==="A"?0:1]?.type??"BATTLE"),B=document.createElement("div");B.className="nodePill primary",B.textContent=K,B.onclick=V=>{V.stopPropagation(),n.onChooseNode(I)},$.appendChild(B),$.appendChild(D("","→"));const F=I==="A"?S.nextIfA:S.nextIfB,O=D("",_r(F));return O.style.cssText="opacity:.85;",$.appendChild(O),$};w.appendChild(P("A")),w.appendChild(P("B")),e.appendChild(w),e.appendChild(Or())}}function Or(){return document.createElement("hr")}function Vt(e,t){let n=null,r=!1,a=!1;const o=[];function d(i){o.length=0,i.choice=null,n=null,document.querySelector(".choice-overlay")?.remove()}function u(i){o.push({choice:i.choice,handler:n})}function l(i){const s=o.pop();if(!s){c(i);return}i.choice=s.choice,n=s.handler}function c(i){if(o.length>0){l(i);return}i.choice=null,n=null,document.querySelector(".choice-overlay")?.remove()}function h(i,s,y){i.choice&&u(i),i.choice=s,n=y}const f=()=>ee||e,p={onHotkeySlot:(i,s)=>{const y=f();if(y.run.finished||H(y)||y.phase!=="PLACE"||i==="back"&&y.backSlotDisabled?.[s])return;const k=i==="front"?y.frontSlots:y.backSlots,x=k[s];if(!y.selectedHandCardUid){if(!x)return;p.onReturnSlotToHand(i,s);return}const v=y.selectedHandCardUid;if(!x){p.onPlaceHandUidToSlot(v,i,s);return}k[s]=null,y.usedThisTurn=Math.max(0,y.usedThisTurn-1),i==="front"&&(y.frontPlacedThisTurn=Math.max(0,y.frontPlacedThisTurn-1)),y.hand.push(x),y.cards[x].zone="hand",yt(y,v,i,s),y.selectedHandCardUid=null,m(y,`[${U(y,v)}] ↔ [${U(y,x)}] 스왑: 손패 ↔ ${i}${s+1}`),C(y,p)},rerender:()=>{const i=f();C(i,p)},onToggleLogOverlay:()=>{tt=!tt,C(f(),p)},onCloseOverlay:()=>{const i=f();A=null,C(i,p)},onNewRun:()=>{const i=f();X=null,A=null,E=null,c(i),sr(),t(Xe(i.content))},onViewRulebook:()=>{const i=f();A={kind:"RULEBOOK"},C(i,p)},onViewPile:i=>{const s=f();A={kind:"PILE",pile:i},C(s,p)},onReturnSlotToHand:(i,s)=>{const y=f();if(y.run.finished||H(y)||y.phase!=="PLACE")return;const k=i==="front"?y.frontSlots:y.backSlots,x=k[s];x&&(k[s]=null,y.usedThisTurn=Math.max(0,y.usedThisTurn-1),i==="front"&&(y.frontPlacedThisTurn=Math.max(0,y.frontPlacedThisTurn-1)),y.hand.push(x),y.cards[x].zone="hand",m(y,`[${U(y,x)}] 회수: ${i}${s+1} → 손패`),C(y,p))},onClearSelected:()=>{const i=f();i.selectedHandCardUid=null,C(i,p)},onSelectEnemy:i=>{const s=f();if(a)return;a=!0,requestAnimationFrame(()=>{a=!1});const y=An(s,i);C(s,p),y&&!s.choice&&!s.run.finished&&p.onAutoAdvance()},onSelectHandCard:i=>{const s=f();H(s)||(s.selectedHandCardUid=s.selectedHandCardUid===i?null:i,C(s,p))},getNodeOffers:()=>{const i=f();et(i),i.run.branchOffer||(i.run.branchOffer=Te(i));const s=i.run,y=Re(i);return s.forcedNext==="BOSS"?(s.nodeExtra01=0,[{id:"A",type:"BATTLE"},{id:"B",type:"BATTLE"}]):(s.nodeExtra01==null&&(s.nodeExtra01=Ct(i.deck.length).extra),y+1+s.nodeExtra01>=s.nextBossTime?[{id:"A",type:"REST"},{id:"B",type:"REST"}]:i.run.branchOffer.root)},onChooseNode:i=>{const s=f();if(r||(r=!0,queueMicrotask(()=>r=!1),s.run.finished)||s.phase!=="NODE")return;et(s),s.run.branchOffer||(s.run.branchOffer=Te(s));const y=s.run,k=p.getNodeOffers(),x=i==="A"?k[0].type:k[1].type,v=Re(s),S=y.forcedNext==="BOSS";let w=0;S||(y.nodeExtra01==null&&(y.nodeExtra01=Ct(s.deck.length).extra),w=y.nodeExtra01);const _=v+1+w,P=s.run.nodePickCount+1;s.run.nodePickCount=P,s.time=(s.time??0)+w,y.nodeExtra01=null;const I=!S&&_>=y.nextBossTime,$=S?"BATTLE":I?"REST":x,z=$==="BATTLE"?1:0,K=_+z;if(s.time=(s.time??0)+w+z,z&&m(s,"전투를 선택해 시간이 더 소모된다. (시간 +1)"),an(s,i),s.run.nodePickByType[$]=(s.run.nodePickByType[$]??0)+1,s.run.treasureObtained&&$!=="TREASURE"){s.run.afterTreasureNodePicks+=1;const B=s.run.deckSizeAtTreasure??De(s),F=He(B);if(s.run.afterTreasureNodePicks>=F){s.run.finished=!0,m(s,`승리! 보물 획득 후 ${F}번의 탐험을 버티고 탈출했습니다.`),C(s,p);return}}if(S){y.forcedNext=null,y.nextBossTime+=40,s.run.bossOmenText=null,m(s,`=== 시간 ${K}: 보스 전투 ===`),pe(s,{forceBoss:!0}),fe(s),C(s,p);return}if(!S&&K>=y.nextBossTime&&(y.forcedNext="BOSS",m(s,"시간이 흘러 보스가 다가옵니다!")),$==="BATTLE"){pe(s,{forceBoss:!1}),fe(s),C(s,p);return}if($==="REST"){let B=function(O){const V=O.player.fatigue??0;V<10||(O.player.fatigue=Math.max(0,V-2),O.time=(O.time??0)+1,m(O,"피로가 너무 높아 휴식이 더 오래 걸립니다. (F -2, 시간 +1)"))};const F=()=>{const O=(s.player.fatigue??0)>=10,V=O?"피로도가 너무 높아 더 쉬어야 합니다.":"휴식",ce=O?" (피로도 10 이상: F -2, 시간 +1)":"";s.choice={kind:"EVENT",title:V,prompt:"무엇을 하시겠습니까?",art:"assets/events/event_rest.png",options:[{key:"rest:heal",label:`HP +15 ${ce}`},{key:"rest:clear_f",label:`F -3 ${ce}`},{key:"rest:upgrade",label:`강화 ${ce}`},{key:"rest:skip",label:"생략"}]},n=N=>{if(N==="rest:heal"){B(s),s.player.hp=Math.min(s.player.maxHp,s.player.hp+15),m(s,"휴식: HP +15"),c(s),s.phase="NODE",C(s,p);return}if(N==="rest:clear_f"){B(s),s.player.fatigue=Math.max(0,s.player.fatigue-3),m(s,"휴식: 피로 F-=3"),c(s),s.phase="NODE",C(s,p);return}if(N==="rest:upgrade"){g(s,p,"강화","강화할 카드 1장을 선택하세요.",{onDone:()=>{B(s),s.phase="NODE",C(s,p)},onSkip:()=>{F(),C(s,p)}});return}m(s,"휴식: 생략"),c(s),s.phase="NODE",C(s,p)}};F(),C(s,p);return}if($==="TREASURE"){zn(s);const B=s.run.deckSizeAtTreasure,F=He(B);m(s,`저주받은 보물을 얻었습니다! 이제부터 ${F}번의 탐험을 버티면 탈출합니다.`),C(s,p);return}if($==="EVENT"){const B=s.run;B.ominousProphecySeen??=!1;const F=.3;let O=Tt(s);if(B.ominousProphecySeen===!0)for(let N=0;N<50&&O.id==="ominous_prophecy";N++)O=Tt(s);else Math.random()<F&&(O=Jn("ominous_prophecy")??O,B.ominousProphecySeen=!0);const V=O.options(s),{tier:ce}=Le(s);ce>=2&&V.push({key:"mad:whisper",label:"속삭임에 귀 기울인다.",detail:"무언가를 얻는다. 그리고 무언가를 잃는다.",apply:N=>{const ue=Math.random();return ue<.34?(N.player.hp=Math.min(N.player.maxHp,N.player.hp+10),m(N,"속삭임: HP +10")):ue<.67?(N.player.fatigue+=1,m(N,"속삭임: F +1 (대가)")):(Oe(N,"mad_echo",{upgrade:0}),m(N,"속삭임: [메아리]를 얻었다.")),"NONE"}}),s.choice={kind:"EVENT",title:O.name,prompt:O.prompt,art:O.art??null,options:V.map(N=>({key:N.key,label:N.label,detail:N.detail}))},n=N=>{const ue=V.find(ze=>ze.key===N);if(!ue)return;const M=ue.apply(s);if(typeof M=="object"&&M.kind==="UPGRADE_PICK"){g(s,p,M.title??"강화",M.prompt??"강화할 카드 1장을 선택하세요.");return}if(typeof M=="object"&&M.kind==="REMOVE_PICK"){const ze=Object.values(s.cards).filter(W=>W.zone==="deck"||W.zone==="hand"||W.zone==="discard").map(W=>W.uid);h(s,{kind:"PICK_CARD",title:M.title,prompt:M.prompt??"제거할 카드 1장을 선택하세요.",options:[...ze.map(W=>{const we=at(s,W);return{key:`remove:${W}`,label:U(s,W),detail:`전열: ${we.frontText} / 후열: ${we.backText}`,cardUid:W}}),{key:"cancel",label:"취소"}]},W=>{if(W==="cancel"){m(s,"제거 취소"),c(s),C(s,p);return}if(!W.startsWith("remove:")){C(s,p);return}const we=W.slice(7);Mt(s,we);const ve=M.then,ht=ve==="REWARD"||ve==="REWARD_PICK"?"REWARD_PICK":ve==="BATTLE"?"BATTLE":ve==="NONE"?"NONE":void 0;if(ht==="BATTLE"){d(s),pe(s),fe(s),C(s,p);return}if(ht==="REWARD_PICK"){d(s),T(s,p,"카드 보상","두 장 중 한 장을 선택하거나 생략합니다.");return}d(s),s.phase="NODE",C(s,p)}),C(s,p);return}if(typeof M=="object"&&M.kind==="BATTLE_SPECIAL"){d(s),m(s,M.title?`이벤트 전투: ${M.title}`:"이벤트 전투 발생!"),pe(s,{forcePatternIds:M.enemyIds}),fe(s),C(s,p);return}if(M==="BATTLE"){d(s),pe(s),fe(s),C(s,p);return}if(M==="REWARD"){d(s),T(s,p,"카드 보상","두 장 중 한 장을 선택하거나 생략합니다.");return}c(s),C(s,p)},C(s,p);return}},onChooseChoice:i=>{const s=f();if(!s.choice)return;if(n){n(i);const k=f();k.enemies.length>0&&k.phase==="PLACE"||p.onAutoAdvance();return}const y=s.choice.kind;if(y==="REWARD"||y==="REWARD_PICK"){if(i==="skip"){m(s,"카드 보상 생략"),c(s),!s.run.finished&&s.enemies.length===0&&(s.phase="NODE"),C(s,p);return}if(i.startsWith("pick:")){const k=i.slice(5),[x,v]=k.split(":"),S=Number(v??"0")||0;Oe(s,x,{upgrade:S}),m(s,`카드 획득: ${Jt(s,x,S)}`),c(s),!s.run.finished&&s.enemies.length===0&&(s.phase="NODE"),C(s,p);return}}m(s,`선택 처리 불가: handler 없음 (kind=${y}, key=${i})`)},onAutoAdvance:()=>{const i=f();gr(i,p)},onRevealIntents:()=>{const i=f();i.run.finished||i.enemies.length!==0&&(dt(i),C(i,p))},onPlaceHandUidToSlot:(i,s,y)=>{const k=f();k.run.finished||H(k)||k.phase==="PLACE"&&(s==="back"&&k.backSlotDisabled?.[y]||(yt(k,i,s,y),k.selectedHandCardUid=null,C(k,p)))},onPlaceSelected:(i,s)=>{const y=f();y.selectedHandCardUid&&p.onPlaceHandUidToSlot(y.selectedHandCardUid,i,s)},onMoveSlotCard:(i,s,y,k)=>{const x=f();if(x.run.finished||H(x)||x.phase!=="PLACE"||y==="back"&&x.backSlotDisabled?.[k])return;const v=i==="front"?x.frontSlots:x.backSlots,S=y==="front"?x.frontSlots:x.backSlots,w=v[s];if(!w)return;const _=S[k];v[s]=_??null,S[k]=w,x.cards[w].zone=y,_&&(x.cards[_].zone=i),i!==y&&(i==="front"&&(x.frontPlacedThisTurn=Math.max(0,x.frontPlacedThisTurn-1)),y==="front"&&(x.frontPlacedThisTurn+=1),_&&(y==="front"&&(x.frontPlacedThisTurn=Math.max(0,x.frontPlacedThisTurn-1)),i==="front"&&(x.frontPlacedThisTurn+=1))),m(x,_?`[${U(x,w)}] ↔ [${U(x,_)}] 스왑: ${i}${s+1} ↔ ${y}${k+1}`:`[${U(x,w)}] 이동: ${i}${s+1} → ${y}${k+1}`),nt(x),C(x,p)},onResolveBack:()=>{const i=f();i.phase==="PLACE"&&nt(i),vn(i),C(i,p)},onResolveFront:()=>{const i=f();Pn(i),C(i,p)},onResolveEnemy:()=>{const i=f();$n(i),C(i,p)},onUpkeep:()=>{const i=f();Bn(i),C(i,p)},onDrawNextTurn:()=>{const i=f();Nn(i),C(i,p)}};function T(i,s,y,k){const v=It(i).map(S=>{const w=re(i.content,S.defId,S.upgrade);return{key:`pick:${S.defId}:${S.upgrade}`,label:aa(i,S),detail:`전열: ${w.frontText} / 후열: ${w.backText}`}});i.choice={kind:"REWARD",title:y,prompt:k,options:[...v,{key:"skip",label:"생략"}]},n=S=>{if(n=null,S.startsWith("pick:")){const w=S.slice(5),[_,P]=w.split(":"),I=Number(P??"0")||0;Oe(i,_,{upgrade:I})}else m(i,"카드 보상 생략");c(i),i.choice=null,i.run.finished||(i.phase="NODE"),C(i,s)},C(i,s)}function g(i,s,y,k,x){let v=Object.values(i.cards).filter(P=>(P.zone==="deck"||P.zone==="hand"||P.zone==="discard")&&Lt(i,P.uid)).map(P=>P.uid);const S=i.player.fatigue??0;let w=1/0;if(S>=8?w=4:S>=5&&(w=8),w!==1/0&&v.length>w&&(v=[...v].sort(()=>Math.random()-.5).slice(0,w)),v.length===0){m(i,"강화할 수 있는 카드가 없습니다."),i.choice=null,n=null,x?.onSkip?x.onSkip():C(i,s);return}const _=[...v].sort((P,I)=>{const $=i.cards[P],z=i.cards[I],K=Me(i,$.defId),B=Me(i,z.defId),F=K.localeCompare(B,"ko");return F!==0?F:($.upgrade??0)-(z.upgrade??0)});i.choice={kind:"UPGRADE_PICK",title:y,prompt:k,options:[..._.map(P=>{const I=i.cards[P],$=at(i,P),z=re(i.content,I.defId,(I.upgrade??0)+1),K=U(i,P),B=`현재: 전열 ${$.frontText} / 후열 ${$.backText}
강화: 전열 ${z.frontText} / 후열 ${z.backText}`;return{key:`up:${P}`,label:K,detail:B,cardUid:P}}),{key:"skip",label:"취소"}]},n=P=>{if(P==="skip"){m(i,"강화 취소"),c(i),x?.onSkip?x.onSkip():C(i,s);return}if(P.startsWith("up:")){const I=P.slice(3),$=Yn(i,I);m(i,$?`강화: [${U(i,I)}]`:"강화 실패"),c(i),x?.onDone?x.onDone():C(i,s);return}c(i),C(i,s)},C(i,s)}return p}function nt(e){const t=e.frontSlots.filter(r=>r!=null).length,n=e.backSlots.filter(r=>r!=null).length;e.frontPlacedThisTurn=t,e.usedThisTurn=t+n}function Ar(){const e=document.querySelector("#app");return e.innerHTML="",e}function J(e,t,n=""){const r=document.createElement("button");return n&&(r.className=n),r.type="button",r.textContent=e,r.onclick=t,r}function Hr(){const e=Array.from(document.querySelectorAll(".enemyName"));if(e.length===0)return;e.forEach(a=>{a.style.display="inline-block",a.style.width="auto",a.style.whiteSpace="nowrap"});let t=0;for(const a of e)t=Math.max(t,a.scrollWidth);const r=Math.min(t,320);e.forEach(a=>{a.style.width=`${r}px`,a.style.overflow="hidden",a.style.textOverflow="ellipsis"})}function Ir(){document.querySelector(".phaseBanner")?.remove(),performance.now()}function Rr(){fr();let e=document.querySelector(".floatFxLayer");e||(e=document.createElement("div"),e.className="floatFxLayer",document.body.appendChild(e)),e.style.cssText="position:fixed; inset:0;pointer-events:none;z-index: 100000;";const t=new Set(Ee.map(n=>String(n.id)));for(const n of Array.from(e.children)){const r=n.dataset.fxId;r&&(t.has(r)||n.remove())}for(const n of Ee){const r=String(n.id);let a=e.querySelector(`.floatNum[data-fx-id="${r}"]`);a?(a.style.left=`${Math.round(n.x)}px`,a.style.top=`${Math.round(n.y)}px`):(a=document.createElement("div"),a.className=`floatNum ${n.kind}`,a.dataset.fxId=r,a.textContent=n.text,a.style.left=`${Math.round(n.x)}px`,a.style.top=`${Math.round(n.y)}px`,e.appendChild(a))}}function Mr(){if(document.querySelector(".floatingNewRun"))return;const e=document.createElement("button");e.className="floatingNewRun",e.type="button",e.textContent="새로운 런",e.style.cssText=`
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    left: calc(env(safe-area-inset-left, 0px) + 10px);
    z-index: 99999;
    pointer-events: auto;

    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.55);
    color: #fff;

    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    cursor: pointer;
    touch-action: manipulation;
  `,e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),zt?.()}),document.body.appendChild(e)}function C(e,t){ee=e,er({getG:()=>ee??e,actions:{onNewRun:()=>t.onNewRun()},rerender:()=>C(ee??e,t),log:h=>m(ee??e,h)}),ie(),zt=()=>t.onNewRun(),Mr(),Sr(),C._logInitDone||(C._logInitDone=!0,xr());const n=document.querySelector(".mainPanel");n&&(Et=n.scrollTop,St=n.scrollLeft);const r=Ar();vt||(window.addEventListener("resize",()=>{}),Jr(()=>ee??e,t),vt=!0),r.appendChild(zr(e,t));const a=b("mainRow"),o=b("stage"),d=b("stageInner"),u=b("panel mainPanel"),l=!e.run.finished&&e.enemies.length>0&&e.phase!=="NODE";u.classList.toggle("inCombat",l),u.scrollTop=Et,u.scrollLeft=St,u.appendChild(qr(e)),e.run.finished?u.appendChild(ut("런 종료")):e.phase==="NODE"?Nr(u,e,t):Vr(u,e,t),d.appendChild(u),o.appendChild(d);const c=b("panel logPanel");if(c.classList.toggle("collapsed",Z),c.appendChild(Kr(Z,()=>{Z=!Z,kr(),C(e,t)})),!Z){const h=ra(e.log.join(`
`));h.classList.add("log"),c.appendChild(h)}a.appendChild(o),a.appendChild(c),r.appendChild(a),Hr(),Lr(e),jr(e,t,H(e)),Qr(),Yr(),Gt(),Fr(e,t),Wr(e,t),Dr(e,t),$r(e,t),hr(e),Ir(),Rr(),Tr(e)}function Lr(e){const t=document.querySelector(".stageInner");if(!t)return;document.querySelector(".stageCornerHud")?.remove();const n=document.createElement("div");n.className="stageCornerHud",n.textContent=Ur(e),document.body.appendChild(n);const r=t.getBoundingClientRect(),a=-56,o=(r.left+r.right)/2;n.style.right="",n.style.left=`${Math.round(o)}px`,n.style.top=`${Math.round(r.top+a)}px`,n.style.transform="translateX(-50%)"}function Dr(e,t){if(document.querySelector(".logOverlay")?.remove(),!tt)return;const n=b("logOverlay");n.style.cssText=`
    position: fixed; inset: 0;
    pointer-events:auto;
    z-index: 100000;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: flex-end;
    justify-content: center;
  `;const r=b("panel");r.style.cssText=`
    width: min(720px, 100%);
    max-height: 70vh;
    border-radius: 18px 18px 0 0;
    padding: 12px;
    margin: 0;
  `;const a=b("panelHeader"),o=document.createElement("h2");o.textContent="로그",a.appendChild(o);const d=J("닫기",()=>t.onToggleLogOverlay());a.appendChild(d),r.appendChild(a);const u=document.createElement("pre");u.className="log",u.textContent=e.log.join(`
`),u.style.maxHeight="60vh",u.style.overflow="auto",r.appendChild(u),n.onclick=()=>t.onToggleLogOverlay(),r.onclick=l=>l.stopPropagation(),n.appendChild(r),document.body.appendChild(n)}function Fr(e,t){if(document.querySelector(".overlay-layer")?.remove(),!A)return;const n=b("overlay-layer");n.style.cssText="position:fixed; inset:0; z-index:30000; background:rgba(0,0,0,.55); display:flex; justify-content:center; align-items:center;",n.onclick=l=>{l.target===n&&t.onCloseOverlay()};const r=b("overlay-panel");r.style.cssText="width:min(980px, 92vw); max-height:80vh; overflow:auto; padding:16px; border:1px solid rgba(255,255,255,.12); border-radius:16px; background:rgba(15,18,22,.92); box-shadow:0 18px 60px rgba(0,0,0,.45);",r.onclick=l=>l.stopPropagation();const a=A.kind==="RULEBOOK"?"룰북":A.pile==="deck"?"덱":A.pile==="discard"?"버림 더미":A.pile==="exhausted"?"소모(이번 전투)":A.pile==="vanished"?"소실(영구)":"손패",o=b("overlayHeader");o.style.cssText="display:flex; align-items:center; justify-content:space-between; gap:12px; position:sticky; top:0; padding-bottom:12px; margin-bottom:12px; background:rgba(15,18,22,.92);";const d=na(a);d.classList.add("overlayTitle");const u=ot("닫기",t.onCloseOverlay,!1);if(u.classList.add("overlayClose"),u.style.cssText="padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#fff; cursor:pointer;",o.appendChild(d),o.appendChild(u),r.appendChild(o),A.kind==="RULEBOOK"){const l=document.createElement("pre");l.className="rulebook",l.textContent=dr,l.style.cssText="white-space:pre-wrap; line-height:1.45; font-size:13px; margin:0; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);",r.appendChild(l)}else{const c=[...A.pile==="deck"?e.deck:A.pile==="discard"?e.discard:A.pile==="exhausted"?e.exhausted:A.pile==="vanished"?e.vanished:e.hand].sort((k,x)=>{const v=e.cards[k],S=e.cards[x],w=Me(e,v.defId),_=Me(e,S.defId),P=w.localeCompare(_,"ko");return P!==0?P:(v.upgrade??0)-(S.upgrade??0)}),h=b("pileView");h.style.cssText="display:grid;grid-template-columns: 1fr 320px;gap:16px;align-items:start;";const f=b("pileGrid");f.style.cssText="display:grid;grid-template-columns: repeat(auto-fill, minmax(var(--handCardW), 1fr));gap:10px;align-content:start;min-width:0;max-height: 62vh;overflow-y: auto;overflow-x: hidden;";const p=b("pileSide");p.style.cssText="position:sticky; top:72px;align-self:start;border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px;background:rgba(0,0,0,.22);";const T=b("pileSideTitle");T.style.cssText="font-weight:800; margin:0 0 10px 0; opacity:.95;",p.appendChild(T);const g=b("pilePreviewBox");g.style.cssText="display:flex; justify-content:center; align-items:flex-start;padding:8px 0 10px 0;",p.appendChild(g);const i=document.createElement("pre");i.className="pileSideDetail",i.style.cssText="margin:0;padding:10px;white-space:pre-wrap;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.20);font-size:12px;line-height:1.45;",p.appendChild(i);let s=c[0]??null;const y=()=>{if(g.innerHTML="",!s){T.textContent="선택된 카드 없음",i.textContent="";return}const k=at(e,s),x=pt(e,s);T.textContent=x;const v=de(e,s);g.appendChild(v),i.textContent=`전열: ${k.frontText}
후열: ${k.backText}`};if(c.length===0){const k=b("overlayEmpty");k.textContent="비어 있음",k.style.cssText="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03);",f.appendChild(k)}else for(const k of c){const x=de(e,k,S=>{s=S,y()});x.style.width="var(--handCardW)",x.style.height="var(--handCardH)",x.style.boxSizing="border-box",x.style.cursor="pointer";const v=()=>{s=k,f.querySelectorAll(".pileSelected").forEach(S=>S.classList.remove("pileSelected")),x.classList.add("pileSelected"),y()};x.onclick=v,x.onmouseenter=v,f.appendChild(x)}if(h.appendChild(f),h.appendChild(p),r.appendChild(h),s){const k=f.firstElementChild;k&&k.classList.add("pileSelected")}y()}n.appendChild(r),document.body.appendChild(n)}function Wr(e,t){document.querySelector(".choice-overlay")?.remove();const n=e.choice;if(!n){document.querySelector(".mainPanel")?.classList.remove("choiceOpen");return}const r=document.querySelector(".mainPanel");if(!r)return;r.classList.add("choiceOpen");const a=b("choice-overlay");a.style.cssText="position:fixed; inset:0; z-index:22000;background: transparent; display:flex; justify-content:center; align-items:flex-start; padding:180px 36px 12px 12px; box-sizing:border-box;pointer-events:auto;",a.style.setProperty("pointer-events","auto","important"),a.onclick=l=>{l.target===a&&t.onChooseChoice("close")};const o=b("choice-panel");o.style.cssText="width:min(750px, 88vw); max-height:70vh;overflow:auto; overflow-x:hidden; padding:16px;border:1px solid rgba(255,255,255,.14); border-radius:16px;background:rgba(0,0,0,1);pointer-events:auto;",o.style.setProperty("pointer-events","auto","important"),o.onclick=l=>l.stopPropagation(),o.appendChild(ta(n.title)),n.prompt&&o.appendChild(ut(n.prompt));const d=l=>{l.style.width="var(--handCardW)",l.style.height="var(--handCardH)",l.style.boxSizing="border-box"};if(n.options.some(l=>l.cardUid?!0:typeof l.key=="string"&&l.key.startsWith("pick:"))){const l=b("choice-list");l.style.cssText="display:flex; flex-direction:column; gap:10px; margin-top:12px;",n.options.forEach(c=>{const h=b("choice-item");h.style.cssText="display:flex; gap:12px; align-items:flex-start;border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px;background:rgba(255,255,255,.03);";const f=b("choice-left");f.style.cssText="flex:0 0 auto;";const p=c.cardUid;if(p){const i=e.choice?.kind==="UPGRADE_PICK",y=(e.cards[p].upgrade??0)+1;let k;try{i?(k=Br(e,p,y),k.classList.add("upgradePreview")):k=de(e,p)}catch{k=de(e,p)}d(k),f.appendChild(k)}else if(typeof c.key=="string"&&c.key.startsWith("pick:")){const i=c.key.slice(5),[s,y]=i.split(":"),k=Number(y??"0")||0,x=qt(e,s,k);d(x),f.appendChild(x)}const T=b("choice-right");T.style.cssText="flex:1 1 auto; min-width:260px;";const g=ot(c.label,()=>t.onChooseChoice(c.key),!1);if(g.classList.add("primary"),T.appendChild(g),c.detail){const i=document.createElement("pre");i.className="choice-detail",i.textContent=String(c.detail),i.style.cssText="margin:10px 0 0 0; padding:10px; white-space:pre-wrap;border-radius:12px; border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22); font-size:12px; line-height:1.45;max-height:220px; overflow:auto;",T.appendChild(i)}h.appendChild(f),h.appendChild(T),l.appendChild(h)}),o.appendChild(l)}else{const l=b("choice-contentRow");l.style.cssText="display:flex; gap:18px; margin-top:12px;justify-content:center; align-items:stretch;";const c=b("choice-leftCol");c.style.cssText="flex:1 1 640px; max-width:720px; min-width:0;";const h=b("choice-illuCol");h.style.cssText="flex:0 0 var(--choiceIlluSize, 260px); min-width:200px;display:flex; align-items:center; justify-content:center;";const f=b("choice-illuBox");f.style.cssText="width:100%; aspect-ratio:1/1;border-radius:18px; border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.35);";const p=n.art;if(p){const g=document.createElement("img");g.src=p,g.alt=n.title??"illustration";const i=1.5;f.style.overflow="hidden",g.style.imageRendering="pixelated",g.style.cssText="position:absolute; inset:0;width:"+i*100+"%;height:"+i*100+"%;left:"+-.5*50+"%;top:"+-.5*50+"%;object-fit:cover;object-position:50% 50%;image-rendering: pixelated; image-rendering: crisp-edges;border-radius:18px;",f.style.position="relative",f.appendChild(g)}h.appendChild(f);const T=b("choice-list");T.style.cssText="display:flex; flex-direction:column; gap:10px;",n.options.forEach(g=>{const i=b("choice-item");i.style.cssText="display:flex; gap:12px; align-items:flex-start;border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px;background:rgba(255,255,255,.03);position:relative;";const s=ot(g.label,()=>t.onChooseChoice(g.key),!1);if(s.classList.add("choiceOptBtn"),i.appendChild(s),g.detail){const y=document.createElement("pre");y.className="choice-detail",y.textContent=String(g.detail),y.style.cssText="margin:10px 0 0 0; padding:10px; white-space:pre-wrap;border-radius:12px; border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22); font-size:12px; line-height:1.45;max-height:220px; overflow:auto;font-family: Mulmaru, ui-sans-serif, system-ui;",i.appendChild(y)}T.appendChild(i)}),c.appendChild(T),l.appendChild(c),l.appendChild(h),o.appendChild(l)}a.appendChild(o),document.body.appendChild(a)}function q(){const e=window.matchMedia?.("(max-width: 900px)").matches??!1,t=window.matchMedia?.("(pointer: coarse)").matches??!1;return e&&t}function zr(e,t){document.querySelectorAll(".topHud").forEach(d=>d.remove()),document.querySelectorAll(".enemyHudCenter").forEach(d=>d.remove());const n=b("topHud"),r=q();r||n.appendChild(b("topHudLeftSpacer"));const a=b("playerHudLeft");if(r){const d=b("mobileTopLine");d.appendChild(Y(`HP ${e.player.hp}/${e.player.maxHp}`)),d.appendChild(Y(`블록 ${e.player.block}`)),d.appendChild(Y(`S ${e.player.supplies} |`,e.player.supplies===0?"warn":"")),d.appendChild(Y(`F ${e.player.fatigue}`)),d.appendChild(Y(`| 시간 ${Math.max(1,Re(e))}`)),d.appendChild(Y(`| 덱 ${e.deck.length}`)),a.appendChild(d);const u=b("mobileStatusLine"),l=e.player.status,c=[];(l.vuln??0)>0&&c.push(`취약 ${l.vuln}`),(l.weak??0)>0&&c.push(`약화 ${l.weak}`),(l.bleed??0)>0&&c.push(`출혈 ${l.bleed}`),(l.disrupt??0)>0&&c.push(`교란 ${l.disrupt}`);const h=c.slice(0,4);for(const f of h)u.appendChild(j(f));c.length>h.length&&u.appendChild(j(`+${c.length-h.length}`)),a.appendChild(u)}else{const d=b("playerTitleRow");d.appendChild(D("playerHudTitle","플레이어"));const u=b("pileButtons");u.appendChild(J("덱",()=>t.onViewPile("deck"))),u.appendChild(J("버림",()=>t.onViewPile("discard"))),u.appendChild(J("손패",()=>t.onViewPile("hand"))),u.appendChild(J("소모",()=>t.onViewPile("exhausted"))),u.appendChild(J("소실",()=>t.onViewPile("vanished"))),d.appendChild(u),a.appendChild(d);const l=b("enemyChip");l.classList.add("playerHudBox");const c=b("enemyChipTop");c.appendChild(D("","HP")),c.appendChild(D("",`${e.player.hp}/${e.player.maxHp}`)),l.appendChild(c);const h=b("enemyHPOuter"),f=b("enemyHPFill");f.style.width=`${Math.max(0,Math.min(100,e.player.hp/Math.max(1,e.player.maxHp)*100))}%`,h.appendChild(f),l.appendChild(h);const p=b("enemyChipTop");p.appendChild(D("","블록")),p.appendChild(D("",`${e.player.block}`)),l.appendChild(p);const T=b("enemyHPOuter"),g=b("enemyHPFill");g.style.background="linear-gradient(90deg, #64b5ff, #2a7cff)",g.style.width=`${Math.max(0,Math.min(100,e.player.block/Math.max(1,e.player.maxHp)*100))}%`,T.appendChild(g),l.appendChild(T);const i=e.player.status,s=b("enemyBadges");l.appendChild(s);const y=[];(i.vuln??0)>0&&y.push(`취약 ${i.vuln}`),(i.weak??0)>0&&y.push(`약화 ${i.weak}`),(i.bleed??0)>0&&y.push(`출혈 ${i.bleed}`),(i.disrupt??0)>0&&y.push(`교란 ${i.disrupt}`);const k=r?y.slice(0,3):y;for(const x of k)s.appendChild(j(x));r&&y.length>k.length&&s.appendChild(j(`+${y.length-k.length}`)),a.appendChild(l)}if(!e.run.finished&&e.enemies.length>0&&e.phase!=="NODE"){const d=b("enemyHudCenter"),u=b("enemyHudCenterMover"),l=b(r?"enemyStrip":"enemyHud");r||(l.style.cssText=`
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;          /* ✅ 줄바꿈 금지 */
        justify-content: center;    /* ✅ 묶음 자체 중앙 */
        align-items: stretch;
        gap: 14px;
        overflow: visible;          /* ✅ 스크롤바/잘림 방지 */
        white-space: nowrap;
      `),d.style.overflow="visible",u.style.overflow="visible",u.style.width="max-content";const c=H(e);u.appendChild(l),document.querySelectorAll(".enemyHudCenter").forEach(h=>h.remove()),d.appendChild(u),document.body.appendChild(d);for(let h=0;h<e.enemies.length;h++){const f=e.enemies[h],p=b("enemyBanner");p.style.cssText=`
        flex: 0 0 var(--enemyBannerW, 520px);  /* 고정 폭 */
        width: var(--enemyBannerW, 520px);
        max-width: min(var(--enemyBannerW, 520px), 92vw);
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(0,0,0,.78);
        padding: 12px 14px;
        box-sizing: border-box;
      `,c&&f.hp>0&&p.classList.add("targetable");const T=b("enemyChipTop");if(T.appendChild(D("",`${h+1}. ${f.name}`)),T.appendChild(D("",`${f.hp}/${f.maxHp}`)),p.appendChild(T),!r){const S=b("enemyHPOuter"),w=b("enemyHPFill");w.style.width=`${Math.max(0,Math.min(100,f.hp/Math.max(1,f.maxHp)*100))}%`,S.appendChild(w),p.appendChild(S)}const g=e.content.enemiesById[f.id],i=g.intents[f.intentIndex%g.intents.length],s=f.intentLabelOverride??i.label;p.appendChild(D("enemyIntent",e.intentsRevealedThisTurn?`${s}`:""));const y=f.status,k=b("enemyBadges");p.appendChild(k);const x=[];(y.vuln??0)>0&&x.push(`취약 ${y.vuln}`),(y.weak??0)>0&&x.push(`약화 ${y.weak}`),(y.bleed??0)>0&&x.push(`출혈 ${y.bleed}`),(y.disrupt??0)>0&&x.push(`교란 ${y.disrupt}`),f.immuneThisTurn&&x.push("면역");const v=r?x.slice(0,2):x;for(const S of v)k.appendChild(j(S));r&&x.length>v.length&&k.appendChild(j(`+${x.length-v.length}`)),p.onclick=()=>t.onSelectEnemy(h),l.appendChild(p)}}if(n.appendChild(a),!r){const d=b("topHudRight");d.appendChild(J("룰북",()=>t.onViewRulebook())),d.appendChild(J("로그",()=>t.onToggleLogOverlay())),n.appendChild(d)}return n}function Ur(e){const t=e.enemies.length>0&&e.phase!=="NODE",n=e.run.nextBattleSuppliesBonus??0,r=[];return t?r.push(`🧰 S ${e.player.supplies} |`):n>0&&r.push(`보너스 🧰 S +${n} |`),r.push(`💤 F ${e.player.fatigue}`),r.push(`| ⏳ 시간 ${Math.max(0,(e.run.nodePickCount??0)+(e.time??0))}`),r.push(`| 🃏 덱 ${e.deck.length}`),r.join(" ")}function Y(e,t=""){const n=document.createElement("span");return n.className="chip"+(t?` ${t}`:""),n.textContent=e,n}function qr(e){if(q()){const l=b("battleTitleRow");return l.style.display="none",l}const n=b("battleTitleRow");n.style.display="flex",n.style.alignItems="center",n.style.gap="12px";const r=document.createElement("h2");r.textContent="",n.appendChild(r);const a=jt(e),o=D("targetHintInline","");o.style.cssText="padding:5px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.55);background: rgb(255, 0, 0);opacity:.82;font-weight:400; font-size:12px; line-height:1.2;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;width: min(400px, 92vw);max-width: none;pointer-events:auto;",a?(o.textContent=a,o.style.visibility="visible",o.style.pointerEvents="auto"):(o.textContent="대상 선택 필요",o.style.visibility="hidden",o.style.pointerEvents="none");const d=b("battleTitleRight");d.style.cssText="margin-left:auto;display:flex; align-items:center; gap:10px;flex: 0 0 auto;white-space:nowrap;position:relative;";const u=b("resourceRow inline");return u.appendChild(Y("")),u.appendChild(Y("")),u.appendChild(Y("")),d.appendChild(u),o.style.position="absolute",o.style.right="207px",o.style.top="calc(100% - 8px)",o.style.marginTop="0px",o.style.zIndex="5",o.style.pointerEvents=a?"auto":"none",n.appendChild(o),n.appendChild(d),n}function Kr(e,t){const n=b("logHeaderRow");n.tabIndex=0;const r=document.createElement("h2");r.textContent="로그";const a=document.createElement("span");return a.className="chev",a.textContent=e?"▸":"▾",n.appendChild(r),n.appendChild(a),n.onclick=()=>t(),n.onkeydown=o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),t())},n}function jt(e){if(!H(e)||e.selectedEnemyIndex!=null)return null;const t=e.pendingTarget??null,n=t?.sourceCardUid?U(e,t.sourceCardUid):null,r=t?.sourceLabel??null,a=t?.reason??null,o=n?`대상 선택 (${n})`:r?`대상 선택 (${r})`:"대상 선택 필요",d=a==="FRONT"?"전열":a==="BACK"?"후열":a==="EVENT"?"이벤트":a==="RELIC"?"유물":null,u=d?` — ${d}`:"",l=e.pendingTargetQueue?.length??0,c=(e.pendingTarget?1:0)+l,h=c>1?` (남은 ${c}개)`:" (남은 1개)";return`${o}${u}${h}: 위의 적 박스를 클릭하세요.`}function Vr(e,t,n){const r=b("combatRoot"),a=b("boardArea"),o=!t.run.finished&&t.enemies.length>0&&t.phase!=="NODE";if(a.classList.toggle("slabOn",o),q()){const d=b("targetHintSlot");d.style.cssText="height: 54px;margin: 0 0 3px 0;display:flex; align-items:center;",r.appendChild(d);const u=jt(t);if(u){const l=b("targetHint");l.textContent=u,d.appendChild(l)}else d.style.visibility="hidden",d.textContent="."}a.appendChild($t(t,n,"front")),a.appendChild($t(t,n,"back")),r.appendChild(a),e.appendChild(r)}let rt=null,Xt=!0;function Pt(e,t){rt=e,Xt=t}function Yt(e,t,n){return e.run.finished?{label:"종료",fn:null,disabled:!0,activePhase:e.phase}:e.choice||A?{label:"선택 중",fn:null,disabled:!0,activePhase:e.phase}:n?{label:"대상 선택",fn:null,disabled:!0,activePhase:e.phase}:e.phase==="NODE"?{label:"노드 선택",fn:null,disabled:!0,activePhase:e.phase}:e.phase==="PLACE"?e.enemies.length>0&&!e.intentsRevealedThisTurn?{label:"다음: 정찰",fn:t.onRevealIntents,disabled:!1,activePhase:e.phase}:{label:"다음: 후열",fn:t.onResolveBack,disabled:!1,activePhase:e.phase}:e.phase==="BACK"?{label:"다음: 후열",fn:t.onResolveBack,disabled:!1,activePhase:e.phase}:e.phase==="FRONT"?{label:"다음: 전열",fn:t.onResolveFront,disabled:!1,activePhase:e.phase}:e.phase==="ENEMY"?{label:"다음: 적",fn:t.onResolveEnemy,disabled:!1,activePhase:e.phase}:e.phase==="UPKEEP"?{label:"다음: 정리",fn:t.onUpkeep,disabled:!1,activePhase:e.phase}:e.phase==="DRAW"?{label:"다음 턴",fn:t.onDrawNextTurn,disabled:!1,activePhase:e.phase}:{label:"다음",fn:null,disabled:!0,activePhase:e.phase}}function jr(e,t,n){const r=document.querySelector(".handDock");r&&r.remove();const a=!e.run.finished&&e.enemies.length>0&&e.phase!=="NODE";document.querySelector(".combatControls")?.remove();const o=b("handDock"),d=Yt(e,t,n);if(a){const c=b("combatControls"),h=document.createElement("button");h.textContent="다음 턴",h.className="stepBtn primary",h.disabled=d.disabled||e.phase==="NODE",h.onclick=()=>t.onAutoAdvance();const f=document.createElement("button");f.textContent="선택 해제",f.disabled=!e.selectedHandCardUid,f.onclick=t.onClearSelected,c.appendChild(h),c.appendChild(f),document.body.appendChild(c);const p=document.querySelector('.slot[data-slot-side="front"][data-slot-index="1"]')??document.querySelector(".stageInner");if(p){const T=p.getBoundingClientRect(),g=T.left+T.width/2;c.style.left=`${Math.round(g)}px`}Pt(()=>t.onAutoAdvance(),h.disabled)}else Pt(null,!0);const u=b("hand");u.dataset.dropHand="1";const l=b("handCardsRow");if(u.appendChild(l),e.hand.length===0){const c=b("handEmptyHint");c.textContent="",l.appendChild(c)}else{const c=!q();for(const h of e.hand)l.appendChild(We(e,h,!0,t.onSelectHandCard,{draggable:c}))}o.appendChild(u),document.body.appendChild(o),q()||Xr(u)}function Xr(e){e.dataset?.wheelX!=="1"&&(e.dataset.wheelX="1",e.addEventListener("wheel",t=>{if(t.shiftKey)return;const n=Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY;e.scrollLeft+=n,t.preventDefault()},{passive:!1}))}function Yr(){const e=document.querySelector(".enemyHudCenter");if(!e)return;const t=e.querySelector(".enemyHudCenterMover")??e,n=e.querySelector(".enemyHud")??e.querySelector(".enemyStrip")??t;e.style.position="fixed",e.style.top="8px",e.style.left="50%",e.style.right="auto",e.style.transform="translateX(-50%)",e.style.overflow="visible",t.style.transform="",t.style.overflow="visible";const a=Array.from(e.querySelectorAll(".enemyBanner")).length;if(a===0){e.style.width="";return}const o=Math.min(520,Math.floor(window.innerWidth*.92)),d=14,u=o,l=Math.min(window.innerWidth-16,u*2+d),c=Math.min(window.innerWidth-16,u*3+d*2);n.style.display="flex",n.style.flexWrap="nowrap",n.style.justifyContent="center",n.style.alignItems="stretch",n.style.gap=`${d}px`,a===1?(e.style.width=`${u}px`,t.style.width="100%"):a===2?(e.style.width=`${l}px`,t.style.width="100%"):(e.style.width=`${c}px`,t.style.width="100%")}function Qr(e){const t=document.querySelector(".hand"),n=document.querySelector(".handCardsRow");if(!t||!n)return;const r=document.querySelector('.slot[data-slot-side="front"][data-slot-index="1"]'),a=document.querySelector(".stageInner"),o=r?.getBoundingClientRect()??a?.getBoundingClientRect();if(!o)return;const d=o.left+o.width/2,u=Array.from(n.querySelectorAll(".card"));if(u.length===0)return;const l=u[0].getBoundingClientRect(),c=u[u.length-1].getBoundingClientRect(),h=l.left,f=c.right,p=(h+f)/2,T=d-p,g=n.scrollWidth,i=t.clientWidth;if(g<=i+1){n.style.transform=`translateX(${Math.round(T)}px)`,t.scrollLeft=0;return}let s=t.scrollLeft-T;const y=Math.max(0,g-i);s<0&&(s=0),s>y&&(s=y),t.scrollLeft=Math.round(s),n.style.transform=""}function $t(e,t,n){const r=b("grid6"),a=!!e.selectedHandCardUid,o=n==="front"?e.frontSlots:e.backSlots,d=q();for(let u=0;u<3;u++){const l=n==="back"?!!e.backSlotDisabled?.[u]:!1,c=b("slot"+(l?" disabled":""));c.dataset.slotSide=n,c.dataset.slotIndex=String(u),X&&X.side===n&&X.idx===u&&c.classList.add("dropHover"),a&&!l&&c.classList.add("placeable");const h=o[u];if(h){const f=q()?vr(e,h):We(e,h,!1);f.classList.add("inSlot"),c.appendChild(f),d?Ut(f,{delayMs:420,moveTolerancePx:8,shouldIgnore:()=>!!(l||H(e)||e.phase!=="PLACE"),onFire:p=>{p.stopPropagation(),t.onReturnSlotToHand(n,u)},onTap:p=>{p.stopPropagation(),Pr(e,h)}}):(f.onpointerdown=p=>{q()||p.button!==0&&p.pointerType==="mouse"||H(e)||e.phase==="PLACE"&&Qt(p,{kind:"slot",cardUid:h,fromSide:n,fromIdx:u})},f.ondblclick=()=>t.onReturnSlotToHand(n,u))}c.onclick=()=>{if(l||H(e)||e.phase!=="PLACE")return;const f=o[u];if(!e.selectedHandCardUid&&f){t.onReturnSlotToHand(n,u);return}t.onPlaceSelected(n,u)},r.appendChild(c)}return r}function Gr(){if(document.querySelectorAll(".slot.dropHover").forEach(n=>n.classList.remove("dropHover")),!X)return;const e=`.slot[data-slot-side="${X.side}"][data-slot-index="${X.idx}"]`,t=document.querySelector(e);t&&t.classList.add("dropHover")}function Jr(e,t){window.onpointermove=n=>{const r=e();if(r.choice||A||!E||n.pointerId!==E.pointerId)return;E.x=n.clientX,E.y=n.clientY;const a=E.x-E.startX,o=E.y-E.startY;!E.dragging&&a*a+o*o>36&&(E.dragging=!0),X=E.dragging?Bt(n.clientX,n.clientY,r):null,Gt(document.querySelector("#app")),Gr()},window.onpointerup=n=>{const r=e();if(!(r.choice||A)&&!(!E||n.pointerId!==E.pointerId)){if(E.dragging){const a=Zr(n.clientX,n.clientY),o=Bt(n.clientX,n.clientY,r);if(a&&E.kind==="slot"&&E.fromSide!=null&&E.fromIdx!=null){!r.run.finished&&!H(r)&&r.phase==="PLACE"&&t.onReturnSlotToHand(E.fromSide,E.fromIdx),E=null,X=null,C(r,t);return}if(o)if(E.kind==="hand"){const d=e();if(!(d.run.finished||H(d)||d.phase!=="PLACE")){const u=o.side,l=o.idx;if(!(u==="back"&&d.backSlotDisabled?.[l])){const c=u==="front"?d.frontSlots:d.backSlots,h=c[l];if(!h)t.onPlaceHandUidToSlot(E.cardUid,u,l);else{const f=E.fromHandIndex!=null&&E.fromHandIndex>=0?E.fromHandIndex:d.hand.indexOf(E.cardUid),p=d.hand.indexOf(E.cardUid);p>=0&&d.hand.splice(p,1),c[l]=E.cardUid,d.cards[E.cardUid].zone=u;const T=f!=null&&f>=0&&f<=d.hand.length?f:d.hand.length;d.hand.splice(T,0,h),d.cards[h].zone="hand",d.selectedHandCardUid=null,nt(d),m(d,`[${U(d,E.cardUid)}] ↔ [${U(d,h)}] 스왑: 손패 ↔ ${u}${l+1}`),C(d,t)}}}}else E.kind==="slot"&&E.fromSide!=null&&E.fromIdx!=null&&(E.fromSide===o.side&&E.fromIdx===o.idx||t.onMoveSlotCard(E.fromSide,E.fromIdx,o.side,o.idx))}E?.sourceEl&&E.sourceEl.classList.remove("isDraggingSource"),E=null,X=null,C(r,t)}},window.addEventListener("keydown",n=>{const r=n.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return;const a=e();if(!tr()){if(n.ctrlKey&&n.shiftKey&&n.code==="KeyK"){n.preventDefault(),nr();return}if(n.code==="KeyF"){n.preventDefault(),t.onNewRun();return}if(n.code==="Digit4"){if(n.preventDefault(),H(a)){a.pendingTarget=null,a.pendingTargetQueue=[],a.selectedEnemyIndex=null,m(a,"대상 선택 취소"),C(a,t);return}t.onClearSelected();return}if(n.key==="Tab"){if(n.preventDefault(),a.hand.length===0)return;const o=a.selectedHandCardUid,d=o?a.hand.indexOf(o):-1,u=n.shiftKey?-1:1,l=((d+u)%a.hand.length+a.hand.length)%a.hand.length;a.selectedHandCardUid=a.hand[l],C(a,t);return}if(n.code==="Space"){n.preventDefault();const o=e();if(o.run.finished||o.choice||H(o))return;t.onAutoAdvance();return}if(n.code==="Digit1"||n.code==="Digit2"||n.code==="Digit3"){n.preventDefault();const o=n.code==="Digit1"?0:n.code==="Digit2"?1:2;if(H(a)){const d=a.enemies[o];if(!d||d.hp<=0){m(a,`대상 선택 실패: ${o+1}번 적이 없습니다.`),C(a,t);return}t.onSelectEnemy(o);return}t.onHotkeySlot("front",o);return}if(n.code==="KeyQ"||n.code==="KeyW"||n.code==="KeyE"){n.preventDefault();const o=n.code==="KeyQ"?0:n.code==="KeyW"?1:2;t.onHotkeySlot("back",o);return}if(n.code==="Enter"){n.preventDefault(),!Xt&&rt&&rt();return}}})}function Qt(e,t){const n=e.currentTarget;try{n.setPointerCapture(e.pointerId)}catch{}const r=n.closest(".card");r&&r.classList.add("isDraggingSource");const a=r?.getBoundingClientRect(),o=a?e.clientX-a.left:20,d=a?e.clientY-a.top:20,u=getComputedStyle(document.documentElement),l=parseFloat(u.getPropertyValue("--handCardW"))||void 0,c=parseFloat(u.getPropertyValue("--handCardH"))||void 0;if(E={kind:t.kind,cardUid:t.cardUid,fromHandIndex:t.fromHandIndex,fromSide:t.fromSide,fromIdx:t.fromIdx,pointerId:e.pointerId,startX:e.clientX,startY:e.clientY,x:e.clientX,y:e.clientY,dragging:!1,previewEl:void 0,previewW:a?.width??l,previewH:a?.height??c,grabDX:o,grabDY:d},r){E.sourceEl=r;const h=r.cloneNode(!0);h.classList.remove("inSlot"),h.classList.remove("selected"),h.classList.remove("isDraggingSource"),h.style.position="static",h.style.inset="",h.style.width="100%",h.style.height="100%",h.style.margin="0",h.style.boxSizing="border-box",h.style.opacity="1",h.style.filter="none",h.style.transform="none",h.style.backgroundColor="transparent",E.previewEl=h}}function Zr(e,t){const n=document.elementFromPoint(e,t);if(!n)return!1;let r=n;for(;r;){if(r.dataset?.dropHand==="1")return!0;r=r.parentElement}return!1}function Bt(e,t,n){const r=document.elementFromPoint(e,t);if(!r)return null;const a=ea(r,["slotSide","slotIndex"]);if(!a)return null;const o=a.dataset.slotSide,d=Number(a.dataset.slotIndex);return o==="back"&&n.backSlotDisabled?.[d]?null:{side:o,idx:d}}function ea(e,t){let n=e;for(;n;){const r=n.dataset;let a=!0;for(const o of t)if(r[o]==null){a=!1;break}if(a)return n;n=n.parentElement}return null}function Gt(e,t){if(q()){document.querySelector(".dragLayer")?.remove();return}if(!E||!E.dragging){document.querySelector(".dragLayer")?.remove();return}let n=document.querySelector(".dragLayer");if(n||(n=document.createElement("div"),n.className="dragLayer",n.style.position="fixed",n.style.inset="0",n.style.zIndex="21000",n.style.pointerEvents="none",document.body.appendChild(n)),n.innerHTML="",!E.previewEl)return;const r=document.createElement("div");r.className="dragCardPreview",r.style.position="fixed",r.style.left=`${Math.round(E.x-(E.grabDX??20))}px`,r.style.top=`${Math.round(E.y-(E.grabDY??20))}px`;const a=E.previewW??0,o=E.previewH??0;a>0&&(r.style.width=`${Math.round(a)}px`),o>0&&(r.style.height=`${Math.round(o)}px`),r.style.transform="none",r.style.opacity="1",r.style.filter="none",r.style.boxShadow="0 16px 44px rgba(0,0,0,.65)",r.style.backdropFilter="none",r.style.isolation="isolate",r.style.mixBlendMode="normal",r.style.overflow="hidden",r.style.borderRadius="16px",r.style.background="transparent",r.style.clipPath="inset(0 round 16px)",r.appendChild(E.previewEl),n.appendChild(r)}function at(e,t){const n=e.cards[t];return re(e.content,n.defId,n.upgrade??0)}function Me(e,t){return e.content.cardsById[t]?.name??t}function Jt(e,t,n){const r=n??0,a=e.content.cardsById[t]?.name??t;return r>0?`${a} +${r}`:a}function U(e,t){const n=e.cards[t];return Jt(e,n.defId,n.upgrade??0)}function We(e,t,n,r,a){const o=e.cards[t],d=re(e.content,o.defId,o.upgrade??0),u=a?.draggable??!0,l=b("card");e.selectedHandCardUid===t&&l.classList.add("selected"),d.tags?.includes("EXHAUST")&&l.classList.add("exhaust"),d.tags?.includes("VANISH")&&l.classList.add("vanish");const c=b("cardHeader"),h=pt(e,t);c.appendChild(D("cardTitle",h));const f=b("cardMeta");d.tags?.includes("EXHAUST")&&f.appendChild(j("소모")),d.tags?.includes("VANISH")&&f.appendChild(j("소실")),c.appendChild(f),l.appendChild(c);const p=b("cardBody"),T=b("cardSection");T.classList.add("front"),T.appendChild(Nt(d.frontText)),p.appendChild(T);const g=b("cardSection");return g.classList.add("back"),g.appendChild(Nt(d.backText)),p.appendChild(g),l.appendChild(p),n&&r&&(l.onclick=()=>r(t)),n&&(l.onpointerdown=i=>{if(!q()){if(i.button!==0&&i.pointerType==="mouse"||H(e)||e.phase!=="PLACE"||!u)return;const s=e.hand.indexOf(t);Qt(i,{kind:"hand",cardUid:t,fromHandIndex:s})}},q()&&Ut(l,{delayMs:280,moveTolerancePx:6,shouldIgnore:()=>H(e),onFire:()=>wr(e,t),onTap:()=>{r&&r(t)}})),l}function b(e){const t=document.createElement("div");return t.className=e,t}function D(e,t){const n=document.createElement("div");return n.className=e,n.textContent=t,n}function ta(e){const t=document.createElement("h2");return t.textContent=e,t}function na(e){const t=document.createElement("h3");return t.textContent=e,t}function ut(e){const t=document.createElement("p");return t.textContent=e,t}function j(e){const t=document.createElement("span");return t.className="badge",t.textContent=e,t}function ot(e,t,n){const r=document.createElement("button");return r.textContent=e,r.disabled=n,r.onclick=t,r}function ra(e){const t=document.createElement("pre");return t.className="log",t.textContent=e,t}function Zt(e,t){const n=t??0;return n>0?`${e} +${n}`:e}function pt(e,t){const n=e.cards[t],r=e.content.cardsById[n.defId].name;return Zt(r,n.upgrade)}function aa(e,t){const n=e.content.cardsById[t.defId].name;return Zt(n,t.upgrade)}const oa={취약:"🎯",약화:"🥀",출혈:"🩸",교란:"🌀",면역:"✨",S:"🧰",F:"💤",드로우:"🃏",피해:"🗡️",회복:"💊",방어:"🛡️",블록:"🛡️",소모:"🔥",소실:"🕳️"};function _t(e,t,n){const r=oa[e]??"",a=t!=null?`${e} ${t}`:e;return`<span class="kwBadge"><span class="kwIcon">${r}</span> <span class="kwLabel">${a}</span><span class="kwPunc">${n||""}</span></span>`}const en="[,，、]",sa=new RegExp(`(취약|약화|출혈|교란|면역|S|F|드로우|피해|방어|블록|회복|소모|소실)\\s*([+-]?\\d+)\\s*(${en})?`,"g"),ia=new RegExp(`\\b(소모|소실|피해)\\b\\s*(${en})?`,"g");function la(e){let t=e.replace(sa,(n,r,a,o)=>_t(r,a,o));return t=t.replace(ia,(n,r,a)=>_t(r,void 0,a)),t=t.replace(/\n/g,"<br>"),t}function Nt(e){const t=b("cardText");return t.innerHTML=la(e),t}nn();rn();const da=Zn();let ke=Er(da);function tn(e){ke=e,st=Vt(ke,tn),C(ke,st)}let st=Vt(ke,tn);C(ke,st);document.documentElement.style.setProperty("--base","/deck-rogue-prototype/");const ft="/deck-rogue-prototype/";document.documentElement.style.setProperty("--bgUrl",`url(${ft}ui/background/dungeon_bg.png)`);document.documentElement.style.setProperty("--boardUrl",`url(${ft}ui/boards/battle_board.png)`);document.documentElement.style.setProperty("--cardUrl",`url(${ft}ui/cards/card_parchment.png)`);
