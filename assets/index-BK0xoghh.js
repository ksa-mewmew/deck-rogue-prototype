(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&a(u)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();function On(){const e=document.documentElement,n=180,t=5,a=7,r=3,i=()=>{const u=getComputedStyle(e),p=window.innerWidth,c=window.innerHeight,d=parseFloat(u.getPropertyValue("--hudH"))||140,h=parseFloat(u.getPropertyValue("--dockH"))||210,m=parseFloat(u.getPropertyValue("--uiGap"))||16,o=parseFloat(u.getPropertyValue("--edgePad"))||14,s=parseFloat(u.getPropertyValue("--logW"))||360,l=parseFloat(u.getPropertyValue("--logGap"))||14,y=parseFloat(u.getPropertyValue("--playerW"))||320,T=Math.max(320,p-(y+s+l*2+o*2)),S=Math.max(260,c-(d+h+m)),E=parseFloat(u.getPropertyValue("--slotGapX"))||22,C=r*n+(r-1)*E,g=n*(a/t),P=parseFloat(u.getPropertyValue("--slotGapY"))||6,$=g*2+P+140,H=T/C,v=S/$,I=Math.min(H,v),Y=Math.max(.55,Math.min(I,1.25));e.style.setProperty("--u",String(Y))};window.addEventListener("resize",i,{passive:!0}),i()}function _n(){const e=()=>{const n=window.innerWidth;document.body.classList.toggle("compact",n<1200)};window.addEventListener("resize",e,{passive:!0}),e()}function Ce(e){return[{id:"A",type:e[0]},{id:"B",type:e[1]}]}function we(e,n,t){e.status[n]=Math.max(0,(e.status[n]??0)+t)}function oe(e){const n=Ce(Se(e)),t=Ce(Se(e)),a=Ce(Se(e));return{root:n,nextIfA:t,nextIfB:a}}function Ln(e,n){e.run.branchOffer||(e.run.branchOffer=oe(e));const t=e.run.branchOffer,a=n==="A"?t.nextIfA:t.nextIfB,r=oe(e);e.run.branchOffer={root:a,nextIfA:r.nextIfA,nextIfB:r.nextIfB}}function Rn(){return Math.random().toString(16).slice(2)+"-"+Date.now().toString(16)}function ye(e,n=0){return e<n?n:e}function Re(e){const n=[...e];for(let t=n.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[n[t],n[a]]=[n[a],n[t]]}return n}function D(e){return e[Math.floor(Math.random()*e.length)]}function f(e,n){e.log.unshift(n),e.log=e.log.slice(0,250)}function _(e){return e.enemies.filter(n=>n.hp>0)}function Dn(e,n,t){e.status[n]=ye((e.status[n]??0)+t,0)}function Se(e){if((e.run.nodePickCount+1)%30===0)return["BATTLE","BATTLE"];const t=[],a=e.run.treasureObtained?25:24,r=e.run.treasureObtained?1:3,i=e.run.treasureObtained?7:5,p=!e.run.treasureObtained&&e.run.nodePickCount>=30?1:0;for(let h=0;h<a;h++)t.push("BATTLE");for(let h=0;h<r;h++)t.push("REST");for(let h=0;h<i;h++)t.push("EVENT");for(let h=0;h<p;h++)t.push("TREASURE");const c=D(t);let d=D(t);if(c==="TREASURE"&&d==="TREASURE"){let h=0;do if(d=D(t),h++,h>50)break;while(d==="TREASURE")}return[c,d]}function Pe(e){const n={phase:"NODE",log:[],uidSeq:0,winHooksAppliedThisCombat:!1,intentsRevealedThisTurn:!1,disruptIndexThisTurn:null,backUidsThisTurn:[],run:{encounterCount:0,treasureObtained:!1,afterTreasureNodePicks:0,finished:!1,nextBattleSuppliesBonus:0,nextBossId:null,bossPool:["boss_gravity_master","boss_cursed_wall","boss_giant_orc","boss_soul_stealer"],nodePickCount:0,branchOffer:null,nodeOfferQueue:[],currentNodeOffers:null,nodePickByType:{BATTLE:0,REST:0,EVENT:0,TREASURE:0},battleCount:0,enemyLastSeenBattle:{},nextBossTime:30,forcedNext:null,bossOmenText:null,deckSizeAtTreasure:0},player:{hp:40,maxHp:40,block:0,supplies:0,fatigue:0,zeroSupplyTurns:0,status:{vuln:0,weak:0,bleed:0,disrupt:0},immuneToDisruptThisTurn:!1,nullifyDamageThisTurn:!1},content:e,cards:{},deck:[],hand:[],discard:[],exhausted:[],vanished:[],choice:null,choiceStack:[],frontSlots:[null,null,null],backSlots:[null,null,null],backSlotDisabled:[!1,!1,!1],enemies:[],attackedEnemyIndicesThisTurn:[],usedThisTurn:0,frontPlacedThisTurn:0,selectedHandCardUid:null,pendingTargetQueue:[],pendingTarget:null,drawCountThisTurn:0,time:0};return n.run.branchOffer=oe(n),Mn(n),f(n,"새 런 시작. 다음 인카운터를 선택하세요."),n}function j(e,n,t){for(let a=0;a<t;a++){const r=Rn(),i={uid:r,defId:n,zone:"deck",upgrade:0};e.cards[r]=i,e.deck.push(r)}}function Mn(e){j(e,"field_ration",2),j(e,"maintenance",2),j(e,"scout",2),j(e,"shield",2),j(e,"power_arrow",1),j(e,"arrow",3),e.deck=Re(e.deck)}function X(e,n){const t=e.cards[n],a=e.content.cardsById[t.defId],r=t.upgrade??0,i=a.upgrades?.[r-1];return i?{...a,...i}:a}function U(e,n,t){const a=e.cardsById[n],r=Math.max(0,t|0);if(r<=0)return a;const i=a.upgrades?.[r-1];return i?{...a,...i}:a}function G(e,n){const a=e.cards[n].upgrade??0,r=X(e,n);return a>0?`${r.name} +${a}`:r.name}const Fn=[{id:"field_ration",name:"야전 식량",frontText:"방어 +3",backText:"S +2",front:[{op:"block",n:3}],back:[{op:"supplies",n:2}],upgrades:[{frontText:"방어 +5",front:[{op:"block",n:5}],backText:"S +3",back:[{op:"supplies",n:3}]}]},{id:"maintenance",name:"정비 도구",exhaustWhen:"BACK",frontText:"방어 +3",backText:"F -1, 소모",front:[{op:"block",n:3}],back:[{op:"fatigue",n:-1}],upgrades:[{frontText:"방어 +5",front:[{op:"block",n:5}],backText:"F -1, S +1, 소모",back:[{op:"fatigue",n:-1},{op:"supplies",n:1}]}]},{id:"scout",name:"정찰",frontText:"선택한 적에게 3 피해, 방어 +2",backText:"드로우 1, 손패 크기 +1, S +2",front:[{op:"damageEnemy",target:"select",n:3},{op:"block",n:2}],back:[{op:"draw",n:1},{op:"supplies",n:2}],upgrades:[{frontText:"선택한 적에게 4 피해, 방어 +3",front:[{op:"damageEnemy",target:"select",n:3},{op:"block",n:2}],backText:"드로우 2, 손패 크기 +2, S +2",back:[{op:"draw",n:2},{op:"supplies",n:2}]}]},{id:"shield",name:"방패",frontText:"방어 +6",backText:"방어 +3",front:[{op:"block",n:6}],back:[{op:"block",n:3}],upgrades:[{frontText:"방어 +8",front:[{op:"block",n:8}],backText:"방어 +4",back:[{op:"block",n:4}]}]},{id:"power_arrow",name:"강력한 화살",frontText:"무작위 적에게 10 피해, S -1",backText:"무작위 적에게 전열 한 장당 2 피해, S -1",front:[{op:"supplies",n:-1},{op:"damageEnemy",target:"random",n:10}],back:[{op:"supplies",n:-1},{op:"damageEnemyBy",target:"random",nPer:2,by:"frontCount"}],upgrades:[{frontText:"무작위 적에게 13 피해, S -1",front:[{op:"supplies",n:-1},{op:"damageEnemy",target:"random",n:13}],backText:"무작위 적에게 전열 한 장당 2 피해",back:[{op:"damageEnemyBy",target:"random",nPer:2,by:"frontCount"}]}]},{id:"arrow",name:"화살",frontText:"선택한 적에게 5 피해",backText:"선택한 적에게 5 피해, S -1",front:[{op:"damageEnemy",target:"select",n:5}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:5}],upgrades:[{frontText:"선택한 적에게 7 피해",front:[{op:"damageEnemy",target:"select",n:7}],backText:"선택한 적에게 7 피해, S -1",back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:7}]}]},{id:"goal_treasure",name:"저주받은 보물",exhaustWhen:"BOTH",frontText:"F +1, 소모",backText:"S -1, F +1, 소모",front:[{op:"fatigue",n:1}],back:[{op:"supplies",n:-1},{op:"fatigue",n:1}]},{id:"berserk",name:"광폭화",frontText:"무작위 적에게 15 피해, F +1",backText:"S +4, F +1",front:[{op:"damageEnemy",target:"random",n:15},{op:"fatigue",n:1}],back:[{op:"supplies",n:4},{op:"fatigue",n:1}],upgrades:[{frontText:"무작위 적에게 20 피해, F +2",front:[{op:"damageEnemy",target:"random",n:20},{op:"fatigue",n:2}],backText:"S +6, F +2",back:[{op:"supplies",n:6},{op:"fatigue",n:2}]}]},{id:"bandage",name:"붕대",exhaustWhen:"BOTH",frontText:"HP +4, 소모",backText:"HP +4, S -1, 소모",front:[{op:"heal",n:4}],back:[{op:"supplies",n:-1},{op:"heal",n:4}],upgrades:[{frontText:"HP +4, 출혈 제거, 소모",front:[{op:"heal",n:4},{op:"clearStatusSelf",key:"bleed"}],backText:"HP +4, 출혈 제거, S -1, 소모",back:[{op:"supplies",n:-1},{op:"heal",n:4},{op:"clearStatusSelf",key:"bleed"}]}]},{id:"arrow_rain",name:"화살의 비",exhaustWhen:"BOTH",frontText:"모든 적에게 10 피해, S -1, F +1, 소모",backText:"드로우 2, 손패 크기 +2, S +2, F +1, 소모",front:[{op:"damageEnemy",target:"all",n:10},{op:"supplies",n:-1},{op:"fatigue",n:1}],back:[{op:"draw",n:2},{op:"supplies",n:2},{op:"fatigue",n:1}],upgrades:[{frontText:"모든 적에게 13 피해, S -2, F +1, 소모",front:[{op:"damageEnemy",target:"all",n:13},{op:"supplies",n:-2},{op:"fatigue",n:1}],backText:"드로우 3, 손패 크기 +3, S +3, F +2, 소모",back:[{op:"draw",n:3},{op:"supplies",n:3},{op:"fatigue",n:2}]}]},{id:"smoke",name:"연막",exhaustWhen:"FRONT",frontText:"이번 턴 피해 무효, 소모",backText:"자신은 교란 당하지 않음",front:[{op:"nullifyDamageThisTurn"}],back:[{op:"immuneDisruptThisTurn"}]},{id:"redeploy",name:"재배치",frontText:"S +2",backText:"3번 슬롯에 있는 후열 카드의 전열 효과 발동",front:[{op:"supplies",n:2}],back:[{op:"triggerFrontOfBackSlot",index:2}],upgrades:[{frontText:"S +3",front:[{op:"supplies",n:3}],backText:"3번 슬롯에 있는 후열 카드의 전열 효과 발동, S +1",back:[{op:"triggerFrontOfBackSlot",index:2},{op:"supplies",n:1}]}]},{id:"secret_strike",name:"비장의 일격",exhaustWhen:"BOTH",frontText:"무작위 적에게 자신의 F의 3배 피해, 소모",backText:"모든 적에게 취약 +4 및 약화 +4, 소모",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:3}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:4},{op:"statusEnemy",target:"all",key:"weak",n:4}],upgrades:[{exhaustWhen:"FRONT",frontText:"선택한 적에게 자신의 F의 3배 피해, 소모",front:[{op:"damageEnemyByPlayerFatigue",target:"select",mult:3}],backText:"모든 적에게 취약 +4 및 약화 +4",back:[{op:"statusEnemy",target:"all",key:"vuln",n:4},{op:"statusEnemy",target:"all",key:"weak",n:4}]}]},{id:"fire_scroll",name:"화염 두루마리",exhaustWhen:"BOTH",frontText:"방어 +7, 소모",backText:"모든 적에게 12 피해, 소모",front:[{op:"block",n:7}],back:[{op:"damageEnemy",target:"all",n:12}],upgrades:[{frontText:"방어 +8, 소모",front:[{op:"block",n:8}],backText:"모든 적에게 14 피해, 소모",back:[{op:"damageEnemy",target:"all",n:14}]}]},{id:"caltrops",name:"마름쇠",frontText:"모든 적에게 출혈 4 부여",backText:"이번 턴에 자신을 공격하려는 적에게 출혈 3 부여",front:[{op:"statusEnemy",target:"all",key:"bleed",n:4}],back:[{op:"statusEnemiesAttackingThisTurn",key:"bleed",n:3}],upgrades:[{frontText:"모든 적에게 출혈 5 부여",backText:"이번 턴에 자신을 공격하려는 적에게 출혈 4 부여",front:[{op:"statusEnemy",target:"all",key:"bleed",n:5}],back:[{op:"statusEnemiesAttackingThisTurn",key:"bleed",n:4}]}]},{id:"emergency_rations",name:"비상식량",vanishWhen:"BACK",frontText:"S +2",backText:"S를 10으로 만듦. 소실",front:[{op:"supplies",n:2}],back:[{op:"setSupplies",n:10}],upgrades:[{frontText:"S +3",backText:"S를 15으로 만듦. 소실",front:[{op:"supplies",n:3}],back:[{op:"setSupplies",n:15}]}]},{id:"painkiller",name:"진통제",exhaustWhen:"BOTH",frontText:"HP -8, F -2, 소모",backText:"HP +10, F +2, 소모",front:[{op:"hp",n:-8},{op:"fatigue",n:-2}],back:[{op:"hp",n:10},{op:"fatigue",n:2}],upgrades:[{frontText:"HP -5, F -2, 소모",backText:"HP +10, F +1, 소모",front:[{op:"hp",n:-5},{op:"fatigue",n:-2}],back:[{op:"hp",n:10},{op:"fatigue",n:1}]}]},{id:"field_experience",name:"실전 경험",exhaustWhen:"BACK",frontText:"모든 적에게 3 피해",backText:"이 카드가 후열에 있는 턴에 승리하면 최대 체력 +2, 소모",front:[{op:"damageEnemy",target:"all",n:3}],back:[],onWinWhileInBack:[{op:"maxHp",n:2}],upgrades:[{frontText:"모든 적에게 4 피해",backText:"이 카드가 후열에 있는 턴에 승리하면 최대 체력 +3, 소모",front:[{op:"damageEnemy",target:"all",n:4}],onWinWhileInBack:[{op:"maxHp",n:3}]}]},{id:"camp_prep",name:"야영 준비",frontText:"방어 +4, S +1",backText:"S +3",front:[{op:"block",n:4},{op:"supplies",n:1}],back:[{op:"supplies",n:3}],upgrades:[{frontText:"방어 +5, S +2",backText:"S +5",front:[{op:"block",n:5},{op:"supplies",n:2}],back:[{op:"supplies",n:5}]}]},{id:"vital_shot",name:"급소 사격",frontText:"선택한 적에게 8 피해",backText:"선택한 적에게 5 피해, 출혈 2 부여, S -1",front:[{op:"damageEnemy",target:"select",n:8}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:5},{op:"statusEnemy",target:"select",key:"bleed",n:2}],upgrades:[{frontText:"선택한 적에게 11 피해",backText:"선택한 적에게 6 피해, 출혈 3 부여, S -1",front:[{op:"damageEnemy",target:"select",n:11}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:6},{op:"statusEnemy",target:"select",key:"bleed",n:3}]}]},{id:"taunt",name:"독설",frontText:"선택한 적에게 약화 +4",backText:"모든 적에게 취약 +2 및 약화 +2",front:[{op:"statusEnemy",target:"select",key:"weak",n:4}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:2},{op:"statusEnemy",target:"all",key:"weak",n:2}],upgrades:[{frontText:"선택한 적에게 약화 +5",backText:"모든 적에게 취약 +2 및 약화 +3",front:[{op:"statusEnemy",target:"select",key:"weak",n:5}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:2},{op:"statusEnemy",target:"all",key:"weak",n:3}]}]},{id:"rapid_fire",name:"연속 사격",frontText:"선택한 적에게 2 피해, 3번 발동",backText:"이번 턴에 카드를 뽑았으면 무작위 적에게 8 피해",front:[{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2}],back:[{op:"ifDrewThisTurn",then:[{op:"damageEnemy",target:"random",n:8}]}],upgrades:[{frontText:"선택한 적에게 2 피해, 4번 발동",backText:"이번 턴에 카드를 뽑았으면 무작위 적에게 10 피해",front:[{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2}],back:[{op:"ifDrewThisTurn",then:[{op:"damageEnemy",target:"random",n:10}]}]}]}],Wn=Object.fromEntries(Fn.map(e=>[e.id,e])),zn=[{id:"other_adventurer",name:"보물을 노리는 다른 모험가",maxHp:40,intents:[{label:"창 찌르기: 5 피해, 3번 발동",acts:[{op:"damagePlayer",n:5},{op:"damagePlayer",n:5},{op:"damagePlayer",n:5}]},{label:"독약 뿌리기: 출혈4, 취약4, 약화4",acts:[{op:"statusPlayer",key:"bleed",n:4},{op:"statusPlayer",key:"vuln",n:4},{op:"statusPlayer",key:"weak",n:4}]}]},{id:"goblin_raider",name:"고블린 약탈자",maxHp:15,intents:[{label:"기습: (12-이번 턴에 사용한 카드의 수) 피해",acts:[{op:"damagePlayerFormula",kind:"goblin_raider"}]},{label:"훔치기: S -3",acts:[{op:"supplies",n:-3}]}]},{id:"watching_statue",name:"감시하는 석상",maxHp:25,intents:[{label:"감시: 4+(이번 턴에 사용한 카드의 수) 피해",acts:[{op:"damagePlayerFormula",kind:"watching_statue"}]}]},{id:"pebble_golem",name:"조약돌 골렘",maxHp:25,intents:[{label:"조약돌 던지기: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"모래 모으기: 자신 HP 6 회복",acts:[{op:"enemyHealSelf",n:6}]}]},{id:"rock_golem",name:"바위 골렘",maxHp:50,intents:[{label:"바위 던지기: 9 피해",acts:[{op:"damagePlayer",n:9}]},{label:"땅 모으기: 자신 HP 10 회복",acts:[{op:"enemyHealSelf",n:10}]}]},{id:"slime",name:"슬라임",maxHp:30,intents:[{label:"유연한 몸: 다음 턴 동안 피해를 입지 않음",acts:[{op:"enemyImmuneNextTurn"}]},{label:"산성액: 약화 3 부여 후 자신 HP 3 회복",acts:[{op:"statusPlayer",key:"weak",n:3},{op:"enemyHealSelf",n:3}]},{label:"때리기: 6 피해",acts:[{op:"damagePlayer",n:6}]}]},{id:"poison_spider",name:"독거미",maxHp:28,intents:[{label:"독니로 물기: 출혈 4 부여",acts:[{op:"statusPlayer",key:"bleed",n:4}]},{label:"송곳니로 물기: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"단번에 물기: 출혈 2 부여, 6 피해)",acts:[{op:"statusPlayer",key:"bleed",n:2},{op:"damagePlayer",n:6}]}]},{id:"gravity_echo",name:"중력의 잔향",maxHp:26,intents:[{label:"하중 인장",acts:[{op:"damagePlayerByDeckSize",base:5,per:2,div:6,cap:18}]},{label:"압축: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"놓치게 만들기: S -3",acts:[{op:"supplies",n:-3}]}]},{id:"boss_gravity_master",name:"중력 통달자",omen:"몸이 점점 무겁다. 몸을 가볍게 하라.",maxHp:70,intents:[{label:"중력 수축: 약화 3 부여",acts:[{op:"statusPlayer",key:"weak",n:3}]},{label:"특이점 생성",acts:[{op:"damagePlayerByDeckSize",base:8,per:3,div:5,cap:30}]},{label:"천장 붕괴: 11 피해",acts:[{op:"damagePlayer",n:11}]}]},{id:"boss_cursed_wall",name:"저주받은 벽",omen:"움직이지 않는다. 당신이 닳아간다.",maxHp:120,intents:[{label:"저주의 기운: F +1",acts:[{op:"fatiguePlayer",n:1}]},{label:"아무 행동도 하지 않음",acts:[]}]},{id:"boss_giant_orc",name:"거대한 오크",omen:"거대한 무언가가 기다린다.",maxHp:80,intents:[{label:"내려치기: 15 피해",acts:[{op:"damagePlayer",n:15}]},{label:"단단한 피부: 다음 턴 동안 피해를 입지 않음",acts:[{op:"enemyImmuneNextTurn"}]},{label:"타고난 회복: 자신 HP 15 회복",acts:[{op:"enemyHealSelf",n:15}]}]},{id:"boss_soul_stealer",name:"영혼 강탈자",omen:"행동하지 않으면 종말이 온다.",maxHp:60,intents:[{label:"허기: 7 피해, S -2",acts:[{op:"damagePlayer",n:7},{op:"supplies",n:-2}]},{label:"나태: 7 피해, F +1",acts:[{op:"damagePlayer",n:7},{op:"fatiguePlayer",n:1}]},{label:"예언: 카운트 진행",acts:[]}]}],Un=Object.fromEntries(zn.map(e=>[e.id,e]));function Kn(e,n){n<=0||(e.player.block+=n,f(e,`방어(블록) +${n} (현재 ${e.player.block})`))}function Vn(e,n){e.player.supplies=ye(e.player.supplies+n,0),f(e,`보급 S ${n>=0?"+":""}${n} (현재 ${e.player.supplies})`)}function ne(e,n){e.player.fatigue=ye(e.player.fatigue+n,0),f(e,`피로 F ${n>=0?"+":""}${n} (현재 ${e.player.fatigue})`)}function qn(e,n){if(n<=0)return;const t=e.player.hp;e.player.hp=Math.min(e.player.maxHp,e.player.hp+n),f(e,`HP +${e.player.hp-t} (현재 ${e.player.hp}/${e.player.maxHp})`)}function Xn(e){_(e).length===0&&(e.pendingTarget=null,e.pendingTargetQueue=[])}function yn(e,n){e.fx||(e.fx={}),e.fx.enemyShake||(e.fx.enemyShake=[]),e.fx.enemyShake.push(n)}function Yn(e){e.fx??={},e.fx.playerShake=!0}function te(e,n,t){const a=e.enemies.indexOf(n);if(a>=0&&!e.attackedEnemyIndicesThisTurn.includes(a)&&e.attackedEnemyIndicesThisTurn.push(a),t<=0)return;const r=e.player.status.weak??0,i=n.status.vuln??0;if(n.immuneThisTurn){f(e,`적(${n.name})은(는) 이번 턴 피해 면역 → ${t} 피해 무시`);return}let u=t-r+i;u<0&&(u=0),n.hp-=u,u>0&&yn(e,a),n.hp<0&&(n.hp=0),f(e,`적(${n.name})에게 ${u} 피해. (HP ${n.hp}/${n.maxHp})`),Xn(e)}function q(e,n,t,a,r){if(n<=0)return 0;let i=n;if(t==="ENEMY_ATTACK"){const u=r??0,p=e.player.status.vuln??0;if(i=i-u+p,i<0&&(i=0),e.player.block>0){const c=Math.min(e.player.block,i);e.player.block-=c,i-=c}}return i<=0?0:(e.player.hp=Math.max(0,e.player.hp-i),i>0&&Yn(e),f(e,`플레이어 ${i} 피해 (${a??t}). (HP ${e.player.hp}/${e.player.maxHp})`),i)}function Ve(){return $e[Math.floor(Math.random()*$e.length)]}const Tn={boss_cursed_wall:"움직이지 않는다. 당신이 닳아간다.",boss_giant_orc:"거대한 무언가가 기다린다.",boss_soul_stealer:"행동하지 않으면 종말이 온다.",boss_gravity_master:"몸이 점점 무겁다. 몸을 가볍게 하라."},$e=[{id:"drop_bag",name:"짐 버리기",prompt:"짐을 줄여 피로를 낮추자.",options:()=>[{key:"drop",label:"카드 1장 제거, F -1",apply:e=>(ne(e,-1),f(e,"이벤트: 짐 버리기 → 제거할 카드를 선택하세요."),{kind:"REMOVE_PICK",title:"짐 버리기",prompt:"제거할 카드 1장을 선택하세요.",then:"NONE"})},{key:"skip",label:"아무것도 하지 않는다",apply:e=>(f(e,"이벤트: 짐 버리기(생략)"),"NONE")}]},{id:"hide_from_monster",name:"몬스터로부터 숨기",prompt:"전투하거나, 대가를 치르고 숨을 수 있다.",options:()=>[{key:"fight",label:"전투",apply:e=>(f(e,"이벤트: 몬스터로부터 숨기 → 전투 선택"),"BATTLE")},{key:"remove_and_fatigue",label:"카드 1장 제거 후 F +1",apply:e=>(ne(e,1),f(e,"이벤트: 몬스터로부터 숨기 → 카드 제거 후 F+1"),{kind:"REMOVE_PICK",title:"숨기",prompt:"제거할 카드 1장을 선택하세요.",then:"NONE"})}]},{id:"overweight",name:"과중량",prompt:"너무 많은 짐이 피로를 부른다!",options:e=>{const n=Object.values(e.cards).filter(a=>["deck","hand","discard"].includes(a.zone)).length,t=Math.floor(n/5);return[{key:"accept",label:`F +${t}`,apply:a=>(ne(a,t),f(a,`이벤트: 과중량 (덱 ${n}장 → F +${t})`),"NONE")}]}},{id:"goblin_ambush_low_supplies",name:"매복한 약탈자들",prompt:`고블린들이 보급을 약탈했다.
이번 전투는 보급(S) 5로 시작합니다.`,options:()=>[{key:"fight",label:"맞서 싸운다",detail:"고블린 약탈자 2마리 전투 (S=5 시작)",apply:e=>(e.run.nextBattleSuppliesBonus=-5,{kind:"BATTLE_SPECIAL",title:"고블린 매복",enemyIds:["goblin_raider","goblin_raider"]})}]},{id:"find_adventurer",name:"다른 모험가 발견",prompt:"거래한다.",options:e=>e.run.treasureObtained?[{key:"adventurer:forced_battle",label:"대치한다",detail:"보물을 노리고 덤벼든다.",apply:n=>({kind:"BATTLE_SPECIAL",enemyIds:["other_adventurer"],title:"보물을 노리는 모험가"})}]:[{key:"trade",label:"카드 1장 제거 후 카드 보상(2장 중 1장)",apply:n=>(f(n,"이벤트: 다른 모험가 발견 → 제거할 카드 선택 후 보상"),{kind:"REMOVE_PICK",title:"다른 모험가 발견",prompt:"제거할 카드 1장을 선택하세요.",then:"REWARD"})},{key:"leave",label:"지나친다",apply:n=>(f(n,"이벤트: 다른 모험가 발견(생략)"),"NONE")}]},{id:"edible_mushroom",name:"식용 버섯 발견",prompt:"기운이 난다. 다음 전투의 시작 보급이 늘어난다.",options:()=>[{key:"eat",label:"F -2, 다음 전투 시작 S +5",apply:e=>(e.player.fatigue=Math.max(0,e.player.fatigue-2),e.run.nextBattleSuppliesBonus+=5,f(e,"식용 버섯: F -2, 다음 전투 시작 S +5"),"NONE")}]},{id:"ominous_prophecy",name:"불길한 예언",prompt:"불길한 속삭임이 귓가를 맴돈다. 대가를 치르고 미래를 엿볼까?",options:e=>[{key:"omen:listen",label:"예언을 듣는다",detail:"F +1. 다음 보스를 확정하고 공개합니다.",apply:n=>{if(ne(n,1),f(n,"불길한 예언: 피로 F +1"),n.run.nextBossId||(n.run.bossPool.length>0?n.run.nextBossId=D(n.run.bossPool):n.run.nextBossId=null),!n.run.nextBossId)return f(n,"예언: 미래가 흐릿하다. (보스가 남아있지 않음)"),"NONE";n.content.enemiesById[n.run.nextBossId];const t=Tn[n.run.nextBossId]??"정체불명의 위협이 다가온다.";return n.run.bossOmenText=`${t}`,f(n,`예언: ${t}`),"NONE"}},{key:"omen:ignore",label:"무시한다",detail:"아무 일도 일어나지 않습니다.",apply:n=>(f(n,"불길한 예언(무시)"),"NONE")}]}];function jn(e){return $e.find(n=>n.id===e)??null}function qe(e,n){const t=e.game,a={kind:"damageSelect",amount:n,sourceCardUid:e.cardUid,reason:e.side==="front"?"FRONT":"BACK"};t.pendingTarget==null?t.pendingTarget=a:t.pendingTargetQueue.push(a),(t.pendingTarget?1:0)+t.pendingTargetQueue.length,f(t,"대상 선택 필요: 적을 클릭하세요.")}function Qn(e,n,t){const a=e.game,r={kind:"statusSelect",key:n,n:t,sourceCardUid:e.cardUid,reason:e.side==="front"?"FRONT":"BACK"};a.pendingTarget==null?a.pendingTarget=r:a.pendingTargetQueue.push(r),(a.pendingTarget?1:0)+a.pendingTargetQueue.length,f(a,"대상 선택 필요: 적을 클릭하세요.")}function Gn(e,n){const t=e.content.enemiesById[n.id];return t.intents[n.intentIndex%t.intents.length].acts.some(r=>r.op==="damagePlayer"||r.op==="damagePlayerFormula")}function se(e,n){const t=e.game;for(const a of n)switch(a.op){case"block":Kn(t,a.n);break;case"supplies":Vn(t,a.n);break;case"fatigue":ne(t,a.n);break;case"heal":qn(t,a.n);break;case"hp":t.player.hp=Math.max(0,Math.min(t.player.maxHp,t.player.hp+a.n)),f(t,`HP ${a.n>=0?"+":""}${a.n} (현재 ${t.player.hp}/${t.player.maxHp})`);break;case"maxHp":t.player.maxHp+=a.n,t.player.hp=Math.min(t.player.maxHp,t.player.hp+a.n),f(t,`최대 HP +${a.n} (현재 ${t.player.hp}/${t.player.maxHp})`);break;case"setSupplies":t.player.supplies=Math.max(0,a.n),f(t,`보급 S를 ${t.player.supplies}으로 설정`);break;case"draw":{const r=De(t,a.n);t.drawCountThisTurn+=r;break}case"ifDrewThisTurn":{t.drawCountThisTurn>0&&se(e,a.then);break}case"damageEnemy":if(a.target==="random"){const r=_(t);if(r.length===0)break;te(t,D(r),a.n)}else if(a.target==="all")for(const r of _(t))te(t,r,a.n);else qe(e,a.n);break;case"clearStatusSelf":{const r=a.key;t.player.status[r]=0,f(t,`상태 해제: ${r} = 0`);break}case"damageEnemyBy":{if(a.target!=="random")break;const r=_(t);if(r.length===0)break;let i=0;a.by==="frontCount"&&(i=t.frontSlots.filter(Boolean).length*a.nPer),te(t,D(r),i);break}case"damageEnemyByPlayerFatigue":{const r=Math.max(0,t.player.fatigue*a.mult);if(a.target==="random"){const i=_(t);if(i.length===0)break;te(t,D(i),r);break}if(a.target==="select"){if(r<=0)break;qe(e,r);break}break}case"statusPlayer":t.player.status[a.key]=Math.max(0,(t.player.status[a.key]??0)+a.n),f(t,`플레이어 상태: ${a.key} ${a.n>=0?"+":""}${a.n}`);break;case"statusEnemy":if(a.target==="random"){const r=_(t);if(r.length===0)break;const i=D(r);we(i,a.key,a.n),f(t,`적(${i.name}) 상태: ${a.key} ${a.n>=0?"+":""}${a.n}`)}else if(a.target==="all"){const r=_(t);if(r.length===0)break;for(const i of r)we(i,a.key,a.n);f(t,`모든 적 상태: ${a.key} ${a.n>=0?"+":""}${a.n}`)}else Qn(e,a.key,a.n);break;case"statusEnemiesAttackingThisTurn":{const r=_(t).filter(i=>Gn(t,i));if(r.length===0){f(t,`이번 턴 공격 의도 적 없음 → ${a.key} 적용 없음`);break}for(const i of r)i.status[a.key]=Math.max(0,(i.status[a.key]??0)+a.n);f(t,`공격 의도 적에게 ${a.key} ${a.n>=0?"+":""}${a.n} (대상 ${r.length})`);break}case"immuneDisruptThisTurn":t.player.immuneToDisruptThisTurn=!0,f(t,"이번 턴 교란 무시");break;case"nullifyDamageThisTurn":t.player.nullifyDamageThisTurn=!0,f(t,"이번 턴 피해 무효");break;case"triggerFrontOfBackSlot":{const r=t.backSlots[a.index];if(!r){f(t,`재배치: 후열 ${a.index+1}번 슬롯이 비어 있음`);break}const i=X(t,r);f(t,`재배치: [[${G(t,r)}]]의 전열 효과를 추가 발동`),se({game:t,side:"front",cardUid:r},i.front);break}default:return a}}function fe(e,n=10,t=16){const a=Math.max(0,e-t),r=Math.ceil(Math.sqrt(a));return n+r}function Ee(e,n){const t=e.content.enemiesById[n];return{id:t.id,name:t.name,hp:t.maxHp,maxHp:t.maxHp,intentIndex:0,status:{vuln:0,weak:0,bleed:0,disrupt:0},immuneThisTurn:!1,immuneNextTurn:!1,lastIntentKey:null,lastIntentStreak:0,soulWarnCount:n==="boss_soul_stealer"?0:void 0,soulArmed:n==="boss_soul_stealer"?!1:void 0,soulWillNukeThisTurn:n==="boss_soul_stealer"?!1:void 0}}function Zn(e,n,t,a=5){for(const r of n){const i=e.run.enemyLastSeenBattle[r];if(i!=null&&t-i<a)return!1}return!0}function J(e,n){const t=n?.forceBoss??!1,a=e.run.nodePickCount,r=e.run.battleCount+1;if(n?.forcePatternIds&&n.forcePatternIds.length>0){const l=n.forcePatternIds;e.run.battleCount=r;for(const y of l)e.run.enemyLastSeenBattle[y]=r;e.enemies=l.map(y=>Ee(e,y)),f(e,`전투 시작! (노드 ${a}, 전투 ${r}회차) 적: ${e.enemies.map(y=>y.name).join(", ")}`);return}if(t)if(e.run.bossPool.length===0&&!e.run.nextBossId)f(e,`보스 풀이 비었습니다. 일반 전투로 진행합니다. (노드 ${a})`);else{let l=e.run.nextBossId??null;l!=null&&(e.run.bossOmenText=e.content.enemiesById[l].omen??null,e.run.bossOmenText=Tn[l]??null),l?(e.run.nextBossId=null,e.run.bossPool=e.run.bossPool.filter(y=>y!==l)):(l=D(e.run.bossPool),e.run.bossPool=e.run.bossPool.filter(y=>y!==l)),e.enemies=[Ee(e,l)],f(e,`보스 등장! (노드 ${a}) 적: ${e.enemies[0].name}`);return}const i=[[["goblin_raider"],["watching_statue"],["pebble_golem"],["slime"]],[["goblin_raider","slime"],["pebble_golem","pebble_golem"],["rock_golem"],["goblin_raider","goblin_raider"],["poison_spider"]],[["goblin_raider","goblin_raider","goblin_raider"],["pebble_golem","pebble_golem","slime"],["rock_golem","pebble_golem"],["slime","slime"],["poison_spider","slime"],["gravity_echo"]]],u=[["gravity_echo","poison_spider"],["poison_spider","slime"],["watching_statue","slime"],["watching_statue","watching_statue"],["poison_spider","poison_spider"],["rock_golem","gravity_echo"],["goblin_raider","goblin_raider","watching_statue"]],p=(e.run.nodePickCount??0)+(e.time??0),c=Math.min(i.length-1,Math.floor(Math.max(0,p)/10)),d=e.run.treasureObtained?u:i[c],h=5,m=d.filter(l=>Zn(e,l,r,h)),o=m.length>0?m:d,s=D(o);e.run.battleCount=r;for(const l of s)e.run.enemyLastSeenBattle[l]=r;e.enemies=s.map(l=>Ee(e,l)),f(e,`전투 시작! (노드 ${a}, 전투 ${r}회차) 적: ${e.enemies.map(l=>l.name).join(", ")}`)}function ee(e){e.player.block=0,e.player.status.vuln=0,e.player.status.weak=0,e.player.status.bleed=0,e.player.status.disrupt=0,e.player.zeroSupplyTurns=0,e.phase="REVEAL",e.frontSlots=[null,null,null],e.backSlots=[null,null,null],e.backSlotDisabled=[!1,!1,!1],e.backUidsThisTurn=[],e.hand=[],e.selectedHandCardUid=null,e.pendingTarget=null,e.pendingTargetQueue=[],e.usedThisTurn=0,e.winHooksAppliedThisCombat=!1;const n=e.run.nextBattleSuppliesBonus??0;e.player.supplies=10+n,n!==0&&(f(e,`다음 전투 보너스 적용: S +${n}`),e.run.nextBattleSuppliesBonus=0),e.player.immuneToDisruptThisTurn=!1,e.player.nullifyDamageThisTurn=!1,e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null,e.drawCountThisTurn=0,e.attackedEnemyIndicesThisTurn=[],e.frontPlacedThisTurn=0,e.usedThisTurn=0,De(e,4),he(e),e.phase="PLACE",e.victoryResolvedThisCombat=!1}function Jn(e){return e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length}function et(e,n){const t=Math.ceil(n/e.div);let a=e.base+e.per*t;return e.cap!=null&&(a=Math.min(a,e.cap)),{dmg:a,scale:t}}const nt={other_adventurer:new Set([1]),slime:new Set([0,1]),poison_spider:new Set([0,2]),boss_cursed_wall:new Set([0]),boss_giant_orc:new Set([1])};function tt(e,n){const t=nt[e];return!!t&&t.has(n)}function ve(e){if(e===null)return"null";const n=typeof e;return n==="number"||n==="boolean"?String(e):n==="string"?JSON.stringify(e):Array.isArray(e)?"["+e.map(ve).join(",")+"]":n==="object"?"{"+Object.keys(e).sort().map(a=>JSON.stringify(a)+":"+ve(e[a])).join(",")+"}":JSON.stringify(String(e))}function kn(e){if(!e)return"NONE";const n={};for(const t of Object.keys(e))t==="label"||t==="text"||t==="desc"||t==="name"||(n[t]=e[t]);return n.effects&&Array.isArray(n.effects)&&(n.effects=n.effects.map(t=>{const a={};for(const r of Object.keys(t??{}))r==="label"||r==="text"||r==="desc"||r==="name"||(a[r]=t[r]);return a})),ve(n)}function at(e,n){const t=e.lastIntentKey??null,a=e.lastIntentStreak??0;t===n?e.lastIntentStreak=Math.min(3,a+1):(e.lastIntentKey=n,e.lastIntentStreak=1)}function rt(e,n,t,a,r){const i=e.length;if(i<=1)return 0;const u=Array.from({length:i},(o,s)=>s),p=o=>o===n&&tt(t,o),c=o=>!!a&&r>=2&&kn(e[o])===a,d=u.filter(o=>!p(o)&&!c(o));if(d.length>0)return D(d);const h=u.filter(o=>!c(o));if(h.length>0)return D(h);const m=u.filter(o=>!p(o));return m.length>0?D(m):D(u)}const ot=2,st=.6;function he(e){if(e.intentsRevealedThisTurn)return;e.intentsRevealedThisTurn=!0,e.attackedEnemyIndicesThisTurn=[],e.backUidsThisTurn=[],e.drawCountThisTurn=0,e.phase="REVEAL",e.player.immuneToDisruptThisTurn=!1,e.player.nullifyDamageThisTurn=!1,e.disruptIndexThisTurn=null,e.backSlotDisabled=[!1,!1,!1],(e.player.status.disrupt??0)>0&&(e.disruptIndexThisTurn=Math.floor(Math.random()*3),e.backSlotDisabled[e.disruptIndexThisTurn]=!0);for(const t of e.enemies)t.immuneThisTurn=t.immuneNextTurn,t.immuneNextTurn=!1;for(const t of _(e)){t.intentLabelOverride=void 0;const r=e.content.enemiesById[t.id].intents;if(!r||r.length===0)continue;const i=rt(r,t.intentIndex??0,t.id,t.lastIntentKey??null,t.lastIntentStreak??0);t.intentIndex=i;const u=r[i%r.length];if(at(t,kn(u)),t.id==="boss_soul_stealer"){t.soulWillNukeThisTurn=!1;const h=t.soulWarnCount??0;if(!!t.soulArmed){if(Math.random()<st){t.soulWillNukeThisTurn=!0,t.intentLabelOverride="종말: 50 피해",f(e,`적 의도: ${t.name} → ${t.intentLabelOverride}`);continue}const s=r[t.intentIndex%r.length];t.intentLabelOverride=`${s.label} (⚠ 폭발 가능 상태)`,f(e,`적 의도: ${t.name} → ${t.intentLabelOverride}`);continue}const o=r[t.intentIndex%r.length];t.intentLabelOverride=`${o.label} (경고 ${h}/3)`,f(e,`적 의도: ${t.name} → ${t.intentLabelOverride}`);continue}const p=r[t.intentIndex%r.length];let c=p.label;const d=p.acts.find(h=>h.op==="damagePlayerByDeckSize");if(d&&d.op==="damagePlayerByDeckSize"){const h=Jn(e),{dmg:m}=et(d,h),o=d.cap!=null?` (최대 ${d.cap})`:"";c=`${p.label.split(":")[0].trim()}: ${m} 피해${o}`}t.intentLabelOverride=c,f(e,`적 의도: ${t.name} → ${c}`)}e.disruptIndexThisTurn!==null&&f(e,`교란: 이번 턴 후열 ${e.disruptIndexThisTurn} 무효`),e.phase="PLACE"}function Xe(e,n,t,a){if(e.phase!=="PLACE"||!e.hand.includes(n))return;t==="back"&&(e.backUidsThisTurn.includes(n)||e.backUidsThisTurn.push(n));const r=t==="front"?e.frontSlots:e.backSlots;r[a]||(e.hand=e.hand.filter(i=>i!==n),r[a]=n,e.cards[n].zone=t,e.usedThisTurn+=1,f(e,`[${G(e,n)}]를 ${t==="front"?"전열":"후열"} ${a}번에 배치`),t==="front"&&(e.frontPlacedThisTurn+=1))}function Ye(e,n,t){return X(e,n).tags?.includes(t)??!1}function it(e,n){e.frontSlots=e.frontSlots.map(t=>t===n?null:t),e.backSlots=e.backSlots.map(t=>t===n?null:t)}function je(e,n,t){const a=X(e,n);it(e,n),e.hand=e.hand.filter(c=>c!==n),e.deck=e.deck.filter(c=>c!==n),e.discard=e.discard.filter(c=>c!==n);const r=a.vanishWhen,i=a.exhaustWhen,u=r==="BOTH"||r==="FRONT"&&t==="front"||r==="BACK"&&t==="back",p=i==="BOTH"||i==="FRONT"&&t==="front"||i==="BACK"&&t==="back";if(r&&r!=="NONE"&&u){e.vanished.push(n),e.cards[n].zone="vanished",f(e,`[${G(e,n)}] 소실(영구 제거)`);return}if(i&&i!=="NONE"&&p){e.exhausted.push(n),e.cards[n].zone="exhausted",f(e,`[${G(e,n)}] 소모(이번 전투에서 제거)`);return}if(!r&&Ye(e,n,"VANISH")){e.vanished.push(n),e.cards[n].zone="vanished",f(e,`[${G(e,n)}] 소실(영구 제거)`);return}if(!i&&Ye(e,n,"EXHAUST")){e.exhausted.push(n),e.cards[n].zone="exhausted",f(e,`[${G(e,n)}] 소모(이번 전투에서 제거)`);return}e.discard.push(n),e.cards[n].zone="discard"}function lt(e){for(let n=0;n<3;n++){const t=e.frontSlots[n];t&&je(e,t,"front"),e.frontSlots[n]=null;const a=e.backSlots[n];a&&je(e,a,"back"),e.backSlots[n]=null}}function ge(e){if(!(e.phase!=="PLACE"&&e.phase!=="BACK")){e.phase="BACK",f(e,"=== 후열 단계 ===");for(let n=0;n<3;n++){const t=e.backSlots[n];if(!t)continue;const a=X(e,t);if(!e.player.immuneToDisruptThisTurn&&e.backSlotDisabled[n]){f(e,`후열 ${n}번 [${a.name}] 교란으로 무효`);continue}se({game:e,side:"back",cardUid:t},a.back)}e.phase="FRONT"}}function Qe(e){if(e.phase==="FRONT"){f(e,"=== 전열 단계 ===");for(let n=0;n<3;n++){const t=e.frontSlots[n];if(!t)continue;const a=X(e,t);se({game:e,side:"front",cardUid:t},a.front)}e.phase="ENEMY"}}function Ge(e){if(e.phase==="ENEMY"){f(e,"=== 적 행동 ===");for(const n of _(e)){const t=e.content.enemiesById[n.id],a=t.intents[n.intentIndex%t.intents.length];if(n.id==="boss_soul_stealer"){if(n.soulWillNukeThisTurn){const r=n.status.weak??0;q(e,50,"ENEMY_ATTACK","영혼 강탈자",r),f(e,"영혼 강탈자: 영혼 폭발 → 50 피해!"),n.soulWillNukeThisTurn=!1,n.soulArmed=!1,n.soulWarnCount=0;continue}for(const r of a.acts)Ze(e,n,r);n.intentIndex===ot&&(n.soulWarnCount=(n.soulWarnCount??0)+1,f(e,`영혼 강탈자: 경고 +1 (${n.soulWarnCount}/3)`),(n.soulWarnCount??0)>=3&&(n.soulArmed=!0,f(e,"영혼 강탈자: 경고 3회 완료 → 폭발 가능 상태!")));continue}for(const r of a.acts)Ze(e,n,r)}e.phase="UPKEEP"}}function Ze(e,n,t){switch(t.op){case"damagePlayer":{const a=n.status.weak??0;q(e,t.n,"ENEMY_ATTACK",n.name,a);return}case"damagePlayerFormula":{if(t.kind==="goblin_raider"){const a=Math.max(0,12-e.usedThisTurn),r=n.status.weak??0;q(e,a,"ENEMY_ATTACK",n.name,r)}else{const a=4+e.usedThisTurn,r=n.status.weak??0;q(e,a,"ENEMY_ATTACK",n.name,r)}return}case"supplies":{e.player.supplies=ye(e.player.supplies+t.n,0),f(e,`적 효과: 보급 S ${t.n>=0?"+":""}${t.n} (현재 ${e.player.supplies})`);return}case"statusPlayer":{Dn(e.player,t.key,t.n),f(e,`적 효과: 플레이어 상태 ${t.key} ${t.n>=0?"+":""}${t.n}`);return}case"enemyHealSelf":{n.hp=Math.min(n.maxHp,n.hp+t.n),f(e,`적(${n.name})이(가) ${t.n} 회복 (HP ${n.hp}/${n.maxHp})`);return}case"enemyImmuneThisTurn":{n.immuneThisTurn=!0,f(e,`적(${n.name})이(가) 피해 면역 상태가 됨`);return}case"enemyImmuneNextTurn":{n.immuneNextTurn=!0,f(e,`적(${n.name})이(가) 다음 턴 피해 면역 상태가 됨`);return}case"fatiguePlayer":{e.player.fatigue=Math.max(0,e.player.fatigue+t.n),f(e,`적 효과: 피로 F ${t.n>=0?"+":""}${t.n} (현재 ${e.player.fatigue})`);return}case"damagePlayerByDeckSize":{const a=e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length,r=Math.ceil(a/t.div);let i=t.base+t.per*r;t.cap!=null&&(i=Math.min(i,t.cap)),q(e,i,"ENEMY_ATTACK",n.name),f(e,`중력 피해: base ${t.base} + per ${t.per} * ceil(${a}/${t.div})=${r} => ${i}`);return}default:return t}}function Je(e){if(e.phase!=="UPKEEP")return;f(e,"=== 유지비 / 상태 처리 ===");const n=e.frontPlacedThisTurn;n>0&&f(e,`전열 유지비 처리: 전열 ${n}장`);for(let a=0;a<n;a++)e.player.supplies>0?e.player.supplies-=1:(e.player.fatigue+=1,q(e,3,"ZERO_SUPPLY","전열 유지비 부족!"));if(e.player.supplies===0){e.player.zeroSupplyTurns+=1;const a=e.player.zeroSupplyTurns;q(e,a,"ZERO_SUPPLY",`보급 없이 턴 종료! 누적 ${a}번째`)}const t=e.player.status.bleed??0;t>0&&q(e,t,"BLEED","출혈");for(const a of _(e)){const r=a.status.bleed??0;if(r>0)if(a.immuneThisTurn)f(e,`적(${a.name})은(는) 이번 턴 면역이라 출혈 피해 무시`);else{a.hp=Math.max(0,a.hp-r);const i=e.enemies.indexOf(a);i>=0&&yn(e,i),f(e,`적(${a.name}) 출혈로 HP -${r} (HP ${a.hp}/${a.maxHp})`)}}e.frontPlacedThisTurn=0,dt(e),lt(e),ie(e),e.phase="DRAW"}function dt(e){const n=["vuln","weak","bleed","disrupt"];for(const t of n)e.player.status[t]>0&&(e.player.status[t]-=1);for(const t of e.enemies)for(const a of n)t.status[a]>0&&(t.status[a]-=1)}function en(e){if(e.phase!=="DRAW"||(e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null,ie(e),e.run.finished))return;if(_(e).length===0){Ie(e),e.phase="NODE";return}const n=e.usedThisTurn;e.usedThisTurn=0,De(e,n),e.player.block>0&&(e.player.block=0,f(e,"방어(블록) 소실")),he(e)}function De(e,n){let t=0;for(let a=0;a<n&&(ct(e),!e.run.finished);a++){const r=e.deck.pop();if(!r)break;e.hand.push(r),t++}return f(e,`드로우 ${t}/${n} (손패 ${e.hand.length})`),t}function ct(e){if(e.deck.length===0&&e.discard.length>0){e.deck=Re(e.discard),e.discard=[];const n=e.player.fatigue;if(q(e,n,"FATIGUE","피로도"),ie(e),e.run.finished)return;e.player.fatigue+=1,f(e,`피로도 F +1 (현재 ${e.player.fatigue})`)}}function A(e){return e.pendingTarget!=null||(e.pendingTargetQueue?.length??0)>0}function ut(e,n){if(!e.pendingTarget)return!1;if(_(e).length===0)return e.pendingTarget=null,e.pendingTargetQueue=[],e.selectedEnemyIndex=null,ie(e),!0;const t=e.enemies[n];if(!t||t.hp<=0)return!1;const a=e.pendingTarget;return a.kind==="damageSelect"?te(e,t,a.amount):a.kind==="statusSelect"&&(we(t,a.key,a.n),f(e,`적(${t.name}) 상태: ${a.key} ${a.n>=0?"+":""}${a.n}`)),ie(e),_(e).length===0?(e.pendingTarget=null,e.pendingTargetQueue=[],e.selectedEnemyIndex=null,!0):(pt(e),!e.pendingTarget&&(e.pendingTargetQueue?.length??0)===0)}function pt(e){const n=e.pendingTargetQueue??[],t=n.shift()??null;e.pendingTarget=t,e.pendingTargetQueue=n,e.selectedEnemyIndex=null}function Ie(e){e.player.block>0&&(e.player.block=0,f(e,"방어(블록) 소실")),e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null}function ft(e){const n=e.run.deckSizeAtTreasure??null;return n==null?10:fe(n)}function ie(e){if(e.player.hp<=0){Ie(e),e.run.finished=!0,f(e,"패배: 죽었습니다.");return}if(!e.victoryResolvedThisCombat&&_(e).length===0&&e.phase!=="NODE"){if(e.victoryResolvedThisCombat=!0,Ie(e),bt(e),f(e,"적을 모두 처치!"),ht(e),e.enemies=[],e.player.zeroSupplyTurns=0,e.phase="NODE",e.run.treasureObtained){const p=ft(e);if(e.run.afterTreasureNodePicks>=p){e.run.finished=!0,f(e,`승리! 저주받은 보물을 얻은 후 ${p}턴 동안 살아남았습니다.`);return}}const[n,t]=Cn(),a=U(e.content,n.defId,n.upgrade),r=U(e.content,t.defId,t.upgrade),i=n.upgrade>0?`${a.name} +${n.upgrade}`:a.name,u=t.upgrade>0?`${r.name} +${t.upgrade}`:r.name;e.choice={kind:"REWARD",title:"전투 보상",prompt:"두 장 중 한 장을 선택하거나 생략합니다.",options:[{key:`pick:${n.defId}:${n.upgrade}`,label:i,detail:`전열: ${a.frontText} / 후열: ${a.backText}`},{key:`pick:${t.defId}:${t.upgrade}`,label:u,detail:`전열: ${r.frontText} / 후열: ${r.backText}`},{key:"skip",label:"생략"}]};return}}function ht(e){const n=[];for(const i of e.deck)n.push(i);for(const i of e.hand)n.push(i);for(const i of e.discard)n.push(i);for(const i of e.frontSlots)i&&n.push(i);for(const i of e.backSlots)i&&n.push(i);for(const i of e.exhausted)n.push(i);const t=new Set,r=n.filter(i=>t.has(i)?!1:(t.add(i),!0)).filter(i=>e.cards[i]?.zone!=="vanished");e.deck=r;for(const i of r)e.cards[i].zone="deck";e.hand=[],e.discard=[],e.frontSlots=[null,null,null],e.backSlots=[null,null,null],e.selectedHandCardUid=null,e.exhausted=[],e.pendingTarget=null,e.pendingTargetQueue=[],mt(e.deck)}function mt(e){for(let n=e.length-1;n>0;n--){const t=Math.floor(Math.random()*(n+1));[e[n],e[t]]=[e[t],e[n]]}}function bt(e){if(!e.winHooksAppliedThisCombat){e.winHooksAppliedThisCombat=!0;for(const n of e.backUidsThisTurn){if(!e.cards[n])continue;const r=X(e,n).onWinWhileInBack;!r||r.length===0||se({game:e,side:"back",cardUid:n},r)}}}function xn(e){return e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length}function yt(e){if(e.run.treasureObtained)return;e.run.treasureObtained=!0,e.run.afterTreasureNodePicks=0,e.run.deckSizeAtTreasure=xn(e);const n=Sn(e);e.cards[n]={uid:n,defId:"goal_treasure",zone:"deck",upgrade:0},e.deck.push(n),e.deck=Re(e.deck),f(e,"저주받은 보물을 획득했습니다! 덱에 [저주받은 보물] 추가")}const Tt=[{id:"berserk",weight:20},{id:"bandage",weight:12},{id:"arrow_rain",weight:20},{id:"smoke",weight:0},{id:"redeploy",weight:12},{id:"secret_strike",weight:1},{id:"fire_scroll",weight:1},{id:"caltrops",weight:12},{id:"emergency_rations",weight:1},{id:"painkiller",weight:1},{id:"field_experience",weight:1},{id:"camp_prep",weight:20},{id:"vital_shot",weight:12},{id:"taunt",weight:12},{id:"rapid_fire",weight:12}];function kt(e){const n=new Map;for(const t of e){const a=Math.max(0,t.weight??0);a<=0||n.set(t.id,(n.get(t.id)??0)+a)}return[...n.entries()].map(([t,a])=>({id:t,w:a}))}function nn(e){let n=0;for(const a of e)n+=a.w;if(n<=0)throw new Error("No positive weights to pick from.");let t=Math.random()*n;for(const a of e)if(t-=a.w,t<=0)return a.id;return e[e.length-1].id}function tn(){return Math.random()<.1?1:0}function Cn(){const e=kt(Tt),n=nn(e),t=e.filter(r=>r.id!==n),a=nn(t);return[{defId:n,upgrade:tn()},{defId:a,upgrade:tn()}]}function Sn(e){return e.uidSeq+=1,`c_${e.uidSeq}`}function an(e,n,t){const a=Sn(e);e.cards[a]={uid:a,defId:n,zone:"deck",upgrade:t?.upgrade??0},e.deck.push(a)}const xt="goal_treasure";function Ct(e,n){const t=e.cards[n];if(t){if(t.defId===xt){f(e,"저주받은 보물은 덱에서 제거할 수 없습니다.");return}e.deck=e.deck.filter(a=>a!==n),e.hand=e.hand.filter(a=>a!==n),e.discard=e.discard.filter(a=>a!==n),e.frontSlots=e.frontSlots.map(a=>a===n?null:a),e.backSlots=e.backSlots.map(a=>a===n?null:a),t.zone="vanished",e.vanished.push(n),f(e,`카드 제거: [${X(e,t.uid).name} +${e.cards[t.uid].upgrade??0}]`)}}function En(e,n){const t=e.cards[n];if(!t)return!1;const r=e.content.cardsById[t.defId].upgrades?.length??0;return(t.upgrade??0)<r}function St(e,n){return En(e,n)?(e.cards[n].upgrade=(e.cards[n].upgrade??0)+1,!0):!1}function Et(){return{cardsById:Wn,enemiesById:Un}}const Te="deck-rogue-save-v1",gn=1;function gt(e){try{return JSON.parse(e)}catch{return null}}function wt(){return!!localStorage.getItem(Te)}function Pt(){localStorage.removeItem(Te)}function $t(e,n){const t={ver:gn,savedAt:Date.now(),build:n?.build,state:e};localStorage.setItem(Te,JSON.stringify(t))}function vt(){const e=localStorage.getItem(Te);if(!e)return null;const n=gt(e);return!n||n.ver!==gn||!n.state?null:{state:n.state,savedAt:n.savedAt}}const It=`# Deck Rogue Prototype — 룰북 (플레이어용)

이 문서는 스포일러를 최소화합니다.

[1] 개요
노드를 선택하며 진행하고, 전투에서 살아남아 성장합니다. 목표는 무엇일까요?
모든 카드는 전열과 후열이 있습니다. 배치에 따라 역할이 달라집니다.

[2] 보급과 피로도

보급(S): 전열 카드 및 일부 효과의 발동에 사용됩니다. 보통 10으로 시작합니다.
보급이 부족한 상태로 턴 종료 시, 이번 전투에서 보급 없이 종료한 턴의 횟수만큼 피해를 받습니다.

피로도(F): 덱을 섞을 때 피로도가 1 올라가며, 일부 카드의 효과로도 변합니다.
덱을 섞을 때 피로도만큼 피해를 입습니다. 피로도는 전투가 끝나도 유지됩니다.

보급이 부족한 채로 턴을 마칠 때, 사용한 전열 카드 한 장 당 피해를 3 받으며, F가 1 증가합니다.
이 효과는 보급 자체에 의한 HP 손실과 별개입니다!

[3] 전투 흐름
배치 → 후열 발동 → 전열 발동 → 적 행동 → 정리 → 드로우
※ “대상 선택 필요”가 뜨면 살아있는 적을 클릭해 대상을 정하세요.
※ 후열 발동을 누르면 턴이 진행되어, 카드의 배치를 변경할 수 없습니다.
보급 및 그에 따른 변화는 정리 단계에서 처리합니다.

손패는 턴이 종료되어도 유지됩니다.
카드는 매 턴마다 사용한 만큼 뽑습니다. 즉, 카드로 인한 드로우는 패의 매수 자체를 늘리는 효과가 있습니다.

[4] 용어
- 소모: 이번 전투에서 사용할 수 없게 되는 것입니다.
- 소실: 런 전체에서 해당 카드가 사라지는 것입니다.
- 취약: 받는 피해가 (취약)만큼 증가합니다.
- 약화: 주는 피해가 (약화)만큼 감소합니다.
- 출혈: 턴 종료 시 (출혈)만큼 피해를 입습니다.
- 교란: 당신을 방해합니다. 무엇일까요?

[5] 조작

(컴퓨터)
- 4: 선택 해제
- Tab: 손패 선택 이동
- 1~3: 전열 배치 / q,w,e: 후열 배치
- 드래그: 손패→슬롯 배치, 슬롯↔슬롯 스왑, 슬롯→손패 회수
- Space: 다음 턴
- F: 새로운 런

(모바일)
- 손패: 클릭 시 선택, 길게 누를 시 확대
- 카드 선택 상태에서 슬롯을 눌러 배치
- 슬롯: 클릭 시 확대, 길게 누를 시 회수
- 슬롯에 넣은 카드는 이름만 보입니다.

[6] 당신을 위한 조언

덱은 당신의 비품입니다. 비품이 적으면, 늘 새로 꾸리느라 힘들 겁니다. 비품이 많으면, 들고 다니기 힘들겠지요. 균형을 찾으세요.
`;let ce=null;function At(e){ce!=null&&window.clearTimeout(ce),ce=window.setTimeout(()=>{ce=null,$t(e)},250)}function Ae(e){const n=e.run;n.nextBossTime==null&&(n.nextBossTime=30),n.forcedNext==null&&(n.forcedNext=null)}function Be(e){return(e.run.nodePickCount??0)+(e.time??0)}function rn(e){const r=Math.max(0,e-20),i=Math.min(85,Math.floor(r*r/3));return{extra:Math.random()*100<i?1:0,pPct:i}}function Bt(e,n){const t=e;return t.content=n,t.time??=0,t.run??={},t.run.nextBossTime??=30,t.run.forcedNext??=null,t.run.bossOmenText??=null,t.run.enemyLastSeenBattle??={},t.run.nodePickByType??={BATTLE:0,REST:0,EVENT:0,TREASURE:0},t.run.bossPool??=["boss_gravity_master","boss_cursed_wall","boss_giant_orc","boss_soul_stealer"],t.run.nextBossId??=null,t.run.afterTreasureNodePicks??=0,t.run.deckSizeAtTreasure??=null,t.run.treasureObtained&&t.run.deckSizeAtTreasure==null&&(t.run.deckSizeAtTreasure=xn(t)),t.choiceStack??=[],t.pendingTargetQueue??=[],t.exhausted??=[],t.vanished??=[],t}function Ht(e){if(!wt())return Pe(e);const n=vt();return n?Bt(n.state,e):Pe(e)}let on=0,sn=0,me=null,F=null,ln=0,dn=0,Q=null,Me=!1;function Nt(e,n){cn();const t=b("cardZoomLayer");t.style.cssText=`
    position:fixed; inset:0; z-index:7000;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:center;
    padding: 14px;
  `;const a=b("cardZoomPanel");a.style.cssText=`
    width: min(420px, 92vw);
    max-height: 82vh;
    overflow: auto;
  `;const r=Fe(e,n);r.classList.add("zoomedCard"),a.appendChild(r),t.onclick=()=>cn(),a.onclick=i=>i.stopPropagation(),t.appendChild(a),document.body.appendChild(t),Me=!0}function cn(){document.querySelector(".cardZoomLayer")?.remove(),Me=!1}function Ot(e,n){const t=e.cards[n],a=U(e.content,t.defId,t.upgrade??0),r=b("card");r.classList.add("inSlot"),r.appendChild(w("cardTitle",ke(e,n)));const i=b("cardMeta");return a.tags?.includes("EXHAUST")&&i.appendChild(R("소모")),a.tags?.includes("VANISH")&&i.appendChild(R("소실")),r.appendChild(i),r}let ae=null,pe=!1,un=0,pn=0;function ue(){ae!=null&&(window.clearTimeout(ae),ae=null),pe=!1}function _t(e,n){document.querySelector(".cardPeekOverlay")?.remove();const t=b("cardPeekOverlay");t.style.cssText="position:fixed; inset:0; z-index:7000; background:rgba(0,0,0,.60);backdrop-filter: blur(6px); display:flex; align-items:center; justify-content:center;padding:18px; box-sizing:border-box;";const a=b("panel");a.classList.add("cardPeekPanel"),a.style.cssText="width: fit-content; max-width: 92vw; max-height: 92vh;overflow: visible; padding: 12px; border-radius: 16px;";const r=Fe(e,n);r.style.width="var(--handCardW)",r.style.height="var(--handCardH)",r.style.boxSizing="border-box",a.appendChild(r),t.appendChild(a),t.onclick=()=>t.remove(),a.onclick=i=>i.stopPropagation(),document.body.appendChild(t)}function Lt(e,n){if(document.querySelector(".mobileQuickMenuBtn")?.remove(),document.querySelector(".mobileQuickMenuSheet")?.remove(),!M())return;const a=document.createElement("button");a.type="button",a.className="mobileQuickMenuBtn",a.textContent="≡",a.style.cssText=`
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    right: calc(env(safe-area-inset-right, 0px) + 10px);
    z-index: 9999;
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(15,18,22,.88);
    color: #fff;
    font-weight: 900;
    backdrop-filter: blur(6px);
  `,a.onclick=()=>r(),document.body.appendChild(a);const r=()=>{document.querySelector(".mobileQuickMenuSheet")?.remove();const i=document.createElement("div");i.className="mobileQuickMenuSheet",i.style.cssText=`
      position: fixed; inset: 0;
      z-index: 9998;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 12px;
      box-sizing: border-box;
    `;const u=document.createElement("div");u.style.cssText=`
      width: min(520px, 100%);
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(15,18,22,.92);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    `;const p=document.createElement("div");p.style.cssText="display:flex; gap:10px; flex-wrap:wrap;";const c=(m,o)=>{const s=document.createElement("button");return s.type="button",s.textContent=m,s.style.cssText=`
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        color: #fff;
        font-weight: 700;
      `,s.onclick=()=>{i.remove(),o()},s};p.appendChild(c("새로운 런",()=>n.onNewRun())),p.appendChild(c("룰북",()=>n.onViewRulebook())),p.appendChild(c("로그",()=>n.onToggleLogOverlay()));const d=document.createElement("div");d.style.cssText="height:1px; margin:12px 0; background: rgba(255,255,255,.10);";const h=document.createElement("div");h.style.cssText="display:flex; gap:10px; flex-wrap:wrap;",h.appendChild(c("덱",()=>n.onViewPile("deck"))),h.appendChild(c("버림",()=>n.onViewPile("discard"))),h.appendChild(c("손패",()=>n.onViewPile("hand"))),h.appendChild(c("소모",()=>n.onViewPile("exhausted"))),h.appendChild(c("소실",()=>n.onViewPile("vanished"))),u.appendChild(p),u.appendChild(d),u.appendChild(h),i.onclick=()=>i.remove(),u.onclick=m=>m.stopPropagation(),i.appendChild(u),document.body.appendChild(i)}}let B=null,fn=!1,x=null,K=null,He=!1;function Fe(e,n){const t=e.cards[n],a=U(e.content,t.defId,t.upgrade??0),r=b("card");r.classList.add("choiceCard"),a.tags?.includes("EXHAUST")&&r.classList.add("exhaust"),a.tags?.includes("VANISH")&&r.classList.add("vanish"),r.appendChild(w("cardTitle",ke(e,n)));const i=b("cardMeta");a.tags?.includes("EXHAUST")&&i.appendChild(R("소모")),a.tags?.includes("VANISH")&&i.appendChild(R("소실")),r.appendChild(i);const u=b("cardSection");u.appendChild(w("cardSectionTitle","⚔ 전열")),u.appendChild(w("cardText",a.frontText)),r.appendChild(u);const p=b("cardSection");return p.appendChild(w("cardSectionTitle","🕯 후열")),p.appendChild(w("cardText",a.backText)),r.appendChild(p),r}function Rt(e,n,t){const a=U(e.content,n,t),r=e.content.cardsById[n]?.name??n,i=b("card");i.classList.add("choiceCard"),a.tags?.includes("EXHAUST")&&i.classList.add("exhaust"),a.tags?.includes("VANISH")&&i.classList.add("vanish"),i.appendChild(w("cardTitle",ze(r,t)));const u=b("cardMeta");a.tags?.includes("EXHAUST")&&u.appendChild(R("소모")),a.tags?.includes("VANISH")&&u.appendChild(R("소실")),i.appendChild(u);const p=b("cardSection");p.appendChild(w("cardSectionTitle","⚔ 전열")),p.appendChild(w("cardText",a.frontText)),i.appendChild(p);const c=b("cardSection");return c.appendChild(w("cardSectionTitle","🕯 후열")),c.appendChild(w("cardText",a.backText)),i.appendChild(c),i}function wn(e,n){return e==="BATTLE"?"⚔️(전투)":e==="REST"?"⛺(휴식)":e==="EVENT"?"❔(미지)":"🌑(보물)"}function Dt(e,n){return e.map(t=>wn(t.type)).join(" / ")}function Mt(e,n,t){const a=[`[탐험 ${n.run.nodePickCount}회]`];if(n.run.treasureObtained){const m=fe(n.run.deckSizeAtTreasure);a.push(`[탈출까지 ${n.run.afterTreasureNodePicks}/${m}]`)}e.appendChild(We(a.join(" "))),Ae(n),(!n.run.bossOmenText||String(n.run.bossOmenText).trim()==="")&&(n.run.bossOmenText="아직 징조가 없다.");const r=n.run,i=Be(n),u=Math.max(0,r.nextBossTime-i),p=` . . . ${n.run.bossOmenText}`,c=w("bossOmenBanner",`다음 보스까지 남은 시간: ${u}${p}`);c.style.cssText="margin-top:8px; padding:10px 12px; border-radius:14px;border:1px solid rgba(255, 255, 255, 0);background:rgba(0, 0, 0, 0.18);font-weight:600;font-size:13px;line-height:1.2;",e.appendChild(c),c.style.color="white";const d=t.getNodeOffers(),h=n.run.branchOffer;if(h){const m=b("nodePreviewBox");m.style.cssText="margin-top:10px; padding:12px; border:1px solid rgba(255,255,255,.10); border-radius:16px; background:rgba(0,0,0,.18);";const o=r.forcedNext==="BOSS",s=l=>{const y=b("nodePreviewRow");y.style.cssText="display:flex; gap:10px; align-items:center; padding:10px; border-radius:14px; cursor:pointer;",y.onmouseenter=()=>y.style.background="rgba(255,255,255,.06)",y.onmouseleave=()=>y.style.background="transparent",y.onclick=()=>t.onChooseNode(l);const S=o?"💀(보스)":wn(d[l==="A"?0:1]?.type??"BATTLE"),E=document.createElement("div");E.className="nodePill primary",E.textContent=S,E.onclick=P=>{P.stopPropagation(),t.onChooseNode(l)},y.appendChild(E),y.appendChild(w("","→"));const C=l==="A"?h.nextIfA:h.nextIfB,g=w("",Dt(C));return g.style.cssText="opacity:.85;",y.appendChild(g),y};m.appendChild(s("A")),m.appendChild(s("B")),e.appendChild(m),e.appendChild(Ft())}}function Ft(){return document.createElement("hr")}function Pn(e,n){let t=null,a=!1,r=!1;const i=[];function u(o){i.push({choice:o.choice,handler:t})}function p(o){const s=i.pop();if(!s){O(o),t=null;return}o.choice=s.choice,t=s.handler}const c=()=>me||e,d={onHotkeySlot:(o,s)=>{const l=c();if(l.run.finished||A(l)||l.phase!=="PLACE"||o==="back"&&l.backSlotDisabled?.[s])return;const y=o==="front"?l.frontSlots:l.backSlots,T=y[s];if(!l.selectedHandCardUid){if(!T)return;d.onReturnSlotToHand(o,s);return}const S=l.selectedHandCardUid;if(!T){d.onPlaceHandUidToSlot(S,o,s);return}y[s]=null,l.usedThisTurn=Math.max(0,l.usedThisTurn-1),o==="front"&&(l.frontPlacedThisTurn=Math.max(0,l.frontPlacedThisTurn-1)),l.hand.push(T),l.cards[T].zone="hand",Xe(l,S,o,s),l.selectedHandCardUid=null,f(l,`[${W(l,S)}] ↔ [${W(l,T)}] 스왑: 손패 ↔ ${o}${s+1}`),k(l,d)},rerender:()=>{const o=c();k(o,d)},onToggleLogOverlay:()=>{He=!He,k(c(),d)},onCloseOverlay:()=>{const o=c();B=null,k(o,d)},onNewRun:()=>{const o=c();K=null,B=null,x=null,t=null,O(o),Pt(),n(Pe(o.content))},onViewRulebook:()=>{const o=c();B={kind:"RULEBOOK"},k(o,d)},onViewPile:o=>{const s=c();B={kind:"PILE",pile:o},k(s,d)},onReturnSlotToHand:(o,s)=>{const l=c();if(l.run.finished||A(l)||l.phase!=="PLACE")return;const y=o==="front"?l.frontSlots:l.backSlots,T=y[s];T&&(y[s]=null,l.usedThisTurn=Math.max(0,l.usedThisTurn-1),o==="front"&&(l.frontPlacedThisTurn=Math.max(0,l.frontPlacedThisTurn-1)),l.hand.push(T),l.cards[T].zone="hand",f(l,`[${W(l,T)}] 회수: ${o}${s+1} → 손패`),k(l,d))},onClearSelected:()=>{const o=c();o.selectedHandCardUid=null,k(o,d)},onSelectEnemy:o=>{const s=c();if(r)return;r=!0,requestAnimationFrame(()=>{r=!1});const l=ut(s,o);k(s,d),l&&!s.choice&&!s.run.finished&&d.onAutoAdvance()},onSelectHandCard:o=>{const s=c();A(s)||(s.selectedHandCardUid=s.selectedHandCardUid===o?null:o,k(s,d))},getNodeOffers:()=>{const o=c();Ae(o),o.run.branchOffer||(o.run.branchOffer=oe(o));const s=o.run,l=Be(o);return s.forcedNext==="BOSS"?(s.nodeExtra01=0,[{id:"A",type:"BATTLE"},{id:"B",type:"BATTLE"}]):(s.nodeExtra01==null&&(s.nodeExtra01=rn(o.deck.length).extra),l+1+s.nodeExtra01>=s.nextBossTime?[{id:"A",type:"REST"},{id:"B",type:"REST"}]:o.run.branchOffer.root)},onChooseNode:o=>{const s=c();if(a||(a=!0,queueMicrotask(()=>a=!1),s.run.finished)||s.phase!=="NODE")return;Ae(s),s.run.branchOffer||(s.run.branchOffer=oe(s));const l=s.run,y=d.getNodeOffers(),T=o==="A"?y[0].type:y[1].type,S=Be(s),E=l.forcedNext==="BOSS";let C=0;E||(l.nodeExtra01==null&&(l.nodeExtra01=rn(s.deck.length).extra),C=l.nodeExtra01);const g=S+1+C,P=s.run.nodePickCount+1;s.run.nodePickCount=P,s.time=(s.time??0)+C,l.nodeExtra01=null;const $=!E&&g>=l.nextBossTime,H=E?"BATTLE":$?"REST":T;if(Ln(s,o),s.run.nodePickByType[H]=(s.run.nodePickByType[H]??0)+1,s.run.treasureObtained&&H!=="TREASURE"){s.run.afterTreasureNodePicks+=1;const v=s.run.deckSizeAtTreasure,I=fe(v);if(s.run.afterTreasureNodePicks>=I){s.run.finished=!0,f(s,`승리! 보물 획득 후 ${I}번의 탐험을 버티고 탈출했습니다.`),k(s,d);return}}if(E){l.forcedNext=null,l.nextBossTime+=30,s.run.bossOmenText=null,f(s,`=== 시간 ${g}: 보스 전투 ===`),J(s,{forceBoss:!0}),ee(s),k(s,d);return}if($&&(l.forcedNext="BOSS",f(s,"시간이 흘러 보스가 다가옵니다!")),H==="BATTLE"){J(s,{forceBoss:!1}),ee(s),k(s,d);return}if(H==="REST"){const v=()=>{s.choice={kind:"EVENT",title:"휴식",prompt:"무엇을 하시겠습니까?",options:[{key:"rest:heal",label:"HP +15"},{key:"rest:clear_f",label:"F -3"},{key:"rest:upgrade",label:"강화"},{key:"rest:skip",label:"생략"}]},t=I=>{if(I==="rest:heal"){s.player.hp=Math.min(s.player.maxHp,s.player.hp+15),f(s,"휴식: HP +15"),O(s),t=null,s.phase="NODE",k(s,d);return}if(I==="rest:clear_f"){s.player.fatigue=Math.max(0,s.player.fatigue-3),f(s,"휴식: 피로 F-=3"),O(s),t=null,s.phase="NODE",k(s,d);return}if(I==="rest:upgrade"){m(s,d,"강화","강화할 카드 1장을 선택하세요.",{onDone:()=>{s.phase="NODE",k(s,d)},onSkip:()=>{v(),k(s,d)}});return}f(s,"휴식: 생략"),O(s),t=null,s.phase="NODE",k(s,d)}};v(),k(s,d);return}if(H==="TREASURE"){yt(s);const v=s.run.deckSizeAtTreasure,I=fe(v);f(s,`저주받은 보물을 얻었습니다! 이제부터 ${I}번의 탐험을 버티면 탈출합니다.`),k(s,d);return}if(H==="EVENT"){const v=s.run;v.firstEventSeen??=!1;const I=v.firstEventSeen?Ve():jn("ominous_prophecy")??Ve();v.firstEventSeen=!0;const Y=I.options(s);s.choice={kind:"EVENT",title:I.name,prompt:I.prompt,options:Y.map(Z=>({key:Z.key,label:Z.label,detail:Z.detail}))},t=Z=>{const Ue=Y.find(xe=>xe.key===Z);if(!Ue)return;const N=Ue.apply(s);if(typeof N=="object"&&N.kind==="UPGRADE_PICK"){m(s,d,N.title??"강화",N.prompt??"강화할 카드 1장을 선택하세요.");return}if(typeof N=="object"&&N.kind==="REMOVE_PICK"){u(s);const xe=Object.values(s.cards).filter(L=>L.zone==="deck"||L.zone==="hand"||L.zone==="discard").map(L=>L.uid);s.choice={kind:"PICK_CARD",title:N.title,prompt:N.prompt??"제거할 카드 1장을 선택하세요.",options:[...xe.map(L=>{const le=_e(s,L);return{key:`remove:${L}`,label:W(s,L),detail:`전열: ${le.frontText} / 후열: ${le.backText}`,cardUid:L}}),{key:"cancel",label:"취소"}]},t=L=>{if(L==="cancel"){f(s,"제거 취소"),p(s),k(s,d);return}if(!L.startsWith("remove:")){k(s,d);return}const le=L.slice(7);Ct(s,le);const de=N.then,Ke=de==="REWARD"||de==="REWARD_PICK"?"REWARD_PICK":de==="BATTLE"?"BATTLE":de==="NONE"?"NONE":void 0;if(Ke==="BATTLE"){O(s),t=null,J(s),ee(s),k(s,d);return}if(Ke==="REWARD_PICK"){O(s),t=null,h(s,d,"카드 보상","두 장 중 한 장을 선택하거나 생략합니다.");return}O(s),t=null,s.phase="NODE",k(s,d)},k(s,d);return}if(typeof N=="object"&&N.kind==="BATTLE_SPECIAL"){s.choice=null,t=null,f(s,N.title?`이벤트 전투: ${N.title}`:"이벤트 전투 발생!"),J(s,{forcePatternIds:N.enemyIds}),ee(s),k(s,d);return}if(N==="BATTLE"){s.choice=null,t=null,J(s),ee(s),k(s,d);return}if(N==="REWARD"){h(s,d,"카드 보상","두 장 중 한 장을 선택하거나 생략합니다.");return}s.choice=null,O(s),t=null,k(s,d)},k(s,d);return}},onChooseChoice:o=>{const s=c();if(!s.choice)return;if(t){t(o);const y=c();y.enemies.length>0&&y.phase==="PLACE"||d.onAutoAdvance();return}const l=s.choice.kind;if(l==="REWARD"||l==="REWARD_PICK"){if(o==="skip"){f(s,"카드 보상 생략"),O(s),k(s,d);return}if(o.startsWith("pick:")){const y=o.slice(5),[T,S]=y.split(":"),E=Number(S??"0")||0;an(s,T,{upgrade:E}),f(s,`카드 획득: ${An(s,T,E)}`),O(s),k(s,d);return}}f(s,`선택 처리 불가: handler 없음 (kind=${l}, key=${o})`)},onAutoAdvance:()=>{const o=c();if(!o.run.finished&&!o.choice&&!A(o)&&o.phase!=="NODE"){for(let s=0;s<50&&!(o.run.finished||o.choice||A(o));s++){if(o.phase==="DRAW"){en(o);break}if(o.phase==="PLACE"){if(o.enemies.length>0&&!o.intentsRevealedThisTurn){he(o);continue}ge(o);continue}if(o.phase==="BACK"){ge(o);continue}if(o.phase==="FRONT"){Qe(o);continue}if(o.phase==="ENEMY"){Ge(o);continue}if(o.phase==="UPKEEP"){Je(o);continue}break}k(o,d)}},onRevealIntents:()=>{const o=c();o.run.finished||o.enemies.length!==0&&(he(o),k(o,d))},onPlaceHandUidToSlot:(o,s,l)=>{const y=c();y.run.finished||A(y)||y.phase==="PLACE"&&(s==="back"&&y.backSlotDisabled?.[l]||(Xe(y,o,s,l),y.selectedHandCardUid=null,k(y,d)))},onPlaceSelected:(o,s)=>{const l=c();l.selectedHandCardUid&&d.onPlaceHandUidToSlot(l.selectedHandCardUid,o,s)},onMoveSlotCard:(o,s,l,y)=>{const T=c();if(T.run.finished||A(T)||T.phase!=="PLACE"||l==="back"&&T.backSlotDisabled?.[y])return;const S=o==="front"?T.frontSlots:T.backSlots,E=l==="front"?T.frontSlots:T.backSlots,C=S[s];if(!C)return;const g=E[y];S[s]=g??null,E[y]=C,T.cards[C].zone=l,g&&(T.cards[g].zone=o),o!==l&&(o==="front"&&(T.frontPlacedThisTurn=Math.max(0,T.frontPlacedThisTurn-1)),l==="front"&&(T.frontPlacedThisTurn+=1),g&&(l==="front"&&(T.frontPlacedThisTurn=Math.max(0,T.frontPlacedThisTurn-1)),o==="front"&&(T.frontPlacedThisTurn+=1))),f(T,g?`[${W(T,C)}] ↔ [${W(T,g)}] 스왑: ${o}${s+1} ↔ ${l}${y+1}`:`[${W(T,C)}] 이동: ${o}${s+1} → ${l}${y+1}`),Ne(T),k(T,d)},onResolveBack:()=>{const o=c();o.phase==="PLACE"&&Ne(o),ge(o),k(o,d)},onResolveFront:()=>{const o=c();Qe(o),k(o,d)},onResolveEnemy:()=>{const o=c();Ge(o),k(o,d)},onUpkeep:()=>{const o=c();Je(o),k(o,d)},onDrawNextTurn:()=>{const o=c();en(o),k(o,d)}};function h(o,s,l,y){const[T,S]=Cn(),E=U(o.content,T.defId,T.upgrade),C=U(o.content,S.defId,S.upgrade),g=bn(o,T),P=bn(o,S);o.choice={kind:"REWARD",title:l,prompt:y,options:[{key:`pick:${T.defId}:${T.upgrade}`,label:g,detail:`전열: ${E.frontText} / 후열: ${E.backText}`},{key:`pick:${S.defId}:${S.upgrade}`,label:P,detail:`전열: ${C.frontText} / 후열: ${C.backText}`},{key:"skip",label:"생략"}]},t=$=>{if($.startsWith("pick:")){const H=$.slice(5),[v,I]=H.split(":"),Y=Number(I??"0")||0;an(o,v,{upgrade:Y})}else f(o,"카드 보상 생략");O(o),t=null,k(o,s)},k(o,s)}function m(o,s,l,y,T){const S=Object.values(o.cards).filter(C=>(C.zone==="deck"||C.zone==="hand"||C.zone==="discard")&&En(o,C.uid)).map(C=>C.uid);if(S.length===0){f(o,"강화할 수 있는 카드가 없습니다."),o.choice=null,t=null,T?.onSkip?T.onSkip():k(o,s);return}const E=[...S].sort((C,g)=>{const P=o.cards[C],$=o.cards[g],H=be(o,P.defId),v=be(o,$.defId),I=H.localeCompare(v,"ko");return I!==0?I:(P.upgrade??0)-($.upgrade??0)});o.choice={kind:"UPGRADE_PICK",title:l,prompt:y,options:[...E.map(C=>{const g=o.cards[C],P=_e(o,C),$=U(o.content,g.defId,(g.upgrade??0)+1),H=W(o,C),v=`현재: 전열 ${P.frontText} / 후열 ${P.backText}
강화: 전열 ${$.frontText} / 후열 ${$.backText}`;return{key:`up:${C}`,label:H,detail:v,cardUid:C}}),{key:"skip",label:"취소"}]},t=C=>{if(C==="skip"){f(o,"강화 취소"),O(o),t=null,T?.onSkip?T.onSkip():k(o,s);return}if(C.startsWith("up:")){const g=C.slice(3),P=St(o,g);f(o,P?`강화: [${W(o,g)}]`:"강화 실패"),O(o),t=null,T?.onDone?T.onDone():k(o,s);return}O(o),t=null,k(o,s)},k(o,s)}return d}function Ne(e){const n=e.frontSlots.filter(a=>a!=null).length,t=e.backSlots.filter(a=>a!=null).length;e.frontPlacedThisTurn=n,e.usedThisTurn=n+t}function Wt(){const e=document.querySelector("#app");return e.innerHTML="",e}function V(e,n,t=""){const a=document.createElement("button");return t&&(a.className=t),a.type="button",a.textContent=e,a.onclick=n,a}function k(e,n){me=e;const t=document.querySelector(".mainPanel");t&&(on=t.scrollTop,sn=t.scrollLeft);const a=Wt();fn||(na(()=>me??e,n),fn=!0),a.appendChild(qt(e,n));const r=b("mainRow"),i=b("stage"),u=b("stageInner"),p=b("panel mainPanel");p.scrollTop=on,p.scrollLeft=sn,p.appendChild(Xt()),e.run.finished?p.appendChild(We("런 종료")):e.phase==="NODE"?Mt(p,e,n):jt(p,e,n),u.appendChild(p),i.appendChild(u);const c=b("panel logPanel");c.appendChild(Yt());const d=ia(e.log.join(`
`));d.classList.add("log"),c.appendChild(d),r.appendChild(i),r.appendChild(c),a.appendChild(r),Zt(e,n,A(e)),In(),Kt(e,n),Vt(e,n),e.fx&&(e.fx.enemyShake=[],e.fx.playerShake=!1),Ut(e,n),zt(n),Lt(e,n),At(e)}function zt(e){if(document.querySelector(".floatingNewRun")?.remove(),M())return;const n=V("새로운 런",()=>e.onNewRun(),"floatingNewRun");n.style.cssText=`
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    left: calc(env(safe-area-inset-left, 0px) + 10px);
    z-index: 10000;
    pointer-events: auto;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.55);
    color: #fff;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    cursor: pointer;
  `,document.body.appendChild(n)}function Ut(e,n){if(document.querySelector(".logOverlay")?.remove(),!He)return;const t=b("logOverlay");t.style.cssText=`
    position: fixed; inset: 0;
    z-index: 6000;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: flex-end;
    justify-content: center;
  `;const a=b("panel");a.style.cssText=`
    width: min(720px, 100%);
    max-height: 70vh;
    border-radius: 18px 18px 0 0;
    padding: 12px;
    margin: 0;
  `;const r=b("panelHeader"),i=document.createElement("h2");i.textContent="로그",r.appendChild(i);const u=V("닫기",()=>n.onToggleLogOverlay());r.appendChild(u),a.appendChild(r);const p=document.createElement("pre");p.className="log",p.textContent=e.log.join(`
`),p.style.maxHeight="60vh",p.style.overflow="auto",a.appendChild(p),t.onclick=()=>n.onToggleLogOverlay(),a.onclick=c=>c.stopPropagation(),t.appendChild(a),document.body.appendChild(t)}function Kt(e,n){if(document.querySelector(".overlay-layer")?.remove(),!B)return;const t=b("overlay-layer");t.style.cssText="position:fixed; inset:0; z-index:2500; background:rgba(0,0,0,.55); display:flex; justify-content:center; align-items:center;",t.onclick=c=>{c.target===t&&n.onCloseOverlay()};const a=b("overlay-panel");a.style.cssText="width:min(980px, 92vw); max-height:80vh; overflow:auto; padding:16px; border:1px solid rgba(255,255,255,.12); border-radius:16px; background:rgba(15,18,22,.92); box-shadow:0 18px 60px rgba(0,0,0,.45);",a.onclick=c=>c.stopPropagation();const r=B.kind==="RULEBOOK"?"룰북":B.pile==="deck"?"덱":B.pile==="discard"?"버림 더미":B.pile==="exhausted"?"소모(이번 전투)":B.pile==="vanished"?"소실(영구)":"손패",i=b("overlayHeader");i.style.cssText="display:flex; align-items:center; justify-content:space-between; gap:12px; position:sticky; top:0; padding-bottom:12px; margin-bottom:12px; background:rgba(15,18,22,.92);";const u=oa(r);u.classList.add("overlayTitle");const p=Hn("닫기",n.onCloseOverlay,!1);if(p.classList.add("overlayClose"),p.style.cssText="padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#fff; cursor:pointer;",i.appendChild(u),i.appendChild(p),a.appendChild(i),B.kind==="RULEBOOK"){const c=document.createElement("pre");c.className="rulebook",c.textContent=It,c.style.cssText="white-space:pre-wrap; line-height:1.45; font-size:13px; margin:0; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);",a.appendChild(c)}else{const d=[...B.pile==="deck"?e.deck:B.pile==="discard"?e.discard:B.pile==="exhausted"?e.exhausted:B.pile==="vanished"?e.vanished:e.hand].sort((m,o)=>{const s=e.cards[m],l=e.cards[o],y=be(e,s.defId),T=be(e,l.defId),S=y.localeCompare(T,"ko");return S!==0?S:(s.upgrade??0)-(l.upgrade??0)}),h=b("overlayList");if(h.style.cssText="display:flex; flex-direction:column; gap:10px;",d.length===0){const m=b("overlayEmpty");m.textContent="비어 있습니다.",m.style.cssText="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03);",h.appendChild(m)}else for(const m of d){const o=_e(e,m),s=ke(e,m),l=b("overlayItem");l.style.cssText="border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:10px; background:rgba(255,255,255,.03);";const y=b("overlayItemTop");y.style.cssText="display:flex; align-items:center; justify-content:space-between; gap:10px;";const T=b("overlayItemTitle");T.textContent=s,T.style.cssText="font-weight:700;";const S=b("overlayItemMeta");S.textContent=`(${e.cards[m].zone})`,S.style.cssText="opacity:.7; font-size:12px; white-space:nowrap;",y.appendChild(T),y.appendChild(S),l.appendChild(y);const E=document.createElement("pre");E.className="overlayItemDetail",E.textContent=`전열: ${o.frontText}
후열: ${o.backText}`,E.style.cssText="margin:10px 0 0 0; padding:10px; white-space:pre-wrap; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.20); font-size:12px; line-height:1.45;",l.appendChild(E),h.appendChild(l)}a.appendChild(h)}t.appendChild(a),document.body.appendChild(t)}function Vt(e,n){document.querySelector(".choice-overlay")?.remove();const t=e.choice;if(!t)return;const a=b("choice-overlay");a.style.cssText="position:fixed; inset:0; z-index:3000; background:rgba(0,0,0,0.82); display:flex; justify-content:center; align-items:center;";const r=b("choice-panel");r.style.cssText="width:min(980px, 92vw); max-height:80vh; overflow:auto; padding:16px; border:1px solid rgba(255,255,255,.12); border-radius:16px; background:rgba(15,18,22,.92);",r.appendChild(ra(t.title)),t.prompt&&r.appendChild(We(t.prompt));const i=b("choice-list");i.style.cssText="display:flex; flex-direction:column; gap:10px; margin-top:12px;",t.options.forEach(u=>{const p=b("choice-item");p.style.cssText="display:flex; gap:12px; align-items:flex-start;border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px;background:rgba(255,255,255,.03);";const c=b("choice-left");c.style.cssText="flex:0 0 auto;";const d=u.cardUid;if(d)c.appendChild(Fe(e,d));else if(typeof u.key=="string"&&u.key.startsWith("pick:")){const o=u.key.slice(5),[s,l]=o.split(":"),y=Number(l??"0")||0;c.appendChild(Rt(e,s,y))}const h=b("choice-right");h.style.cssText="flex:1 1 auto; min-width:260px;";const m=Hn(u.label,()=>n.onChooseChoice(u.key),!1);if(m.classList.add("primary"),h.appendChild(m),u.detail){const o=document.createElement("pre");o.className="choice-detail",o.textContent=String(u.detail),o.style.cssText="margin:10px 0 0 0; padding:10px; white-space:pre-wrap;border-radius:12px; border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22); font-size:12px; line-height:1.45;max-height:220px; overflow:auto;",h.appendChild(o)}p.appendChild(c),p.appendChild(h),i.appendChild(p)}),r.appendChild(i),a.appendChild(r),document.body.appendChild(a)}function M(){return window.matchMedia&&window.matchMedia("(max-width: 900px)").matches}function qt(e,n){document.querySelectorAll(".topHud").forEach(d=>d.remove());const t=e.time,a=b("topHud"),r=M();r||a.appendChild(b("topHudLeftSpacer"));const i=b("playerHudLeft");if(r){const d=b("mobileTopLine");d.appendChild(z(`HP ${e.player.hp}/${e.player.maxHp}`)),d.appendChild(z(`블록 ${e.player.block}`)),d.appendChild(z(`S ${e.player.supplies}`,e.player.supplies===0?"warn":"")),d.appendChild(z(`F ${e.player.fatigue}`)),d.appendChild(z(`시간 ${Math.max(1,e.run.nodePickCount+t)}`)),d.appendChild(z(`덱 ${e.deck.length}`)),i.appendChild(d);const h=b("mobileStatusLine"),m=e.player.status,o=[];(m.vuln??0)>0&&o.push(`취약 ${m.vuln}`),(m.weak??0)>0&&o.push(`약화 ${m.weak}`),(m.bleed??0)>0&&o.push(`출혈 ${m.bleed}`),(m.disrupt??0)>0&&o.push(`교란 ${m.disrupt}`);const s=o.slice(0,4);for(const l of s)h.appendChild(R(l));o.length>s.length&&h.appendChild(R(`+${o.length-s.length}`)),i.appendChild(h)}else{const d=b("playerTitleRow");d.appendChild(w("playerHudTitle","플레이어"));const h=b("pileButtons");h.appendChild(V("덱",()=>n.onViewPile("deck"))),h.appendChild(V("버림",()=>n.onViewPile("discard"))),h.appendChild(V("손패",()=>n.onViewPile("hand"))),h.appendChild(V("소모",()=>n.onViewPile("exhausted"))),h.appendChild(V("소실",()=>n.onViewPile("vanished"))),d.appendChild(h),i.appendChild(d);const m=b("enemyChip");m.classList.add("playerHudBox"),e.fx?.playerShake&&m.classList.add("shake");const o=b("enemyChipTop");o.appendChild(w("","HP")),o.appendChild(w("",`${e.player.hp}/${e.player.maxHp}`)),m.appendChild(o);const s=b("enemyHPOuter"),l=b("enemyHPFill");l.style.width=`${Math.max(0,Math.min(100,e.player.hp/Math.max(1,e.player.maxHp)*100))}%`,s.appendChild(l),m.appendChild(s);const y=b("enemyChipTop");y.appendChild(w("","블록")),y.appendChild(w("",`${e.player.block}`)),m.appendChild(y);const T=b("enemyHPOuter"),S=b("enemyHPFill");S.style.background="linear-gradient(90deg, #64b5ff, #2a7cff)",S.style.width=`${Math.max(0,Math.min(100,e.player.block/Math.max(1,e.player.maxHp)*100))}%`,T.appendChild(S),m.appendChild(T);const E=e.player.status,C=b("enemyBadges");m.appendChild(C);const g=[];(E.vuln??0)>0&&g.push(`취약 ${E.vuln}`),(E.weak??0)>0&&g.push(`약화 ${E.weak}`),(E.bleed??0)>0&&g.push(`출혈 ${E.bleed}`),(E.disrupt??0)>0&&g.push(`교란 ${E.disrupt}`);const P=r?g.slice(0,3):g;for(const I of P)C.appendChild(R(I));r&&g.length>P.length&&C.appendChild(R(`+${g.length-P.length}`)),i.appendChild(m);const $=b("resourceRow inline"),H=e.enemies.length>0&&e.phase!=="NODE",v=e.run.nextBattleSuppliesBonus??0;H?$.appendChild(z(`S ${e.player.supplies}`,e.player.supplies===0?"warn":"")):v>0&&$.appendChild(z(`보너스 S +${v}`,"bonus")),$.appendChild(z(`F ${e.player.fatigue}`)),$.appendChild(z(`시간 ${Math.max(1,e.run.nodePickCount+t)}`)),$.appendChild(z(`덱 ${e.deck.length}`)),i.appendChild($)}const u=b("enemyHudCenter"),p=b(r?"enemyStrip":"enemyHud"),c=e.fx?.enemyShake??[];if(e.enemies.length===0)p.appendChild(w("enemyNone",""));else{const d=A(e);for(let h=0;h<e.enemies.length;h++){const m=e.enemies[h],o=b("enemyChip");c.includes(h)&&o.classList.add("shake"),d&&m.hp>0&&o.classList.add("targetable");const s=b("enemyChipTop");if(s.appendChild(w("",`${h+1}. ${m.name}`)),s.appendChild(w("",`${m.hp}/${m.maxHp}`)),o.appendChild(s),!r){const P=b("enemyHPOuter"),$=b("enemyHPFill");$.style.width=`${Math.max(0,Math.min(100,m.hp/Math.max(1,m.maxHp)*100))}%`,P.appendChild($),o.appendChild(P)}const l=e.content.enemiesById[m.id],y=l.intents[m.intentIndex%l.intents.length],T=m.intentLabelOverride??y.label;o.appendChild(w("enemyIntent",e.intentsRevealedThisTurn?`${T}`:""));const S=m.status,E=b("enemyBadges");o.appendChild(E);const C=[];(S.vuln??0)>0&&C.push(`취약 ${S.vuln}`),(S.weak??0)>0&&C.push(`약화 ${S.weak}`),(S.bleed??0)>0&&C.push(`출혈 ${S.bleed}`),(S.disrupt??0)>0&&C.push(`교란 ${S.disrupt}`),m.immuneThisTurn&&C.push("면역");const g=r?C.slice(0,2):C;for(const P of g)E.appendChild(R(P));r&&C.length>g.length&&E.appendChild(R(`+${C.length-g.length}`)),o.onclick=()=>n.onSelectEnemy(h),p.appendChild(o)}}if(u.appendChild(p),a.appendChild(i),a.appendChild(u),!r){const d=b("topHudRight"),h=b("topRightControls");h.appendChild(V("룰북",n.onViewRulebook)),h.appendChild(V("로그",n.onToggleLogOverlay)),d.appendChild(h),a.appendChild(d)}return e.fx?.enemyShake?.length&&(e.fx.enemyShake=[]),a}function z(e,n=""){const t=document.createElement("span");return t.className="chip"+(n?` ${n}`:""),t.textContent=e,t}function Xt(e){if(M()){const r=b("battleTitleRow");return r.style.display="none",r}const t=b("battleTitleRow"),a=document.createElement("h2");return a.textContent="전장",t.appendChild(a),t}function Yt(){const e=b("logHeaderRow"),n=document.createElement("h2");return n.textContent="로그",e.appendChild(n),e}function jt(e,n,t){const a=b("combatRoot"),r=b("boardArea");if(A(n)&&n.selectedEnemyIndex==null){const i=b("targetHint"),u=n.pendingTarget,p=u?.sourceCardUid?W(n,u.sourceCardUid):null,c=u?.sourceLabel??null,d=u?.reason??null,h=p?`대상 선택 (${p})`:c?`대상 선택 (${c})`:"대상 선택 필요",m=d==="FRONT"?"전열":d==="BACK"?"후열":d==="EVENT"?"이벤트":d==="RELIC"?"유물":null,o=m?` — ${m}`:"",s=n.pendingTargetQueue?.length??0,l=(n.pendingTarget?1:0)+s,y=l>1?` (남은 ${l}개)`:" (남은 1개)";i.textContent=`${h}${o}${y}: 위의 적 박스를 클릭하세요.`,a.appendChild(i)}r.appendChild(hn(n,t,"front")),r.appendChild(hn(n,t,"back")),a.appendChild(r),e.appendChild(a)}let Oe=null,$n=!0;function Qt(e,n){Oe=e,$n=n}function Gt(e,n,t){return e.run.finished?{label:"종료",fn:null,disabled:!0,activePhase:e.phase}:e.choice||B?{label:"선택 중",fn:null,disabled:!0,activePhase:e.phase}:t?{label:"대상 선택",fn:null,disabled:!0,activePhase:e.phase}:e.phase==="NODE"?{label:"노드 선택",fn:null,disabled:!0,activePhase:e.phase}:e.phase==="PLACE"?e.enemies.length>0&&!e.intentsRevealedThisTurn?{label:"다음: 정찰",fn:n.onRevealIntents,disabled:!1,activePhase:e.phase}:{label:"다음: 후열",fn:n.onResolveBack,disabled:!1,activePhase:e.phase}:e.phase==="BACK"?{label:"다음: 전열",fn:n.onResolveFront,disabled:!1,activePhase:e.phase}:e.phase==="FRONT"?{label:"다음: 적",fn:n.onResolveEnemy,disabled:!1,activePhase:e.phase}:e.phase==="ENEMY"?{label:"다음: 정리",fn:n.onUpkeep,disabled:!1,activePhase:e.phase}:e.phase==="UPKEEP"?{label:"다음: 드로우",fn:n.onDrawNextTurn,disabled:!1,activePhase:e.phase}:e.phase==="DRAW"?{label:"다음 턴",fn:n.onDrawNextTurn,disabled:!1,activePhase:e.phase}:{label:"다음",fn:null,disabled:!0,activePhase:e.phase}}function Zt(e,n,t){const a=document.querySelector(".handDock");a&&a.remove();const r=b("handDock"),i=b("controlsDock"),u=Gt(e,n,t),p=document.createElement("button");p.textContent="다음 턴",p.className="stepBtn primary",p.disabled=u.disabled||e.phase==="NODE",p.onclick=()=>n.onAutoAdvance(),i.appendChild(p);const c=document.createElement("button");c.textContent="선택 해제",c.disabled=!e.selectedHandCardUid,c.onclick=n.onClearSelected,i.appendChild(c),r.appendChild(i);const d=b("hand");d.dataset.dropHand="1";const h=b("handCardsRow");if(d.appendChild(h),e.hand.length===0){const m=b("handEmptyHint");m.textContent="손패가 비었습니다.",h.appendChild(m)}else{const m=!M();for(const o of e.hand)h.appendChild(Bn(e,o,!0,n.onSelectHandCard,{draggable:m}))}Qt(()=>n.onAutoAdvance(),p.disabled),r.appendChild(d),document.body.appendChild(r),M()||Jt(d)}function Jt(e){e.dataset?.wheelX!=="1"&&(e.dataset.wheelX="1",e.addEventListener("wheel",n=>{if(n.shiftKey)return;const t=Math.abs(n.deltaX)>Math.abs(n.deltaY)?n.deltaX:n.deltaY;e.scrollLeft+=t,n.preventDefault()},{passive:!1}))}function hn(e,n,t){const a=b("grid6"),r=!!e.selectedHandCardUid,i=t==="front"?e.frontSlots:e.backSlots,u=M();for(let p=0;p<3;p++){const c=t==="back"?!!e.backSlotDisabled?.[p]:!1,d=b("slot"+(c?" disabled":""));d.dataset.slotSide=t,d.dataset.slotIndex=String(p),K&&K.side===t&&K.idx===p&&d.classList.add("dropHover"),r&&!c&&d.classList.add("placeable"),d.appendChild(sa(`${t==="front"?"전열":"후열"} ${p+1}`));const h=i[p];if(h){const m=M()?Ot(e,h):Bn(e,h,!1);m.classList.add("inSlot"),d.appendChild(m),u?(m.onpointerdown=o=>{o.stopPropagation(),!c&&(A(e)||e.phase==="PLACE"&&(ue(),un=o.clientX,pn=o.clientY,pe=!1,ae=window.setTimeout(()=>{pe=!0,n.onReturnSlotToHand(t,p)},420)))},m.onpointermove=o=>{if(ae==null)return;const s=o.clientX-un,l=o.clientY-pn;s*s+l*l>64&&ue()},m.onpointerup=o=>{o.stopPropagation();const s=pe;ue(),!c&&(A(e)||e.phase==="PLACE"&&(s||_t(e,h)))},m.onpointercancel=()=>ue()):(m.onpointerdown=o=>{M()||o.button!==0&&o.pointerType==="mouse"||A(e)||e.phase==="PLACE"&&vn(o,{kind:"slot",cardUid:h,fromSide:t,fromIdx:p})},m.ondblclick=()=>n.onReturnSlotToHand(t,p))}d.onclick=()=>{if(c||A(e)||e.phase!=="PLACE")return;const m=i[p];if(!e.selectedHandCardUid&&m){n.onReturnSlotToHand(t,p);return}n.onPlaceSelected(t,p)},a.appendChild(d)}return a}function ea(){if(document.querySelectorAll(".slot.dropHover").forEach(t=>t.classList.remove("dropHover")),!K)return;const e=`.slot[data-slot-side="${K.side}"][data-slot-index="${K.idx}"]`,n=document.querySelector(e);n&&n.classList.add("dropHover")}function na(e,n){window.onpointermove=t=>{const a=e();if(a.choice||B||!x||t.pointerId!==x.pointerId)return;x.x=t.clientX,x.y=t.clientY;const r=x.x-x.startX,i=x.y-x.startY;!x.dragging&&r*r+i*i>36&&(x.dragging=!0),K=x.dragging?mn(t.clientX,t.clientY,a):null,In(document.querySelector("#app")),ea()},window.onpointerup=t=>{const a=e();if(!(a.choice||B)&&!(!x||t.pointerId!==x.pointerId)){if(x.dragging){const r=ta(t.clientX,t.clientY),i=mn(t.clientX,t.clientY,a);if(r&&x.kind==="slot"&&x.fromSide!=null&&x.fromIdx!=null){!a.run.finished&&!A(a)&&a.phase==="PLACE"&&n.onReturnSlotToHand(x.fromSide,x.fromIdx),x=null,K=null,k(a,n);return}if(i)if(x.kind==="hand"){const u=e();if(!(u.run.finished||A(u)||u.phase!=="PLACE")){const p=i.side,c=i.idx;if(!(p==="back"&&u.backSlotDisabled?.[c])){const d=p==="front"?u.frontSlots:u.backSlots,h=d[c];if(!h)n.onPlaceHandUidToSlot(x.cardUid,p,c);else{const m=x.fromHandIndex!=null&&x.fromHandIndex>=0?x.fromHandIndex:u.hand.indexOf(x.cardUid),o=u.hand.indexOf(x.cardUid);o>=0&&u.hand.splice(o,1),d[c]=x.cardUid,u.cards[x.cardUid].zone=p;const s=m!=null&&m>=0&&m<=u.hand.length?m:u.hand.length;u.hand.splice(s,0,h),u.cards[h].zone="hand",u.selectedHandCardUid=null,Ne(u),f(u,`[${W(u,x.cardUid)}] ↔ [${W(u,h)}] 스왑: 손패 ↔ ${p}${c+1}`),k(u,n)}}}}else x.kind==="slot"&&x.fromSide!=null&&x.fromIdx!=null&&(x.fromSide===i.side&&x.fromIdx===i.idx||n.onMoveSlotCard(x.fromSide,x.fromIdx,i.side,i.idx))}x?.sourceEl&&x.sourceEl.classList.remove("isDraggingSource"),x=null,K=null,k(a,n)}},window.addEventListener("keydown",t=>{const a=t.target;if(a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"))return;const r=e();if(t.code==="KeyF"){t.preventDefault(),n.onNewRun();return}if(t.code==="Digit4"){if(t.preventDefault(),A(r)){r.pendingTarget=null,r.pendingTargetQueue=[],f(r,"대상 선택 취소"),k(r,n);return}n.onClearSelected();return}if(t.key==="Tab"){if(t.preventDefault(),r.hand.length===0)return;const i=r.selectedHandCardUid,u=i?r.hand.indexOf(i):-1,p=t.shiftKey?-1:1,c=((u+p)%r.hand.length+r.hand.length)%r.hand.length;r.selectedHandCardUid=r.hand[c],k(r,n);return}if(t.code==="Space"){t.preventDefault();const i=e();if(i.run.finished||i.choice||A(i))return;n.onAutoAdvance();return}if(t.code==="Digit1"||t.code==="Digit2"||t.code==="Digit3"){t.preventDefault();const i=t.code==="Digit1"?0:t.code==="Digit2"?1:2;if(A(r)){const u=r.enemies[i];if(!u||u.hp<=0){f(r,`대상 선택 실패: ${i+1}번 적이 없습니다.`),k(r,n);return}n.onSelectEnemy(i);return}n.onHotkeySlot("front",i);return}if(t.code==="KeyQ"||t.code==="KeyW"||t.code==="KeyE"){t.preventDefault();const i=t.code==="KeyQ"?0:t.code==="KeyW"?1:2;n.onHotkeySlot("back",i);return}if(t.code==="Enter"){t.preventDefault(),!$n&&Oe&&Oe();return}})}function vn(e,n){const t=e.currentTarget;try{t.setPointerCapture(e.pointerId)}catch{}const a=t.closest(".card");a&&a.classList.add("isDraggingSource");const r=a?.getBoundingClientRect(),i=r?e.clientX-r.left:20,u=r?e.clientY-r.top:20;if(x={kind:n.kind,cardUid:n.cardUid,fromHandIndex:n.fromHandIndex,fromSide:n.fromSide,fromIdx:n.fromIdx,pointerId:e.pointerId,startX:e.clientX,startY:e.clientY,x:e.clientX,y:e.clientY,dragging:!1,previewEl:void 0,previewW:r?.width,previewH:r?.height,grabDX:i,grabDY:u},a){const p=a.cloneNode(!0);p.classList.remove("inSlot"),p.classList.remove("selected"),p.classList.remove("isDraggingSource"),p.style.position="static",p.style.inset="",p.style.width="100%",p.style.height="100%",p.style.margin="0",x.previewEl=p}}function ta(e,n){const t=document.elementFromPoint(e,n);if(!t)return!1;let a=t;for(;a;){if(a.dataset?.dropHand==="1")return!0;a=a.parentElement}return!1}function mn(e,n,t){const a=document.elementFromPoint(e,n);if(!a)return null;const r=aa(a,["slotSide","slotIndex"]);if(!r)return null;const i=r.dataset.slotSide,u=Number(r.dataset.slotIndex);return i==="back"&&t.backSlotDisabled?.[u]?null:{side:i,idx:u}}function aa(e,n){let t=e;for(;t;){const a=t.dataset;let r=!0;for(const i of n)if(a[i]==null){r=!1;break}if(r)return t;t=t.parentElement}return null}function In(e,n){if(M()){document.querySelector(".dragLayer")?.remove();return}if(!x||!x.dragging){document.querySelector(".dragLayer")?.remove();return}if(!x||!x.dragging){document.querySelector(".dragLayer")?.remove();return}let t=document.querySelector(".dragLayer");if(t||(t=document.createElement("div"),t.className="dragLayer",t.style.position="fixed",t.style.inset="0",t.style.zIndex="5000",t.style.pointerEvents="none",document.body.appendChild(t)),t.innerHTML="",!x.previewEl)return;const a=document.createElement("div");a.className="dragCardPreview",a.style.position="fixed",a.style.left=`${x.x-(x.grabDX??20)}px`,a.style.top=`${x.y-(x.grabDY??20)}px`,a.appendChild(x.previewEl),t.appendChild(a)}function O(e){e.choice=null,document.querySelector(".choice-overlay")?.remove()}function _e(e,n){const t=e.cards[n];return U(e.content,t.defId,t.upgrade??0)}function be(e,n){return e.content.cardsById[n]?.name??n}function An(e,n,t){const a=t??0,r=e.content.cardsById[n]?.name??n;return a>0?`${r} +${a}`:r}function W(e,n){const t=e.cards[n];return An(e,t.defId,t.upgrade??0)}function Bn(e,n,t,a,r){const i=e.cards[n],u=U(e.content,i.defId,i.upgrade??0),p=r?.draggable??!0,c=b("card");e.selectedHandCardUid===n&&c.classList.add("selected"),u.tags?.includes("EXHAUST")&&c.classList.add("exhaust"),u.tags?.includes("VANISH")&&c.classList.add("vanish");const d=ke(e,n);c.appendChild(w("cardTitle",d));const h=b("cardMeta");u.tags?.includes("EXHAUST")&&h.appendChild(R("소모")),u.tags?.includes("VANISH")&&h.appendChild(R("소실")),c.appendChild(h);const m=b("cardSection");m.appendChild(w("cardSectionTitle","⚔ 전열")),m.appendChild(w("cardText",u.frontText)),c.appendChild(m);const o=b("cardSection");return o.appendChild(w("cardSectionTitle","🕯 후열")),o.appendChild(w("cardText",u.backText)),c.appendChild(o),t&&a&&(c.onclick=()=>a(n)),t&&(c.onpointerdown=s=>{if(!M()){if(s.button!==0&&s.pointerType==="mouse"||A(e)||e.phase!=="PLACE"||!p)return;const l=e.hand.indexOf(n);vn(s,{kind:"hand",cardUid:n,fromHandIndex:l});return}A(e)||(Q=n,ln=s.clientX,dn=s.clientY,F&&window.clearTimeout(F),F=window.setTimeout(()=>{Q===n&&Nt(e,n)},280))},c.onpointermove=s=>{if(!M()||!Q)return;const l=s.clientX-ln,y=s.clientY-dn;l*l+y*y>36&&(F&&window.clearTimeout(F),F=null,Q=null)},c.onpointerup=()=>{M()&&(F&&window.clearTimeout(F),F=null,!Me&&a&&a(n),Q=null)},c.onpointercancel=()=>{M()&&(F&&window.clearTimeout(F),F=null,Q=null)}),c}function b(e){const n=document.createElement("div");return n.className=e,n}function w(e,n){const t=document.createElement("div");return t.className=e,t.textContent=n,t}function ra(e){const n=document.createElement("h2");return n.textContent=e,n}function oa(e){const n=document.createElement("h3");return n.textContent=e,n}function We(e){const n=document.createElement("p");return n.textContent=e,n}function sa(e){const n=document.createElement("small");return n.textContent=e,n}function R(e){const n=document.createElement("span");return n.className="badge",n.textContent=e,n}function Hn(e,n,t){const a=document.createElement("button");return a.textContent=e,a.disabled=t,a.onclick=n,a}function ia(e){const n=document.createElement("pre");return n.className="log",n.textContent=e,n}function ze(e,n){const t=n??0;return t>0?`${e} +${t}`:e}function ke(e,n){const t=e.cards[n],a=e.content.cardsById[t.defId].name;return ze(a,t.upgrade)}function bn(e,n){const t=e.content.cardsById[n.defId].name;return ze(t,n.upgrade)}On();_n();const la=Et();let re=Ht(la);function Nn(e){re=e,Le=Pn(re,Nn),k(re,Le)}let Le=Pn(re,Nn);k(re,Le);
