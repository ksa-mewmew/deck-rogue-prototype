(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();function pn(){const e=document.documentElement,t=180,n=5,r=7,a=3;let o=0;const l=()=>{o=0;const p=getComputedStyle(e),d=window.innerWidth,m=window.innerHeight,h=parseFloat(p.getPropertyValue("--hudH"))||140,u=parseFloat(p.getPropertyValue("--dockH"))||210,k=parseFloat(p.getPropertyValue("--uiGap"))||16,S=parseFloat(p.getPropertyValue("--edgePad"))||14,i=parseFloat(p.getPropertyValue("--logW"))||360,s=parseFloat(p.getPropertyValue("--logGap"))||14,y=parseFloat(p.getPropertyValue("--playerW"))||320,g=parseFloat(p.getPropertyValue("--slotGapXBase"))||22,x=parseFloat(p.getPropertyValue("--slotGapYBase"))||6,w=Math.max(320,d-(y+i+s*2+S*2)),v=Math.max(260,m-(h+u+k)),E=a*t+(a-1)*g,I=t*(r/n),_=parseFloat(p.getPropertyValue("--battleChromeHBase"))||140,$=I*2+x+_,P=w/E,W=v/$,K=Math.min(P,W),N=Math.max(.55,Math.min(K,1.25));e.style.setProperty("--u",String(N))},c=()=>{o||(o=requestAnimationFrame(l))};window.addEventListener("resize",c,{passive:!0}),l()}function fn(){let e=!1;const t=()=>{const a=window.innerWidth;!e&&a<1180&&(e=!0),e&&a>1220&&(e=!1),document.body.classList.toggle("compact",e)};let n=0;const r=()=>{n||(n=requestAnimationFrame(()=>{n=0,t()}))};window.addEventListener("resize",r,{passive:!0}),t()}function qe(e){return[{id:"A",type:e[0]},{id:"B",type:e[1]}]}function Oe(e,t,n){e.status[t]=Math.max(0,(e.status[t]??0)+n)}function Se(e){const t=qe(Ke(e)),n=qe(Ke(e)),r=qe(Ke(e));return{root:t,nextIfA:n,nextIfB:r}}function hn(e,t){e.run.branchOffer||(e.run.branchOffer=Se(e));const n=e.run.branchOffer,r=t==="A"?n.nextIfA:n.nextIfB,a=Se(e);e.run.branchOffer={root:r,nextIfA:a.nextIfA,nextIfB:a.nextIfB}}function mn(){return Math.random().toString(16).slice(2)+"-"+Date.now().toString(16)}function pt(e,t=0){return e<t?t:e}function ft(e){const t=[...e];for(let n=t.length-1;n>0;n--){const r=Math.floor(Math.random()*(n+1));[t[n],t[r]]=[t[r],t[n]]}return t}function F(e,t="pickOne"){if(e.length===0)throw new Error(`${t}: empty array`);return e[Math.floor(Math.random()*e.length)]}function f(e,t){e.log.unshift(t),e.log=e.log.slice(0,250)}function q(e){return e.enemies.filter(t=>t.hp>0)}function Ke(e){const t=[],n=e.run.treasureObtained?24:20,r=e.run.treasureObtained?1:4,a=(e.run.treasureObtained,5),l=!e.run.treasureObtained&&e.run.nodePickCount>=30?1:0;for(let d=0;d<n;d++)t.push("BATTLE");for(let d=0;d<r;d++)t.push("REST");for(let d=0;d<a;d++)t.push("EVENT");for(let d=0;d<l;d++)t.push("TREASURE");const c=F(t,"rollNodeOffers pool");let p=F(t,"rollNodeOffers pool");if(c==="TREASURE"){const d=t.filter(m=>m!=="TREASURE");p=F(d,"rollNodeOffers poolNoTreasure")}return[c,p]}function yn(e){return Math.max(0,Math.min(1,e))}function De(e,t=0){const n=e.player?.fatigue??0,r=yn(t+Math.max(0,n-5)*.12),a=n<=5?0:n<=8?1:n<=11?2:3;return{f:n,p:r,tier:a}}function Qe(e){const t={phase:"NODE",log:[],uidSeq:0,winHooksAppliedThisCombat:!1,intentsRevealedThisTurn:!1,disruptIndexThisTurn:null,backUidsThisTurn:[],run:{encounterCount:0,treasureObtained:!1,afterTreasureNodePicks:0,finished:!1,nextBattleSuppliesBonus:0,nextBossId:null,bossPool:["boss_gravity_master","boss_cursed_wall","boss_giant_orc","boss_soul_stealer"],nodePickCount:0,branchOffer:null,nodeOfferQueue:[],currentNodeOffers:null,nodePickByType:{BATTLE:0,REST:0,EVENT:0,TREASURE:0},battleCount:0,enemyLastSeenBattle:{},nextBossTime:40,forcedNext:null,bossOmenText:null,deckSizeAtTreasure:null,ominousProphecySeen:!1},player:{hp:40,maxHp:40,block:0,supplies:0,fatigue:0,zeroSupplyTurns:0,status:{vuln:0,weak:0,bleed:0,disrupt:0},immuneToDisruptThisTurn:!1,nullifyDamageThisTurn:!1},content:e,cards:{},deck:[],hand:[],discard:[],exhausted:[],vanished:[],choice:null,choiceStack:[],frontSlots:[null,null,null],backSlots:[null,null,null],backSlotDisabled:[!1,!1,!1],enemies:[],attackedEnemyIndicesThisTurn:[],usedThisTurn:0,frontPlacedThisTurn:0,selectedHandCardUid:null,pendingTargetQueue:[],pendingTarget:null,drawCountThisTurn:0,time:0};return t.run.branchOffer=Se(t),bn(t),f(t,"새 런 시작."),t}function se(e,t,n){for(let r=0;r<n;r++){const a=mn(),o={uid:a,defId:t,zone:"deck",upgrade:0};e.cards[a]=o,e.deck.push(a)}}function bn(e){se(e,"field_ration",2),se(e,"maintenance",2),se(e,"scout",2),se(e,"shield",2),se(e,"power_arrow",1),se(e,"arrow",3),e.deck=ft(e.deck)}function Z(e,t){const n=e.cards[t],r=e.content.cardsById[n.defId],a=n.upgrade??0,o=r.upgrades?.[a-1];return o?{...r,...o}:r}function ue(e,t,n){const r=e.cardsById[t],a=Math.max(0,n|0);if(a<=0)return r;const o=r.upgrades?.[a-1];return o?{...r,...o}:r}function ie(e,t){const r=e.cards[t].upgrade??0,a=Z(e,t);return r>0?`${a.name} +${r}`:a.name}const xn=[{id:"field_ration",name:"야전 식량",frontText:"방어 +3",backText:"S +2",front:[{op:"block",n:3}],back:[{op:"supplies",n:2}],upgrades:[{frontText:"방어 +5",front:[{op:"block",n:5}],backText:"S +3",back:[{op:"supplies",n:3}]}]},{id:"maintenance",name:"정비 도구",exhaustWhen:"BACK",frontText:"방어 +3",backText:"F -1, 소모",front:[{op:"block",n:3}],back:[{op:"fatigue",n:-1}],upgrades:[{frontText:"방어 +5",front:[{op:"block",n:5}],backText:"F -1, S +1, 소모",back:[{op:"fatigue",n:-1},{op:"supplies",n:1}]}]},{id:"scout",name:"정찰",frontText:"지정 피해 3, 방어 +1",backText:"드로우 1, S +2",front:[{op:"damageEnemy",target:"select",n:3},{op:"block",n:1}],back:[{op:"draw",n:1},{op:"supplies",n:2}],upgrades:[{frontText:"지정 피해 4, 방어 +2",front:[{op:"damageEnemy",target:"select",n:4},{op:"block",n:2}],backText:"드로우 2, S +2",back:[{op:"draw",n:2},{op:"supplies",n:2}]}]},{id:"shield",name:"방패",frontText:"방어 +5",backText:"방어 +3",front:[{op:"block",n:5}],back:[{op:"block",n:3}],upgrades:[{frontText:"방어 +7",front:[{op:"block",n:7}],backText:"방어 +4",back:[{op:"block",n:4}]}]},{id:"power_arrow",name:"강력한 화살",frontText:"무작위 피해 10, S -2",backText:"무작위 피해 7, S -2",front:[{op:"supplies",n:-2},{op:"damageEnemy",target:"random",n:10}],back:[{op:"supplies",n:-2},{op:"damageEnemy",target:"random",n:7}],upgrades:[{frontText:"무작위 피해 13, S -2",front:[{op:"supplies",n:-2},{op:"damageEnemy",target:"random",n:13}],backText:"무작위 피해 10, S -2",back:[{op:"supplies",n:-2},{op:"damageEnemy",target:"random",n:10}]}]},{id:"arrow",name:"화살",frontText:"지정 피해 5",backText:"지정 피해 5, S -1",front:[{op:"damageEnemy",target:"select",n:5}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:5}],upgrades:[{frontText:"지정 피해 7",front:[{op:"damageEnemy",target:"select",n:7}],backText:"지정 피해 7, S -1",back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:7}]}]},{id:"goal_treasure",name:"저주받은 보물",exhaustWhen:"BOTH",frontText:"F +1, 소모",backText:"S -1, F +1, 소모",front:[{op:"fatigue",n:1}],back:[{op:"supplies",n:-1},{op:"fatigue",n:1}]},{id:"berserk",name:"광폭화",frontText:"무작위 피해 15, F +1",backText:"S +4, F +1",front:[{op:"damageEnemy",target:"random",n:15},{op:"fatigue",n:1}],back:[{op:"supplies",n:4},{op:"fatigue",n:1}],upgrades:[{frontText:"무작위 피해 20, F +2",front:[{op:"damageEnemy",target:"random",n:20},{op:"fatigue",n:2}],backText:"S +6, F +2",back:[{op:"supplies",n:6},{op:"fatigue",n:2}]}]},{id:"bandage",name:"붕대",exhaustWhen:"BOTH",frontText:"HP +4, 소모",backText:"HP +4, S -1, 소모",front:[{op:"heal",n:4}],back:[{op:"supplies",n:-1},{op:"heal",n:4}],upgrades:[{frontText:"HP +4, 출혈 제거, 소모",front:[{op:"heal",n:4},{op:"clearStatusSelf",key:"bleed"}],backText:"HP +4, 출혈 제거, S -1, 소모",back:[{op:"supplies",n:-1},{op:"heal",n:4},{op:"clearStatusSelf",key:"bleed"}]}]},{id:"arrow_rain",name:"화살의 비",exhaustWhen:"BOTH",frontText:"모든 적에게 피해 10, S -1, F +1, 소모",backText:"드로우 2, S +2, F +1, 소모",front:[{op:"damageEnemy",target:"all",n:10},{op:"supplies",n:-1},{op:"fatigue",n:1}],back:[{op:"draw",n:2},{op:"supplies",n:2},{op:"fatigue",n:1}],upgrades:[{frontText:"모든 적에게 피해 13, S -2, F +1, 소모",front:[{op:"damageEnemy",target:"all",n:13},{op:"supplies",n:-2},{op:"fatigue",n:1}],backText:"드로우 3, S +3, F +2, 소모",back:[{op:"draw",n:3},{op:"supplies",n:3},{op:"fatigue",n:2}]}]},{id:"smoke",name:"연막",exhaustWhen:"FRONT",frontText:"이번 턴 적 공격 피해 무효, 소모",backText:"자신은 교란 당하지 않음",front:[{op:"nullifyDamageThisTurn"}],back:[{op:"immuneDisruptThisTurn"}]},{id:"redeploy",name:"재배치",frontText:"S +2",backText:"3번 슬롯에 있는 후열 카드의 전열 효과 발동",front:[{op:"supplies",n:2}],back:[{op:"triggerFrontOfBackSlot",index:2}],upgrades:[{frontText:"S +3",front:[{op:"supplies",n:3}],backText:"3번 슬롯에 있는 후열 카드의 전열 효과 발동, S +1",back:[{op:"triggerFrontOfBackSlot",index:2},{op:"supplies",n:1}]}]},{id:"secret_strike",name:"비장의 일격",exhaustWhen:"BOTH",frontText:"무작위 피해 (F의 3배), 소모",backText:"모든 적에게 취약 +4 및 약화 +4, 소모",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:3}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:4},{op:"statusEnemy",target:"all",key:"weak",n:4}],upgrades:[{exhaustWhen:"FRONT",frontText:"지정 피해 (F의 3배), 소모",front:[{op:"damageEnemyByPlayerFatigue",target:"select",mult:3}],backText:"모든 적에게 취약 +4 및 약화 +4",back:[{op:"statusEnemy",target:"all",key:"vuln",n:4},{op:"statusEnemy",target:"all",key:"weak",n:4}]}]},{id:"fire_scroll",name:"화염 두루마리",exhaustWhen:"BOTH",frontText:"방어 +7, 소모",backText:"모든 적에게 피해 12, 소모",front:[{op:"block",n:7}],back:[{op:"damageEnemy",target:"all",n:12}],upgrades:[{frontText:"방어 +8, 소모",front:[{op:"block",n:8}],backText:"모든 적에게 피해 14, 소모",back:[{op:"damageEnemy",target:"all",n:14}]}]},{id:"caltrops",name:"마름쇠",frontText:"모든 적에게 출혈 4 부여",backText:"이번 턴에 자신을 공격하려는 적에게 출혈 3 부여",front:[{op:"statusEnemy",target:"all",key:"bleed",n:4}],back:[{op:"statusEnemiesAttackingThisTurn",key:"bleed",n:3}],upgrades:[{frontText:"모든 적에게 출혈 5 부여",backText:"이번 턴에 자신을 공격하려는 적에게 출혈 4 부여",front:[{op:"statusEnemy",target:"all",key:"bleed",n:5}],back:[{op:"statusEnemiesAttackingThisTurn",key:"bleed",n:4}]}]},{id:"emergency_rations",name:"비상식량",vanishWhen:"BACK",frontText:"S +2",backText:"S를 10으로 만듦. 소실",front:[{op:"supplies",n:2}],back:[{op:"setSupplies",n:10}],upgrades:[{frontText:"S +3",backText:"S를 15으로 만듦. 소실",front:[{op:"supplies",n:3}],back:[{op:"setSupplies",n:15}]}]},{id:"painkiller",name:"진통제",exhaustWhen:"BOTH",frontText:"HP -8, F -2, 소모",backText:"HP +8, F +2, 소모",front:[{op:"hp",n:-8},{op:"fatigue",n:-2}],back:[{op:"hp",n:8},{op:"fatigue",n:2}],upgrades:[{frontText:"HP -6, F -2, 소모",backText:"HP +10, F +2, 소모",front:[{op:"hp",n:-6},{op:"fatigue",n:-2}],back:[{op:"hp",n:10},{op:"fatigue",n:2}]}]},{id:"field_experience",name:"실전 경험",exhaustWhen:"BACK",frontText:"모든 적에게 피해 3",backText:"이 카드가 후열에 있는 턴에 승리하면 최대 체력 +2, 소모",front:[{op:"damageEnemy",target:"all",n:3}],back:[],onWinWhileInBack:[{op:"maxHp",n:2}],upgrades:[{frontText:"모든 적에게 피해 4",backText:"이 카드가 후열에 있는 턴에 승리하면 최대 체력 +3, 소모",front:[{op:"damageEnemy",target:"all",n:4}],onWinWhileInBack:[{op:"maxHp",n:3}]}]},{id:"camp_prep",name:"야영 준비",frontText:"방어 +4, S +1",backText:"S +3",front:[{op:"block",n:4},{op:"supplies",n:1}],back:[{op:"supplies",n:3}],upgrades:[{frontText:"방어 +5, S +2",backText:"S +5",front:[{op:"block",n:5},{op:"supplies",n:2}],back:[{op:"supplies",n:5}]}]},{id:"vital_shot",name:"급소 사격",frontText:"지정 피해 8",backText:"지정 피해 5, 출혈 2 부여, S -1",front:[{op:"damageEnemy",target:"select",n:8}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:5},{op:"statusEnemy",target:"select",key:"bleed",n:2}],upgrades:[{frontText:"지정 피해 11",backText:"지정 피해 6, 출혈 3 부여, S -1",front:[{op:"damageEnemy",target:"select",n:11}],back:[{op:"supplies",n:-1},{op:"damageEnemy",target:"select",n:6},{op:"statusEnemy",target:"select",key:"bleed",n:3}]}]},{id:"taunt",name:"독설",frontText:"지정 약화 +4",backText:"모든 적에게 취약 +2 및 약화 +2",front:[{op:"statusEnemy",target:"select",key:"weak",n:4}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:2},{op:"statusEnemy",target:"all",key:"weak",n:2}],upgrades:[{frontText:"지정 약화 +5",backText:"모든 적에게 취약 +2 및 약화 +3",front:[{op:"statusEnemy",target:"select",key:"weak",n:5}],back:[{op:"statusEnemy",target:"all",key:"vuln",n:2},{op:"statusEnemy",target:"all",key:"weak",n:3}]}]},{id:"rapid_fire",name:"연속 사격",frontText:"지정 피해 2, 3번 발동",backText:"이번 턴에 카드를 뽑았으면 무작위 피해 8",front:[{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2}],back:[{op:"ifDrewThisTurn",then:[{op:"damageEnemy",target:"random",n:8}]}],upgrades:[{frontText:"지정 피해 2, 4번 발동",backText:"이번 턴에 카드를 뽑았으면 무작위 피해 10",front:[{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2},{op:"damageEnemy",target:"select",n:2}],back:[{op:"ifDrewThisTurn",then:[{op:"damageEnemy",target:"random",n:10}]}]}]},{id:"mad_echo",name:"메아리",frontText:"무작위 피해 (F)",backText:"드로우 1, S +2, F +1",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:1}],back:[{op:"draw",n:1},{op:"supplies",n:2},{op:"fatigue",n:1}],upgrades:[{frontText:"무작위 피해 (F의 2배)",front:[{op:"damageEnemyByPlayerFatigue",target:"random",mult:2}],backText:"드로우 2, S +2, F +1",back:[{op:"draw",n:2},{op:"supplies",n:2},{op:"fatigue",n:1}]}]},{id:"mad_insight",name:"금단의 통찰",exhaustWhen:"BOTH",frontText:"방어 +8, 드로우 1, F +1, 소모",backText:"드로우 3, S +2, F +2, 소모",front:[{op:"block",n:8},{op:"draw",n:1},{op:"fatigue",n:1}],back:[{op:"draw",n:3},{op:"supplies",n:2},{op:"fatigue",n:2}],upgrades:[{frontText:"방어 +10, 드로우 2, F +1, 소모",front:[{op:"block",n:10},{op:"draw",n:2},{op:"fatigue",n:1}],backText:"드로우 4, S +3, F +2, 소모",back:[{op:"draw",n:4},{op:"supplies",n:3},{op:"fatigue",n:2}]}]},{id:"mad_bargain",name:"거래의 잔재",exhaustWhen:"BOTH",frontText:"지정 12 피해, S -1, F +1, 소모",backText:"HP +6, F +2, 소모",front:[{op:"damageEnemy",target:"select",n:12},{op:"supplies",n:-1},{op:"fatigue",n:1}],back:[{op:"heal",n:6},{op:"fatigue",n:2}],upgrades:[{frontText:"지정 16 피해, S -1, F +1, 소모",front:[{op:"damageEnemy",target:"select",n:16},{op:"supplies",n:-1},{op:"fatigue",n:1}],backText:"HP +8, F +2, 소모",back:[{op:"heal",n:8},{op:"fatigue",n:2}]}]}],kn=Object.fromEntries(xn.map(e=>[e.id,e])),Tn=[{id:"other_adventurer",name:"보물을 노리는 다른 모험가",maxHp:60,intents:[{label:"창 찌르기: 5 피해, 3번 발동",acts:[{op:"damagePlayer",n:5},{op:"damagePlayer",n:5},{op:"damagePlayer",n:5}]},{label:"독약 뿌리기: 출혈 +4, 취약 +4, 약화 +4 부여",acts:[{op:"statusPlayer",key:"bleed",n:4},{op:"statusPlayer",key:"vuln",n:4},{op:"statusPlayer",key:"weak",n:4}]}]},{id:"goblin_raider",name:"고블린 약탈자",maxHp:20,intents:[{label:"기습: 12 - 이번 턴에 사용한 카드의 수만큼 피해",acts:[{op:"damagePlayerFormula",kind:"goblin_raider"}]},{label:"훔치기: 출혈 +2 부여, S -3",acts:[{op:"supplies",n:-3},{op:"statusPlayer",key:"bleed",n:2}]}]},{id:"watching_statue",name:"감시하는 석상",maxHp:25,intents:[{label:"감시: 4 + 이번 턴에 사용한 카드의 수만큼 피해",acts:[{op:"damagePlayerFormula",kind:"watching_statue"}]}]},{id:"pebble_golem",name:"조약돌 골렘",maxHp:30,intents:[{label:"조약돌 던지기: 8 피해",acts:[{op:"damagePlayer",n:8}]},{label:"모래 모으기: 자신 HP 6 회복",acts:[{op:"enemyHealSelf",n:6}]}]},{id:"rock_golem",name:"바위 골렘",maxHp:50,intents:[{label:"바위 던지기: 10 피해",acts:[{op:"damagePlayer",n:10}]},{label:"땅 모으기: 자신 HP 10 회복",acts:[{op:"enemyHealSelf",n:10}]}]},{id:"slime",name:"슬라임",maxHp:30,intents:[{label:"유연한 몸: 다음 턴 동안 피해를 입지 않음",acts:[{op:"enemyImmuneNextTurn"}]},{label:"산성액: 약화 +3 부여 후 자신 HP 3 회복",acts:[{op:"statusPlayer",key:"weak",n:3},{op:"enemyHealSelf",n:3}]},{label:"때리기: 6 피해",acts:[{op:"damagePlayer",n:6}]}]},{id:"poison_spider",name:"독거미",maxHp:28,intents:[{label:"독니로 물기: 출혈 +4 부여",acts:[{op:"statusPlayer",key:"bleed",n:4}]},{label:"송곳니로 물기: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"단번에 물기: 출혈 +2 부여, 6 피해",acts:[{op:"statusPlayer",key:"bleed",n:2},{op:"damagePlayer",n:6}]}]},{id:"gravity_echo",name:"중력의 잔향",maxHp:26,intents:[{label:"하중 인장",acts:[{op:"damagePlayerByDeckSize",base:5,per:2,div:6,cap:18}]},{label:"압축: 7 피해",acts:[{op:"damagePlayer",n:7}]},{label:"놓치게 만들기: S -3",acts:[{op:"supplies",n:-3}]}]},{id:"boss_gravity_master",name:"중력 통달자",omen:"몸이 점점 무겁다.",maxHp:70,intents:[{label:"중력 수축: 약화 +3 부여",acts:[{op:"statusPlayer",key:"weak",n:3}]},{label:"특이점 생성",acts:[{op:"damagePlayerByDeckSize",base:8,per:3,div:5,cap:30}]},{label:"천장 붕괴: 11 피해",acts:[{op:"damagePlayer",n:11}]}]},{id:"boss_cursed_wall",name:"저주받은 벽",omen:"움직이지 않는다. 당신이 닳아간다.",maxHp:120,intents:[{label:"저주의 기운: F +1",acts:[{op:"fatiguePlayer",n:1}]},{label:"아무 행동도 하지 않음",acts:[]}]},{id:"boss_giant_orc",name:"거대한 오크",omen:"거대한 무언가가 기다린다.",maxHp:80,intents:[{label:"내려치기: 15 피해",acts:[{op:"damagePlayer",n:15}]},{label:"단단한 피부: 다음 턴 동안 피해를 입지 않음",acts:[{op:"enemyImmuneNextTurn"}]},{label:"타고난 회복: 자신 HP 15 회복",acts:[{op:"enemyHealSelf",n:15}]}]},{id:"boss_soul_stealer",name:"영혼 강탈자",omen:"행동하지 않으면 종말이 오리라.",maxHp:60,intents:[{label:"허기: 7 피해, S -2",acts:[{op:"damagePlayer",n:7},{op:"supplies",n:-2}]},{label:"나태: 7 피해, F +1",acts:[{op:"damagePlayer",n:7},{op:"fatiguePlayer",n:1}]},{label:"예언: 카운트 진행",acts:[]}]}],gn=Object.fromEntries(Tn.map(e=>[e.id,e]));function St(e,t){const n=e.game,r={kind:"damageSelect",amount:t,sourceCardUid:e.cardUid,reason:e.side==="front"?"FRONT":"BACK"};n.pendingTargetQueue??=[],n.pendingTarget==null?n.pendingTarget=r:n.pendingTargetQueue.push(r),f(n,`대상 선택 필요: 적을 클릭하세요. (${1+n.pendingTargetQueue.length}개 남음)`)}function Sn(e,t,n){const r=e.game,a={kind:"statusSelect",key:t,n,sourceCardUid:e.cardUid,reason:e.side==="front"?"FRONT":"BACK"};r.pendingTargetQueue??=[],r.pendingTarget==null?r.pendingTarget=a:r.pendingTargetQueue.push(a),f(r,"대상 선택 필요: 적을 클릭하세요.")}function Cn(e,t){if(t.id==="boss_soul_stealer"&&t.soulWillNukeThisTurn)return!0;const n=e.content.enemiesById[t.id];return n.intents[t.intentIndex%n.intents.length].acts.some(a=>a.op==="damagePlayer"||a.op==="damagePlayerFormula"||a.op==="damagePlayerByDeckSize")}function Ce(e,t){const n=e.game;for(const r of t)switch(r.op){case"block":Yn(n,r.n);break;case"supplies":Xn(n,r.n);break;case"fatigue":ae(n,r.n);break;case"heal":Gn(n,r.n);break;case"hp":n.player.hp=Math.max(0,Math.min(n.player.maxHp,n.player.hp+r.n)),f(n,`HP ${r.n>=0?"+":""}${r.n} (현재 ${n.player.hp}/${n.player.maxHp})`);break;case"maxHp":n.player.maxHp+=r.n,n.player.hp=Math.min(n.player.maxHp,n.player.hp+r.n),f(n,`최대 HP +${r.n} (현재 ${n.player.hp}/${n.player.maxHp})`);break;case"setSupplies":n.player.supplies=Math.max(0,r.n),f(n,`보급 S를 ${n.player.supplies}으로 설정`);break;case"draw":{const a=mt(n,r.n);n.drawCountThisTurn+=a;break}case"ifDrewThisTurn":{n.drawCountThisTurn>0&&Ce(e,r.then);break}case"damageEnemy":if(r.target==="random"){const a=q(n);if(a.length===0)break;xe(n,F(a),r.n)}else if(r.target==="all")for(const a of q(n))xe(n,a,r.n);else St(e,r.n);break;case"clearStatusSelf":{const a=r.key;n.player.status[a]=0,f(n,`상태 해제: ${a} = 0`);break}case"damageEnemyBy":{if(r.target!=="random")break;const a=q(n);if(a.length===0)break;let o=0;r.by==="frontCount"&&(o=n.frontSlots.filter(Boolean).length*r.nPer),xe(n,F(a),o);break}case"damageEnemyByPlayerFatigue":{const a=Math.max(0,n.player.fatigue*r.mult);if(r.target==="random"){const o=q(n);if(o.length===0)break;xe(n,F(o),a);break}if(r.target==="select"){if(a<=0)break;St(e,a);break}break}case"statusPlayer":n.player.status[r.key]=Math.max(0,(n.player.status[r.key]??0)+r.n),f(n,`플레이어 상태: ${r.key} ${r.n>=0?"+":""}${r.n}`);break;case"statusEnemy":if(r.target==="random"){const a=q(n);if(a.length===0)break;const o=F(a);Oe(o,r.key,r.n),f(n,`적(${o.name}) 상태: ${r.key} ${r.n>=0?"+":""}${r.n}`)}else if(r.target==="all"){const a=q(n);if(a.length===0)break;for(const o of a)Oe(o,r.key,r.n);f(n,`모든 적 상태: ${r.key} ${r.n>=0?"+":""}${r.n}`)}else Sn(e,r.key,r.n);break;case"statusEnemiesAttackingThisTurn":{const a=q(n).filter(o=>Cn(n,o));if(a.length===0){f(n,`이번 턴 공격 의도 적 없음 → ${r.key} 적용 없음`);break}for(const o of a)o.status[r.key]=Math.max(0,(o.status[r.key]??0)+r.n);f(n,`공격 의도 적에게 ${r.key} ${r.n>=0?"+":""}${r.n} (대상 ${a.length})`);break}case"immuneDisruptThisTurn":n.player.immuneToDisruptThisTurn=!0,f(n,"이번 턴 교란 무시");break;case"nullifyDamageThisTurn":n.player.nullifyDamageThisTurn=!0,f(n,"이번 턴 적 공격 피해 무효");break;case"triggerFrontOfBackSlot":{const a=n.backSlots[r.index];if(!a){f(n,`재배치: 후열 ${r.index+1}번 슬롯이 비어 있음`);break}const o=Z(n,a);f(n,`재배치: [[${ie(n,a)}]]의 전열 효과를 추가 발동`),Ce({game:n,side:"front",cardUid:a},o.front);break}default:return r}}function Ie(e,t=10,n=16){const r=Math.max(0,e-n),a=Math.ceil(Math.sqrt(r));return t+a}function Ve(e,t){const n=e.content.enemiesById[t];return{id:n.id,name:n.name,hp:n.maxHp,maxHp:n.maxHp,intentIndex:0,status:{vuln:0,weak:0,bleed:0,disrupt:0},immuneThisTurn:!1,immuneNextTurn:!1,lastIntentKey:null,lastIntentStreak:0,soulWarnCount:t==="boss_soul_stealer"?0:void 0,soulArmed:t==="boss_soul_stealer"?!1:void 0,soulWillNukeThisTurn:t==="boss_soul_stealer"?!1:void 0}}function En(e,t,n,r=5){for(const a of t){const o=e.run.enemyLastSeenBattle[a];if(o!=null&&n-o<r)return!1}return!0}function he(e,t){const n=t?.forceBoss??!1,r=e.run.nodePickCount,a=e.run.battleCount+1;if(t?.forcePatternIds&&t.forcePatternIds.length>0){const S=t.forcePatternIds;e.run.battleCount=a;for(const i of S)e.run.enemyLastSeenBattle[i]=a;e.enemies=S.map(i=>Ve(e,i)),f(e,`전투 시작! (노드 ${r}, 전투 ${a}회차) 적: ${e.enemies.map(i=>i.name).join(", ")}`);return}if(n)if(e.run.bossPool.length===0&&!e.run.nextBossId)f(e,`보스 풀이 비었습니다. 일반 전투로 진행합니다. (노드 ${r})`);else{let S=e.run.nextBossId??null;if(S!=null){const s=e.content.enemiesById[S];e.run.bossOmenText=jt[S]??s.omen??null}S?(e.run.nextBossId=null,e.run.bossPool=e.run.bossPool.filter(s=>s!==S)):(S=F(e.run.bossPool),e.run.bossPool=e.run.bossPool.filter(s=>s!==S)),e.enemies=[Ve(e,S)];const i=e.run;i.ominousProphecySeen=!1,f(e,`보스 등장! (노드 ${r}) 적: ${e.enemies[0].name}`);return}const o=[[["goblin_raider"],["watching_statue"],["pebble_golem"],["slime"]],[["goblin_raider","slime"],["pebble_golem","pebble_golem"],["rock_golem"],["goblin_raider","goblin_raider"],["poison_spider"]],[["goblin_raider","goblin_raider","goblin_raider"],["pebble_golem","pebble_golem","slime"],["rock_golem","pebble_golem"],["slime","slime"],["poison_spider","slime"],["gravity_echo"]]],l=[["gravity_echo","poison_spider"],["poison_spider","slime"],["watching_statue","slime"],["watching_statue","watching_statue"],["poison_spider","poison_spider"],["rock_golem","gravity_echo"],["goblin_raider","goblin_raider","watching_statue"]],c=(e.run.nodePickCount??0)+(e.time??0),p=Math.min(o.length-1,Math.floor(Math.max(0,c)/10)),d=e.run.treasureObtained?l:o[p],m=5,h=d.filter(S=>En(e,S,a,m)),u=h.length>0?h:d,k=F(u);e.run.battleCount=a;for(const S of k)e.run.enemyLastSeenBattle[S]=a;e.enemies=k.map(S=>Ve(e,S)),f(e,`전투 시작! (노드 ${r}, 전투 ${a}회차) 적: ${e.enemies.map(S=>S.name).join(", ")}`)}function me(e){e.player.block=0,e.player.status.vuln=0,e.player.status.weak=0,e.player.status.bleed=0,e.player.status.disrupt=0,e.player.zeroSupplyTurns=0,e.phase="REVEAL",e.frontSlots=[null,null,null],e.backSlots=[null,null,null],e.backSlotDisabled=[!1,!1,!1],e.backUidsThisTurn=[],e.hand=[],e.selectedHandCardUid=null,e.pendingTarget=null,e.pendingTargetQueue=[],e.usedThisTurn=0,e.winHooksAppliedThisCombat=!1;const t=e.run.nextBattleSuppliesBonus??0;e.player.supplies=7+t,t!==0&&(f(e,`다음 전투 보너스 적용: S +${t}`),e.run.nextBattleSuppliesBonus=0),e.player.immuneToDisruptThisTurn=!1,e.player.nullifyDamageThisTurn=!1,e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null,e.drawCountThisTurn=0,e.attackedEnemyIndicesThisTurn=[],e.frontPlacedThisTurn=0,e.usedThisTurn=0,mt(e,4),ht(e),e.phase="PLACE",e.victoryResolvedThisCombat=!1}function wn(e){return e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length}function vn(e,t){const n=Math.ceil(t/e.div);let r=e.base+e.per*n;return e.cap!=null&&(r=Math.min(r,e.cap)),{dmg:r,scale:n}}const Pn={other_adventurer:new Set([1]),slime:new Set([0,1]),pebble_golem:new Set([1]),rock_golem:new Set([1]),poison_spider:new Set([0,2]),boss_cursed_wall:new Set([0]),boss_giant_orc:new Set([1])};function $n(e,t){const n=Pn[e];return!!n&&n.has(t)}function Je(e){if(e===null)return"null";const t=typeof e;return t==="number"||t==="boolean"?String(e):t==="string"?JSON.stringify(e):Array.isArray(e)?"["+e.map(Je).join(",")+"]":t==="object"?"{"+Object.keys(e).sort().map(r=>JSON.stringify(r)+":"+Je(e[r])).join(",")+"}":JSON.stringify(String(e))}function Ft(e){if(!e)return"NONE";const t={};for(const n of Object.keys(e))n==="label"||n==="text"||n==="desc"||n==="name"||(t[n]=e[n]);return t.effects&&Array.isArray(t.effects)&&(t.effects=t.effects.map(n=>{const r={};for(const a of Object.keys(n??{}))a==="label"||a==="text"||a==="desc"||a==="name"||(r[a]=n[a]);return r})),Je(t)}function _n(e,t){const n=e.lastIntentKey??null,r=e.lastIntentStreak??0;n===t?e.lastIntentStreak=Math.min(3,r+1):(e.lastIntentKey=t,e.lastIntentStreak=1)}function Nn(e,t,n,r,a){const o=e.length;if(o<=1)return 0;const l=Array.from({length:o},(u,k)=>k),c=u=>u===t&&$n(n,u),p=u=>!!r&&a>=2&&Ft(e[u])===r,d=l.filter(u=>!c(u)&&!p(u));if(d.length>0)return F(d);const m=l.filter(u=>!p(u));if(m.length>0)return F(m);const h=l.filter(u=>!c(u));return h.length>0?F(h):F(l)}const Bn=2,An=.6;function ht(e){if(e.intentsRevealedThisTurn)return;e.intentsRevealedThisTurn=!0,e.attackedEnemyIndicesThisTurn=[],e.backUidsThisTurn=[],e.drawCountThisTurn=0,e.phase="REVEAL",e.player.immuneToDisruptThisTurn=!1,e.player.nullifyDamageThisTurn=!1,e.disruptIndexThisTurn=null,e.backSlotDisabled=[!1,!1,!1],(e.player.status.disrupt??0)>0&&(e.disruptIndexThisTurn=Math.floor(Math.random()*3),e.backSlotDisabled[e.disruptIndexThisTurn]=!0);for(const n of e.enemies)n.immuneThisTurn=n.immuneNextTurn,n.immuneNextTurn=!1;for(const n of q(e)){n.intentLabelOverride=void 0;const a=e.content.enemiesById[n.id].intents;if(!a||a.length===0)continue;const o=Nn(a,n.intentIndex??0,n.id,n.lastIntentKey??null,n.lastIntentStreak??0);n.intentIndex=o;const l=a[o%a.length];if(_n(n,Ft(l)),n.id==="boss_soul_stealer"){n.soulWillNukeThisTurn=!1;const m=n.soulWarnCount??0;if(!!n.soulArmed){if(Math.random()<An){n.soulWillNukeThisTurn=!0,n.intentLabelOverride="종말: 50 피해",f(e,`적 의도: ${n.name} → ${n.intentLabelOverride}`);continue}const k=a[n.intentIndex%a.length];n.intentLabelOverride=`${k.label} (⚠ 폭발 가능 상태)`,f(e,`적 의도: ${n.name} → ${n.intentLabelOverride}`);continue}const u=a[n.intentIndex%a.length];n.intentLabelOverride=`${u.label} (경고 ${m}/3)`,f(e,`적 의도: ${n.name} → ${n.intentLabelOverride}`);continue}const c=a[n.intentIndex%a.length];let p=c.label;const d=c.acts.find(m=>m.op==="damagePlayerByDeckSize");if(d&&d.op==="damagePlayerByDeckSize"){const m=wn(e),{dmg:h}=vn(d,m);p=`${c.label.split(":")[0].trim()}: ${h} 피해`}n.intentLabelOverride=p,f(e,`적 의도: ${n.name} → ${p}`)}e.disruptIndexThisTurn!==null&&f(e,`교란: 이번 턴 후열 ${e.disruptIndexThisTurn} 무효`),e.phase="PLACE"}function Ct(e,t,n,r){if(e.phase!=="PLACE"||!e.hand.includes(t))return;n==="back"&&(e.backUidsThisTurn.includes(t)||e.backUidsThisTurn.push(t));const a=n==="front"?e.frontSlots:e.backSlots;a[r]||(e.hand=e.hand.filter(o=>o!==t),a[r]=t,e.cards[t].zone=n,e.usedThisTurn+=1,f(e,`[${ie(e,t)}]를 ${n==="front"?"전열":"후열"} ${r}번에 배치`),n==="front"&&(e.frontPlacedThisTurn+=1))}function Et(e,t,n){return Z(e,t).tags?.includes(n)??!1}function On(e,t){e.frontSlots=e.frontSlots.map(n=>n===t?null:n),e.backSlots=e.backSlots.map(n=>n===t?null:n)}function wt(e,t,n){const r=Z(e,t);On(e,t),e.hand=e.hand.filter(p=>p!==t),e.deck=e.deck.filter(p=>p!==t),e.discard=e.discard.filter(p=>p!==t);const a=r.vanishWhen,o=r.exhaustWhen,l=a==="BOTH"||a==="FRONT"&&n==="front"||a==="BACK"&&n==="back",c=o==="BOTH"||o==="FRONT"&&n==="front"||o==="BACK"&&n==="back";if(a&&a!=="NONE"&&l){e.vanished.push(t),e.cards[t].zone="vanished",f(e,`[${ie(e,t)}] 소실(영구 제거)`);return}if(o&&o!=="NONE"&&c){e.exhausted.push(t),e.cards[t].zone="exhausted",f(e,`[${ie(e,t)}] 소모(이번 전투에서 제거)`);return}if(!a&&Et(e,t,"VANISH")){e.vanished.push(t),e.cards[t].zone="vanished",f(e,`[${ie(e,t)}] 소실(영구 제거)`);return}if(!o&&Et(e,t,"EXHAUST")){e.exhausted.push(t),e.cards[t].zone="exhausted",f(e,`[${ie(e,t)}] 소모(이번 전투에서 제거)`);return}e.discard.push(t),e.cards[t].zone="discard"}function In(e){for(let t=0;t<3;t++){const n=e.frontSlots[t];n&&wt(e,n,"front"),e.frontSlots[t]=null;const r=e.backSlots[t];r&&wt(e,r,"back"),e.backSlots[t]=null}}function Hn(e){if(!(e.phase!=="PLACE"&&e.phase!=="BACK")){e.phase="BACK",f(e,"=== 후열 단계 ===");for(let t=0;t<3;t++){const n=e.backSlots[t];if(!n)continue;const r=Z(e,n);if(!e.player.immuneToDisruptThisTurn&&e.backSlotDisabled[t]){f(e,`후열 ${t}번 [${r.name}] 교란으로 무효`);continue}Ce({game:e,side:"back",cardUid:n},r.back)}e.phase="FRONT"}}function Rn(e){if(e.phase==="FRONT"){f(e,"=== 전열 단계 ===");for(let t=0;t<3;t++){const n=e.frontSlots[t];if(!n)continue;const r=Z(e,n);Ce({game:e,side:"front",cardUid:n},r.front)}e.phase="ENEMY"}}function Mn(e){if(e.phase==="ENEMY"){f(e,"=== 적 행동 ===");for(const t of q(e)){const n=e.content.enemiesById[t.id],r=n.intents[t.intentIndex%n.intents.length];if(t.id==="boss_soul_stealer"){if(t.soulWillNukeThisTurn){const a=t.status.weak??0;re(e,50,"ENEMY_ATTACK","영혼 강탈자",a),f(e,"영혼 강탈자: 영혼 폭발 → 50 피해!"),t.soulWillNukeThisTurn=!1,t.soulArmed=!1,t.soulWarnCount=0;continue}for(const a of r.acts)vt(e,t,a);t.intentIndex===Bn&&(t.soulWarnCount=(t.soulWarnCount??0)+1,f(e,`영혼 강탈자: 경고 +1 (${t.soulWarnCount}/3)`),(t.soulWarnCount??0)>=3&&(t.soulArmed=!0,f(e,"영혼 강탈자: 경고 3회 완료 → 폭발 가능 상태!")));continue}for(const a of r.acts)vt(e,t,a)}e.phase="UPKEEP"}}function vt(e,t,n){switch(n.op){case"damagePlayer":{const r=t.status.weak??0;re(e,n.n,"ENEMY_ATTACK",t.name,r);return}case"damagePlayerFormula":{if(n.kind==="goblin_raider"){const r=Math.max(0,12-e.usedThisTurn),a=t.status.weak??0;re(e,r,"ENEMY_ATTACK",t.name,a)}else{const r=4+e.usedThisTurn,a=t.status.weak??0;re(e,r,"ENEMY_ATTACK",t.name,a)}return}case"supplies":{e.player.supplies=pt(e.player.supplies+n.n,0),f(e,`적 효과: 보급 S ${n.n>=0?"+":""}${n.n} (현재 ${e.player.supplies})`);return}case"statusPlayer":{Oe(e.player,n.key,n.n),f(e,`적 효과: 플레이어 상태 ${n.key} ${n.n>=0?"+":""}${n.n}`);return}case"enemyHealSelf":{t.hp=Math.min(t.maxHp,t.hp+n.n),f(e,`적(${t.name})이(가) ${n.n} 회복 (HP ${t.hp}/${t.maxHp})`);return}case"enemyImmuneThisTurn":{t.immuneThisTurn=!0,f(e,`적(${t.name})이(가) 피해 면역 상태가 됨`);return}case"enemyImmuneNextTurn":{t.immuneNextTurn=!0,f(e,`적(${t.name})이(가) 다음 턴 피해 면역 상태가 됨`);return}case"fatiguePlayer":{e.player.fatigue=Math.max(0,e.player.fatigue+n.n),f(e,`적 효과: 피로 F ${n.n>=0?"+":""}${n.n} (현재 ${e.player.fatigue})`);return}case"damagePlayerByDeckSize":{const r=e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length,a=Math.ceil(r/n.div);let o=n.base+n.per*a;n.cap!=null&&(o=Math.min(o,n.cap)),re(e,o,"ENEMY_ATTACK",t.name),f(e,`중력 피해: base ${n.base} + per ${n.per} * ceil(${r}/${n.div})=${a} => ${o}`);return}default:return n}}function Dn(e){if(e.phase!=="UPKEEP")return;f(e,"=== 유지비 / 상태 처리 ===");const t=e.frontPlacedThisTurn;t>0&&f(e,`전열 유지비 처리: 전열 ${t}장`);let n=!1;for(let a=0;a<t;a++)e.player.supplies>0?e.player.supplies-=1:n=!0;if(n&&(e.player.fatigue+=1,f(e,"전열 유지비 부족! (F +1)")),e.player.supplies===0){e.player.zeroSupplyTurns+=1;const a=e.player.fatigue;re(e,a,"ZERO_SUPPLY",`보급 없이 턴 종료! 피해 ${a}`)}const r=e.player.status.bleed??0;r>0&&re(e,r,"BLEED","출혈");for(const a of q(e)){const o=a.status.bleed??0;o>0&&(a.immuneThisTurn?f(e,`적(${a.name})은(는) 이번 턴 면역이라 출혈 피해 무시`):(a.hp=Math.max(0,a.hp-o),e.enemies.indexOf(a),f(e,`적(${a.name}) 출혈로 HP -${o} (HP ${a.hp}/${a.maxHp})`)))}e.frontPlacedThisTurn=0,Ln(e),In(e),ke(e),pe(e),e.phase="DRAW"}function Ln(e){const t=["vuln","weak","bleed","disrupt"];for(const n of t)e.player.status[n]>0&&(e.player.status[n]-=1);for(const n of e.enemies)for(const r of t)n.status[r]>0&&(n.status[r]-=1)}function Fn(e){if(e.phase!=="DRAW"||(e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null,pe(e),e.run.finished))return;if(q(e).length===0){Ze(e),e.phase="NODE";return}const t=e.usedThisTurn;e.usedThisTurn=0,mt(e,t),e.player.block>0&&(e.player.block=0,f(e,"방어(블록) 소실")),ht(e)}function mt(e,t){let n=0;for(let r=0;r<t&&(Wn(e),!e.run.finished);r++){const a=e.deck.pop();if(!a)break;e.hand.push(a),n++}return f(e,`드로우 ${n}/${t} (손패 ${e.hand.length})`),n}function Wn(e){e.deck.length===0&&e.discard.length>0&&(e.deck=ft(e.discard),e.discard=[],e.player.fatigue+=1,f(e,`피로도 F +1 (셔플, 현재 ${e.player.fatigue})`))}function D(e){return e.pendingTarget!=null||(e.pendingTargetQueue?.length??0)>0}function zn(e,t){if(!e.pendingTarget)return!1;if(q(e).length===0)return e.pendingTarget=null,e.pendingTargetQueue=[],e.selectedEnemyIndex=null,pe(e),!0;const n=e.enemies[t];if(!n||n.hp<=0)return!1;const r=e.pendingTarget;return r.kind==="damageSelect"?xe(e,n,r.amount):r.kind==="statusSelect"&&(Oe(n,r.key,r.n),f(e,`적(${n.name}) 상태: ${r.key} ${r.n>=0?"+":""}${r.n}`)),ke(e),pe(e),q(e).length===0?!0:(Un(e),!e.pendingTarget&&(e.pendingTargetQueue?.length??0)===0)}function Un(e){const t=e.pendingTargetQueue??[],n=t.shift()??null;e.pendingTarget=n,e.pendingTargetQueue=t,e.selectedEnemyIndex=null}function Ze(e){e.player.block>0&&(e.player.block=0,f(e,"방어(블록) 소실")),e.intentsRevealedThisTurn=!1,e.disruptIndexThisTurn=null}function qn(e){const t=e.run.deckSizeAtTreasure??null;return t==null?10:Ie(t)}function pe(e){if(e.player.hp<=0){Ze(e),e.run.finished=!0,f(e,"패배: 죽었습니다.");return}if(!e.victoryResolvedThisCombat&&q(e).length===0&&e.phase!=="NODE"){if(e.victoryResolvedThisCombat=!0,Ze(e),jn(e),f(e,"적을 모두 처치!"),Kn(e),e.enemies=[],e.player.zeroSupplyTurns=0,e.phase="NODE",e.run.treasureObtained){const c=qn(e);if(e.run.afterTreasureNodePicks>=c){e.run.finished=!0,f(e,`승리! 저주받은 보물을 얻은 후 ${c}번의 탐험 동안 살아남았습니다.`);return}}const[t,n]=tr(e),r=ue(e.content,t.defId,t.upgrade),a=ue(e.content,n.defId,n.upgrade),o=t.upgrade>0?`${r.name} +${t.upgrade}`:r.name,l=n.upgrade>0?`${a.name} +${n.upgrade}`:a.name;e.choice={kind:"REWARD",title:"전투 보상",prompt:"두 장 중 한 장을 선택하거나 생략합니다.",options:[{key:`pick:${t.defId}:${t.upgrade}`,label:o,detail:`전열: ${r.frontText} / 후열: ${r.backText}`},{key:`pick:${n.defId}:${n.upgrade}`,label:l,detail:`전열: ${a.frontText} / 후열: ${a.backText}`},{key:"skip",label:"생략"}]};return}}function Kn(e){const t=[];for(const o of e.deck)t.push(o);for(const o of e.hand)t.push(o);for(const o of e.discard)t.push(o);for(const o of e.frontSlots)o&&t.push(o);for(const o of e.backSlots)o&&t.push(o);for(const o of e.exhausted)t.push(o);const n=new Set,a=t.filter(o=>n.has(o)?!1:(n.add(o),!0)).filter(o=>e.cards[o]?.zone!=="vanished");e.deck=a;for(const o of a)e.cards[o].zone="deck";e.hand=[],e.discard=[],e.frontSlots=[null,null,null],e.backSlots=[null,null,null],e.selectedHandCardUid=null,e.exhausted=[],e.pendingTarget=null,e.pendingTargetQueue=[],Vn(e.deck)}function Vn(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}function jn(e){if(!e.winHooksAppliedThisCombat){e.winHooksAppliedThisCombat=!0;for(const t of e.backUidsThisTurn){if(!e.cards[t])continue;const a=Z(e,t).onWinWhileInBack;!a||a.length===0||Ce({game:e,side:"back",cardUid:t},a)}}}function Le(e){return e.deck.length+e.hand.length+e.discard.length+e.frontSlots.filter(Boolean).length+e.backSlots.filter(Boolean).length+e.exhausted.length}function Yn(e,t){t<=0||(e.player.block+=t,f(e,`방어(블록) +${t} (현재 ${e.player.block})`))}function Xn(e,t){e.player.supplies=pt(e.player.supplies+t,0),f(e,`보급 S ${t>=0?"+":""}${t} (현재 ${e.player.supplies})`)}function ae(e,t){e.player.fatigue=pt(e.player.fatigue+t,0),f(e,`피로 F ${t>=0?"+":""}${t} (현재 ${e.player.fatigue})`)}function Gn(e,t){if(t<=0)return;const n=e.player.hp;e.player.hp=Math.min(e.player.maxHp,e.player.hp+t),f(e,`HP +${e.player.hp-n} (현재 ${e.player.hp}/${e.player.maxHp})`)}function ke(e){q(e).length===0&&(e.pendingTarget=null,e.pendingTargetQueue=[],e.selectedEnemyIndex=null)}function xe(e,t,n){if(n<=0)return;const r=e.enemies.indexOf(t);if(r<0){f(e,`WARN: applyDamageToEnemy target not in g.enemies (${t?.id??"?"})`);return}if(e.attackedEnemyIndicesThisTurn.includes(r)||e.attackedEnemyIndicesThisTurn.push(r),t.immuneThisTurn){f(e,`적(${t.name})은(는) 이번 턴 피해 면역 → ${n} 피해 무시`),ke(e);return}const a=e.player.status.weak??0,o=t.status.vuln??0;let l=n-a+o;l<0&&(l=0),t.hp=Math.max(0,t.hp-l),f(e,`적(${t.name})에게 ${l} 피해. (HP ${t.hp}/${t.maxHp})`),ke(e),q(e).length===0&&(ke(e),pe(e))}function re(e,t,n,r,a){if(n==="ENEMY_ATTACK"&&e.player.nullifyDamageThisTurn)return f(e,`적 공격 피해 무효 (${r??n})`),0;if(t<=0)return 0;let o=t;if(n==="ENEMY_ATTACK"){const l=a??0,c=e.player.status.vuln??0;if(o=o-l+c,o<0&&(o=0),e.player.block>0){const p=Math.min(e.player.block,o);e.player.block-=p,o-=p}}return o<=0?0:(e.player.hp=Math.max(0,e.player.hp-o),f(e,`플레이어 ${o} 피해 (${r??n}). (HP ${e.player.hp}/${e.player.maxHp})`),o)}function Qn(e){if(e.run.treasureObtained)return;e.run.treasureObtained=!0,e.run.afterTreasureNodePicks=0,e.run.deckSizeAtTreasure=Le(e);const t=qt(e);e.cards[t]={uid:t,defId:"goal_treasure",zone:"deck",upgrade:0},e.deck.push(t),e.deck=ft(e.deck),f(e,"저주받은 보물을 획득했습니다! 덱에 [저주받은 보물] 추가")}const Jn=["arrow","shield","scout","field_ration","maintenance","power_arrow"],Zn=["arrow","shield","scout","field_ration"],Te=[{id:"mad_echo",weight:20},{id:"mad_insight",weight:12},{id:"mad_bargain",weight:3}],ye=[{id:"berserk",weight:20},{id:"bandage",weight:12},{id:"arrow_rain",weight:20},{id:"smoke",weight:0},{id:"redeploy",weight:12},{id:"secret_strike",weight:3},{id:"fire_scroll",weight:3},{id:"caltrops",weight:20},{id:"emergency_rations",weight:3},{id:"painkiller",weight:12},{id:"field_experience",weight:3},{id:"camp_prep",weight:20},{id:"vital_shot",weight:12},{id:"taunt",weight:12},{id:"rapid_fire",weight:20}];function ve(e,t,n){const r=n?zt(t,n):Wt(t);return{defId:et(r),upgrade:t===Te?0:tt(e)}}function Pe(e,t,n){const r=n?zt(t,n):Wt(t),a=et(r),o=r.filter(m=>m.id!==a),l=et(o),c=t===Te,p=c?0:tt(e),d=c?0:tt(e);return[{defId:a,upgrade:p},{defId:l,upgrade:d}]}function er(e){const{tier:t}=De(e);return Math.random()<(t===0?0:t===1?.15:t===2?.35:.6)}function Wt(e){const t=new Map;for(const n of e){const r=Math.max(0,n.weight??0);r<=0||t.set(n.id,(t.get(n.id)??0)+r)}return[...t.entries()].map(([n,r])=>({id:n,w:r}))}function zt(e,t={}){const n=t.mult3??1,r=t.mult12??1,a=t.mult20??1,o=new Map;for(const l of e){const c=Math.max(0,l.weight??0);if(c<=0||c===3&&t.drop3||c===12&&t.drop12||c===20&&t.drop20)continue;let p=null;c===3?p=c*n:c===12?p=c*r:c===20?p=c*a:p=c,!(p<=0)&&o.set(l.id,(o.get(l.id)??0)+p)}return[...o.entries()].map(([l,c])=>({id:l,w:c}))}function et(e){let t=0;for(const r of e)t+=r.w;if(t<=0)throw new Error("No positive weights to pick from.");let n=Math.random()*t;for(const r of e)if(n-=r.w,n<=0)return r.id;return e[e.length-1].id}function tt(e){const t=e?.player?.fatigue??0;if((e?.run.nodePickCount??999)<=6)return 0;const r=.1,a=t>=12?0:t>=9?.25:t>=6?.5:1;return Math.random()<r*a?1:0}function Ut(e){const t=e.player?.fatigue??0,n={defId:F(Zn),upgrade:0};F(Jn);const r=()=>t<=3?Pe(e,ye):t<=6?Pe(e,ye,{mult3:.25,mult12:.75,mult20:1}):t<=8?Pe(e,ye,{mult3:.1,mult12:.55,mult20:1}):Pe(e,ye,{drop3:!0,mult12:.45,mult20:1}),a=c=>er(e)?ve(e,Te):c;if(t<=8){if(t<=6){const[m,h]=r();return[a(m),a(h)]}const c=t===7?.3:.55;if(Math.random()<c){const[m]=r(),h=a(m);return Math.random()<.5?[n,h]:[h,n]}const[p,d]=r();return[a(p),a(d)]}if(t<=11){const c=a(ve(e,ye,{drop3:!0,mult12:.45,mult20:1}));return Math.random()<.5?[n,c]:[c,n]}const o=ve(e,Te),l=Math.random()<.65?ve(e,Te):n;return Math.random()<.5?[o,l]:[l,o]}function tr(e){const t=Ut(e),n=t[0]??{defId:"arrow",upgrade:0},r=t[1]??{defId:"shield",upgrade:0};return[n,r]}function qt(e){return e.uidSeq+=1,`c_${e.uidSeq}`}function Ae(e,t,n){const r=qt(e);e.cards[r]={uid:r,defId:t,zone:"deck",upgrade:n?.upgrade??0},e.deck.push(r)}function nr(e){const t=Object.values(e.cards).filter(r=>r.zone==="deck"||r.zone==="hand"||r.zone==="discard");if(t.length===0)return;const n=F(t);e.cards[n.uid].zone="vanished",e.vanished.push(n.uid),e.deck=e.deck.filter(r=>r!==n.uid),e.hand=e.hand.filter(r=>r!==n.uid),e.discard=e.discard.filter(r=>r!==n.uid),f(e,`카드 제거: [${Z(e,n.uid).name} +${e.cards[n.uid].upgrade??0}]`)}const rr="goal_treasure";function Kt(e,t){const n=e.cards[t];if(n){if(n.defId===rr){f(e,"저주받은 보물은 덱에서 제거할 수 없습니다.");return}e.deck=e.deck.filter(r=>r!==t),e.hand=e.hand.filter(r=>r!==t),e.discard=e.discard.filter(r=>r!==t),e.frontSlots=e.frontSlots.map(r=>r===t?null:r),e.backSlots=e.backSlots.map(r=>r===t?null:r),n.zone="vanished",e.vanished.push(t),f(e,`카드 제거: [${Z(e,n.uid).name} +${e.cards[n.uid].upgrade??0}]`)}}function Vt(e,t){const n=e.cards[t];if(!n)return!1;const a=e.content.cardsById[n.defId].upgrades?.length??0;return(n.upgrade??0)<a}function ar(e,t){return Vt(e,t)?(e.cards[t].upgrade=(e.cards[t].upgrade??0)+1,!0):!1}function or(){return nt[Math.floor(Math.random()*nt.length)]}function Pt(e){const{tier:t}=De(e),n=t===0?0:t===1?.25:t===2?.55:.85;return Math.random()<n?sr():or()}const jt={boss_cursed_wall:"움직이지 않는다. 당신이 닳아간다.",boss_giant_orc:"거대한 무언가가 기다린다.",boss_soul_stealer:"행동하지 않으면 종말이 온다.",boss_gravity_master:"몸이 점점 무겁다. 몸을 가볍게 하라."},$t=[{id:"mad_mirror",name:"거울에 잠긴 물",prompt:"물 속의 당신이 먼저 웃습니다.",art:"assets/events/event_mad_mirror.png",options:e=>[{key:"mad_mirror:take",label:"손을 넣는다",detail:"카드 보상. F +2.",apply:t=>(ae(t,2),f(t,"거울: 무언가를 건져 올렸다. (F +2)"),"REWARD")},{key:"mad_mirror:leave",label:"외면한다",apply:t=>(f(t,"거울: 당신은 물러났다."),"NONE")}]},{id:"mad_contract",name:"젖은 계약서",prompt:"곰팡이 냄새가 납니다.",art:"assets/events/event_mad_contract.png",options:e=>[{key:"mad_contract:sign",label:"서명한다",detail:"최대 HP +2. 카드 1장 제거 후 보상.",apply:t=>(t.player.maxHp+=2,t.player.hp=Math.min(t.player.maxHp,t.player.hp+2),f(t,"계약: 최대 HP +2"),{kind:"REMOVE_PICK",title:"대가",prompt:"제거할 카드 1장을 선택하세요.",then:"REWARD"})},{key:"mad_contract:burn",label:"찢어버린다",detail:"F +1",apply:t=>(ae(t,1),f(t,"불길함: F +1"),"NONE")}]},{id:"mad_lullaby",name:"자장가",prompt:"잠들면 회복하지만, 깨어나면 잊습니다.",art:"assets/events/event_mad_lullaby.png",options:e=>[{key:"mad_lullaby:sleep",label:"잠든다",detail:"HP +12. 덱에서 무작위 1장 소실.",apply:t=>(t.player.hp=Math.min(t.player.maxHp,t.player.hp+12),nr(t),f(t,"자장가: HP 회복, 그러나 잊었다… (무작위 1장 소실)"),"NONE")},{key:"mad_lullaby:stay",label:"버틴다",detail:"F -1",apply:t=>(ae(t,-1),f(t,"버팀: F -1"),"NONE")}]}];function sr(e){return $t[Math.floor(Math.random()*$t.length)]}const nt=[{id:"drop_bag",name:"짐 버리기",prompt:"짐을 줄여 피로를 낮추자.",art:"assets/events/event_drop_bag.png",options:()=>[{key:"drop",label:"카드 1장 제거, F -1",apply:e=>(ae(e,-1),f(e,"이벤트: 짐 버리기 → 제거할 카드를 선택하세요."),{kind:"REMOVE_PICK",title:"짐 버리기",prompt:"제거할 카드 1장을 선택하세요.",then:"NONE"})},{key:"skip",label:"아무것도 하지 않는다",apply:e=>(f(e,"이벤트: 짐 버리기(생략)"),"NONE")}]},{id:"hide_from_monster",name:"몬스터로부터 숨기",prompt:"전투하거나, 대가를 치르고 숨을 수 있다.",art:"assets/events/event_hide_from_monster.png",options:()=>[{key:"fight",label:"전투",apply:e=>(f(e,"이벤트: 몬스터로부터 숨기 → 전투 선택"),"BATTLE")},{key:"remove_and_fatigue",label:"카드 1장 제거 후 F +1",apply:e=>(ae(e,1),f(e,"이벤트: 몬스터로부터 숨기 → 카드 제거 후 F+1"),{kind:"REMOVE_PICK",title:"숨기",prompt:"제거할 카드 1장을 선택하세요.",then:"NONE"})}]},{id:"goblin_ambush_low_supplies",name:"매복한 약탈자들",prompt:`고블린들이 보급을 약탈했다.
이번 전투는 보급(S) 5로 시작합니다.`,art:"assets/events/event_goblin_ambush_low_supplies.png",options:()=>[{key:"fight",label:"맞서 싸운다",detail:"고블린 약탈자 2마리 전투 (S=5 시작)",apply:e=>(e.run.nextBattleSuppliesBonus=-5,{kind:"BATTLE_SPECIAL",title:"고블린 매복",enemyIds:["goblin_raider","goblin_raider"]})}]},{id:"find_adventurer",name:"다른 모험가 발견",prompt:"거래한다.",art:"assets/events/event_find_adventurer.png",options:e=>e.run.treasureObtained?[{key:"adventurer:forced_battle",label:"대치한다",detail:"보물을 노리고 덤벼든다.",apply:t=>({kind:"BATTLE_SPECIAL",enemyIds:["other_adventurer"],title:"보물을 노리는 모험가"})}]:[{key:"trade",label:"카드 1장 제거 후 카드 보상(2장 중 1장)",apply:t=>(f(t,"이벤트: 다른 모험가 발견 → 제거할 카드 선택 후 보상"),{kind:"REMOVE_PICK",title:"다른 모험가 발견",prompt:"제거할 카드 1장을 선택하세요.",then:"REWARD"})},{key:"leave",label:"지나친다",apply:t=>(f(t,"이벤트: 다른 모험가 발견(생략)"),"NONE")}]},{id:"edible_mushroom",name:"식용 버섯 발견",prompt:"기운이 난다. 다음 전투의 시작 보급이 늘어난다.",art:"assets/events/event_edible_mushroom.png",options:()=>[{key:"eat",label:"F -2, 다음 전투 시작 S +5",apply:e=>(e.player.fatigue=Math.max(0,e.player.fatigue-2),e.run.nextBattleSuppliesBonus+=5,f(e,"식용 버섯: F -2, 다음 전투 시작 S +5"),"NONE")}]},{id:"ominous_prophecy",name:"불길한 예언",prompt:"불길한 속삭임이 귓가를 맴돈다. 대가를 치르고 미래를 엿볼까?",art:"assets/events/event_ominous_prophecy.png",options:e=>[{key:"omen:listen",label:"예언을 듣는다",detail:"F +1. 다음 보스를 확정하고 공개합니다.",apply:t=>{if(ae(t,1),f(t,"불길한 예언: F +1"),t.run.nextBossId||(t.run.bossPool.length>0?t.run.nextBossId=F(t.run.bossPool):t.run.nextBossId=null),!t.run.nextBossId)return f(t,"예언: 미래가 흐릿하다. (보스가 남아있지 않음)"),"NONE";t.content.enemiesById[t.run.nextBossId];const n=jt[t.run.nextBossId]??"정체불명의 위협이 다가온다.";return t.run.bossOmenText=`${n}`,f(t,`예언: ${n}`),"NONE"}},{key:"omen:ignore",label:"무시한다",detail:"아무 일도 일어나지 않습니다.",apply:t=>(f(t,"불길한 예언(무시)"),"NONE")}]}];function ir(e){return nt.find(t=>t.id===e)??null}function lr(){return{cardsById:kn,enemiesById:gn}}let ce=!1,Yt=null,le=[],be=[],ee=-1;function He(e,t){le.push({t:Date.now(),kind:e,text:t}),le.length>300&&(le=le.slice(-300))}function dr(e){Yt=e}function cr(){return ce}function ur(e){ce=!ce,de()}function de(){if(document.querySelector(".devConsole")?.remove(),!ce)return;const e=document.createElement("div");e.className="devConsole",e.style.cssText=`
    position: fixed; inset: 0;
    z-index: 60000;
    pointer-events: auto;
    background: rgba(0,0,0,.35);
    backdrop-filter: blur(4px);
    display:flex; align-items:flex-end; justify-content:center;
    padding: 12px;
    box-sizing: border-box;
  `;const t=document.createElement("div");t.style.cssText=`
    width: min(980px, 100%);
    height: min(420px, 70vh);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(10,12,14,.92);
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    display:flex;
    flex-direction: column;
    overflow:hidden;
  `;const n=document.createElement("div");n.style.cssText=`
    padding: 10px 12px;
    display:flex; align-items:center; justify-content:space-between;
    border-bottom: 1px solid rgba(255,255,255,.10);
  `;const r=document.createElement("div");r.textContent="Dev Console",r.style.cssText="font-weight:800; color:#fff; opacity:.95;";const a=document.createElement("div");a.style.cssText="display:flex; gap:8px;";const o=(h,u)=>{const k=document.createElement("button");return k.type="button",k.textContent=h,k.style.cssText=`
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #fff;
      cursor: pointer;
      font-weight: 700;
    `,k.onclick=u,k};a.appendChild(o("Clear",()=>{le=[],de()})),a.appendChild(o("Close",()=>{ce=!1,de()})),n.appendChild(r),n.appendChild(a);const l=document.createElement("div");l.className="devConsoleOut",l.style.cssText=`
    flex: 1 1 auto;
    padding: 10px 12px;
    overflow: auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 12px;
    line-height: 1.4;
    color: #ddd;
    white-space: pre-wrap;
  `;const c=h=>(h.kind==="in"?"> ":h.kind==="err"?"! ":"  ")+h.text;l.textContent=le.map(c).join(`
`),queueMicrotask(()=>{l.scrollTop=l.scrollHeight});const p=document.createElement("div");p.style.cssText=`
    border-top: 1px solid rgba(255,255,255,.10);
    padding: 10px 12px;
    display:flex; gap:10px; align-items:center;
  `;const d=document.createElement("div");d.textContent=">",d.style.cssText="color:#fff; font-weight:900; opacity:.9;";const m=document.createElement("input");m.type="text",m.placeholder="help / state / newrun ...",m.style.cssText=`
    flex: 1 1 auto;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: #fff;
    outline: none;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 13px;
  `,m.onkeydown=h=>{if(h.key==="Escape"){ce=!1,de();return}if(h.key==="Enter"){const u=m.value.trim();if(!u)return;m.value="",be.unshift(u),ee=-1,He("in",u);try{pr(u)}catch(k){He("err",String(k?.message??k))}de();return}if(h.key==="ArrowUp"){h.preventDefault();const u=be.length;if(u===0)return;ee=Math.min(u-1,ee+1),m.value=be[ee]??"";return}if(h.key==="ArrowDown"){if(h.preventDefault(),be.length===0)return;ee=Math.max(-1,ee-1),m.value=ee>=0?be[ee]??"":"";return}},p.appendChild(d),p.appendChild(m),t.appendChild(n),t.appendChild(l),t.appendChild(p),t.onclick=h=>h.stopPropagation(),e.appendChild(t),document.body.appendChild(e),queueMicrotask(()=>m.focus())}function pr(e){const t=Yt;if(!t){He("err","Dev console context not set");return}const n=t.getG(),r=e.split(/\s+/).filter(Boolean),a=(r[0]??"").toLowerCase(),o=r[1],l=r[2],c=d=>He("out",d);if(a==="help"){c(["help","state","newrun","hp <n> | maxhp <n> | supplies <n> | fatigue <n>","phase <PLACE|BACK|FRONT|ENEMY|UPKEEP|DRAW|NODE>","addcard <defId> [upgrade=0] [zone=deck|hand|discard]","removecard <uid>","win | lose","log <text...>"].join(`
`));return}if(a==="state"){c(JSON.stringify({phase:n.phase,hp:`${n.player.hp}/${n.player.maxHp}`,supplies:n.player.supplies,fatigue:n.player.fatigue,deck:n.deck.length,hand:n.hand.length,discard:n.discard.length,enemies:n.enemies.map(d=>({id:d.id,hp:`${d.hp}/${d.maxHp}`,intent:d.intentIndex}))},null,2));return}if(a==="newrun"){t.actions.onNewRun(),c("OK: newrun");return}const p=(d,m)=>{const h=Number(o);if(!Number.isFinite(h)){c(`ERR: ${d} requires number`);return}m(h),t.rerender(),c(`OK: ${d} = ${h}`)};if(a==="hp")return p("hp",d=>n.player.hp=Math.max(0,Math.min(n.player.maxHp,d)));if(a==="maxhp")return p("maxHp",d=>{n.player.maxHp=Math.max(1,d),n.player.hp=Math.min(n.player.hp,n.player.maxHp)});if(a==="supplies")return p("supplies",d=>n.player.supplies=Math.max(0,d));if(a==="fatigue")return p("fatigue",d=>n.player.fatigue=Math.max(0,d));if(a==="phase"){const d=(o??"").toUpperCase();if(!new Set(["PLACE","BACK","FRONT","ENEMY","UPKEEP","DRAW","NODE"]).has(d)){c("ERR: phase invalid");return}n.phase=d,t.rerender(),c(`OK: phase=${d}`);return}if(a==="log"){const d=e.slice(e.indexOf(" ")+1);if(!d||d===e){c("ERR: log <text...>");return}t.log?.(`[DEV] ${d}`),c("OK: logged");return}if(a==="addcard"){const d=o;if(!d){c("ERR: addcard <defId> [upgrade=0] [zone=deck|hand|discard]");return}const m=Math.max(0,Number(l??"0")||0),h=r[3]??"deck";Ae(n,d,{upgrade:m});const u=n.deck[n.deck.length-1];u&&h!=="deck"&&(n.deck=n.deck.filter(k=>k!==u),h==="hand"?n.hand.push(u):h==="discard"&&n.discard.push(u),n.cards[u].zone=h),t.log?.(`[DEV] addcard ${d} +${m} (${h}) uid=${u}`),t.rerender(),c(`OK: addcard uid=${u}`);return}if(a==="removecard"){const d=o;if(!d){c("ERR: removecard <uid>");return}if(!n.cards[d]){c(`ERR: uid not found: ${d}`);return}Kt(n,d),t.log?.(`[DEV] removecard ${d}`),t.rerender(),c("OK: removecard");return}if(a==="win"){if(!n.enemies||n.enemies.length===0){c("WARN: enemies=0");return}for(const d of n.enemies)d.hp=0;n.enemies=[],n.pendingTarget=null,n.pendingTargetQueue=[],n.selectedEnemyIndex=null,pe(n),t.log?.("[DEV] win"),t.rerender(),c("OK: win");return}if(a==="lose"){n.run.finished=!0,t.log?.("[DEV] lose"),t.rerender(),c("OK: lose");return}c(`Unknown command: ${a} (try: help)`)}const Fe="deck-rogue-save-v1",Xt=1;function fr(e){try{return JSON.parse(e)}catch{return null}}function hr(){return!!localStorage.getItem(Fe)}function mr(){localStorage.removeItem(Fe)}function yr(e,t){const n={ver:Xt,savedAt:Date.now(),build:t?.build,state:e};localStorage.setItem(Fe,JSON.stringify(n))}function br(){const e=localStorage.getItem(Fe);if(!e)return null;const t=fr(e);return!t||t.ver!==Xt||!t.state?null:{state:t.state,savedAt:t.savedAt}}const xr=`# Deck Rogue Prototype — 룰북 (플레이어용)

이 문서는 스포일러를 최소화합니다.

[1] 개요
노드를 선택하며 진행하고, 전투에서 살아남아 성장합니다. 목표는 무엇일까요?
모든 카드는 전열과 후열이 있습니다. 배치에 따라 역할이 달라집니다.

[2] 보급과 피로도

보급(S): 전열 카드 및 일부 효과의 발동에 사용됩니다. 보통 7로 시작합니다.
보급이 부족한 상태로 턴 종료 시 피로도만큼 피해를 받습니다.

피로도(F): 덱을 섞거나 전열 카드의 보급이 부족한 채로 턴을 마칠 때 피로도가 1 올라가며, 일부 카드의 효과로도 변합니다.
피로도는 전투가 끝나도 유지됩니다. 너무 쌓인 피로는 때때로 당신을 변하게 합니다.

[3] 전투 흐름
배치 → 후열 발동 → 전열 발동 → 적 행동 → 정리 → 드로우
※ “대상 선택 필요”가 뜨면 살아있는 적을 클릭해 대상을 정하세요.
※ 후열 발동을 누르면 턴이 진행되어, 카드의 배치를 변경할 수 없습니다.
보급 및 그에 따른 변화는 정리 단계에서 처리합니다.

손패는 턴이 종료되어도 유지됩니다.
카드는 매 턴마다 사용한 만큼 뽑습니다. 즉, 카드로 인한 드로우는 패의 매수 자체를 늘리는 효과가 있습니다.

[4] 용어
- 소모: 이번 전투에서 사용할 수 없게 되는 것입니다.
- 소실: 런 전체에서 해당 카드가 사라지는 것입니다.
- 취약: 받는 피해가 (취약)만큼 증가합니다.
- 약화: 주는 피해가 (약화)만큼 감소합니다.
- 출혈: 턴 종료 시 (출혈)만큼 피해를 입습니다.
- 교란: 당신을 방해합니다. 무엇일까요?

[5] 조작

(컴퓨터)
- 4: 선택 해제
- Tab: 손패 선택 이동
- 1~3: 전열 배치 / q,w,e: 후열 배치
- 드래그: 손패→슬롯 배치, 슬롯↔슬롯 스왑, 슬롯→손패 회수
- Space: 다음 턴
- F: 새로운 런

(모바일)
- 손패: 클릭 시 선택, 길게 누를 시 확대
- 카드 선택 상태에서 슬롯을 눌러 배치
- 슬롯: 클릭 시 확대, 길게 누를 시 회수
- 슬롯에 넣은 카드는 이름만 보입니다.

[6] 당신을 위한 조언

덱은 당신의 비품입니다. 비품이 적으면, 늘 새로 꾸리느라 힘들 겁니다. 비품이 많으면, 들고 다니기 힘들겠지요. 균형을 찾으세요.

[7] 시간

시간은 금입니다. 모든 행동은 시간을 소모합니다. 싸움은 좀 더 소모할지도 모르겠군요.
중요한 건 이곳이 당신에게 넉넉한 시간을 주지 않는다는 것이겠지요.
`;function kr(e){return new Promise(t=>window.setTimeout(t,e))}function Tr(e){switch(e){case"BACK":return 400;case"FRONT":return 400;case"ENEMY":return 400;case"UPKEEP":return 400;case"DRAW":return 400;case"PLACE":return 0;default:return 220}}let je=!1;function gr(e){je||(je=!0,requestAnimationFrame(()=>{je=!1,yt(),xt(),bt()}))}let Sr=1,Ee=[],Gt=null;function we(e,t,n,r){Ee.push({id:Sr++,kind:e,text:t,x:n,y:r,born:performance.now()})}function Cr(){const e=performance.now();Ee=Ee.filter(t=>e-t.born<700)}let $e=null,_e=null,Ye=[];function Er(e){if(!(!e.run.finished&&e.enemies.length>0&&e.phase!=="NODE")){$e=null,_e=null,Ye=[];return}if($e!=null){const n=e.player.hp-$e;n!==0&&wr(n)}if(_e!=null){const n=e.player.block-_e;n!==0&&vr(n)}for(let n=0;n<e.enemies.length;n++){const r=e.enemies[n].hp,a=Ye[n];a!=null&&r!==a&&Pr(n,r-a)}$e=e.player.hp,_e=e.player.block,Ye=e.enemies.map(n=>n.hp)}function wr(e){const t=document.querySelector(".playerHudBox")??document.querySelector(".playerHudLeft");if(!t)return;const n=t.getBoundingClientRect(),r=(n.left+n.right)/2,a=n.top+14;e<0?we("dmg",`${e}`,r,a):we("heal",`+${e}`,r,a),t.classList.add("fxFlash"),setTimeout(()=>t.classList.remove("fxFlash"),240)}function vr(e){const t=document.querySelector(".playerHudBox")??document.querySelector(".playerHudLeft");if(!t)return;const n=t.getBoundingClientRect(),r=(n.left+n.right)/2,a=n.top+34;we("block",e>0?`+${e}`:`${e}`,r,a)}function Pr(e,t){const r=Array.from(document.querySelectorAll(".enemyHudCenter .enemyBanner"))[e];if(!r)return;const a=r.getBoundingClientRect(),o=(a.left+a.right)/2,l=a.top+14;t<0?we("dmg",`${t}`,o,l):we("heal",`+${t}`,o,l),r.classList.add("fxFlash"),setTimeout(()=>r.classList.remove("fxFlash"),240)}let G=1;function $r(){try{const e=localStorage.getItem("deckrogue_uiScale");if(!e)return;const t=Number(e);Number.isFinite(t)&&(G=Math.min(1.25,Math.max(.75,t)))}catch{}}function _r(){try{localStorage.setItem("deckrogue_uiScale",String(G))}catch{}}function Qt(){document.documentElement.style.setProperty("--uiScale",String(G))}const Nr="deckrogue_uiSettings_v1";function _t(e,t,n){return Math.max(t,Math.min(n,e))}function Br(){try{const e=localStorage.getItem(Nr);if(!e)return{uiScaleDesktop:1,uiScaleMobile:1};const t=JSON.parse(e);return{uiScaleDesktop:_t(Number(t.uiScaleDesktop??1)||1,.75,1.5),uiScaleMobile:_t(Number(t.uiScaleMobile??1)||1,.75,1.5)}}catch{return{uiScaleDesktop:1,uiScaleMobile:1}}}let Ne=Br();function Ar(){return window.matchMedia("(max-width: 900px) and (pointer: coarse)").matches}let ne=!1;function Or(){try{const e=localStorage.getItem("deckrogue_logCollapsed");if(e==null)return;ne=e==="1"}catch{}}function Ir(){try{localStorage.setItem("deckrogue_logCollapsed",ne?"1":"0")}catch{}}let Be=null;function Hr(e){Be!=null&&window.clearTimeout(Be),Be=window.setTimeout(()=>{Be=null,yr(e)},250)}let Xe=!1;async function Rr(e,t){if(!Xe){Xe=!0;try{if(e.run.finished||e.choice||D(e)||B||e.phase==="NODE")return;let n=0;for(;n++<60&&!(e.run.finished||e.choice||B||D(e));){const r=nn(e,t,!1);if(!r.fn||r.disabled)break;const a=e.phase;if(r.fn(),T(e,t),a==="DRAW"&&e.phase==="PLACE"||e.phase==="PLACE")break;const o=Tr(a);o>0&&await kr(o)}}finally{Xe=!1}}}function rt(e){const t=e.run;t.nextBossTime==null&&(t.nextBossTime=40),t.forcedNext==null&&(t.forcedNext=null)}function at(e){return(e.run.nodePickCount??0)+(e.time??0)}function Nt(e){const a=Math.max(0,e-20),o=Math.min(85,Math.floor(a*a/3));return{extra:Math.random()*100<o?1:0,pPct:o}}function Mr(e,t){const n=e;return n.content=t,n.time??=0,n.run??={},n.run.nextBossTime??=40,n.run.forcedNext??=null,n.run.bossOmenText??=null,n.run.enemyLastSeenBattle??={},n.run.nodePickByType??={BATTLE:0,REST:0,EVENT:0,TREASURE:0},n.run.bossPool??=["boss_gravity_master","boss_cursed_wall","boss_giant_orc","boss_soul_stealer"],n.run.nextBossId??=null,n.run.afterTreasureNodePicks??=0,n.run.deckSizeAtTreasure??=null,n.run.treasureObtained&&n.run.deckSizeAtTreasure==null&&(n.run.deckSizeAtTreasure=Le(n)),n.choiceStack??=[],n.pendingTargetQueue??=[],n.exhausted??=[],n.vanished??=[],n}function Dr(e){if(!hr())return Qe(e);const t=br();return t?Mr(t.state,e):Qe(e)}function Lr(){if(document.querySelector(".bgLayer"))return;const e=document.createElement("div");e.className="bgLayer",document.body.appendChild(e)}let Bt=0,At=0,te=null,B=null,Ot=!1,C=null,Q=null,ot=!1;function Fr(e,t,n){const r=e.cards[t];return Jt(e,r.defId,n)}function Re(e,t,n){const a=We(e,t,!!n,n,{draggable:!1});return a.classList.add("overlayCard"),a}function Jt(e,t,n){const r=`__preview:${t}:${n}:${Math.random().toString(36).slice(2)}`,a=e.cards[r];e.cards[r]={uid:r,defId:t,upgrade:n,zone:"preview"};const o=We(e,r,!1,void 0,{draggable:!1});return o.classList.add("overlayCard"),o.draggable=!1,o.style.pointerEvents="none",a?e.cards[r]=a:delete e.cards[r],o}function Zt(e,t){return e==="BATTLE"?"⚔️(전투)":e==="REST"?"⛺(휴식)":e==="EVENT"?"❔(미지)":"🌑(보물)"}function Wr(e,t){return e.map(n=>Zt(n.type)).join(" / ")}function zr(e,t,n){const r=[`[탐험 ${t.run.nodePickCount}회]`];if(t.run.treasureObtained){const E=t.run.deckSizeAtTreasure??Le(t),I=Ie(E);r.push(`[탈출까지 ${t.run.afterTreasureNodePicks}/${I}]`)}e.appendChild(kt(r.join(" "))),rt(t),(!t.run.bossOmenText||String(t.run.bossOmenText).trim()==="")&&(t.run.bossOmenText="아직 징조가 없다.");const a=t.run,o=at(t),l=a.nextBossTime??40,c=n.getNodeOffers(),p=a.nodeExtra01??0,d=o+1+p,m=a.forcedNext==="BOSS",h=!m&&d>=l,u=!m&&!h&&(c[0]?.type==="BATTLE"||c[1]?.type==="BATTLE"),k=d+1,S=m?d+1:u?k:d,i=Math.max(0,l-o);if(S>=l&&a.forcedNext!=="BOSS"){const E=U("bossIncomingBanner","보스가 온다.");E.style.cssText="margin-top:10px; padding:10px 12px; border-radius:14px;border:1px solid rgba(255,255,255,1);background: rgba(255,120,60,1);font-weight:700; font-size:13px; line-height:1.25;",e.appendChild(E)}const{tier:y}=De(t),g=y===0?"":y===1?Math.random()<.1?" . . . 들린다.":"":y===2?Math.random()<.1?" . . . 보인다.":"":Math.random()<.1?" . . . 닿았다.":"",x=` . . . ${t.run.bossOmenText}${g}`,w=U("bossOmenBanner",`다음 보스까지 남은 시간: ${i}${x}`);w.style.cssText="margin-top:8px; padding:10px 12px; border-radius:14px;border:1px solid rgba(255, 255, 255, 1);background:rgba(0, 0, 0, 1);font-weight:600;font-size:13px;line-height:1.2;",w.style.color="white",e.appendChild(w);const v=t.run.branchOffer;if(v){const E=b("nodePreviewBox");E.style.cssText="margin-top:10px; padding:12px; border:1px solid rgba(255,255,255,1); border-radius:16px; background:rgba(0,0,0,1);";const I=a.forcedNext==="BOSS",_=$=>{const P=b("nodePreviewRow");P.style.cssText="display:flex; gap:10px; align-items:center; padding:10px; border-radius:14px; cursor:pointer;",P.onmouseenter=()=>P.style.background="rgba(255,255,255,.06)",P.onmouseleave=()=>P.style.background="transparent",P.onclick=()=>n.onChooseNode($);const K=I?"💀(보스)":Zt(c[$==="A"?0:1]?.type??"BATTLE"),N=document.createElement("div");N.className="nodePill primary",N.textContent=K,N.onclick=V=>{V.stopPropagation(),n.onChooseNode($)},P.appendChild(N),P.appendChild(U("","→"));const L=$==="A"?v.nextIfA:v.nextIfB,H=U("",Wr(L));return H.style.cssText="opacity:.85;",P.appendChild(H),P};E.appendChild(_("A")),E.appendChild(_("B")),e.appendChild(E),e.appendChild(Ur())}}function Ur(){return document.createElement("hr")}function en(e,t){let n=null,r=!1,a=!1;const o=[];function l(i){o.length=0,i.choice=null,n=null,document.querySelector(".choice-overlay")?.remove()}function c(i){o.push({choice:i.choice,handler:n})}function p(i){const s=o.pop();if(!s){d(i);return}i.choice=s.choice,n=s.handler}function d(i){if(o.length>0){p(i);return}i.choice=null,n=null,document.querySelector(".choice-overlay")?.remove()}function m(i,s,y){i.choice&&c(i),i.choice=s,n=y}const h=()=>te||e,u={onHotkeySlot:(i,s)=>{const y=h();if(y.run.finished||D(y)||y.phase!=="PLACE"||i==="back"&&y.backSlotDisabled?.[s])return;const g=i==="front"?y.frontSlots:y.backSlots,x=g[s];if(!y.selectedHandCardUid){if(!x)return;u.onReturnSlotToHand(i,s);return}const w=y.selectedHandCardUid;if(!x){u.onPlaceHandUidToSlot(w,i,s);return}g[s]=null,y.usedThisTurn=Math.max(0,y.usedThisTurn-1),i==="front"&&(y.frontPlacedThisTurn=Math.max(0,y.frontPlacedThisTurn-1)),y.hand.push(x),y.cards[x].zone="hand",Ct(y,w,i,s),y.selectedHandCardUid=null,f(y,`[${j(y,w)}] ↔ [${j(y,x)}] 스왑: 손패 ↔ ${i}${s+1}`),T(y,u)},rerender:()=>{const i=h();T(i,u)},onToggleLogOverlay:()=>{ot=!ot,T(h(),u)},onCloseOverlay:()=>{const i=h();B=null,T(i,u)},onNewRun:()=>{const i=h();Q=null,B=null,C=null,d(i),mr(),t(Qe(i.content))},onViewRulebook:()=>{const i=h();B={kind:"RULEBOOK"},T(i,u)},onViewPile:i=>{const s=h();B={kind:"PILE",pile:i},T(s,u)},onViewSettings:()=>{const i=h();B={kind:"SETTINGS"},T(i,u)},onReturnSlotToHand:(i,s)=>{const y=h();if(y.run.finished||D(y)||y.phase!=="PLACE")return;const g=i==="front"?y.frontSlots:y.backSlots,x=g[s];x&&(g[s]=null,y.usedThisTurn=Math.max(0,y.usedThisTurn-1),i==="front"&&(y.frontPlacedThisTurn=Math.max(0,y.frontPlacedThisTurn-1)),y.hand.push(x),y.cards[x].zone="hand",f(y,`[${j(y,x)}] 회수: ${i}${s+1} → 손패`),T(y,u))},onClearSelected:()=>{const i=h();i.selectedHandCardUid=null,T(i,u)},onSelectEnemy:i=>{const s=h();if(a)return;a=!0,requestAnimationFrame(()=>{a=!1});const y=zn(s,i);T(s,u),y&&!s.choice&&!s.run.finished&&u.onAutoAdvance()},onSelectHandCard:i=>{const s=h();D(s)||(s.selectedHandCardUid=s.selectedHandCardUid===i?null:i,T(s,u))},getNodeOffers:()=>{const i=h();rt(i),i.run.branchOffer||(i.run.branchOffer=Se(i));const s=i.run,y=at(i);return s.forcedNext==="BOSS"?(s.nodeExtra01=0,[{id:"A",type:"BATTLE"},{id:"B",type:"BATTLE"}]):(s.nodeExtra01==null&&(s.nodeExtra01=Nt(i.deck.length).extra),y+1+s.nodeExtra01>=s.nextBossTime?[{id:"A",type:"REST"},{id:"B",type:"REST"}]:i.run.branchOffer.root)},onChooseNode:i=>{const s=h();if(r||(r=!0,queueMicrotask(()=>r=!1),s.run.finished)||s.phase!=="NODE")return;rt(s),s.run.branchOffer||(s.run.branchOffer=Se(s));const y=s.run,g=u.getNodeOffers(),x=i==="A"?g[0].type:g[1].type,w=at(s),v=y.forcedNext==="BOSS";let E=0;v||(y.nodeExtra01==null&&(y.nodeExtra01=Nt(s.deck.length).extra),E=y.nodeExtra01);const I=w+1+E,_=s.run.nodePickCount+1;s.run.nodePickCount=_,y.nodeExtra01=null;const $=!v&&I>=y.nextBossTime,P=v?"BATTLE":$?"REST":x,W=P==="BATTLE"?1:0,K=I+W;if(s.time=(s.time??0)+E+W,W&&f(s,"전투를 선택해 시간이 더 소모된다. (시간 +1)"),hn(s,i),s.run.nodePickByType[P]=(s.run.nodePickByType[P]??0)+1,s.run.treasureObtained&&P!=="TREASURE"){s.run.afterTreasureNodePicks+=1;const N=s.run.deckSizeAtTreasure??Le(s),L=Ie(N);if(s.run.afterTreasureNodePicks>=L){s.run.finished=!0,f(s,`승리! 보물 획득 후 ${L}번의 탐험을 버티고 탈출했습니다.`),T(s,u);return}}if(v){y.forcedNext=null,y.nextBossTime+=40,s.run.bossOmenText=null,f(s,`=== 시간 ${K}: 보스 전투 ===`),he(s,{forceBoss:!0}),me(s),T(s,u);return}if(!v&&K>=y.nextBossTime&&(y.forcedNext="BOSS",f(s,"시간이 흘러 보스가 다가옵니다!")),P==="BATTLE"){he(s,{forceBoss:!1}),me(s),T(s,u);return}if(P==="REST"){let N=function(H){const V=H.player.fatigue??0;V<10||(H.player.fatigue=Math.max(0,V-2),H.time=(H.time??0)+1,f(H,"피로가 너무 높아 휴식이 더 오래 걸립니다. (F -2, 시간 +1)"))};const L=()=>{const H=(s.player.fatigue??0)>=10,V=H?"피로도가 너무 높아 더 쉬어야 합니다.":"휴식",z=H?" (피로도 10 이상: F -2, 시간 +1)":"";s.choice={kind:"EVENT",title:V,prompt:"무엇을 하시겠습니까?",art:"assets/events/event_rest.png",options:[{key:"rest:heal",label:`HP +15 ${z}`},{key:"rest:clear_f",label:`F -3 ${z}`},{key:"rest:upgrade",label:`강화 ${z}`},{key:"rest:skip",label:"생략"}]},n=A=>{if(A==="rest:heal"){N(s),s.player.hp=Math.min(s.player.maxHp,s.player.hp+15),f(s,"휴식: HP +15"),d(s),s.phase="NODE",T(s,u);return}if(A==="rest:clear_f"){N(s),s.player.fatigue=Math.max(0,s.player.fatigue-3),f(s,"휴식: 피로 F-=3"),d(s),s.phase="NODE",T(s,u);return}if(A==="rest:upgrade"){S(s,u,"강화","강화할 카드 1장을 선택하세요.",{onDone:()=>{N(s),s.phase="NODE",T(s,u)},onSkip:()=>{L(),T(s,u)}});return}f(s,"휴식: 생략"),d(s),s.phase="NODE",T(s,u)}};L(),T(s,u);return}if(P==="TREASURE"){Qn(s);const N=s.run.deckSizeAtTreasure,L=Ie(N);f(s,`저주받은 보물을 얻었습니다! 이제부터 ${L}번의 탐험을 버티면 탈출합니다.`),T(s,u);return}if(P==="EVENT"){const N=s.run;N.ominousProphecySeen??=!1;const L=.3;let H=Pt(s);if(N.ominousProphecySeen===!0)for(let A=0;A<50&&H.id==="ominous_prophecy";A++)H=Pt(s);else Math.random()<L&&(H=ir("ominous_prophecy")??H,N.ominousProphecySeen=!0);const V=H.options(s),{tier:z}=De(s);z>=2&&V.push({key:"mad:whisper",label:"속삭임에 귀 기울인다.",detail:"무언가를 얻는다. 그리고 무언가를 잃는다.",apply:A=>{const J=Math.random();return J<.34?(A.player.hp=Math.min(A.player.maxHp,A.player.hp+10),f(A,"속삭임: HP +10")):J<.67?(A.player.fatigue+=1,f(A,"속삭임: F +1 (대가)")):(Ae(A,"mad_echo",{upgrade:0}),f(A,"속삭임: [메아리]를 얻었다.")),"NONE"}}),s.choice={kind:"EVENT",title:H.name,prompt:H.prompt,art:H.art??null,options:V.map(A=>({key:A.key,label:A.label,detail:A.detail}))},n=A=>{const J=V.find(oe=>oe.key===A);if(!J)return;const M=J.apply(s);if(typeof M=="object"&&M.kind==="UPGRADE_PICK"){S(s,u,M.title??"강화",M.prompt??"강화할 카드 1장을 선택하세요.");return}if(typeof M=="object"&&M.kind==="REMOVE_PICK"){const oe=Object.values(s.cards).filter(O=>O.zone==="deck"||O.zone==="hand"||O.zone==="discard").map(O=>O.uid);m(s,{kind:"PICK_CARD",title:M.title,prompt:M.prompt??"제거할 카드 1장을 선택하세요.",options:[...oe.map(O=>{const R=lt(s,O);return{key:`remove:${O}`,label:j(s,O),detail:`전열: ${R.frontText} / 후열: ${R.backText}`,cardUid:O}}),{key:"cancel",label:"취소"}]},O=>{if(O==="cancel"){f(s,"제거 취소"),d(s),T(s,u);return}if(!O.startsWith("remove:")){T(s,u);return}const R=O.slice(7);Kt(s,R);const Y=M.then,fe=Y==="REWARD"||Y==="REWARD_PICK"?"REWARD_PICK":Y==="BATTLE"?"BATTLE":Y==="NONE"?"NONE":void 0;if(fe==="BATTLE"){l(s),he(s),me(s),T(s,u);return}if(fe==="REWARD_PICK"){l(s),k(s,u,"카드 보상","두 장 중 한 장을 선택하거나 생략합니다.");return}l(s),s.phase="NODE",T(s,u)}),T(s,u);return}if(typeof M=="object"&&M.kind==="BATTLE_SPECIAL"){l(s),f(s,M.title?`이벤트 전투: ${M.title}`:"이벤트 전투 발생!"),he(s,{forcePatternIds:M.enemyIds}),me(s),T(s,u);return}if(M==="BATTLE"){l(s),he(s),me(s),T(s,u);return}if(M==="REWARD"){l(s),k(s,u,"카드 보상","두 장 중 한 장을 선택하거나 생략합니다.");return}d(s),T(s,u)},T(s,u);return}},onChooseChoice:i=>{const s=h();if(!s.choice)return;if(n){n(i);const g=h();g.enemies.length>0&&g.phase==="PLACE"||u.onAutoAdvance();return}const y=s.choice.kind;if(y==="REWARD"||y==="REWARD_PICK"){if(i==="skip"){f(s,"카드 보상 생략"),d(s),!s.run.finished&&s.enemies.length===0&&(s.phase="NODE"),T(s,u);return}if(i.startsWith("pick:")){const g=i.slice(5),[x,w]=g.split(":"),v=Number(w??"0")||0;Ae(s,x,{upgrade:v}),f(s,`카드 획득: ${on(s,x,v)}`),d(s),!s.run.finished&&s.enemies.length===0&&(s.phase="NODE"),T(s,u);return}}f(s,`선택 처리 불가: handler 없음 (kind=${y}, key=${i})`)},onAutoAdvance:()=>{const i=h();Rr(i,u)},onRevealIntents:()=>{const i=h();i.run.finished||i.enemies.length!==0&&(ht(i),T(i,u))},onPlaceHandUidToSlot:(i,s,y)=>{const g=h();g.run.finished||D(g)||g.phase==="PLACE"&&(s==="back"&&g.backSlotDisabled?.[y]||(Ct(g,i,s,y),g.selectedHandCardUid=null,T(g,u)))},onPlaceSelected:(i,s)=>{const y=h();y.selectedHandCardUid&&u.onPlaceHandUidToSlot(y.selectedHandCardUid,i,s)},onMoveSlotCard:(i,s,y,g)=>{const x=h();if(x.run.finished||D(x)||x.phase!=="PLACE"||y==="back"&&x.backSlotDisabled?.[g])return;const w=i==="front"?x.frontSlots:x.backSlots,v=y==="front"?x.frontSlots:x.backSlots,E=w[s];if(!E)return;const I=v[g];w[s]=I??null,v[g]=E,x.cards[E].zone=y,I&&(x.cards[I].zone=i),i!==y&&(i==="front"&&(x.frontPlacedThisTurn=Math.max(0,x.frontPlacedThisTurn-1)),y==="front"&&(x.frontPlacedThisTurn+=1),I&&(y==="front"&&(x.frontPlacedThisTurn=Math.max(0,x.frontPlacedThisTurn-1)),i==="front"&&(x.frontPlacedThisTurn+=1))),f(x,I?`[${j(x,E)}] ↔ [${j(x,I)}] 스왑: ${i}${s+1} ↔ ${y}${g+1}`:`[${j(x,E)}] 이동: ${i}${s+1} → ${y}${g+1}`),st(x),T(x,u)},onResolveBack:()=>{const i=h();i.phase==="PLACE"&&st(i),Hn(i),T(i,u)},onResolveFront:()=>{const i=h();Rn(i),T(i,u)},onResolveEnemy:()=>{const i=h();Mn(i),T(i,u)},onUpkeep:()=>{const i=h();Dn(i),T(i,u)},onDrawNextTurn:()=>{const i=h();Fn(i),T(i,u)}};function k(i,s,y,g){const w=Ut(i).map(v=>{const E=ue(i.content,v.defId,v.upgrade);return{key:`pick:${v.defId}:${v.upgrade}`,label:ya(i,v),detail:`전열: ${E.frontText} / 후열: ${E.backText}`}});i.choice={kind:"REWARD",title:y,prompt:g,options:[...w,{key:"skip",label:"생략"}]},n=v=>{if(n=null,v.startsWith("pick:")){const E=v.slice(5),[I,_]=E.split(":"),$=Number(_??"0")||0;Ae(i,I,{upgrade:$})}else f(i,"카드 보상 생략");d(i),i.choice=null,i.run.finished||(i.phase="NODE"),T(i,s)},T(i,s)}function S(i,s,y,g,x){let w=Object.values(i.cards).filter(_=>(_.zone==="deck"||_.zone==="hand"||_.zone==="discard")&&Vt(i,_.uid)).map(_=>_.uid);const v=i.player.fatigue??0;let E=1/0;if(v>=8?E=4:v>=5&&(E=8),E!==1/0&&w.length>E&&(w=[...w].sort(()=>Math.random()-.5).slice(0,E)),w.length===0){f(i,"강화할 수 있는 카드가 없습니다."),i.choice=null,n=null,x?.onSkip?x.onSkip():T(i,s);return}const I=[...w].sort((_,$)=>{const P=i.cards[_],W=i.cards[$],K=Me(i,P.defId),N=Me(i,W.defId),L=K.localeCompare(N,"ko");return L!==0?L:(P.upgrade??0)-(W.upgrade??0)});i.choice={kind:"UPGRADE_PICK",title:y,prompt:g,options:[...I.map(_=>{const $=i.cards[_],P=lt(i,_),W=ue(i.content,$.defId,($.upgrade??0)+1),K=j(i,_),N=`현재: 전열 ${P.frontText} / 후열 ${P.backText}
강화: 전열 ${W.frontText} / 후열 ${W.backText}`;return{key:`up:${_}`,label:K,detail:N,cardUid:_}}),{key:"skip",label:"취소"}]},n=_=>{if(_==="skip"){f(i,"강화 취소"),d(i),x?.onSkip?x.onSkip():T(i,s);return}if(_.startsWith("up:")){const $=_.slice(3),P=ar(i,$);f(i,P?`강화: [${j(i,$)}]`:"강화 실패"),d(i),x?.onDone?x.onDone():T(i,s);return}d(i),T(i,s)},T(i,s)}return u}function st(e){const t=e.frontSlots.filter(r=>r!=null).length,n=e.backSlots.filter(r=>r!=null).length;e.frontPlacedThisTurn=t,e.usedThisTurn=t+n}function qr(){const e=document.querySelector("#app");return e.innerHTML="",e}function X(e,t,n=""){const r=document.createElement("button");return n&&(r.className=n),r.type="button",r.textContent=e,r.onclick=t,r}function yt(){const e=Array.from(document.querySelectorAll(".enemyName"));if(e.length===0)return;e.forEach(a=>{a.style.display="inline-block",a.style.width="auto",a.style.whiteSpace="nowrap"});let t=0;for(const a of e)t=Math.max(t,a.scrollWidth);const r=Math.min(t,320);e.forEach(a=>{a.style.width=`${r}px`,a.style.overflow="hidden",a.style.textOverflow="ellipsis"})}function Kr(){document.querySelector(".phaseBanner")?.remove(),performance.now()}function Vr(){Cr();let e=document.querySelector(".floatFxLayer");e||(e=document.createElement("div"),e.className="floatFxLayer",document.body.appendChild(e)),e.style.cssText="position:fixed; inset:0;pointer-events:none;z-index: 100000;";const t=new Set(Ee.map(n=>String(n.id)));for(const n of Array.from(e.children)){const r=n.dataset.fxId;r&&(t.has(r)||n.remove())}for(const n of Ee){const r=String(n.id);let a=e.querySelector(`.floatNum[data-fx-id="${r}"]`);a?(a.style.left=`${Math.round(n.x)}px`,a.style.top=`${Math.round(n.y)}px`):(a=document.createElement("div"),a.className=`floatNum ${n.kind}`,a.dataset.fxId=r,a.textContent=n.text,a.style.left=`${Math.round(n.x)}px`,a.style.top=`${Math.round(n.y)}px`,e.appendChild(a))}}function jr(){if(document.querySelector(".floatingNewRun"))return;const e=document.createElement("button");e.className="floatingNewRun",e.type="button",e.textContent="새로운 런",e.style.cssText=`
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    left: calc(env(safe-area-inset-left, 0px) + 10px);
    z-index: 99999;
    pointer-events: auto;

    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.55);
    color: #fff;

    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    cursor: pointer;
    touch-action: manipulation;
  `,e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),Gt?.()}),document.body.appendChild(e)}function T(e,t){T._uiScaleInitDone||(T._uiScaleInitDone=!0,$r(),Qt(),Jr()),te=e,dr({getG:()=>te??e,actions:{onNewRun:()=>t.onNewRun()},rerender:()=>T(te??e,t),log:m=>f(te??e,m)}),de(),Gt=()=>t.onNewRun(),jr(),Lr(),T._logInitDone||(T._logInitDone=!0,Or());const n=document.querySelector(".mainPanel");n&&(Bt=n.scrollTop,At=n.scrollLeft);const r=qr();Ot||(window.addEventListener("resize",()=>{}),ca(()=>te??e,t),Ot=!0),r.appendChild(ta(e,t));const a=b("mainRow"),o=b("stage"),l=b("stageInner"),c=b("panel mainPanel"),p=!e.run.finished&&e.enemies.length>0&&e.phase!=="NODE";c.classList.toggle("inCombat",p),c.scrollTop=Bt,c.scrollLeft=At,c.appendChild(ra(e)),e.run.finished?c.appendChild(kt("런 종료")):e.phase==="NODE"?zr(c,e,t):sa(c,e,t),l.appendChild(c),o.appendChild(l);const d=b("panel logPanel");if(d.classList.toggle("collapsed",ne),d.appendChild(aa(ne,()=>{ne=!ne,Ir(),T(e,t)})),!ne){const m=ma(e.log.join(`
`));m.classList.add("log"),d.appendChild(m)}a.appendChild(o),a.appendChild(d),r.appendChild(a),yt(),Yr(e),ia(e,t,D(e)),xt(),bt(),Qr(),an(),Zr(e,t),ea(e,t),Xr(e,t),Er(e),Kr(),Vr(),Hr(e),gr()}function Yr(e){const t=document.querySelector(".stageInner");if(!t)return;document.querySelector(".stageCornerHud")?.remove();const n=document.createElement("div");n.className="stageCornerHud",n.textContent=na(e),document.body.appendChild(n);const r=t.getBoundingClientRect(),a=-56,o=(r.left+r.right)/2;n.style.right="",n.style.left=`${Math.round(o)}px`,n.style.top=`${Math.round(r.top+a)}px`,n.style.transform="translateX(-50%)"}function Xr(e,t){if(document.querySelector(".logOverlay")?.remove(),!ot)return;const n=b("logOverlay");n.style.cssText=`
    position: fixed; inset: 0;
    pointer-events:auto;
    z-index: 100000;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: flex-end;
    justify-content: center;
  `;const r=b("panel");r.style.cssText=`
    width: min(720px, 100%);
    max-height: 70vh;
    border-radius: 18px 18px 0 0;
    padding: 12px;
    margin: 0;
  `;const a=b("panelHeader"),o=document.createElement("h2");o.textContent="로그",a.appendChild(o);const l=X("닫기",()=>t.onToggleLogOverlay());a.appendChild(l),r.appendChild(a);const c=document.createElement("pre");c.className="log",c.textContent=e.log.join(`
`),c.style.maxHeight="60vh",c.style.overflow="auto",r.appendChild(c),n.onclick=()=>t.onToggleLogOverlay(),r.onclick=p=>p.stopPropagation(),n.appendChild(r),document.body.appendChild(n)}function Gr(e,t){const n=b("settingsPanel");n.style.cssText="display:flex; flex-direction:column; gap:12px;";const r=b("settingsRow");r.style.cssText="display:flex; align-items:center; gap:12px; flex-wrap:wrap;";const a=U("","UI 스케일");a.style.cssText="font-weight:800;";const o=U("",`${Math.round(G*100)}%`);o.style.cssText="opacity:.9; min-width:64px; text-align:right;";const l=document.createElement("input");l.type="range",l.min="0.75",l.max="1.25",l.step="0.01",l.value=String(G),l.style.cssText="flex:1 1 260px;",l.oninput=()=>{G=Number(l.value),o.textContent=`${Math.round(G*100)}%`,e()},r.appendChild(a),r.appendChild(l),r.appendChild(o),n.appendChild(r);const c=b("settingsPresets");c.style.cssText="display:flex; gap:8px; flex-wrap:wrap;";const p=(h,u)=>{const k=X(h,()=>{G=u,l.value=String(u),o.textContent=`${Math.round(G*100)}%`,e()});return k.style.cssText="padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06); color:#fff; cursor:pointer;",k};c.appendChild(p("작게 90%",.9)),c.appendChild(p("기본 100%",1)),c.appendChild(p("크게 110%",1.1)),c.appendChild(p("더 크게 120%",1.2)),n.appendChild(c);const d=b("settingsResetRow");d.style.cssText="display:flex; justify-content:flex-end; margin-top:6px;";const m=X("초기화",()=>{G=1,l.value="1",o.textContent="100%",e()});return m.style.cssText="padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06); color:#fff; cursor:pointer;",d.appendChild(m),n.appendChild(d),n}function Qr(){const e=document.querySelector(".playerHudLeft"),t=document.querySelector(".stageInner");if(!e||!t)return;const n=t.getBoundingClientRect(),r=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--uiScale"))||1,a=18*r,o=360*r,l=Math.round(n.left-a-o),c=Math.round(n.top+n.height*.18);e.style.left=`${l}px`,e.style.top=`${c}px`}function Jr(){const e=document.documentElement,t=Ar()?Ne.uiScaleMobile:Ne.uiScaleDesktop;e.style.setProperty("--uiScale",String(t)),e.style.setProperty("--uiScaleDesktop",String(Ne.uiScaleDesktop)),e.style.setProperty("--uiScaleMobile",String(Ne.uiScaleMobile))}function Zr(e,t){if(document.querySelector(".overlay-layer")?.remove(),!B)return;const n=B.kind==="SETTINGS",r=b("overlay-layer");r.style.cssText=n?"position:fixed; inset:0; z-index:30000;background:rgba(0,0,0,1);display:flex; justify-content:center; align-items:flex-start;padding:24px; box-sizing:border-box;":"position:fixed; inset:0; z-index:30000;background:rgba(0,0,0,.55);display:flex; justify-content:center; align-items:center;",r.onclick=d=>{d.target===r&&t.onCloseOverlay()};const a=b("overlay-panel");a.style.cssText=n?"width:min(860px, 96vw); max-height:calc(100vh - 48px); overflow:auto;padding:16px; border:1px solid rgba(255,255,255,.12); border-radius:16px;background:rgba(15,18,22,1); box-shadow:0 18px 60px rgba(0,0,0,.45);":"width:min(980px, 92vw); max-height:80vh; overflow:auto; padding:16px;border:1px solid rgba(255,255,255,.12); border-radius:16px;background:rgba(15,18,22,.92); box-shadow:0 18px 60px rgba(0,0,0,.45);",a.onclick=d=>d.stopPropagation();const o=B.kind==="RULEBOOK"?"룰북":B.kind==="SETTINGS"?"설정":B.pile==="deck"?"덱":B.pile==="discard"?"버림 더미":B.pile==="exhausted"?"소모(이번 전투)":B.pile==="vanished"?"소실(영구)":"손패",l=b("overlayHeader");l.style.cssText="display:flex; align-items:center; justify-content:space-between; gap:12px; position:sticky; top:0; padding-bottom:12px; margin-bottom:12px; background:rgba(15,18,22,.92);";const c=ha(o);c.classList.add("overlayTitle");const p=ct("닫기",t.onCloseOverlay,!1);if(p.classList.add("overlayClose"),p.style.cssText="padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#fff; cursor:pointer;",l.appendChild(c),l.appendChild(p),a.appendChild(l),B.kind==="RULEBOOK"){const d=document.createElement("pre");d.className="rulebook",d.textContent=xr,d.style.cssText="white-space:pre-wrap; line-height:1.45; font-size:13px; margin:0; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);",a.appendChild(d)}else if(B.kind==="SETTINGS")a.appendChild(Gr(()=>{Qt(),_r(),te&&(yt(),xt(),bt())}));else{const m=[...B.pile==="deck"?e.deck:B.pile==="discard"?e.discard:B.pile==="exhausted"?e.exhausted:B.pile==="vanished"?e.vanished:e.hand].sort((x,w)=>{const v=e.cards[x],E=e.cards[w],I=Me(e,v.defId),_=Me(e,E.defId),$=I.localeCompare(_,"ko");return $!==0?$:(v.upgrade??0)-(E.upgrade??0)}),h=b("pileView");h.style.cssText="display:grid;grid-template-columns: 1fr 320px;gap:16px;align-items:start;";const u=b("pileGrid");u.style.cssText="display:grid;grid-template-columns: repeat(auto-fill, minmax(var(--handCardW), 1fr));gap:10px;align-content:start;min-width:0;max-height: 62vh;overflow-y: auto;overflow-x: hidden;";const k=b("pileSide");k.style.cssText="position:sticky; top:72px;align-self:start;border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px;background:rgba(0,0,0,.22);";const S=b("pileSideTitle");S.style.cssText="font-weight:800; margin:0 0 10px 0; opacity:.95;",k.appendChild(S);const i=b("pilePreviewBox");i.style.cssText="display:flex; justify-content:center; align-items:flex-start;padding:8px 0 10px 0;",k.appendChild(i);const s=document.createElement("pre");s.className="pileSideDetail",s.style.cssText="margin:0;padding:10px;white-space:pre-wrap;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.20);font-size:12px;line-height:1.45;",k.appendChild(s);let y=m[0]??null;const g=()=>{if(i.innerHTML="",!y){S.textContent="선택된 카드 없음",s.textContent="";return}const x=lt(e,y),w=ln(e,y);S.textContent=w;const v=Re(e,y);i.appendChild(v),s.textContent=`전열: ${x.frontText}
후열: ${x.backText}`};if(m.length===0){const x=b("overlayEmpty");x.textContent="비어 있음",x.style.cssText="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03);",u.appendChild(x)}else for(const x of m){const w=Re(e,x,E=>{y=E,g()});w.style.width="var(--handCardW)",w.style.height="var(--handCardH)",w.style.boxSizing="border-box",w.style.cursor="pointer";const v=()=>{y=x,u.querySelectorAll(".pileSelected").forEach(E=>E.classList.remove("pileSelected")),w.classList.add("pileSelected"),g()};w.onclick=v,w.onmouseenter=v,u.appendChild(w)}if(h.appendChild(u),h.appendChild(k),a.appendChild(h),y){const x=u.firstElementChild;x&&x.classList.add("pileSelected")}g()}r.appendChild(a),document.body.appendChild(r)}function ea(e,t){document.querySelector(".choice-overlay")?.remove();const n=e.choice;if(!n){document.querySelector(".mainPanel")?.classList.remove("choiceOpen");return}const r=document.querySelector(".mainPanel");if(!r)return;r.classList.add("choiceOpen");const a=b("choice-overlay");a.style.cssText="position:fixed; inset:0; z-index:22000;background: transparent; display:flex; justify-content:center; align-items:flex-start; padding:180px 36px 12px 12px; box-sizing:border-box;pointer-events:auto;",a.style.setProperty("pointer-events","auto","important");const o=b("choice-panel");o.style.cssText="width:min(750px, 88vw); max-height:70vh;overflow:auto; overflow-x:hidden; padding:16px;border:1px solid rgba(255,255,255,.14); border-radius:16px;background:rgba(0,0,0,1);pointer-events:auto;",o.style.setProperty("pointer-events","auto","important"),o.onclick=p=>p.stopPropagation(),o.appendChild(fa(n.title)),n.prompt&&o.appendChild(kt(n.prompt));const l=p=>{p.style.width="var(--handCardW)",p.style.height="var(--handCardH)",p.style.boxSizing="border-box"};if(n.options.some(p=>p.cardUid?!0:typeof p.key=="string"&&p.key.startsWith("pick:"))){const p=b("choice-list");p.style.cssText="display:flex; flex-direction:column; gap:10px; margin-top:12px;",n.options.forEach(d=>{const m=b("choice-item");m.style.cssText="display:flex; gap:12px; align-items:flex-start;border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px;background:rgba(255,255,255,.03);";const h=b("choice-left");h.style.cssText="flex:0 0 auto;";const u=d.cardUid;if(u){const i=e.choice?.kind==="UPGRADE_PICK",y=(e.cards[u].upgrade??0)+1;let g;try{i?(g=Fr(e,u,y),g.classList.add("upgradePreview")):g=Re(e,u)}catch{g=Re(e,u)}l(g),h.appendChild(g)}else if(typeof d.key=="string"&&d.key.startsWith("pick:")){const i=d.key.slice(5),[s,y]=i.split(":"),g=Number(y??"0")||0,x=Jt(e,s,g);l(x),h.appendChild(x)}const k=b("choice-right");k.style.cssText="flex:1 1 auto; min-width:260px;";const S=ct(d.label,()=>t.onChooseChoice(d.key),!1);if(S.classList.add("primary"),k.appendChild(S),d.detail){const i=document.createElement("pre");i.className="choice-detail",i.textContent=String(d.detail),i.style.cssText="margin:10px 0 0 0; padding:10px; white-space:pre-wrap;border-radius:12px; border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22); font-size:12px; line-height:1.45;max-height:220px; overflow:auto;",k.appendChild(i)}m.appendChild(h),m.appendChild(k),p.appendChild(m)}),o.appendChild(p)}else{const p=b("choice-contentRow");p.style.cssText="display:flex; gap:18px; margin-top:12px;justify-content:center; align-items:stretch;";const d=b("choice-leftCol");d.style.cssText="flex:1 1 640px; max-width:720px; min-width:0;";const m=b("choice-illuCol");m.style.cssText="flex:0 0 var(--choiceIlluSize, 260px); min-width:200px;display:flex; align-items:center; justify-content:center;";const h=b("choice-illuBox");h.style.cssText="width:100%; aspect-ratio:1/1;border-radius:18px; border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.35);";const u=n.art;if(u){const S=document.createElement("img");S.src=u,S.alt=n.title??"illustration";const i=1.5;h.style.overflow="hidden",S.style.imageRendering="pixelated",S.style.cssText="position:absolute; inset:0;width:"+i*100+"%;height:"+i*100+"%;left:"+-.5*50+"%;top:"+-.5*50+"%;object-fit:cover;object-position:50% 50%;image-rendering: pixelated; image-rendering: crisp-edges;border-radius:18px;",h.style.position="relative",h.appendChild(S)}m.appendChild(h);const k=b("choice-list");k.style.cssText="display:flex; flex-direction:column; gap:10px;",n.options.forEach(S=>{const i=b("choice-item");i.style.cssText="display:flex; gap:12px; align-items:flex-start;border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px;background:rgba(255,255,255,.03);position:relative;";const s=ct(S.label,()=>t.onChooseChoice(S.key),!1);if(s.classList.add("choiceOptBtn"),i.appendChild(s),S.detail){const y=document.createElement("pre");y.className="choice-detail",y.textContent=String(S.detail),y.style.cssText="margin:10px 0 0 0; padding:10px; white-space:pre-wrap;border-radius:12px; border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22); font-size:12px; line-height:1.45;max-height:220px; overflow:auto;font-family: Mulmaru, ui-sans-serif, system-ui;",i.appendChild(y)}k.appendChild(i)}),d.appendChild(k),p.appendChild(d),p.appendChild(m),o.appendChild(p)}a.appendChild(o),document.body.appendChild(a)}function ta(e,t){document.querySelectorAll(".topHud").forEach(g=>g.remove()),document.querySelectorAll(".enemyHudCenter").forEach(g=>g.remove());const n=b("topHud");n.appendChild(b("topHudLeftSpacer"));const r=b("playerHudLeft"),a=b("playerTitleRow");a.appendChild(U("playerHudTitle","플레이어"));const o=b("pileButtons");o.appendChild(X("덱",()=>t.onViewPile("deck"))),o.appendChild(X("버림",()=>t.onViewPile("discard"))),o.appendChild(X("손패",()=>t.onViewPile("hand"))),o.appendChild(X("소모",()=>t.onViewPile("exhausted"))),o.appendChild(X("소실",()=>t.onViewPile("vanished"))),a.appendChild(o),r.appendChild(a);const l=b("enemyChip");l.classList.add("playerHudBox");const c=b("enemyChipTop");c.appendChild(U("","HP")),c.appendChild(U("",`${e.player.hp}/${e.player.maxHp}`)),l.appendChild(c);const p=b("enemyHPOuter"),d=b("enemyHPFill");d.style.width=`${Math.max(0,Math.min(100,e.player.hp/Math.max(1,e.player.maxHp)*100))}%`,p.appendChild(d),l.appendChild(p);const m=b("enemyChipTop");m.appendChild(U("","블록")),m.appendChild(U("",`${e.player.block}`)),l.appendChild(m);const h=b("enemyHPOuter"),u=b("enemyHPFill");u.style.background="linear-gradient(90deg, #64b5ff, #2a7cff)",u.style.width=`${Math.max(0,Math.min(100,e.player.block/Math.max(1,e.player.maxHp)*100))}%`,h.appendChild(u),l.appendChild(h);const k=e.player.status,S=b("enemyBadges");l.appendChild(S);const i=[];(k.vuln??0)>0&&i.push(`취약 ${k.vuln}`),(k.weak??0)>0&&i.push(`약화 ${k.weak}`),(k.bleed??0)>0&&i.push(`출혈 ${k.bleed}`),(k.disrupt??0)>0&&i.push(`교란 ${k.disrupt}`);for(const g of i)S.appendChild(dt(g));if(r.appendChild(l),!e.run.finished&&e.enemies.length>0&&e.phase!=="NODE"){const g=b("enemyHudCenter"),x=b("enemyHudCenterMover"),w=b("enemyHud");w.style.cssText=`
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      justify-content: center;
      align-items: stretch;
      gap: 14px;
      overflow: visible;
      white-space: nowrap;
    `,g.style.overflow="visible",x.style.overflow="visible",x.style.width="max-content";const v=D(e);x.appendChild(w),g.appendChild(x),document.body.appendChild(g);for(let E=0;E<e.enemies.length;E++){let I=function(R){const Y=document.createElement("span");Y.className="badge";const fe=R.match(/\s*\[\[d:([+-]?\d+)\]\]\s*$/);if(!fe)return Y.textContent=R,Y;const un=fe[1],gt=R.replace(/\s*\[\[d:[+-]?\d+\]\]\s*$/,"");gt.trim().length>0&&Y.appendChild(document.createTextNode(gt+" "));const ze=document.createElement("span"),Ue=Number(un);return ze.className=`deltaInline ${Ue>0?"plus":"minus"}`,ze.textContent=`(${Ue>0?"+":""}${Ue} / 단타)`,Y.appendChild(ze),Y},_=function(R){return R===0?"":R>0?`+${R}`:`${R}`};const $=e.enemies[E],P=b("enemyBanner");P.style.cssText=`
        flex: 0 0 var(--enemyBannerW, 520px);
        width: var(--enemyBannerW, 520px);
        max-width: min(var(--enemyBannerW, 520px), 92vw);
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(0,0,0,.78);
        padding: 12px 14px;
        box-sizing: border-box;
      `,v&&$.hp>0&&P.classList.add("targetable");const W=b("enemyChipTop");W.appendChild(U("",`${E+1}. ${$.name}`)),W.appendChild(U("",`${$.hp}/${$.maxHp}`)),P.appendChild(W);const K=b("enemyHPOuter"),N=b("enemyHPFill");N.style.width=`${Math.max(0,Math.min(100,$.hp/Math.max(1,$.maxHp)*100))}%`,K.appendChild(N),P.appendChild(K);const L=e.content.enemiesById[$.id],H=L.intents[$.intentIndex%L.intents.length],V=$.intentLabelOverride??H.label;P.appendChild(U("enemyIntent",e.intentsRevealedThisTurn?`${V}`:""));const z=$.status,A=b("enemyBadges");P.appendChild(A);const J=e.player.status?.vuln??0,M=$.status?.weak??0,oe=J-M,O=[];if((z.vuln??0)>0&&O.push(`취약 ${z.vuln}`),(z.weak??0)>0)if(J!==0||M!==0){const R=_(oe);R?O.push(`약화 ${z.weak} [[d:${R}]]`):O.push(`약화 ${z.weak}`)}else O.push(`약화 ${z.weak}`);else if(J!==0||M!==0){const R=_(oe);R&&O.push(`[[d:${R}]]`)}(z.bleed??0)>0&&O.push(`출혈 ${z.bleed}`),(z.disrupt??0)>0&&O.push(`교란 ${z.disrupt}`),$.immuneThisTurn&&O.push("면역");for(const R of O)A.appendChild(I(R));P.onclick=()=>t.onSelectEnemy(E),w.appendChild(P)}}n.appendChild(r);const y=b("topHudRight");return y.appendChild(X("룰북",()=>t.onViewRulebook())),y.appendChild(X("로그",()=>t.onToggleLogOverlay())),y.appendChild(X("⚙️",()=>{B={kind:"SETTINGS"},T(e,t)})),n.appendChild(y),n}function na(e){const t=e.enemies.length>0&&e.phase!=="NODE",n=e.run.nextBattleSuppliesBonus??0,r=[];return t?r.push(`🧰 S ${e.player.supplies} |`):n>0&&r.push(`보너스 🧰 S +${n} |`),r.push(`💤 F ${e.player.fatigue}`),r.push(`| ⏳ 시간 ${Math.max(0,(e.run.nodePickCount??0)+(e.time??0))}`),r.push(`| 🃏 덱 ${e.deck.length}`),r.join(" ")}function Ge(e,t=""){const n=document.createElement("span");return n.className="chip"+(t?` ${t}`:""),n.textContent=e,n}function ra(e){const t=b("battleTitleRow");t.style.display="flex",t.style.alignItems="center",t.style.gap="12px";const n=document.createElement("h2");n.textContent="",t.appendChild(n);const r=oa(e),a=U("targetHintInline","");a.style.cssText="padding:5px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.55);background: rgb(255, 0, 0);opacity:.82;font-weight:400; font-size:12px; line-height:1.2;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;width: min(400px, 92vw);max-width: none;pointer-events:auto;",r?(a.textContent=r,a.style.visibility="visible",a.style.pointerEvents="auto"):(a.textContent="대상 선택 필요",a.style.visibility="hidden",a.style.pointerEvents="none");const o=b("battleTitleRight");o.style.cssText="margin-left:auto;display:flex; align-items:center; gap:10px;flex: 0 0 auto;white-space:nowrap;position:relative;";const l=b("resourceRow inline");return l.appendChild(Ge("")),l.appendChild(Ge("")),l.appendChild(Ge("")),o.appendChild(l),a.style.position="absolute",a.style.right="207px",a.style.top="calc(100% - 8px)",a.style.marginTop="0px",a.style.zIndex="5",a.style.pointerEvents=r?"auto":"none",t.appendChild(a),t.appendChild(o),t}function aa(e,t){const n=b("logHeaderRow");n.tabIndex=0;const r=document.createElement("h2");r.textContent="로그";const a=document.createElement("span");return a.className="chev",a.textContent=e?"▸":"▾",n.appendChild(r),n.appendChild(a),n.onclick=()=>t(),n.onkeydown=o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),t())},n}function oa(e){if(!D(e)||e.selectedEnemyIndex!=null)return null;const t=e.pendingTarget??null,n=t?.sourceCardUid?j(e,t.sourceCardUid):null,r=t?.sourceLabel??null,a=t?.reason??null,o=n?`대상 선택 (${n})`:r?`대상 선택 (${r})`:"대상 선택 필요",l=a==="FRONT"?"전열":a==="BACK"?"후열":a==="EVENT"?"이벤트":a==="RELIC"?"유물":null,c=l?` — ${l}`:"",p=e.pendingTargetQueue?.length??0,d=(e.pendingTarget?1:0)+p,m=d>1?` (남은 ${d}개)`:" (남은 1개)";return`${o}${c}${m}: 위의 적 박스를 클릭하세요.`}function sa(e,t,n){const r=b("combatRoot"),a=b("boardArea"),o=!t.run.finished&&t.enemies.length>0&&t.phase!=="NODE";a.classList.toggle("slabOn",o),a.appendChild(Ht(t,n,"front")),a.appendChild(Ht(t,n,"back")),r.appendChild(a),e.appendChild(r)}let it=null,tn=!0;function It(e,t){it=e,tn=t}function nn(e,t,n){return e.run.finished?{label:"종료",fn:null,disabled:!0,activePhase:e.phase}:e.choice||B?{label:"선택 중",fn:null,disabled:!0,activePhase:e.phase}:n?{label:"대상 선택",fn:null,disabled:!0,activePhase:e.phase}:e.phase==="NODE"?{label:"노드 선택",fn:null,disabled:!0,activePhase:e.phase}:e.phase==="PLACE"?e.enemies.length>0&&!e.intentsRevealedThisTurn?{label:"다음: 정찰",fn:t.onRevealIntents,disabled:!1,activePhase:e.phase}:{label:"다음: 후열",fn:t.onResolveBack,disabled:!1,activePhase:e.phase}:e.phase==="BACK"?{label:"다음: 후열",fn:t.onResolveBack,disabled:!1,activePhase:e.phase}:e.phase==="FRONT"?{label:"다음: 전열",fn:t.onResolveFront,disabled:!1,activePhase:e.phase}:e.phase==="ENEMY"?{label:"다음: 적",fn:t.onResolveEnemy,disabled:!1,activePhase:e.phase}:e.phase==="UPKEEP"?{label:"다음: 정리",fn:t.onUpkeep,disabled:!1,activePhase:e.phase}:e.phase==="DRAW"?{label:"다음 턴",fn:t.onDrawNextTurn,disabled:!1,activePhase:e.phase}:{label:"다음",fn:null,disabled:!0,activePhase:e.phase}}function ia(e,t,n){const r=document.querySelector(".handDock");r&&r.remove();const a=!e.run.finished&&e.enemies.length>0&&e.phase!=="NODE";document.querySelector(".combatControls")?.remove();const o=b("handDock"),l=nn(e,t,n);if(a){const d=b("combatControls"),m=document.createElement("button");m.textContent="다음 턴",m.className="stepBtn primary",m.disabled=l.disabled||e.phase==="NODE",m.onclick=()=>t.onAutoAdvance();const h=document.createElement("button");h.textContent="선택 해제",h.disabled=!e.selectedHandCardUid,h.onclick=t.onClearSelected,d.appendChild(m),d.appendChild(h),document.body.appendChild(d);const u=document.querySelector('.slot[data-slot-side="front"][data-slot-index="1"]')??document.querySelector(".stageInner");if(u){const k=u.getBoundingClientRect(),S=k.left+k.width/2;d.style.left=`${Math.round(S)}px`}It(()=>t.onAutoAdvance(),m.disabled)}else It(null,!0);const c=b("hand");c.dataset.dropHand="1";const p=b("handCardsRow");if(c.appendChild(p),e.hand.length===0){const d=b("handEmptyHint");d.textContent="",p.appendChild(d)}else for(const d of e.hand)p.appendChild(We(e,d,!0,t.onSelectHandCard,{draggable:!0}));o.appendChild(c),document.body.appendChild(o),la(c)}function la(e){e.dataset?.wheelX!=="1"&&(e.dataset.wheelX="1",e.addEventListener("wheel",t=>{if(t.shiftKey)return;const n=Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY;e.scrollLeft+=n,t.preventDefault()},{passive:!1}))}function bt(){const e=document.querySelector(".enemyHudCenter");if(!e)return;const t=e.querySelector(".enemyHudCenterMover")??e,n=e.querySelector(".enemyHud")??e.querySelector(".enemyStrip")??t;e.style.position="fixed",e.style.top="8px",e.style.left="50%",e.style.right="auto",e.style.transform="translateX(-50%)",e.style.overflow="visible",t.style.transform="",t.style.overflow="visible";const a=Array.from(e.querySelectorAll(".enemyBanner")).length;if(a===0){e.style.width="";return}const o=Math.min(520,Math.floor(window.innerWidth*.92)),l=14,c=o,p=Math.min(window.innerWidth-16,c*2+l),d=Math.min(window.innerWidth-16,c*3+l*2);n.style.display="flex",n.style.flexWrap="nowrap",n.style.justifyContent="center",n.style.alignItems="stretch",n.style.gap=`${l}px`,a===1?(e.style.width=`${c}px`,t.style.width="100%"):a===2?(e.style.width=`${p}px`,t.style.width="100%"):(e.style.width=`${d}px`,t.style.width="100%")}function xt(e){const t=document.querySelector(".hand"),n=document.querySelector(".handCardsRow");if(!t||!n)return;const r=document.querySelector('.slot[data-slot-side="front"][data-slot-index="1"]'),a=document.querySelector(".stageInner"),o=r?.getBoundingClientRect()??a?.getBoundingClientRect();if(!o)return;const l=o.left+o.width/2,c=Array.from(n.querySelectorAll(".card"));if(c.length===0)return;const p=c[0].getBoundingClientRect(),d=c[c.length-1].getBoundingClientRect(),m=p.left,h=d.right,u=(m+h)/2,k=l-u,S=n.scrollWidth,i=t.clientWidth;if(S<=i+1){n.style.transform=`translateX(${Math.round(k)}px)`,t.scrollLeft=0;return}let s=t.scrollLeft-k;const y=Math.max(0,S-i);s<0&&(s=0),s>y&&(s=y),t.scrollLeft=Math.round(s),n.style.transform=""}function Ht(e,t,n){const r=b("grid6"),a=!!e.selectedHandCardUid,o=n==="front"?e.frontSlots:e.backSlots;for(let l=0;l<3;l++){const c=n==="back"?!!e.backSlotDisabled?.[l]:!1,p=b("slot"+(c?" disabled":""));p.dataset.slotSide=n,p.dataset.slotIndex=String(l),Q&&Q.side===n&&Q.idx===l&&p.classList.add("dropHover"),a&&!c&&p.classList.add("placeable");const d=o[l];if(d){const m=We(e,d,!1);m.classList.add("inSlot"),p.appendChild(m),m.onpointerdown=h=>{h.button!==0&&h.pointerType==="mouse"||D(e)||e.phase==="PLACE"&&rn(h,{kind:"slot",cardUid:d,fromSide:n,fromIdx:l})},m.ondblclick=()=>t.onReturnSlotToHand(n,l)}p.onclick=()=>{if(c||D(e)||e.phase!=="PLACE")return;const m=o[l];if(!e.selectedHandCardUid&&m){t.onReturnSlotToHand(n,l);return}t.onPlaceSelected(n,l)},r.appendChild(p)}return r}function da(){if(document.querySelectorAll(".slot.dropHover").forEach(n=>n.classList.remove("dropHover")),!Q)return;const e=`.slot[data-slot-side="${Q.side}"][data-slot-index="${Q.idx}"]`,t=document.querySelector(e);t&&t.classList.add("dropHover")}let Rt=!1;function ca(e,t){Rt||(Rt=!0,window.addEventListener("pointermove",n=>{const r=e();if(r.choice||B||!C||n.pointerId!==C.pointerId)return;C.x=n.clientX,C.y=n.clientY;const a=C.x-C.startX,o=C.y-C.startY;!C.dragging&&a*a+o*o>36&&(C.dragging=!0),Q=C.dragging?Mt(n.clientX,n.clientY,r):null,an(document.querySelector("#app")),da()},{passive:!0}),window.addEventListener("pointerup",n=>{const r=e();if(!(r.choice||B)&&!(!C||n.pointerId!==C.pointerId)){if(C.dragging){const a=ua(n.clientX,n.clientY),o=Mt(n.clientX,n.clientY,r);if(a&&C.kind==="slot"&&C.fromSide!=null&&C.fromIdx!=null){!r.run.finished&&!D(r)&&r.phase==="PLACE"&&t.onReturnSlotToHand(C.fromSide,C.fromIdx),C=null,Q=null,T(r,t);return}if(o)if(C.kind==="hand"){const l=e();if(!(l.run.finished||D(l)||l.phase!=="PLACE")){const c=o.side,p=o.idx;if(!(c==="back"&&l.backSlotDisabled?.[p])){const d=c==="front"?l.frontSlots:l.backSlots,m=d[p];if(!m)t.onPlaceHandUidToSlot(C.cardUid,c,p);else{const h=C.fromHandIndex!=null&&C.fromHandIndex>=0?C.fromHandIndex:l.hand.indexOf(C.cardUid),u=l.hand.indexOf(C.cardUid);u>=0&&l.hand.splice(u,1),d[p]=C.cardUid,l.cards[C.cardUid].zone=c;const k=h!=null&&h>=0&&h<=l.hand.length?h:l.hand.length;l.hand.splice(k,0,m),l.cards[m].zone="hand",l.selectedHandCardUid=null,st(l),f(l,`[${j(l,C.cardUid)}] ↔ [${j(l,m)}] 스왑: 손패 ↔ ${c}${p+1}`),T(l,t)}}}}else C.kind==="slot"&&C.fromSide!=null&&C.fromIdx!=null&&(C.fromSide===o.side&&C.fromIdx===o.idx||t.onMoveSlotCard(C.fromSide,C.fromIdx,o.side,o.idx))}C?.sourceEl&&C.sourceEl.classList.remove("isDraggingSource"),C=null,Q=null,T(r,t)}}),window.addEventListener("keydown",n=>{const r=n.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return;const a=e();if(!cr()){if(n.ctrlKey&&n.shiftKey&&n.code==="KeyK"){n.preventDefault(),ur();return}if(n.code==="KeyF"){n.preventDefault(),t.onNewRun();return}if(n.code==="Digit4"){if(n.preventDefault(),D(a)){a.pendingTarget=null,a.pendingTargetQueue=[],a.selectedEnemyIndex=null,f(a,"대상 선택 취소"),T(a,t);return}t.onClearSelected();return}if(n.key==="Tab"){if(n.preventDefault(),a.hand.length===0)return;const o=a.selectedHandCardUid,l=o?a.hand.indexOf(o):-1,c=n.shiftKey?-1:1,p=((l+c)%a.hand.length+a.hand.length)%a.hand.length;a.selectedHandCardUid=a.hand[p],T(a,t);return}if(n.code==="Space"){n.preventDefault();const o=e();if(o.run.finished||o.choice||D(o))return;t.onAutoAdvance();return}if(n.code==="Digit1"||n.code==="Digit2"||n.code==="Digit3"){n.preventDefault();const o=n.code==="Digit1"?0:n.code==="Digit2"?1:2;if(D(a)){const l=a.enemies[o];if(!l||l.hp<=0){f(a,`대상 선택 실패: ${o+1}번 적이 없습니다.`),T(a,t);return}t.onSelectEnemy(o);return}t.onHotkeySlot("front",o);return}if(n.code==="KeyQ"||n.code==="KeyW"||n.code==="KeyE"){n.preventDefault();const o=n.code==="KeyQ"?0:n.code==="KeyW"?1:2;t.onHotkeySlot("back",o);return}if(n.code==="Enter"){n.preventDefault(),!tn&&it&&it();return}}}))}function rn(e,t){const n=e.currentTarget;try{n.setPointerCapture(e.pointerId)}catch{}const r=n.closest(".card");r&&r.classList.add("isDraggingSource");const a=r?.getBoundingClientRect(),o=a?e.clientX-a.left:20,l=a?e.clientY-a.top:20,c=getComputedStyle(document.documentElement),p=parseFloat(c.getPropertyValue("--handCardW"))||void 0,d=parseFloat(c.getPropertyValue("--handCardH"))||void 0;if(C={kind:t.kind,cardUid:t.cardUid,fromHandIndex:t.fromHandIndex,fromSide:t.fromSide,fromIdx:t.fromIdx,pointerId:e.pointerId,startX:e.clientX,startY:e.clientY,x:e.clientX,y:e.clientY,dragging:!1,previewEl:void 0,previewW:a?.width??p,previewH:a?.height??d,grabDX:o,grabDY:l},r){C.sourceEl=r;const m=r.cloneNode(!0);m.classList.remove("inSlot"),m.classList.remove("selected"),m.classList.remove("isDraggingSource"),m.style.position="static",m.style.inset="",m.style.width="100%",m.style.height="100%",m.style.margin="0",m.style.boxSizing="border-box",m.style.opacity="1",m.style.filter="none",m.style.transform="none",m.style.backgroundColor="transparent",C.previewEl=m}}function ua(e,t){const n=document.elementFromPoint(e,t);if(!n)return!1;let r=n;for(;r;){if(r.dataset?.dropHand==="1")return!0;r=r.parentElement}return!1}function Mt(e,t,n){const r=document.elementFromPoint(e,t);if(!r)return null;const a=pa(r,["slotSide","slotIndex"]);if(!a)return null;const o=a.dataset.slotSide,l=Number(a.dataset.slotIndex);return o==="back"&&n.backSlotDisabled?.[l]?null:{side:o,idx:l}}function pa(e,t){let n=e;for(;n;){const r=n.dataset;let a=!0;for(const o of t)if(r[o]==null){a=!1;break}if(a)return n;n=n.parentElement}return null}function an(e,t){if(!C||!C.dragging){document.querySelector(".dragLayer")?.remove();return}let n=document.querySelector(".dragLayer");if(n||(n=document.createElement("div"),n.className="dragLayer",n.style.position="fixed",n.style.inset="0",n.style.zIndex="21000",n.style.pointerEvents="none",document.body.appendChild(n)),n.innerHTML="",!C.previewEl)return;const r=document.createElement("div");r.className="dragCardPreview",r.style.position="fixed",r.style.left=`${Math.round(C.x-(C.grabDX??20))}px`,r.style.top=`${Math.round(C.y-(C.grabDY??20))}px`;const a=C.previewW??0,o=C.previewH??0;a>0&&(r.style.width=`${Math.round(a)}px`),o>0&&(r.style.height=`${Math.round(o)}px`),r.style.transform="none",r.style.opacity="1",r.style.filter="none",r.style.boxShadow="0 16px 44px rgba(0,0,0,.65)",r.style.backdropFilter="none",r.style.isolation="isolate",r.style.mixBlendMode="normal",r.style.overflow="hidden",r.style.borderRadius="16px",r.style.background="transparent",r.style.clipPath="inset(0 round 16px)",r.appendChild(C.previewEl),n.appendChild(r)}function lt(e,t){const n=e.cards[t];return ue(e.content,n.defId,n.upgrade??0)}function Me(e,t){return e.content.cardsById[t]?.name??t}function on(e,t,n){const r=n??0,a=e.content.cardsById[t]?.name??t;return r>0?`${a} +${r}`:a}function j(e,t){const n=e.cards[t];return on(e,n.defId,n.upgrade??0)}function We(e,t,n,r,a){const o=e.cards[t],l=ue(e.content,o.defId,o.upgrade??0),c=a?.draggable??!0,p=b("card");e.selectedHandCardUid===t&&p.classList.add("selected"),l.tags?.includes("EXHAUST")&&p.classList.add("exhaust"),l.tags?.includes("VANISH")&&p.classList.add("vanish");const d=b("cardHeader"),m=ln(e,t);d.appendChild(U("cardTitle",m));const h=b("cardMeta");l.tags?.includes("EXHAUST")&&h.appendChild(dt("소모")),l.tags?.includes("VANISH")&&h.appendChild(dt("소실")),d.appendChild(h),p.appendChild(d);const u=b("cardBody"),k=b("cardSection");k.classList.add("front"),k.appendChild(Lt(l.frontText)),u.appendChild(k);const S=b("cardSection");return S.classList.add("back"),S.appendChild(Lt(l.backText)),u.appendChild(S),p.appendChild(u),n&&r&&(p.onclick=()=>r(t)),n&&(p.onpointerdown=i=>{if(i.button!==0&&i.pointerType==="mouse"||D(e)||e.phase!=="PLACE"||!c)return;const s=e.hand.indexOf(t);rn(i,{kind:"hand",cardUid:t,fromHandIndex:s})}),p}function b(e){const t=document.createElement("div");return t.className=e,t}function U(e,t){const n=document.createElement("div");return n.className=e,n.textContent=t,n}function fa(e){const t=document.createElement("h2");return t.textContent=e,t}function ha(e){const t=document.createElement("h3");return t.textContent=e,t}function kt(e){const t=document.createElement("p");return t.textContent=e,t}function dt(e){const t=document.createElement("span");return t.className="badge",t.textContent=e,t}function ct(e,t,n){const r=document.createElement("button");return r.textContent=e,r.disabled=n,r.onclick=t,r}function ma(e){const t=document.createElement("pre");return t.className="log",t.textContent=e,t}function sn(e,t){const n=t??0;return n>0?`${e} +${n}`:e}function ln(e,t){const n=e.cards[t],r=e.content.cardsById[n.defId].name;return sn(r,n.upgrade)}function ya(e,t){const n=e.content.cardsById[t.defId].name;return sn(n,t.upgrade)}const ba={취약:"🎯",약화:"🥀",출혈:"🩸",교란:"🌀",면역:"✨",S:"🧰",F:"💤",드로우:"🃏",피해:"🗡️",회복:"💊",방어:"🛡️",블록:"🛡️",소모:"🔥",소실:"🕳️"};function Dt(e,t,n){const r=ba[e]??"",a=t!=null?`${e} ${t}`:e;return`<span class="kwBadge"><span class="kwIcon">${r}</span> <span class="kwLabel">${a}</span><span class="kwPunc">${n||""}</span></span>`}const dn="[,，、]",xa=new RegExp(`(취약|약화|출혈|교란|면역|S|F|드로우|피해|방어|블록|회복|소모|소실)\\s*([+-]?\\d+)\\s*(${dn})?`,"g"),ka=new RegExp(`(^|[^가-힣A-Za-z0-9_])(소모|소실)\\s*(${dn})?`,"g");function Ta(e){let t=e.replace(xa,(n,r,a,o)=>Dt(r,a,o));return t=t.replace(ka,(n,r,a,o)=>`${r}${Dt(a,void 0,o)}`),t=t.replace(/\n/g,"<br>"),t}function Lt(e){const t=b("cardText");return t.innerHTML=Ta(e),t}pn();fn();const ga=lr();let ge=Dr(ga);function cn(e){ge=e,ut=en(ge,cn),T(ge,ut)}let ut=en(ge,cn);T(ge,ut);document.documentElement.style.setProperty("--base","/deck-rogue-prototype/");const Tt="/deck-rogue-prototype/";document.documentElement.style.setProperty("--bgUrl",`url(${Tt}ui/background/dungeon_bg.png)`);document.documentElement.style.setProperty("--boardUrl",`url(${Tt}ui/boards/battle_board.png)`);document.documentElement.style.setProperty("--cardUrl",`url(${Tt}ui/cards/card_parchment.png)`);
